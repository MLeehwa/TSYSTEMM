<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LEEHWA VW TM System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
    
    .digital-clock {
      font-family: 'Orbitron', monospace;
      font-weight: 900;
    }
    
    .timer-display {
      font-family: 'Orbitron', monospace;
      font-weight: 700;
    }
    
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    
    .progress-bar {
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.3s ease;
    }
    
    .work_status-active {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: 2px solid #10b981;
    }
    
    .work_status-waiting {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      border: 2px solid #f59e0b;
    }
    
    .work_status-completed {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
      border: 2px solid #6b7280;
    }
    
    /* ÌíÄÏä§ÌÅ¨Î¶∞ Í¥ÄÎ†® Ïä§ÌÉÄÏùº */
    .sidebar-hidden {
      display: none !important;
    }
    
    .main-content-fullscreen {
      margin-left: 0 !important;
      width: 100% !important;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white shadow-lg border-r border-gray-200">
      <div class="p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
          <span class="text-3xl mr-2">üîÑ</span>
          LEEHWA VW TM System
        </h2>
        
        <nav>
          <ul class="space-y-2">
            <li class="pt-2">
              <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-4">
                FIFO Management
              </div>
              <ul class="space-y-1 ml-2">
                <li><button onclick="loadPage('pages/fifo/upload.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">üì§</span>
                  Excel Upload
                </button></li>
                <li><button onclick="loadPage('pages/analysis-new.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">üìä</span>
                  Shipping Plan Analysis
                </button></li>
                <li><button onclick="loadPage('pages/packaging-analysis-fixed.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">üì¶</span>
                  Packaging Analysis
                </button></li>
              </ul>
            </li>
            
            <li class="pt-4">
              <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-4">
                Truck Status
              </div>
              <ul class="space-y-1 ml-2">
                <li><button onclick="loadPage('pages/truck/status.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                   <span class="text-lg mr-3">üì∫</span>
                   Live Status Display
                 </button></li>
                <li><button onclick="loadPage('pages/truck/management.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">üöõ</span>
                  Truck Management
                </button></li>
              </ul>
            </li>
            
            <li class="pt-4">
              <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-4">
                Display Control
              </div>
              <ul class="space-y-1 ml-2">
                <li><button onclick="toggleSidebar()" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">üìè</span>
                  Toggle Sidebar
                </button></li>
                <li><button onclick="toggleFullscreenMode()" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">üñ•Ô∏è</span>
                  Fullscreen Mode
                </button></li>
              </ul>
            </li>
            
            <li class="pt-4">
              <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-4">
                Packaging Schedule
              </div>
              <ul class="space-y-1 ml-2">
                <li><button onclick="loadPage('pages/schedule/display.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">üì∫</span>
                  Live Display
                </button></li>
                <li><button onclick="loadPage('pages/schedule/admin.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">‚öôÔ∏è</span>
                  Admin Schedule
                </button></li>
                <li><button onclick="loadPage('pages/schedule/supervisor.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">üë®‚Äçüíº</span>
                  Supervisor Control
                </button></li>
              </ul>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main id="mainContent" class="flex-1 overflow-hidden">
      <div class="h-full flex flex-col">
        <!-- Content Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-semibold text-gray-800" id="pageTitle">Welcome to TM System</h1>
            <div class="flex items-center space-x-4">
              <button onclick="toggleFullscreen()" id="fullscreenBtn" class="bg-red-500 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg">
                <span id="fullscreenText">üñ•Ô∏è FULLSCREEN</span>
              </button>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                System Status
              </span>
            </div>
          </div>
        </header>
        
        <!-- Content Body -->
        <div class="flex-1 overflow-y-auto p-6" id="mainContent">
          <!-- Welcome Content -->
          <div class="welcome-content">
            <h2 class="text-4xl font-bold text-gray-800 mb-6 text-center">Welcome to TM System</h2>
            <p class="text-xl text-gray-600 text-center mb-12">Efficient FIFO Management and Truck Status Monitoring</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              <!-- FIFO Management -->
              <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
                <div class="text-4xl mb-4">üì¶</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">FIFO Management</h3>
                <p class="text-gray-600">Upload Excel files and analyze shipping plans efficiently.</p>
              </div>
              
              <!-- Truck Management -->
              <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
                <div class="text-4xl mb-4">üöõ</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Truck Management</h3>
                <p class="text-gray-600">Monitor real-time truck work_status and manage fleet operations.</p>
              </div>
              
              <!-- System Overview -->
              <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
                <div class="text-4xl mb-4">‚öôÔ∏è</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">System Overview</h3>
                <p class="text-gray-600">Comprehensive dashboard for monitoring and controlling operations.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ÌíÄÏä§ÌÅ¨Î¶∞ ÌÜ†Í∏Ä Ìï®Ïàò
    function toggleFullscreen() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      const fullscreenText = document.getElementById('fullscreenText');
      
      if (sidebar && mainContent && fullscreenBtn && fullscreenText) {
        if (sidebar.classList.contains('sidebar-hidden')) {
          // ÏÇ¨Ïù¥ÎìúÎ∞î ÌëúÏãú (ÏùºÎ∞ò Î™®Îìú)
          sidebar.classList.remove('sidebar-hidden');
          mainContent.classList.remove('main-content-fullscreen');
          fullscreenText.textContent = 'üñ•Ô∏è FULLSCREEN';
          fullscreenBtn.className = 'bg-red-500 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg';
          fullscreenBtn.style.position = 'absolute';
          fullscreenBtn.style.top = '0';
          fullscreenBtn.style.right = '0';
        } else {
          // ÏÇ¨Ïù¥ÎìúÎ∞î Ïà®ÍπÄ (Ï†ÑÏ≤¥ ÌôîÎ©¥ Î™®Îìú)
          sidebar.classList.add('sidebar-hidden');
          mainContent.classList.add('main-content-fullscreen');
          fullscreenText.textContent = '‚ùå EXIT FULLSCREEN';
          fullscreenBtn.className = 'bg-green-500 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg';
          fullscreenBtn.style.position = 'fixed';
          fullscreenBtn.style.top = '20px';
          fullscreenBtn.style.right = '20px';
          fullscreenBtn.style.zIndex = '9999';
        }
      }
    }

    // ÌéòÏù¥ÏßÄ Î°úÎî© ÏôÑÎ£å ÌõÑ Ï¥àÍ∏∞Ìôî
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ TM System Ï¥àÍ∏∞Ìôî ÏãúÏûë');
      
      // ÏÇ¨Ïù¥ÎìúÎ∞î ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      if (sidebar && mainContent) {
        sidebar.style.display = 'block';
        mainContent.style.marginLeft = '256px';
        mainContent.style.width = 'calc(100% - 256px)';
      }
      
      // Supabase ÏÑ§Ï†ï
      const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
      
      // Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ± (Ìïú Î≤àÎßå)
      let sb = null;
      if (typeof supabase !== 'undefined') {
        try {
          sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
              autoRefreshToken: true,    // ÌÜ†ÌÅ∞ ÏûêÎèô Í∞±Ïã†
              persistSession: true       // ÏÑ∏ÏÖò ÏßÄÏÜç
            }
          });
        window.sb = sb;
          window.supabase = sb;
        console.log('‚úÖ Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ± ÏôÑÎ£å');
        } catch (error) {
          console.error('‚ùå Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ± Ïã§Ìå®:', error);
        }
      } else {
        console.warn('‚ö†Ô∏è Supabase ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§');
      }
      
             // Í≥µÎ∞± ÏãúÍ∞Ñ Ï∂îÍ∞Ä Î™®Îã¨ Ïó¥Í∏∞
             function addGapRow() {
               const gaps = detectTimeGaps();
               if (gaps.length === 0) {
                 console.warn('‚ö†Ô∏è Í∞êÏßÄÎêú Í≥µÎ∞±Ïù¥ ÏóÜÏäµÎãàÎã§.');
                 alert('Í∞êÏßÄÎêú Í≥µÎ∞±Ïù¥ ÏóÜÏäµÎãàÎã§. ÏãúÍ∞Ñ Í∞ÑÍ≤©Ïù¥ ÏûàÎäî Ïä§ÏºÄÏ§ÑÏùÑ Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                 return;
               }
               
               // Ï≤´ Î≤àÏß∏ Í≥µÎ∞±ÏùÑ Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
               const firstGap = gaps[0];
               const modal = document.getElementById('gapTimeModal');
               const startTimeInput = document.getElementById('gapStartTime');
               const endTimeInput = document.getElementById('gapEndTime');
               const gapInfo = document.getElementById('detectedGapInfo');
               
               // Í∞êÏßÄÎêú Í≥µÎ∞± Ï†ïÎ≥¥ ÌëúÏãú
               gapInfo.textContent = `${firstGap.startTime} ~ ${firstGap.endTime} (${firstGap.duration}Î∂Ñ)`;
               
               // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
               startTimeInput.value = firstGap.startTime;
               endTimeInput.value = firstGap.endTime;
               document.getElementById('gapRemarks').value = '';
               
               modal.classList.remove('hidden');
               modal.classList.add('flex');
             }
             
             // Í≥µÎ∞± ÏãúÍ∞Ñ Ï∂îÍ∞Ä Î™®Îã¨ Îã´Í∏∞
             function closeGapTimeModal() {
               const modal = document.getElementById('gapTimeModal');
               modal.classList.add('hidden');
               modal.classList.remove('flex');
             }
             
             // Í≥µÎ∞± ÏãúÍ∞Ñ Ï†ÄÏû•
             async function saveGapTime() {
               const startTime = document.getElementById('gapStartTime').value;
               const endTime = document.getElementById('gapEndTime').value;
               const remarks = document.getElementById('gapRemarks').value;
               
               if (!startTime || !endTime) {
                 alert('ÏãúÏûë ÏãúÍ∞ÑÍ≥º Ï¢ÖÎ£å ÏãúÍ∞ÑÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                 return;
               }
               
               // ÏãúÍ∞Ñ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
               if (startTime >= endTime) {
                 alert('Ï¢ÖÎ£å ÏãúÍ∞ÑÏùÄ ÏãúÏûë ÏãúÍ∞ÑÎ≥¥Îã§ Îä¶Ïñ¥Ïïº Ìï©ÎãàÎã§.');
                 return;
               }
               
               // ÏÉàÎ°úÏö¥ Í≥µÎ∞± Ìñâ ÏÉùÏÑ±
               const maxSeq = Math.max(0, ...window.adminScheduleData.map(item => item.seq_no || 0));
               const newGapRow = {
                 seq_no: maxSeq + 1,
                 part_no: 'GAP', // Í≥µÎ∞± ÌëúÏãú
                 work_start_time: startTime,
                 work_end_time: endTime,
                 work_status: 'gap', // Í≥µÎ∞± ÏÉÅÌÉú
                 remarks: remarks || 'Í≥µÎ∞± ÏãúÍ∞Ñ',
                 work_date: window.adminSelectedDate,
                 created_at: new Date().toISOString()
               };
               
               try {
                 // SupabaseÏóê Ï†ÄÏû•
                 const { data, error } = await window.supabase
                   .from('tm_packaging_schedule')
                   .insert([newGapRow])
                   .select();
                 
                 if (error) throw error;
                 
                 // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                 window.adminScheduleData.push(newGapRow);
                 
                 console.log('‚úÖ Gap time added successfully:', newGapRow);
                 
                 // ÌÖåÏù¥Î∏î ÏÉàÎ°úÍ≥†Ïπ®
                 renderAdminTable();
                 updateAdminStatistics();
                 
                 closeGapTimeModal();
                 
               } catch (error) {
                 console.error('‚ùå Error adding gap time:', error);
                 alert('Í≥µÎ∞± ÏãúÍ∞Ñ Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
               }
             }
             
             // Ï†ÑÏó≠ Ìï®Ïàò Îì±Î°ù
             window.loadPage = loadPage;
             window.openStatusInNewTab = openStatusInNewTab;
             window.zoomIn = zoomIn;
             window.zoomOut = zoomOut;
             window.toggleSidebar = toggleSidebar;
             window.toggleFullscreenMode = toggleFullscreenMode;
             window.addGapRow = addGapRow;
             window.closeGapTimeModal = closeGapTimeModal;
             window.saveGapTime = saveGapTime;
      
      console.log('‚úÖ TM System Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
    });

             // Í∞ÑÎã®Ìïú ÌéòÏù¥ÏßÄ Î°úÎçî
             function loadPage(path) {
               console.log('Loading page:', path);
               
               // ÏÇ¨Ïù¥ÎìúÎ∞î Î≥µÏõê (Live DisplayÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞)
               if (path !== 'pages/schedule/display.html') {
                 document.getElementById('sidebar').style.display = 'block';
                 document.getElementById('mainContent').style.marginLeft = '256px';
                 document.getElementById('mainContent').style.width = 'calc(100% - 256px)';
               }
               
               // ÌéòÏù¥ÏßÄ Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
               const pageTitle = document.getElementById('pageTitle');
               if (pageTitle) {
                 if (path.includes('upload.html')) {
                   pageTitle.textContent = 'Excel Upload';
                 } else if (path.includes('analysis-new.html')) {
                   pageTitle.textContent = 'Shipping Plan Analysis';
                 } else if (path.includes('packaging-analysis-fixed.html')) {
                   pageTitle.textContent = 'Packaging Analysis';
                 } else if (path.includes('truck/status.html')) {
                   pageTitle.textContent = 'Truck Status';
                 } else if (path.includes('management.html')) {
                   pageTitle.textContent = 'Truck Management';
                 } else if (path.includes('schedule/display.html')) {
                   pageTitle.textContent = 'Packaging Schedule - Live Display';
                 } else if (path.includes('schedule/admin.html')) {
                   pageTitle.textContent = 'Packaging Schedule - Admin';
                 } else if (path.includes('schedule/supervisor.html')) {
                   pageTitle.textContent = 'Packaging Schedule - Supervisor';
                 } else {
                   pageTitle.textContent = 'TM System';
                 }
               }
               
               // ÌéòÏù¥ÏßÄ ÎÇ¥Ïö©ÏùÑ ÏßÅÏ†ë ÌëúÏãú
               if (path === 'pages/fifo/upload.html') {
                 document.getElementById('mainContent').innerHTML = `
                   <div class="bg-white rounded-lg shadow-md p-8">
                     <h2 class="text-2xl font-bold text-gray-800 mb-6">Excel Upload</h2>
                     <div class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center">
                       <div class="text-4xl mb-4">üì§</div>
                       <h3 class="text-xl font-semibold text-gray-700 mb-2">Excel ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</h3>
                       <p class="text-gray-600 mb-4">.xlsx ÎòêÎäî .xls ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                       <input type="file" id="fileInput" accept=".xlsx,.xls" class="mb-4 block mx-auto" />
                       <button onclick="handleFileUpload()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">ÏóÖÎ°úÎìú</button>
                     </div>
                     <div id="uploadStatus" class="mt-4"></div>
                     <div id="dataTable" class="mt-6"></div>
                   </div>
                 `;
               } else if (path === 'pages/analysis-new.html') {
                 document.getElementById('mainContent').innerHTML = `
                   <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                     <!-- Header -->
                     <div class="mb-8">
                         <h2 class="text-2xl font-bold text-gray-900 mb-2">Advanced Part No Analysis</h2>
                         <p class="text-gray-600">Advanced pallet analysis with separate Excel sheets for shipping planning</p>
                     </div>

                     <!-- Filter Panel -->
                     <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                         <h3 class="text-lg font-semibold text-gray-900 mb-4">Search Filters</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                             <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                                 <select id="locationFilter" 
                                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                     <option value="">All</option>
                                     <option value="F100">F100</option>
                                     <option value="F101" selected>F101</option>
                                 </select>
                             </div>
                             <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-2">Part No</label>
                                 <select id="partNoFilter" 
                                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                     <option value="">All</option>
                                     <option value="" disabled>Loading...</option>
                                 </select>
                                 <p id="partNoStatus" class="text-xs text-gray-500 mt-1">Loading part numbers...</p>
                             </div>
                             <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-2">Hold Whether</label>
                                 <select id="holdWhetherFilter" 
                                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                     <option value="">All</option>
                                     <option value="Y">Y</option>
                                     <option value="N" selected>N</option>
                                 </select>
                             </div>
                             <div class="flex items-end space-x-2">
                                 <button id="applyFilterBtn" 
                                         class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                     Apply Filter
                                 </button>
                                 <button id="resetFilterBtn" 
                                         class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                     Reset
                                 </button>
                             </div>
                             <div class="col-span-4 mt-2">
                                 <p id="filterStatus" class="text-xs text-gray-500">No filters applied</p>
                             </div>
                         </div>
                     </div>

                     <!-- Summary Cards -->
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">8+ Pallets Summary</h3>
                             <div id="summary8" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">Under 8 Pallets Summary</h3>
                             <div id="summary7" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                     </div>

                     <!-- Data Table -->
                     <div class="bg-white rounded-lg shadow-sm border">
                         <div class="px-6 py-4 border-b border-gray-200">
                             <div class="flex justify-between items-center">
                                 <div>
                                     <h3 class="text-lg font-semibold text-gray-900">Analysis Results</h3>
                                     <p id="resultCount" class="text-sm text-gray-500 mt-1">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</p>
                                 </div>
                                 <div class="flex items-center space-x-4">
                                     <div class="flex space-x-2">
                                         <button id="exportExcelBtn" 
                                                 class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                             üìä Export to Excel
                                         </button>
                                         <button id="refreshDataBtn" 
                                                 class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                             üîÑ Refresh Data
                                         </button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="overflow-x-auto">
                             <div class="mb-4 text-sm text-gray-600">
                                 <span id="analysisDataInfo">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</span>
                             </div>
                             <table class="min-w-full divide-y divide-gray-200">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('palletNo')">
                                             Pallet No
                                             <span id="sort-palletNo" class="ml-1">‚Üï</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('rackNo')">
                                             Rack No
                                             <span id="sort-rackNo" class="ml-1">‚Üï</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('dataCount')">
                                             Data Count
                                             <span id="sort-dataCount" class="ml-1">‚Üï</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('tmCount')">
                                             TM Count
                                             <span id="sort-tmCount" class="ml-1">‚Üï</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('partNoList')">
                                             Part No List
                                             <span id="sort-partNoList" class="ml-1">‚Üï</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('earliestDate')">
                                             Earliest Date
                                             <span id="sort-earliestDate" class="ml-1">‚Üï</span>
                                         </th>
                                     </tr>
                                 </thead>
                                 <tbody id="resultsTable" class="bg-white divide-y divide-gray-200">
                                     <tr>
                                         <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                             Îç∞Ïù¥ÌÑ∞Î•º Î°úÎî© Ï§ëÏûÖÎãàÎã§... Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.
                                         </td>
                                     </tr>
                                 </tbody>
                             </table>
                         </div>
                     </div>

                     <!-- Loading State -->
                     <div id="loadingState" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                         <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                             <div class="mt-3 text-center">
                                 <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                                     <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                     </svg>
                                 </div>
                                 <h3 class="text-lg font-medium text-gray-900 mt-4">Loading Data...</h3>
                                 <p class="text-sm text-gray-500 mt-2">Loading all data from database...</p>
                                 <p id="loadingProgress" class="text-xs text-blue-600 mt-1">Please wait...</p>
                             </div>
                         </div>
                     </div>
                   </div>
                 `;
                 
                 // Analysis ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
                 setTimeout(() => {
                   initializeAnalysisPage();
                 }, 100);
               } else if (path === 'pages/packaging-analysis-fixed.html') {
                 document.getElementById('mainContent').innerHTML = `
                   <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                     <!-- Header -->
                     <div class="mb-8">
                         <h2 class="text-2xl font-bold text-gray-900 mb-2">Packaging Analysis</h2>
                         <p class="text-gray-600">Location-based packaging analysis with RACK NO pattern recognition (Hold Whether 'N' required)</p>
                         <div class="mt-2 text-sm text-gray-500">
                             <p><strong>Before Packaging:</strong> LHSAB, LHSBA, LHSAA, LHSBB</p>
                             <p><strong>After Packaging:</strong> LHSAC, LHSAD, LHSBC, LHSBD</p>
                             <p><strong>No Rack No:</strong> RACK NOÍ∞Ä ÏóÜÎäî ÌåîÎ†àÌä∏</p>
                             <p class="text-blue-600"><strong>Note:</strong> Only records with Hold Whether = 'N' are included in analysis</p>
                         </div>
                     </div>

                     <!-- Filter Panel -->
                     <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                         <h3 class="text-lg font-semibold text-gray-900 mb-4">Search Filters</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                             <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-2">Part No</label>
                                 <select id="packagingPartNoFilter" 
                                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                     <option value="">All</option>
                                     <option value="" disabled>Loading...</option>
                                 </select>
                                 <p id="packagingPartNoStatus" class="text-xs text-gray-500 mt-1">Loading part numbers...</p>
                             </div>
                             <div class="flex items-end space-x-2">
                                 <button id="packagingApplyFilterBtn" 
                                         class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                     Apply Filter
                                 </button>
                                 <button id="packagingResetFilterBtn" 
                                         class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                     Reset
                                 </button>
                             </div>
                             <div class="col-span-3 mt-2">
                                 <p id="packagingFilterStatus" class="text-xs text-gray-500">Fixed filters: Location=F101, Hold Whether=N, RACK NO required (Part No only searchable)</p>
                             </div>
                         </div>
                     </div>

                     <!-- Summary Cards -->
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">Total TM</h3>
                             <div id="packagingTotalPallets" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">Before Packaging TM</h3>
                             <div id="packagingBeforePallets" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">After Packaging TM</h3>
                             <div id="packagingAfterPallets" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">No Rack No TM</h3>
                             <div id="packagingNoRackPallets" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">Packaging Rate</h3>
                             <div id="packagingRate" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                     </div>

                     <!-- Data Table -->
                     <div class="bg-white rounded-lg shadow-sm border">
                         <div class="px-6 py-4 border-b border-gray-200">
                             <div class="flex justify-between items-center">
                                 <div>
                                     <h3 class="text-lg font-semibold text-gray-900">Packaging Analysis Results</h3>
                                     <p id="packagingResultCount" class="text-sm text-gray-500 mt-1">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</p>
                                 </div>
                                 <div class="flex items-center space-x-4">
                                     <div class="flex space-x-2">
                                         <button id="packagingExportExcelBtn" 
                                                 class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                             üìä Export to Excel
                                         </button>
                                         <button id="packagingRefreshDataBtn" 
                                                 class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                             üîÑ Refresh Data
                                         </button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="overflow-x-auto">
                             <div class="mb-4 text-sm text-gray-600">
                                 <span id="packagingDataInfo">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</span>
                             </div>
                             <table class="min-w-full divide-y divide-gray-200">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('palletNo')">
                                             Pallet No
                                             <span id="packaging-sort-palletNo" class="ml-1">‚Üï</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('rackNo')">
                                             Rack No
                                             <span id="packaging-sort-rackNo" class="ml-1">‚Üï</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('partNo')">
                                             Part No
                                             <span id="packaging-sort-partNo" class="ml-1">‚Üï</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('tmCount')">
                                             TM Count
                                             <span id="packaging-sort-tmCount" class="ml-1">‚Üï</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('packagingStatus')">
                                             Packaging Status
                                             <span id="packaging-sort-packagingStatus" class="ml-1">‚Üï</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('location')">
                                             Location
                                             <span id="packaging-sort-location" class="ml-1">‚Üï</span>
                                         </th>
                                     </tr>
                                 </thead>
                                 <tbody id="packagingResultsTable" class="bg-white divide-y divide-gray-200">
                                     <tr>
                                         <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                             Îç∞Ïù¥ÌÑ∞Î•º Î°úÎî© Ï§ëÏûÖÎãàÎã§... Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.
                                         </td>
                                     </tr>
                                 </tbody>
                             </table>
                         </div>
                     </div>

                     <!-- Loading State -->
                     <div id="packagingLoadingState" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                         <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                             <div class="mt-3 text-center">
                                 <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                                     <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                     </svg>
                                 </div>
                                 <h3 class="text-lg font-medium text-gray-900 mt-4">Loading Data...</h3>
                                 <p class="text-sm text-gray-500 mt-2">Loading all data from database...</p>
                                 <p id="packagingLoadingProgress" class="text-xs text-blue-600 mt-1">Please wait...</p>
                             </div>
                         </div>
                     </div>
                   </div>
                 `;
                 
                 // Packaging ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
                 setTimeout(() => {
                   initializePackagingPage();
                 }, 100);
               } else if (path === 'pages/truck/status.html') {
                 // Truck Status ÌéòÏù¥ÏßÄÎ•º iframeÏúºÎ°ú Î°úÎìú
                 document.getElementById('mainContent').innerHTML = `
                   <div class="w-full h-screen">
                     <iframe src="${path}" class="w-full h-full border-0" frameborder="0"></iframe>
                   </div>
                 `;
               } else if (path === 'pages/truck/management.html') {
                 // Truck Management ÌéòÏù¥ÏßÄÎ•º iframeÏúºÎ°ú Î°úÎìú
                 document.getElementById('mainContent').innerHTML = `
                   <div class="w-full h-screen">
                     <iframe src="${path}" class="w-full h-full border-0" frameborder="0"></iframe>
                   </div>
                 `;
              } else if (path === 'pages/schedule/display.html') {
                // Live Display ÌéòÏù¥ÏßÄ - ÏÇ¨Ïù¥ÎìúÎ∞î Ïà®Í∏∞Í≥† Ï†ÑÏ≤¥ ÌôîÎ©¥ÏúºÎ°ú ÌëúÏãú
                document.getElementById('sidebar').style.display = 'none';
                document.getElementById('mainContent').style.marginLeft = '0';
                document.getElementById('mainContent').style.width = '100%';
                
                document.getElementById('mainContent').innerHTML = `
                  <div class="h-screen p-4 bg-gray-900 text-white overflow-hidden">
                    <!-- Header -->
                    <div class="text-center mb-4 relative">
                      <h2 class="text-3xl font-semibold text-blue-300 mb-1">PACKAGING SCHEDULE STATUS</h2>
                      <div class="text-lg font-bold text-yellow-300 mb-2" id="displayDate">-</div>
                      <button onclick="toggleFullscreen()" id="fullscreenBtn" class="absolute top-0 right-0 bg-red-500 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg">
                        <span id="fullscreenText">üñ•Ô∏è FULLSCREEN</span>
                      </button>
                    </div>

                    <!-- Current Status Card -->
                    <div class="bg-gray-800 rounded-xl shadow-xl p-6 mb-4">
                      <div class="text-center">
                        <h3 class="text-3xl font-bold mb-6 text-green-300">CURRENT PROGRESS</h3>
                        <div class="grid grid-cols-3 gap-6">
                          <!-- Current NO -->
                          <div class="bg-gray-700 rounded-lg p-6 border-2 border-gray-600 flex items-center justify-center">
                            <div class="text-8xl font-bold text-yellow-300" id="currentId">-</div>
                          </div>
                          
                          <!-- Current Part -->
                          <div class="bg-gray-700 rounded-lg p-6 border-2 border-gray-600 flex items-center justify-center">
                            <div class="text-8xl font-bold text-blue-300" id="currentPart">-</div>
                          </div>
                          
                          <!-- Elapsed Time -->
                          <div class="bg-gray-700 rounded-lg p-6 border-2 border-gray-600 flex items-center justify-center">
                            <div class="text-8xl font-bold text-red-300 timer-display" id="elapsedTime">00:00:00</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Today's Schedule -->
                    <div class="bg-gray-800 rounded-xl shadow-xl p-4 border border-gray-600 flex-1 overflow-hidden">
                      <h3 class="text-xl font-bold mb-3 text-center text-blue-300">TODAY'S SCHEDULE</h3>
                      <div class="h-full overflow-y-auto" id="scheduleList">
                        <!-- Schedule items will be populated here -->
                      </div>
                    </div>
                  </div>
                `;
                
                // Live Display ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
                console.log('üì∫ Live Display page HTML loaded, scheduling initialization...');
                setTimeout(() => {
                  console.log('‚è∞ Live Display page initialization timeout triggered');
                  initializeDisplayPage();
                }, 100);
               } else if (path === 'pages/schedule/admin.html') {
                 // Admin ÌéòÏù¥ÏßÄ - Ïù∏ÎùºÏù∏ÏúºÎ°ú Íµ¨ÌòÑ
                 document.getElementById('mainContent').innerHTML = `
                   <div class="h-screen flex flex-col p-4">
                     <!-- Header -->
                     <div class="bg-white rounded-lg shadow-sm border p-4 mb-4">
                       <div class="flex justify-between items-center">
                         <div>
                           <h1 class="text-2xl font-bold text-gray-900">Ìè¨Ïû• Ïä§ÏºÄÏ§Ñ Í¥ÄÎ¶¨</h1>
                           <p class="text-gray-600 text-sm">Packaging Schedule Administration</p>
                         </div>
                         <div class="flex space-x-2">
                           <button onclick="refreshData()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                             üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                           </button>
                           <button id="adminAutoRefreshBtn" onclick="toggleAdminAutoRefresh()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                             üîÑ AUTO: ON
                           </button>
                         </div>
                       </div>
                     </div>

                     <!-- Date Selector and Statistics -->
                     <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
                       <!-- Date Selector -->
                       <div class="bg-white rounded-lg shadow-sm border p-4">
                         <div class="space-y-2">
                           <label class="text-sm font-semibold text-gray-700">ÎÇ†Ïßú ÏÑ†ÌÉù</label>
                           <div class="flex space-x-2">
                             <input type="date" id="dateSelector" class="border border-gray-300 rounded-lg px-3 py-2 text-sm flex-1" onchange="loadScheduleForDate()">
                             <button onclick="loadTodaySchedule()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-semibold">
                               Ïò§Îäò
                             </button>
                           </div>
                         </div>
                       </div>

                       <!-- Statistics Cards -->
                       <div class="bg-white rounded-lg shadow-sm border p-4">
                         <div class="text-2xl font-bold text-blue-600" id="totalRounds">0</div>
                         <div class="text-sm text-gray-600">Ï¥ù Ï∞®Ïàò</div>
                       </div>
                       <div class="bg-white rounded-lg shadow-sm border p-4">
                         <div class="text-2xl font-bold text-green-600" id="completedRounds">0</div>
                         <div class="text-sm text-gray-600">ÏôÑÎ£åÎêú Ï∞®Ïàò</div>
                       </div>
                       <div class="bg-white rounded-lg shadow-sm border p-4">
                         <div class="text-2xl font-bold text-yellow-600" id="activeRounds">0</div>
                         <div class="text-sm text-gray-600">ÏßÑÌñâ Ï§ëÏù∏ Ï∞®Ïàò</div>
                       </div>
                     </div>

                     <!-- Schedule Management -->
                     <div class="bg-white rounded-lg shadow-sm border flex-1 flex flex-col">
                       <div class="p-4 border-b border-gray-200">
                         <div class="flex justify-between items-center">
                           <div>
                             <h2 class="text-xl font-bold text-gray-900">Ïä§ÏºÄÏ§Ñ Ìé∏Ïßë ÌÖåÏù¥Î∏î</h2>
                             <p class="text-gray-600 text-sm">Ï∞®ÏàòÎ≥Ñ ÌååÌä∏ Ïä§ÏºÄÏ§ÑÏùÑ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî</p>
                           </div>
                           <div class="flex space-x-2">
                             <button onclick="addNewRow()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-semibold">
                               + Ìñâ Ï∂îÍ∞Ä
                             </button>
                             <button onclick="addGapRow()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-semibold">
                               ‚è∞ Îπà ÏãúÍ∞Ñ Ï∂îÍ∞Ä
                             </button>
                             <button onclick="loadScheduleToTable()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm font-semibold">
                               üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                             </button>
                             <div class="flex items-center text-sm text-gray-600">
                               <span class="mr-2">üíæ</span>
                               <span>ÏûêÎèô Ï†ÄÏû•</span>
                             </div>
                           </div>
                         </div>
                       </div>
                       
                       <div class="flex-1 p-4">
                         <div id="scheduleTable" class="h-full border border-gray-300 rounded-lg">
                           <div class="flex items-center justify-center h-full text-gray-500">
                             <div class="text-center">
                               <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                               <p>ÌÖåÏù¥Î∏î Î°úÎî© Ï§ë...</p>
                             </div>
                           </div>
                         </div>
                       </div>
                     </div>

                     <!-- ÏãúÍ∞Ñ ÏàòÏ†ï Î™®Îã¨ -->
                     <div id="timeEditModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                       <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                         <h3 class="text-xl font-bold text-gray-900 mb-4">ÏãúÍ∞Ñ ÏàòÏ†ï</h3>
                         <div class="space-y-4">
                           <div>
                             <label class="block text-sm font-medium text-gray-700 mb-2">ÏãúÏûë ÏãúÍ∞Ñ</label>
                             <input type="time" id="editStartTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                           </div>
                           <div>
                             <label class="block text-sm font-medium text-gray-700 mb-2">Ï¢ÖÎ£å ÏãúÍ∞Ñ</label>
                             <input type="time" id="editEndTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                           </div>
                         </div>
                         <div class="flex justify-end space-x-2 mt-6">
                           <button onclick="closeTimeEditModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Ï∑®ÏÜå</button>
                           <button onclick="saveTimeEdit()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ï†ÄÏû•</button>
                         </div>
                       </div>
                     </div>

                     <!-- Í≥µÎ∞± ÏãúÍ∞Ñ Ï∂îÍ∞Ä Î™®Îã¨ -->
                     <div id="gapTimeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                       <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                         <h3 class="text-xl font-bold text-gray-900 mb-4">Í≥µÎ∞± ÏãúÍ∞Ñ Ï∂îÍ∞Ä</h3>
                         <div class="space-y-4">
                           <div class="bg-blue-50 p-3 rounded-lg">
                             <p class="text-sm text-blue-800">
                               <strong>Í∞êÏßÄÎêú Í≥µÎ∞±:</strong> <span id="detectedGapInfo">-</span>
                             </p>
                           </div>
                           <div>
                             <label class="block text-sm font-medium text-gray-700 mb-2">ÏãúÏûë ÏãúÍ∞Ñ</label>
                             <input type="time" id="gapStartTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                           </div>
                           <div>
                             <label class="block text-sm font-medium text-gray-700 mb-2">Ï¢ÖÎ£å ÏãúÍ∞Ñ</label>
                             <input type="time" id="gapEndTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                           </div>
                           <div>
                             <label class="block text-sm font-medium text-gray-700 mb-2">ÎπÑÍ≥† (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                             <input type="text" id="gapRemarks" placeholder="Ïòà: Ìú¥Ïãù, Ï†êÍ≤Ä, ÎåÄÍ∏∞, Ï§ÄÎπÑ Îì±" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                           </div>
                           <div class="flex justify-end space-x-2">
                             <button onclick="closeGapTimeModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                               Ï∑®ÏÜå
                             </button>
                             <button onclick="saveGapTime()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                               Ï∂îÍ∞Ä
                             </button>
                           </div>
                         </div>
                       </div>
                     </div>

                     <!-- Hidden schedule container for compatibility -->
                     <div id="scheduleContainer" style="display: none;"></div>
                   </div>
                 `;
                 
                 // Admin ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî (DOMÏù¥ ÏôÑÏ†ÑÌûà Î°úÎìúÎêú ÌõÑ Ïã§Ìñâ)
                 console.log('üìã Admin page HTML loaded, scheduling initialization...');
                 setTimeout(() => {
                   console.log('‚è∞ Admin page initialization timeout triggered');
                   initializeAdminPage();
                 }, 100);
               } else if (path === 'pages/schedule/supervisor.html') {
                 // Supervisor ÌéòÏù¥ÏßÄ - Ïù∏ÎùºÏù∏ÏúºÎ°ú Íµ¨ÌòÑ (24Ïù∏Ïπò Î™®ÎãàÌÑ∞Ïö© ÎåÄÌòï ÌôîÎ©¥)
                 document.getElementById('mainContent').innerHTML = `
                   <div class="h-screen flex flex-col p-3 bg-gray-50 overflow-y-auto" style="transform: scaleY(1.5); transform-origin: top left; width: 100%; max-width: 100vw;">
                     <!-- Header -->
                     <div class="bg-white rounded-lg shadow-sm border p-4 mb-3">
                       <div class="flex justify-between items-center">
                         <div>
                           <h1 class="text-2xl font-bold text-gray-900" id="supervisorTitle">Packaging Work Management</h1>
                           <p class="text-gray-600 text-base" id="supervisorSubtitle">Supervisor Control Panel</p>
                         </div>
                         <div class="flex items-center space-x-6">
                           <!-- Language Selector -->
                           <div class="flex space-x-2">
                             <button onclick="setSupervisorLanguage('en')" id="langEn" class="px-4 py-2 text-sm font-semibold rounded bg-gray-100 text-gray-600 border border-gray-300">EN</button>
                             <button onclick="setSupervisorLanguage('es')" id="langEs" class="px-4 py-2 text-sm font-semibold rounded bg-blue-100 text-blue-800 border border-blue-300">ES</button>
                           </div>
                           <div class="text-right">
                             <div class="text-sm text-gray-500" id="currentTimeLabel">Current Time</div>
                             <div class="text-2xl font-bold text-blue-600" id="currentTime">00:00:00</div>
                           </div>
                           <button onclick="refreshSupervisorData()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded text-lg font-semibold">
                             üîÑ
                           </button>
                           <button id="supervisorAutoRefreshBtn" onclick="toggleSupervisorAutoRefresh()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded text-lg font-semibold">
                             üîÑ AUTO: ON
                           </button>
                           
                           <!-- Zoom Controls -->
                           <div class="flex items-center space-x-2">
                             <button onclick="zoomOut()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-lg font-semibold" title="Zoom Out">
                               ‚ûñ
                             </button>
                             <span id="zoomLevel" class="text-sm font-bold text-gray-700 min-w-[60px] text-center">110%</span>
                             <button onclick="zoomIn()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-lg font-semibold" title="Zoom In">
                               ‚ûï
                           </button>
                       </div>
                       </div>
                       </div>
                     </div>

        <!-- Current Work Dashboard -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-xl shadow-xl p-6 mb-3 text-white">
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Current Work -->
            <div class="lg:col-span-3">
              <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-2 text-3xl">‚ö°</span>
                <span id="currentWorkTitle">Current Work</span>
                         </h2>
              <div class="bg-white bg-opacity-25 rounded-xl p-4">
                <div class="grid grid-cols-4 gap-4">
                  <div class="text-center">
                    <div class="text-sm opacity-90 mb-1 font-semibold" id="currentIdLabel">Task ID</div>
                    <div class="text-3xl font-bold" id="currentRound">-</div>
                         </div>
                  <div class="text-center">
                    <div class="text-sm opacity-90 mb-1 font-semibold" id="currentPartLabel">Part Number</div>
                    <div class="text-3xl font-bold" id="currentPart">-</div>
                       </div>
                  <div class="text-center">
                    <div class="text-sm opacity-90 mb-1 font-semibold" id="elapsedTimeLabel">Elapsed Time</div>
                    <div class="text-3xl font-bold text-yellow-300 timer-display" id="elapsedTime">00:00:00</div>
                             </div>
                  <div class="text-center">
                    <div class="text-sm opacity-90 mb-1 font-semibold" id="todayDateLabel">Today's Date</div>
                    <div class="text-lg font-bold" id="todayDate">-</div>
                             </div>
                           </div>
                           
                           <!-- Control Buttons -->
                <div class="mt-4 flex justify-center space-x-3">
                                 <button id="startWorkBtn" onclick="startSelectedWork()" 
                          class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-lg transition-all disabled:bg-gray-400 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:scale-105">
                                   <span id="startWorkText">üöÄ Start Work</span>
                                 </button>
                                 <button id="cancelWorkBtn" onclick="cancelSelectedWork()" 
                          class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-bold text-lg transition-all disabled:bg-gray-400 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:scale-105">
                    <span id="cancelWorkText">‚ùå Cancel</span>
                                 </button>
                                 <button id="endWorkBtn" onclick="endSelectedWork()" 
                          class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold text-lg transition-all disabled:bg-gray-400 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:scale-105">
                                   <span id="endWorkText">‚èπÔ∏è End Work</span>
                                 </button>
                               </div>
                             </div>
                             </div>
                         
                         <!-- Next Work Preview -->
                         <div>
                           <h2 class="text-xl font-bold mb-4 flex items-center">
                             <span class="mr-2 text-2xl">‚è≠Ô∏è</span>
                             <span id="nextWorkTitle">Next Work</span>
                           </h2>
                           <div class="bg-white bg-opacity-25 rounded-xl p-4">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-3" id="nextWorkPreview">
                               <div class="text-center text-gray-300 text-sm" id="noNextWork">No upcoming work</div>
                             </div>
                             </div>
                           </div>
                         </div>
                       </div>

                     <!-- Main Content -->
                     <div class="flex-1 flex flex-col">
                       <!-- ID Selection -->
                       <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-md border-2 border-blue-200 p-3 mb-3">
                         <h2 class="text-base font-bold text-blue-800 mb-2 flex items-center" id="idSelectionTitle">
                           <span class="mr-1">üéØ</span>
                           Task ID Selection
                         </h2>
                         <div class="grid grid-cols-8 md:grid-cols-10 lg:grid-cols-12 xl:grid-cols-16 gap-1" id="idSelector">
                           <!-- ID buttons will be populated here -->
                         </div>
                       </div>


                       <!-- Part Summary Dashboard -->
                       <div class="bg-white rounded-lg shadow-sm border flex-1 flex flex-col">
                         <div class="p-3 border-b border-gray-200">
                           <h2 class="text-base font-bold text-gray-900" id="partSummaryTitle">Part Summary</h2>
                           <p class="text-xs text-gray-600 mt-1">Remaining work by part number</p>
                         </div>
                         <div class="flex-1 p-3">
                           <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-2" id="partSummaryGrid">
                             <!-- Part summary cards will be populated here -->
                           </div>
                         </div>
                       </div>
                     </div>
                   </div>
                 `;
                 
                 // Supervisor ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
                 console.log('üë®‚Äçüíº Supervisor page HTML loaded, scheduling initialization...');
                 setTimeout(() => {
                   console.log('‚è∞ Supervisor page initialization timeout triggered');
                   initializeSupervisorPage();
                 }, 100);
               } else {
                 document.getElementById('mainContent').innerHTML = `
                   <div class="text-center p-8">
                     <h2 class="text-2xl font-bold text-gray-600 mb-4">ÌéòÏù¥ÏßÄ Ï§ÄÎπÑ Ï§ë</h2>
                     <p class="text-gray-500">${path} ÌéòÏù¥ÏßÄÍ∞Ä Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.</p>
                   </div>
                 `;
               }
             }

             // Analysis ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
             function initializeAnalysisPage() {
               console.log('üîß Initializing Analysis page...');
               
               // Ï†ÑÏó≠ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
               window.allData = [];
               window.filteredData = [];
               window.currentSortColumn = 'palletNo';
               window.currentSortDirection = 'asc';
               window.lastAnalysisResults = [];
               
               // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
               const refreshBtn = document.getElementById('refreshDataBtn');
               if (refreshBtn) {
                 refreshBtn.onclick = loadAnalysisData;
               }
               
               const applyBtn = document.getElementById('applyFilterBtn');
               if (applyBtn) {
                 applyBtn.onclick = applyAnalysisFilter;
               }
               
               const resetBtn = document.getElementById('resetFilterBtn');
               if (resetBtn) {
                 resetBtn.onclick = resetAnalysisFilter;
               }
               
               const exportBtn = document.getElementById('exportExcelBtn');
               if (exportBtn) {
                 exportBtn.onclick = exportAnalysisData;
               }
               
               // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
               loadAnalysisData();
             }
             
             // Analysis Îç∞Ïù¥ÌÑ∞ Î°úÎìú
             function loadAnalysisData() {
               console.log('üîÑ Loading Analysis data...');
               
               // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
               const loadingState = document.getElementById('loadingState');
               if (loadingState) {
                 loadingState.classList.remove('hidden');
               }
               
               // SupabaseÏóêÏÑú Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò)
               if (window.sb) {
                 loadAllAnalysisData(0, []);
               } else {
                 console.log('‚ö†Ô∏è Supabase not available, using sample data');
                 showAnalysisSampleData();
                 
                 // Î°úÎî© ÏÉÅÌÉú Ïà®Í∏∞Í∏∞
                 if (loadingState) {
                   loadingState.classList.add('hidden');
                 }
               }
             }
             
             // Î™®Îì† Analysis Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò)
             function loadAllAnalysisData(offset, allData) {
               console.log(`üîÑ Loading Analysis data batch starting from ${offset}...`);
               
               // Î°úÎî© ÏßÑÌñâ ÏÉÅÌô© ÏóÖÎç∞Ïù¥Ìä∏
               const progressElement = document.getElementById('loadingProgress');
               if (progressElement) {
                 progressElement.textContent = `Loading batch ${Math.floor(offset / 1000) + 1}... (${allData.length} records loaded)`;
               }
               
               window.sb.from('vwtm_list_data')
                 .select('*')
                 .range(offset, offset + 999) // 1000Í∞úÏî© Î°úÎìú
                 .then(({ data, error }) => {
                   if (error) {
                     console.error('‚ùå Database error:', error);
                     showAnalysisSampleData();
                     
                     // Î°úÎî© ÏÉÅÌÉú Ïà®Í∏∞Í∏∞
                     const loadingState = document.getElementById('loadingState');
                     if (loadingState) {
                       loadingState.classList.add('hidden');
                     }
                     return;
                   }
                   
                   const batchData = data || [];
                   console.log(`‚úÖ Loaded batch: ${batchData.length} records (offset: ${offset})`);
                   
                   // Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                   allData.push(...batchData);
                   
                   // Îçî ÎßéÏùÄ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
                   if (batchData.length === 1000) {
                     // Îã§Ïùå Î∞∞Ïπò Î°úÎìú
                     setTimeout(() => {
                       loadAllAnalysisData(offset + 1000, allData);
                     }, 100); // 100ms ÎåÄÍ∏∞
                   } else {
                     // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å
                     console.log('‚úÖ All Analysis data loaded:', allData.length, 'records');
                     console.log('Sample data:', allData.slice(0, 3));
                     
                     window.allData = allData;
                     window.filteredData = [...window.allData];
                     populateAnalysisFilterOptions();
                     performAnalysis();
                     
                     // Î°úÎî© ÏÉÅÌÉú Ïà®Í∏∞Í∏∞
                     const loadingState = document.getElementById('loadingState');
                     if (loadingState) {
                       loadingState.classList.add('hidden');
                     }
                   }
                 });
             }
             
             // Analysis ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
             function showAnalysisSampleData() {
               console.log('üìä Showing Analysis sample data...');
               
               // Îçî ÎßéÏùÄ ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
               const sampleData = [];
               const locations = ['F100', 'F101'];
               const partNos = ['3T24', '3T33', '3T34', '3T35', '3T36', '3T37', '3T38', '3T39', '3T40'];
               const holdValues = ['N', 'Y'];
               
               // 50Í∞úÏùò ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
               for (let i = 1; i <= 50; i++) {
                 const location = locations[Math.floor(Math.random() * locations.length)];
                 const partNo = partNos[Math.floor(Math.random() * partNos.length)];
                 const holdWhether = holdValues[Math.floor(Math.random() * holdValues.length)];
                 
                 sampleData.push({
                   pallet_no: `PAL${String(i).padStart(3, '0')}`,
                   rack_no: `${location}-${String(Math.floor(Math.random() * 20) + 1).padStart(2, '0')}`,
                   part_no: partNo,
                   hold_whether: holdWhether,
                   location: location,
                   upload_time: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
                 });
               }
               
               window.allData = sampleData;
               window.filteredData = [...sampleData];
               populateAnalysisFilterOptions();
               performAnalysis();
             }
             
             // Analysis ÌïÑÌÑ∞ ÏòµÏÖò Ï±ÑÏö∞Í∏∞
             function populateAnalysisFilterOptions() {
               console.log('üîß Populating Analysis filter options...');
               
               // Part No ÌïÑÌÑ∞ ÏòµÏÖò Ï±ÑÏö∞Í∏∞ (ÏßÄÏ†ïÎêú 6Í∞úÎßå)
               const partNoFilter = document.getElementById('partNoFilter');
               if (partNoFilter) {
                 const allowedPartNos = ['3T24', '3T33', '3T34', '3T35', '7Z79', '7Z80'];
                 partNoFilter.innerHTML = '<option value="">All</option>' + 
                   allowedPartNos.map(part => `<option value="${part}">${part}</option>`).join('');
                 
                 const partNoStatus = document.getElementById('partNoStatus');
                 if (partNoStatus) {
                   partNoStatus.textContent = `${allowedPartNos.length} part numbers available`;
                 }
               }
               
               // Location ÌïÑÌÑ∞ ÏòµÏÖò Ï±ÑÏö∞Í∏∞
               const locationFilter = document.getElementById('locationFilter');
               if (locationFilter) {
                 const locations = [...new Set(window.allData.map(item => item.location))].filter(Boolean);
                 locationFilter.innerHTML = '<option value="">All</option>' + 
                   locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
               }
               
               // Hold Whether ÌïÑÌÑ∞ ÏòµÏÖò Ï±ÑÏö∞Í∏∞
               const holdWhetherFilter = document.getElementById('holdWhetherFilter');
               if (holdWhetherFilter) {
                 const holdValues = [...new Set(window.allData.map(item => item.hold_whether))].filter(Boolean);
                 holdWhetherFilter.innerHTML = '<option value="">All</option>' + 
                   holdValues.map(hold => `<option value="${hold}">${hold}</option>`).join('');
               }
             }
             
             // Analysis ÌïÑÌÑ∞ Ï†ÅÏö©
             function applyAnalysisFilter() {
               console.log('üîç Applying Analysis filter...');
               
               const location = document.getElementById('locationFilter')?.value || '';
               const partNo = document.getElementById('partNoFilter')?.value || '';
               const holdWhether = document.getElementById('holdWhetherFilter')?.value || '';
               
               console.log('Filter conditions:', { location, partNo, holdWhether });
               console.log('Original data count:', window.allData.length);
               console.log('Sample data:', window.allData.slice(0, 3));
               
               // ÌïÑÌÑ∞ Ï†ÅÏö© Î°úÏßÅ
               let filtered = [...window.allData];
               
               if (location) {
                 filtered = filtered.filter(item => item.location === location);
                 console.log('After location filter:', filtered.length);
               }
               if (partNo) {
                 filtered = filtered.filter(item => item.part_no === partNo);
                 console.log('After partNo filter:', filtered.length);
               }
               if (holdWhether) {
                 filtered = filtered.filter(item => item.hold_whether === holdWhether);
                 console.log('After holdWhether filter:', filtered.length);
                 console.log('Hold whether values in data:', [...new Set(window.allData.map(item => item.hold_whether))]);
               }
               
               window.filteredData = filtered;
               console.log('Final filtered data:', filtered.length, 'records');
               performAnalysis();
               
               // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
               const work_status = document.getElementById('filterStatus');
               if (work_status) {
                 work_status.textContent = `ÌïÑÌÑ∞ Ï†ÅÏö©Îê®: ${filtered.length}Í∞ú Î†àÏΩîÎìú`;
               }
             }
             
             // Analysis ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
             function resetAnalysisFilter() {
               console.log('üîÑ Resetting Analysis filter...');
               
               document.getElementById('locationFilter').value = '';
               document.getElementById('partNoFilter').value = '';
               document.getElementById('holdWhetherFilter').value = '';
               
               window.filteredData = [...window.allData];
               performAnalysis();
               
               const work_status = document.getElementById('filterStatus');
               if (work_status) {
                 work_status.textContent = 'No filters applied';
               }
             }
             
             // Analysis ÏàòÌñâ
             function performAnalysis() {
               console.log('üìä Performing Analysis...');
               
               const data = window.filteredData || [];
               console.log('Analysis data:', data.length, 'records');
               
               // Pallet NoÎ≥ÑÎ°ú Í∑∏Î£πÌôîÌïòÏó¨ Î∂ÑÏÑù (Part NoÎ≥ÑÏù¥ ÏïÑÎãå PalletÎ≥Ñ)
               const palletGroups = {};
               data.forEach(item => {
                 const palletNo = item.pallet_no || 'Unknown';
                 if (!palletGroups[palletNo]) {
                   palletGroups[palletNo] = {
                     palletNo: palletNo,
                     rackNo: new Set(),
                     tmCount: new Set(),
                     partNoList: new Set(),
                     earliestDate: null,
                     items: []
                   };
                 }
                 
                 // Rack No ÏàòÏßë
                 if (item.rack_no && item.rack_no.trim() !== '') {
                   palletGroups[palletNo].rackNo.add(item.rack_no);
                 }
                 
                 // TM No ÏàòÏßë (Í≥†Ïú†Ìïú TM Í∞úÏàò Í≥ÑÏÇ∞)
                 if (item.tm_no && item.tm_no.trim() !== '') {
                   palletGroups[palletNo].tmCount.add(item.tm_no);
                 }
                 
                 // Part No ÏàòÏßë
                 if (item.part_no && item.part_no.trim() !== '') {
                   palletGroups[palletNo].partNoList.add(item.part_no);
                 }
                 
                 // ÏïÑÏù¥ÌÖú Ï†ÄÏû•
                 palletGroups[palletNo].items.push(item);
                 
                 // Í∞ÄÏû• Îπ†Î•∏ ÎÇ†Ïßú Í≥ÑÏÇ∞
                 if (item.prod_date && item.prod_date.trim() !== '') {
                   const currentDate = palletGroups[palletNo].earliestDate;
                   if (!currentDate || item.prod_date < currentDate) {
                     palletGroups[palletNo].earliestDate = item.prod_date;
                   }
                 }
               });
               
               // Í≤∞Í≥º Î∞∞Ïó¥Î°ú Î≥ÄÌôò
               const results = Object.values(palletGroups).map(group => ({
                 palletNo: group.palletNo,
                 rackNo: Array.from(group.rackNo).filter(r => r).join(', ') || 'N/A',
                 dataCount: group.items.length,
                 tmCount: group.tmCount.size, // Í≥†Ïú†Ìïú TM Í∞úÏàò
                 partNoList: Array.from(group.partNoList).filter(p => p).join(', ') || 'N/A',
                 earliestDate: group.earliestDate || 'N/A',
                 items: group.items
               }));
               
               window.lastAnalysisResults = results;
               displayAnalysisResults(results);
               updateAnalysisSummary(results);
             }
             
             // Analysis Í≤∞Í≥º ÌëúÏãú
             function displayAnalysisResults(results) {
               console.log('üìã Displaying Analysis results...');
               
               const tableBody = document.getElementById('resultsTable');
               if (!tableBody) return;
               
               if (results.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                 return;
               }
               
               const tableRows = results.map(result => `
                 <tr class="hover:bg-gray-50">
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.palletNo}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.rackNo}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.dataCount}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.tmCount}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.partNoList}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.earliestDate}</td>
                 </tr>
               `);
               
               tableBody.innerHTML = tableRows.join('');
               
               // Í≤∞Í≥º Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
               const resultCount = document.getElementById('resultCount');
               if (resultCount) {
                 resultCount.textContent = `Found ${results.length} pallets`;
               }
               
               // Îç∞Ïù¥ÌÑ∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
               const dataInfo = document.getElementById('analysisDataInfo');
               if (dataInfo) {
                 dataInfo.textContent = `Ï¥ù ${window.allData.length}Í∞ú Î†àÏΩîÎìú Ï§ë ${results.length}Í∞ú ÌëúÏãú`;
               }
             }
             
             // Analysis ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
             function updateAnalysisSummary(results) {
               console.log('üìä Updating Analysis summary...');
               
               const summary8 = document.getElementById('summary8');
               const summary7 = document.getElementById('summary7');
               
               if (summary8) {
                 const count8Plus = results.filter(r => r.tmCount >= 8).length;
                 summary8.innerHTML = `<div class="text-2xl font-bold text-blue-600">${count8Plus}</div><div class="text-sm text-gray-500">ÌåîÎ†àÌä∏</div>`;
               }
               
               if (summary7) {
                 const countUnder8 = results.filter(r => r.tmCount < 8).length;
                 summary7.innerHTML = `<div class="text-2xl font-bold text-orange-600">${countUnder8}</div><div class="text-sm text-gray-500">ÌåîÎ†àÌä∏</div>`;
               }
             }
             
             // Analysis Excel ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (TM COUNT 8Í∞ú ÎØ∏Îßå Î≥ÑÎèÑ ÏãúÌä∏)
             function exportAnalysisData() {
               console.log('üìä Exporting Analysis data...');
               
               if (!window.lastAnalysisResults || window.lastAnalysisResults.length === 0) {
                 console.warn('‚ö†Ô∏è ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Î∂ÑÏÑùÏùÑ Ïã§ÌñâÌï¥Ï£ºÏÑ∏Ïöî.');
                 return;
               }
               
               // Îç∞Ïù¥ÌÑ∞ Î∂ÑÎ¶¨: TM COUNT 8Í∞ú Ïù¥ÏÉÅÍ≥º 8Í∞ú ÎØ∏Îßå
               const results8Plus = window.lastAnalysisResults.filter(result => result.tmCount >= 8);
               const resultsUnder8 = window.lastAnalysisResults.filter(result => result.tmCount < 8);
               
               console.log(`üìä Exporting: ${results8Plus.length} pallets (8+ TM), ${resultsUnder8.length} pallets (Under 8 TM)`);
               
               // Excel ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Î°úÏßÅ
               const workbook = new ExcelJS.Workbook();
               
               // 1. Ï†ÑÏ≤¥ Í≤∞Í≥º ÏãúÌä∏ (8Í∞ú Ïù¥ÏÉÅ)
               const mainWorksheet = workbook.addWorksheet('8+ TM Pallets');
               mainWorksheet.addRow(['Pallet No', 'Rack No', 'Data Count', 'TM Count', 'Part No List', 'Earliest Date']);
               
               results8Plus.forEach(result => {
                 mainWorksheet.addRow([
                   result.palletNo || '',
                   result.rackNo || '',
                   result.dataCount || 0,
                   result.tmCount || 0,
                   result.partNoList || '',
                   result.earliestDate || ''
                 ]);
               });
               
               // 2. 8Í∞ú ÎØ∏Îßå ÌåîÎ†àÌä∏ ÏãúÌä∏
               if (resultsUnder8.length > 0) {
                 const under8Worksheet = workbook.addWorksheet('Under 8 TM Pallets');
                 under8Worksheet.addRow(['Pallet No', 'Rack No', 'Data Count', 'TM Count', 'Part No List', 'Earliest Date']);
                 
                 resultsUnder8.forEach(result => {
                   under8Worksheet.addRow([
                     result.palletNo || '',
                     result.rackNo || '',
                     result.dataCount || 0,
                     result.tmCount || 0,
                     result.partNoList || '',
                     result.earliestDate || ''
                   ]);
                 });
               }
               
               // 3. ÏöîÏïΩ ÏãúÌä∏
               const summaryWorksheet = workbook.addWorksheet('Summary');
               summaryWorksheet.addRow(['Category', 'Count', 'Description']);
               summaryWorksheet.addRow(['8+ TM Pallets', results8Plus.length, 'ÌåîÎ†àÌä∏Îãπ 8Í∞ú Ïù¥ÏÉÅÏùò TMÏùÑ Í∞ÄÏßÑ ÌåîÎ†àÌä∏']);
               summaryWorksheet.addRow(['Under 8 TM Pallets', resultsUnder8.length, 'ÌåîÎ†àÌä∏Îãπ 8Í∞ú ÎØ∏ÎßåÏùò TMÏùÑ Í∞ÄÏßÑ ÌåîÎ†àÌä∏']);
               summaryWorksheet.addRow(['Total Pallets', window.lastAnalysisResults.length, 'Ï†ÑÏ≤¥ ÌåîÎ†àÌä∏ Ïàò']);
               
               // ÌååÏùº Îã§Ïö¥Î°úÎìú
               workbook.xlsx.writeBuffer().then(buffer => {
                 const blob = new Blob([buffer], { 
                   type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                 });
                 const url = window.URL.createObjectURL(blob);
                 const link = document.createElement('a');
                 link.href = url;
                 link.download = `shipping_analysis_${new Date().toISOString().slice(0, 10)}.xlsx`;
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 window.URL.revokeObjectURL(url);
                 
                 console.log(`‚úÖ Excel export completed: ${results8Plus.length} (8+ TM) + ${resultsUnder8.length} (Under 8 TM) pallets`);
               });
             }
             
             // ÌÖåÏù¥Î∏î Ï†ïÎ†¨
             function sortTable(column) {
               console.log(`üîç Sorting by column: ${column}`);
               
               if (window.currentSortColumn === column) {
                 window.currentSortDirection = window.currentSortDirection === 'asc' ? 'desc' : 'asc';
               } else {
                 window.currentSortColumn = column;
                 window.currentSortDirection = 'asc';
               }
               
               const results = [...window.lastAnalysisResults];
               results.sort((a, b) => {
                 let aVal = a[column] || '';
                 let bVal = b[column] || '';
                 
                 if (['dataCount', 'tmCount'].includes(column)) {
                   aVal = parseFloat(aVal) || 0;
                   bVal = parseFloat(bVal) || 0;
                 } else {
                   aVal = String(aVal).toLowerCase();
                   bVal = String(bVal).toLowerCase();
                 }
                 
                 if (aVal < bVal) return window.currentSortDirection === 'asc' ? -1 : 1;
                 if (aVal > bVal) return window.currentSortDirection === 'asc' ? 1 : -1;
                 return 0;
               });
               
               displayAnalysisResults(results);
               updateSortIcons(column);
             }
             
             // Ï†ïÎ†¨ ÏïÑÏù¥ÏΩò ÏóÖÎç∞Ïù¥Ìä∏
             function updateSortIcons(activeColumn) {
               const columns = ['palletNo', 'rackNo', 'dataCount', 'tmCount', 'partNoList', 'earliestDate'];
               columns.forEach(col => {
                 const icon = document.getElementById(`sort-${col}`);
                 if (icon) {
                   if (col === activeColumn) {
                     icon.textContent = window.currentSortDirection === 'asc' ? '‚Üë' : '‚Üì';
                   } else {
                     icon.textContent = '‚Üï';
                   }
                 }
               });
             }

             // Packaging ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
             function initializePackagingPage() {
               console.log('üîß Initializing Packaging page...');
               
               // Ï†ÑÏó≠ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
               window.packagingAllData = [];
               window.packagingFilteredData = [];
               window.packagingCurrentSortColumn = 'palletNo';
               window.packagingCurrentSortDirection = 'asc';
               window.packagingLastResults = [];
               
               // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
               const refreshBtn = document.getElementById('packagingRefreshDataBtn');
               if (refreshBtn) {
                 refreshBtn.onclick = loadPackagingData;
               }
               
               const applyBtn = document.getElementById('packagingApplyFilterBtn');
               if (applyBtn) {
                 applyBtn.onclick = applyPackagingFilter;
               }
               
               const resetBtn = document.getElementById('packagingResetFilterBtn');
               if (resetBtn) {
                 resetBtn.onclick = resetPackagingFilter;
               }
               
               const exportBtn = document.getElementById('packagingExportExcelBtn');
               if (exportBtn) {
                 exportBtn.onclick = exportPackagingData;
               }
               
               // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
               loadPackagingData();
             }
             
             // Packaging Îç∞Ïù¥ÌÑ∞ Î°úÎìú
             function loadPackagingData() {
               console.log('üîÑ Loading Packaging data...');
               
               // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
               const loadingState = document.getElementById('packagingLoadingState');
               if (loadingState) {
                 loadingState.classList.remove('hidden');
               }
               
               // SupabaseÏóêÏÑú Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò)
               if (window.sb) {
                 loadAllPackagingData(0, []);
               } else {
                 console.log('‚ö†Ô∏è Supabase not available, using sample data');
                 showPackagingSampleData();
                 
                 // Î°úÎî© ÏÉÅÌÉú Ïà®Í∏∞Í∏∞
                 if (loadingState) {
                   loadingState.classList.add('hidden');
                 }
               }
             }
             
             // Î™®Îì† Packaging Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò)
             function loadAllPackagingData(offset, allData) {
               console.log(`üîÑ Loading Packaging data batch starting from ${offset}...`);
               
               // Î°úÎî© ÏßÑÌñâ ÏÉÅÌô© ÏóÖÎç∞Ïù¥Ìä∏
               const progressElement = document.getElementById('packagingLoadingProgress');
               if (progressElement) {
                 progressElement.textContent = `Loading batch ${Math.floor(offset / 1000) + 1}... (${allData.length} records loaded)`;
               }
               
               window.sb.from('vwtm_list_data')
                 .select('*')
                 .range(offset, offset + 999) // 1000Í∞úÏî© Î°úÎìú
                 .then(({ data, error }) => {
                   if (error) {
                     console.error('‚ùå Database error:', error);
                     showPackagingSampleData();
                     
                     // Î°úÎî© ÏÉÅÌÉú Ïà®Í∏∞Í∏∞
                     const loadingState = document.getElementById('packagingLoadingState');
                     if (loadingState) {
                       loadingState.classList.add('hidden');
                     }
                     return;
                   }
                   
                   const batchData = data || [];
                   console.log(`‚úÖ Loaded batch: ${batchData.length} records (offset: ${offset})`);
                   
                   // Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                   allData.push(...batchData);
                   
                   // Îçî ÎßéÏùÄ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
                   if (batchData.length === 1000) {
                     // Îã§Ïùå Î∞∞Ïπò Î°úÎìú
                     setTimeout(() => {
                       loadAllPackagingData(offset + 1000, allData);
                     }, 100); // 100ms ÎåÄÍ∏∞
                   } else {
                     // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å
                     console.log('‚úÖ All Packaging data loaded:', allData.length, 'records');
                     console.log('Sample packaging data:', allData.slice(0, 3));
                     
                     window.packagingAllData = allData;
                     window.packagingFilteredData = [...window.packagingAllData];
                     populatePackagingFilterOptions();
                     performPackagingAnalysis();
                     
                     // Î°úÎî© ÏÉÅÌÉú Ïà®Í∏∞Í∏∞
                     const loadingState = document.getElementById('packagingLoadingState');
                     if (loadingState) {
                       loadingState.classList.add('hidden');
                     }
                   }
                 });
             }
             
             // Packaging ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
             function showPackagingSampleData() {
               console.log('üì¶ Showing Packaging sample data...');
               
               // Îçî ÎßéÏùÄ ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
               const sampleData = [];
               const partNos = ['3T24', '3T33', '3T34', '3T35', '3T36', '3T37', '3T38', '3T39', '3T40'];
               const rackPrefixes = ['LHSAB', 'LHSBA', 'LHSAA', 'LHSBB', 'LHSAC', 'LHSAD', 'LHSBC', 'LHSBD'];
               
               // 50Í∞úÏùò ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (ÏùºÎ∂ÄÎäî Hold Whether 'Y', ÏùºÎ∂ÄÎäî RACK NO ÏóÜÏùå)
               for (let i = 1; i <= 50; i++) {
                 const location = 'F101'; // Í∏∞Î≥∏Í∞í F101
                 const partNo = partNos[Math.floor(Math.random() * partNos.length)];
                 const holdWhether = Math.random() < 0.2 ? 'Y' : 'N'; // 20% ÌôïÎ•†Î°ú 'Y'
                 
                 // RACK NOÍ∞Ä ÏóÜÎäî Î†àÏΩîÎìú Ï∂îÍ∞Ä (10% ÌôïÎ•†)
                 let rackNo = '';
                 if (Math.random() < 0.1) {
                   rackNo = ''; // RACK NO ÏóÜÏùå
                 } else {
                   const rackPrefix = rackPrefixes[Math.floor(Math.random() * rackPrefixes.length)];
                   const rackSuffix = String(Math.floor(Math.random() * 20) + 1).padStart(2, '0');
                   rackNo = `${rackPrefix}${rackSuffix}`;
                 }

                 sampleData.push({
                   pallet_no: `PAL${String(i).padStart(3, '0')}`,
                   rack_no: rackNo,
                   part_no: partNo,
                   hold_whether: holdWhether,
                   location: location,
                   upload_time: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
                 });
               }
               
               window.packagingAllData = sampleData;
               window.packagingFilteredData = [...sampleData];
               populatePackagingFilterOptions();
               performPackagingAnalysis();
             }
             
             // Packaging ÌïÑÌÑ∞ ÏòµÏÖò Ï±ÑÏö∞Í∏∞
             function populatePackagingFilterOptions() {
               console.log('üîß Populating Packaging filter options...');
               
               // Part No ÌïÑÌÑ∞ ÏòµÏÖòÎßå Ï±ÑÏö∞Í∏∞ (ÏßÄÏ†ïÎêú 6Í∞úÎßå, LocationÍ≥º Hold WhetherÎäî Í≥†Ï†ïÍ∞í)
               const partNoFilter = document.getElementById('packagingPartNoFilter');
               if (partNoFilter) {
                 const allowedPartNos = ['3T24', '3T33', '3T34', '3T35', '7Z79', '7Z80'];
                 partNoFilter.innerHTML = '<option value="">All</option>' + 
                   allowedPartNos.map(part => `<option value="${part}">${part}</option>`).join('');
                 
                 const partNoStatus = document.getElementById('packagingPartNoStatus');
                 if (partNoStatus) {
                   partNoStatus.textContent = `${allowedPartNos.length} part numbers available`;
                 }
               }
               
               console.log('Packaging filter options populated (Location=F101, Hold Whether=N fixed)');
             }
             
             // Packaging ÌïÑÌÑ∞ Ï†ÅÏö©
             function applyPackagingFilter() {
               console.log('üîç Applying Packaging filter...');
               
               const partNo = document.getElementById('packagingPartNoFilter')?.value || '';
               
               console.log('Packaging filter conditions:', { partNo });
               console.log('Original packaging data count:', window.packagingAllData.length);
               console.log('Sample packaging data:', window.packagingAllData.slice(0, 3));
               
               // ÌïÑÌÑ∞ Ï†ÅÏö© Î°úÏßÅ (Location=F101, Hold Whether=N Í≥†Ï†ï)
               let filtered = [...window.packagingAllData];
               
               // Location=F101, Hold Whether=N Í≥†Ï†ï ÌïÑÌÑ∞ Ï†ÅÏö©
               filtered = filtered.filter(item => item.location === 'F101' && item.hold_whether === 'N');
               console.log('After fixed filters (F101, N):', filtered.length);
               
               // Part No ÌïÑÌÑ∞Îßå ÏÇ¨Ïö©ÏûêÍ∞Ä Î≥ÄÍ≤Ω Í∞ÄÎä•
               if (partNo) {
                 filtered = filtered.filter(item => item.part_no === partNo);
                 console.log('After partNo filter:', filtered.length);
               }
               
               window.packagingFilteredData = filtered;
               console.log('Final packaging filtered data:', filtered.length, 'records');
               performPackagingAnalysis();
               
               // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
               const work_status = document.getElementById('packagingFilterStatus');
               if (work_status) {
                 if (partNo) {
                   work_status.textContent = `Fixed: F101, N, RACK NO | Applied: Part No=${partNo} | ${filtered.length}Í∞ú Î†àÏΩîÎìú`;
                 } else {
                   work_status.textContent = `Fixed filters: Location=F101, Hold Whether=N, RACK NO required (Part No only searchable) | ${filtered.length}Í∞ú Î†àÏΩîÎìú`;
                 }
               }
             }
             
             // Packaging ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
             function resetPackagingFilter() {
               console.log('üîÑ Resetting Packaging filter...');
               
               document.getElementById('packagingPartNoFilter').value = '';
               
               // Location=F101, Hold Whether=N Í≥†Ï†ï ÌïÑÌÑ∞ Ï†ÅÏö©
               let filtered = [...window.packagingAllData];
               filtered = filtered.filter(item => item.location === 'F101' && item.hold_whether === 'N');
               
               window.packagingFilteredData = filtered;
               performPackagingAnalysis();
               
               const work_status = document.getElementById('packagingFilterStatus');
               if (work_status) {
                 work_status.textContent = `Fixed filters: Location=F101, Hold Whether=N, RACK NO required (Part No only searchable) | ${filtered.length}Í∞ú Î†àÏΩîÎìú`;
               }
             }
             
             // Packaging Î∂ÑÏÑù ÏàòÌñâ
             function performPackagingAnalysis() {
               console.log('üì¶ Performing Packaging analysis...');
               
               const data = window.packagingFilteredData || [];
               console.log('Packaging data:', data.length, 'records');
               
               // Hold WhetherÍ∞Ä 'N'Ïù∏ Í≤ÉÎßå ÌïÑÌÑ∞ÎßÅ (RACK NO Ïú†Î¨¥ Í¥ÄÍ≥ÑÏóÜÏù¥)
               const validData = data.filter(item => 
                 item.hold_whether === 'N'
               );
               
               console.log(`üìä Valid records for packaging analysis: ${validData.length} out of ${data.length}`);
               
               // ÌåîÎ†àÌä∏Î≥ÑÎ°ú Í∑∏Î£πÌôîÌïòÏó¨ TM COUNT Í≥ÑÏÇ∞
               const palletGroups = {};
               validData.forEach(item => {
                 const palletNo = item.pallet_no || 'Unknown';
                 if (!palletGroups[palletNo]) {
                   palletGroups[palletNo] = {
                     palletNo: palletNo,
                     rackNo: new Set(),
                     tmCount: new Set(),
                     partNo: new Set(),
                     location: item.location || 'Unknown',
                     holdWhether: item.hold_whether,
                     items: []
                   };
                 }
                 
                 // Rack No ÏàòÏßë
                 if (item.rack_no && item.rack_no.trim() !== '') {
                   palletGroups[palletNo].rackNo.add(item.rack_no);
                 }
                 
                 // TM No ÏàòÏßë (Í≥†Ïú†Ìïú TM Í∞úÏàò Í≥ÑÏÇ∞)
                 if (item.tm_no && item.tm_no.trim() !== '') {
                   palletGroups[palletNo].tmCount.add(item.tm_no);
                 }
                 
                 // Part No ÏàòÏßë
                 if (item.part_no && item.part_no.trim() !== '') {
                   palletGroups[palletNo].partNo.add(item.part_no);
                 }
                 
                 // ÏïÑÏù¥ÌÖú Ï†ÄÏû•
                 palletGroups[palletNo].items.push(item);
               });
               
               // LocationÎ≥ÑÎ°ú Í∑∏Î£πÌôîÌïòÏó¨ Ìè¨Ïû• Ï†Ñ/ÌõÑ Î∂ÑÏÑù
               const locationGroups = {};
               let totalRecords = data.length;
               let filteredRecords = validData.length;
               
               Object.values(palletGroups).forEach(palletGroup => {
                 const location = palletGroup.location;
                 if (!locationGroups[location]) {
                   locationGroups[location] = {
                     location: location,
                     totalPallets: 0,
                     beforePackaging: 0,
                     afterPackaging: 0,
                     pallets: []
                   };
                 }
                 
                 locationGroups[location].totalPallets++;
                 
                 // RACK NOÏóê Îî∞Îùº Ìè¨Ïû• Ï†Ñ/ÌõÑ Íµ¨Î∂Ñ (Ï≤´ Î≤àÏß∏ RACK NO Í∏∞Ï§Ä)
                 const rackNo = Array.from(palletGroup.rackNo)[0] || '';
                 let packagingStatus = 'Unknown';
                 
                 if (rackNo === '') {
                   // RACK NOÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞
                   packagingStatus = 'No Rack No';
                   if (!locationGroups[location].noRackNo) {
                     locationGroups[location].noRackNo = 0;
                   }
                   locationGroups[location].noRackNo++;
                 } else if (rackNo.startsWith('LHSAB') || rackNo.startsWith('LHSBA') || 
                     rackNo.startsWith('LHSAA') || rackNo.startsWith('LHSBB')) {
                   packagingStatus = 'Before Packaging';
                   locationGroups[location].beforePackaging++;
                 } else if (rackNo.startsWith('LHSAC') || rackNo.startsWith('LHSAD') || 
                           rackNo.startsWith('LHSBC') || rackNo.startsWith('LHSBD')) {
                   packagingStatus = 'After Packaging';
                   locationGroups[location].afterPackaging++;
                 } else {
                   // Í∏∞ÌÉÄ RACK NOÎäî Hold Whether 'N'Ïù¥ÎØÄÎ°ú After Packaging
                   packagingStatus = 'After Packaging';
                   locationGroups[location].afterPackaging++;
                 }
                 
                 // ÌåîÎ†àÌä∏ Ï†ïÎ≥¥ Ï†ÄÏû• (Ïã§Ï†ú TM COUNT ÏÇ¨Ïö©)
                 locationGroups[location].pallets.push({
                   palletNo: palletGroup.palletNo,
                   rackNo: Array.from(palletGroup.rackNo).filter(r => r).join(', ') || 'N/A',
                   partNo: Array.from(palletGroup.partNo).filter(p => p).join(', ') || 'N/A',
                   tmCount: palletGroup.tmCount.size, // Ïã§Ï†ú Í≥†Ïú†Ìïú TM Í∞úÏàò
                   packagingStatus: packagingStatus,
                   location: location,
                   holdWhether: palletGroup.holdWhether,
                   items: palletGroup.items
                 });
               });
               
               // Í≤∞Í≥ºÎ•º ÌèâÎ©¥ÌôîÌïòÏó¨ ÌÖåÏù¥Î∏îÏóê ÌëúÏãú
               const results = [];
               Object.values(locationGroups).forEach(group => {
                 results.push(...group.pallets);
               });
               
               console.log(`üìä Packaging analysis completed: ${totalRecords} total records, ${filteredRecords} valid records (Hold Whether 'N' + RACK NO exists) processed`);
               console.log(`üìä Processed ${Object.keys(palletGroups).length} unique pallets`);
               
               window.packagingLastResults = results;
               displayPackagingResults(results);
               updatePackagingSummary(locationGroups);
             }
             
             // Ìå®ÌÇ§Ïßï ÌÉÄÏûÖ Í≤∞Ï†ï
             function determinePackagingType(partNo) {
               if (!partNo) return 'Standard';
               
               // Part NoÏóê Îî∞Î•∏ Ìå®ÌÇ§Ïßï ÌÉÄÏûÖ Í≤∞Ï†ï Î°úÏßÅ
               if (partNo.includes('3T2')) return 'High Priority';
               if (partNo.includes('3T3')) return 'Standard';
               if (partNo.includes('3T4')) return 'Bulk';
               return 'Standard';
             }
             
             // ÏµúÏ†ÅÌôî Ï†êÏàò Í≥ÑÏÇ∞
             function calculateOptimization(partNo, location) {
               if (!partNo || !location) return 'N/A';
               
               // Í∞ÑÎã®Ìïú ÏµúÏ†ÅÌôî Ï†êÏàò Í≥ÑÏÇ∞
               let score = 0;
               if (location === 'F101') score += 10; // F101ÏùÄ Îçî Ìö®Ïú®Ï†Å
               if (partNo.includes('3T2')) score += 15; // Í≥†Ïö∞ÏÑ†ÏàúÏúÑ Î∂ÄÌíà
               if (partNo.includes('3T3')) score += 10; // ÌëúÏ§Ä Î∂ÄÌíà
               if (partNo.includes('3T4')) score += 5; // Î≤åÌÅ¨ Î∂ÄÌíà
               
               if (score >= 20) return 'Excellent';
               if (score >= 15) return 'Good';
               if (score >= 10) return 'Fair';
               return 'Poor';
             }
             
             // Packaging Í≤∞Í≥º ÌëúÏãú
             function displayPackagingResults(results) {
               console.log('üìã Displaying Packaging results...');
               
               const tableBody = document.getElementById('packagingResultsTable');
               if (!tableBody) return;
               
               if (results.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                 return;
               }
               
               const tableRows = results.map(result => `
                 <tr class="hover:bg-gray-50">
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.palletNo}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.rackNo}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.partNo}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                     <span class="${result.holdWhether === 'Y' ? 'text-red-500 line-through' : 'text-gray-900'}">${result.tmCount}</span>
                     ${result.holdWhether === 'Y' ? '<span class="text-xs text-red-500 ml-1">(HOLD)</span>' : ''}
                   </td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                     <span class="px-2 py-1 text-xs font-medium rounded-full ${
                       result.packagingStatus === 'After Packaging' ? 'bg-green-100 text-green-800' :
                       result.packagingStatus === 'Before Packaging' ? 'bg-yellow-100 text-yellow-800' :
                       result.packagingStatus === 'No Rack No' ? 'bg-red-100 text-red-800' :
                       'bg-gray-100 text-gray-800'
                     }">${result.packagingStatus}</span>
                   </td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                     <span class="px-2 py-1 text-xs font-medium rounded-full ${
                       result.location === 'F101' ? 'bg-blue-100 text-blue-800' :
                       result.location === 'F100' ? 'bg-purple-100 text-purple-800' :
                       'bg-gray-100 text-gray-800'
                     }">${result.location}</span>
                   </td>
                 </tr>
               `);
               
               tableBody.innerHTML = tableRows.join('');
               
               // Í≤∞Í≥º Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
               const resultCount = document.getElementById('packagingResultCount');
               if (resultCount) {
                 resultCount.textContent = `Found ${results.length} pallets`;
               }
               
               // Îç∞Ïù¥ÌÑ∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
               const dataInfo = document.getElementById('packagingDataInfo');
               if (dataInfo) {
                 const totalData = window.packagingAllData.length;
                 const validCount = window.packagingAllData.filter(item => 
                   item.hold_whether === 'N' && item.rack_no && item.rack_no.trim() !== ''
                 ).length;
                 dataInfo.textContent = `Ï¥ù ${totalData}Í∞ú Î†àÏΩîÎìú Ï§ë Ïú†Ìö®Ìïú Î†àÏΩîÎìú (Hold Whether 'N' + RACK NO): ${validCount}Í∞ú, ÌëúÏãú: ${results.length}Í∞ú`;
               }
             }
             
             // Packaging ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
             function updatePackagingSummary(locationGroups) {
               console.log('üìä Updating Packaging summary...');
               
               const totalPallets = document.getElementById('packagingTotalPallets');
               const beforePallets = document.getElementById('packagingBeforePallets');
               const afterPallets = document.getElementById('packagingAfterPallets');
               const noRackPallets = document.getElementById('packagingNoRackPallets');
               const packagingRate = document.getElementById('packagingRate');
               
               // Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
               let totalCount = 0;
               let beforeCount = 0;
               let afterCount = 0;
               let noRackCount = 0;
               let totalTmCount = 0; // Hold Whether 'Y' Ï†úÏô∏Ìïú TM COUNT
               
               Object.values(locationGroups).forEach(group => {
                 totalCount += group.totalPallets;
                 beforeCount += group.beforePackaging;
                 afterCount += group.afterPackaging;
                 noRackCount += group.noRackNo || 0;
                 
                 // TM COUNT Í≥ÑÏÇ∞ (Hold Whether 'Y' Ï†úÏô∏)
                 group.pallets.forEach(pallet => {
                   if (pallet.holdWhether !== 'Y') {
                     totalTmCount += pallet.tmCount;
                   }
                 });
               });
               
               const packagingRatePercent = totalCount > 0 ? Math.round((afterCount / totalCount) * 100) : 0;
               
               if (totalPallets) {
                 totalPallets.innerHTML = `<div class="text-2xl font-bold text-blue-600">${totalTmCount}</div><div class="text-sm text-gray-500">EA</div><div class="text-xs text-gray-400">ÌåîÎ†àÌä∏: ${totalCount}Í∞ú</div>`;
               }
               
               if (beforePallets) {
                 const beforeTmCount = Object.values(locationGroups).reduce((sum, group) => {
                   return sum + group.pallets.filter(p => p.packagingStatus === 'Before Packaging' && p.holdWhether !== 'Y').reduce((pSum, p) => pSum + p.tmCount, 0);
                 }, 0);
                 beforePallets.innerHTML = `<div class="text-2xl font-bold text-yellow-600">${beforeTmCount}</div><div class="text-sm text-gray-500">EA</div><div class="text-xs text-gray-400">ÌåîÎ†àÌä∏: ${beforeCount}Í∞ú</div>`;
               }
               
               if (afterPallets) {
                 const afterTmCount = Object.values(locationGroups).reduce((sum, group) => {
                   return sum + group.pallets.filter(p => p.packagingStatus === 'After Packaging' && p.holdWhether !== 'Y').reduce((pSum, p) => pSum + p.tmCount, 0);
                 }, 0);
                 afterPallets.innerHTML = `<div class="text-2xl font-bold text-green-600">${afterTmCount}</div><div class="text-sm text-gray-500">EA</div><div class="text-xs text-gray-400">ÌåîÎ†àÌä∏: ${afterCount}Í∞ú</div>`;
               }
               
               if (noRackPallets) {
                 const noRackTmCount = Object.values(locationGroups).reduce((sum, group) => {
                   return sum + group.pallets.filter(p => p.packagingStatus === 'No Rack No' && p.holdWhether !== 'Y').reduce((pSum, p) => pSum + p.tmCount, 0);
                 }, 0);
                 noRackPallets.innerHTML = `<div class="text-2xl font-bold text-red-600">${noRackTmCount}</div><div class="text-sm text-gray-500">EA</div><div class="text-xs text-gray-400">ÌåîÎ†àÌä∏: ${noRackCount}Í∞ú</div>`;
               }
               
               if (packagingRate) {
                 packagingRate.innerHTML = `<div class="text-2xl font-bold text-purple-600">${packagingRatePercent}%</div><div class="text-sm text-gray-500">Ìè¨Ïû•Î•†</div>`;
               }
               
               console.log(`üìä Packaging summary: ${totalCount} pallets, ${totalTmCount} TMs (EA) - Hold Whether 'Y' excluded`);
             }
             
             // Packaging Excel ÎÇ¥Î≥¥ÎÇ¥Í∏∞
             function exportPackagingData() {
               console.log('üìä Exporting Packaging data...');
               
               if (!window.packagingLastResults || window.packagingLastResults.length === 0) {
                 console.warn('‚ö†Ô∏è ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Î∂ÑÏÑùÏùÑ Ïã§ÌñâÌï¥Ï£ºÏÑ∏Ïöî.');
                 return;
               }
               
               // Excel ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Î°úÏßÅ
               const workbook = new ExcelJS.Workbook();
               const worksheet = workbook.addWorksheet('Packaging Analysis Results');
               
               // Ìó§Îçî Ï∂îÍ∞Ä
               worksheet.addRow(['Pallet No', 'Rack No', 'Part No', 'TM Count', 'Packaging Status', 'Location']);
               
               // Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
               window.packagingLastResults.forEach(result => {
                 worksheet.addRow([
                   result.palletNo || '',
                   result.rackNo || '',
                   result.partNo || '',
                   result.tmCount || 0,
                   result.packagingStatus || '',
                   result.location || ''
                 ]);
               });
               
               // ÌååÏùº Îã§Ïö¥Î°úÎìú
               workbook.xlsx.writeBuffer().then(buffer => {
                 const blob = new Blob([buffer], { 
                   type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                 });
                 const url = window.URL.createObjectURL(blob);
                 const link = document.createElement('a');
                 link.href = url;
                 link.download = `packaging_analysis_${new Date().toISOString().slice(0, 10)}.xlsx`;
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 window.URL.revokeObjectURL(url);
               });
             }
             
             // Packaging ÌÖåÏù¥Î∏î Ï†ïÎ†¨
             function sortPackagingTable(column) {
               console.log(`üîç Sorting Packaging table by column: ${column}`);
               
               if (window.packagingCurrentSortColumn === column) {
                 window.packagingCurrentSortDirection = window.packagingCurrentSortDirection === 'asc' ? 'desc' : 'asc';
               } else {
                 window.packagingCurrentSortColumn = column;
                 window.packagingCurrentSortDirection = 'asc';
               }
               
               const results = [...window.packagingLastResults];
               results.sort((a, b) => {
                 let aVal = a[column] || '';
                 let bVal = b[column] || '';
                 
                 if (['tmCount'].includes(column)) {
                   aVal = parseFloat(aVal) || 0;
                   bVal = parseFloat(bVal) || 0;
                 } else {
                   aVal = String(aVal).toLowerCase();
                   bVal = String(bVal).toLowerCase();
                 }
                 
                 if (aVal < bVal) return window.packagingCurrentSortDirection === 'asc' ? -1 : 1;
                 if (aVal > bVal) return window.packagingCurrentSortDirection === 'asc' ? 1 : -1;
                 return 0;
               });
               
               displayPackagingResults(results);
               updatePackagingSortIcons(column);
             }
             
             // Packaging Ï†ïÎ†¨ ÏïÑÏù¥ÏΩò ÏóÖÎç∞Ïù¥Ìä∏
             function updatePackagingSortIcons(activeColumn) {
               const columns = ['palletNo', 'rackNo', 'partNo', 'tmCount', 'packagingStatus', 'location'];
               columns.forEach(col => {
                 const icon = document.getElementById(`packaging-sort-${col}`);
                 if (icon) {
                   if (col === activeColumn) {
                     icon.textContent = window.packagingCurrentSortDirection === 'asc' ? '‚Üë' : '‚Üì';
                   } else {
                     icon.textContent = '‚Üï';
                   }
                 }
               });
             }

             // ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨ Ìï®Ïàò (Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Îèô)
             async function handleFileUpload() {
               const fileInput = document.getElementById('fileInput');
               const file = fileInput.files[0];
               const work_statusDiv = document.getElementById('uploadStatus');
               const tableDiv = document.getElementById('dataTable');
               
               if (!file) {
                 work_statusDiv.innerHTML = '<div class="text-red-600">ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</div>';
                 return;
               }
               
               // Supabase Ïó∞Í≤∞ ÌôïÏù∏
               if (!window.sb) {
                 work_statusDiv.innerHTML = '<div class="text-red-600">‚ùå Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞Ïù¥ ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.</div>';
                 console.error('‚ùå Supabase client not available');
                 return;
               }
               
               const supabase = window.sb;
               work_statusDiv.innerHTML = '<div class="text-blue-600">üìÅ ÌååÏùº ÏùΩÎäî Ï§ë...</div>';
               
               try {
                 // 1Îã®Í≥Ñ: ÌååÏùº ÏùΩÍ∏∞
                 const data = await readExcelFile(file);
                 if (!data || data.length === 0) {
                   throw new Error('No data found in file');
                 }
                 
                 work_statusDiv.innerHTML = '<div class="text-blue-600">üîç Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Ï§ë...</div>';
                 
                 // 2Îã®Í≥Ñ: Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
                 const validatedData = validateData(data);
                 if (!validatedData || validatedData.length === 0) {
                   throw new Error('No valid data after validation');
                 }
                 
                 work_statusDiv.innerHTML = '<div class="text-blue-600">üóëÔ∏è Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ï§ë...</div>';
                 
                 // 3Îã®Í≥Ñ: Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                 const { error: deleteError } = await supabase
                   .from('vwtm_list_data')
                   .delete()
                   .neq('id', 0);
                 
                 if (deleteError) {
                   throw new Error(`Delete error: ${deleteError.message}`);
                 }
                 
                 work_statusDiv.innerHTML = '<div class="text-blue-600">üìù Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ï†ÄÏû• Ï§ë...</div>';
                 
                 // 4Îã®Í≥Ñ: ÏÉà Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä (Î∞∞Ïπò Ï≤òÎ¶¨)
                 const batchSize = 500;
                 const batches = [];
                 
                 for (let i = 0; i < validatedData.length; i += batchSize) {
                   batches.push(validatedData.slice(i, i + batchSize));
                 }
                 
                 let totalInserted = 0;
                 let failedBatches = [];
                 
                 for (let i = 0; i < batches.length; i++) {
                   const batch = batches[i];
                   work_statusDiv.innerHTML = `<div class="text-blue-600">üì§ Î∞∞Ïπò ${i + 1}/${batches.length} Ï≤òÎ¶¨ Ï§ë... (${totalInserted}Í∞ú ÏôÑÎ£å)</div>`;
                   
                   try {
                     const { data: result, error: insertError } = await supabase
                       .from('vwtm_list_data')
                       .insert(batch);
                     
                     if (insertError) {
                       console.error(`‚ùå Batch ${i + 1} insert error:`, insertError);
                       failedBatches.push({ batchIndex: i, error: insertError });
                       continue;
                     }
                     
                     if (result) {
                       totalInserted += result.length;
                     }
                   } catch (batchError) {
                     console.error(`‚ùå Batch ${i + 1} unexpected error:`, batchError);
                     failedBatches.push({ batchIndex: i, error: batchError });
                   }
                 }
                 
                 // Í≤∞Í≥º ÌëúÏãú
                 if (failedBatches.length > 0) {
                   const successRate = ((batches.length - failedBatches.length) / batches.length * 100).toFixed(1);
                   work_statusDiv.innerHTML = `<div class="text-yellow-600">‚ö†Ô∏è ÏóÖÎ°úÎìú ÏôÑÎ£å: ${totalInserted}Í∞ú ÏÑ±Í≥µ, ${failedBatches.length}Í∞ú Î∞∞Ïπò Ïã§Ìå® (${successRate}% ÏÑ±Í≥µÎ•†)</div>`;
                 } else {
                   work_statusDiv.innerHTML = `<div class="text-green-600">‚úÖ ÏóÖÎ°úÎìú ÏôÑÎ£å: ${totalInserted}Í∞ú Î†àÏΩîÎìúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!</div>`;
                 }
                 
                 // ÎØ∏Î¶¨Î≥¥Í∏∞ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
                 if (validatedData.length > 0) {
                   let tableHTML = '<h3 class="text-lg font-semibold mb-4">ÏóÖÎ°úÎìúÎêú Îç∞Ïù¥ÌÑ∞ ÎØ∏Î¶¨Î≥¥Í∏∞:</h3>';
                     tableHTML += '<div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-300">';
                     
                     // Ìó§Îçî
                     tableHTML += '<thead class="bg-gray-50"><tr>';
                   const headers = ['Pallet No', 'Location', 'Rack No', 'TM No', 'Part No', 'Hold Whether', 'Prod Date'];
                   headers.forEach(header => {
                     tableHTML += `<th class="px-4 py-2 border-b text-left">${header}</th>`;
                     });
                     tableHTML += '</tr></thead>';
                     
                   // Îç∞Ïù¥ÌÑ∞ Ìñâ (Ï≤òÏùå 10Í∞úÎßå)
                     tableHTML += '<tbody>';
                   validatedData.slice(0, 10).forEach(row => {
                       tableHTML += '<tr>';
                     tableHTML += `<td class="px-4 py-2 border-b">${row.pallet_no || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.location || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.rack_no || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.tm_no || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.part_no || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.hold_whether || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.prod_date || ''}</td>`;
                       tableHTML += '</tr>';
                     });
                     tableHTML += '</tbody></table></div>';
                     
                   if (validatedData.length > 10) {
                     tableHTML += `<p class="text-sm text-gray-600 mt-2">Ï¥ù ${validatedData.length}Í∞ú Ìñâ Ï§ë Ï≤òÏùå 10Í∞ú ÌñâÏùÑ ÌëúÏãúÌï©ÎãàÎã§.</p>`;
                     }
                     
                     tableDiv.innerHTML = tableHTML;
                   }
                 
                 } catch (error) {
                 console.error('‚ùå Upload failed:', error);
                 work_statusDiv.innerHTML = `<div class="text-red-600">‚ùå ÏóÖÎ°úÎìú Ïã§Ìå®: ${error.message}</div>`;
               }
             }
             
             // Excel ÌååÏùº ÏùΩÍ∏∞ Ìï®Ïàò
             function readExcelFile(file) {
               return new Promise((resolve, reject) => {
                 const reader = new FileReader();
                 
                 reader.onload = (e) => {
                   try {
                     const data = new Uint8Array(e.target.result);
                     const workbook = XLSX.read(data, { type: 'array' });
                     const sheetName = workbook.SheetNames[0];
                     const worksheet = workbook.Sheets[sheetName];
                     const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                     
                     // 5ÌñâÎ∂ÄÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏãúÏûë (Ïù∏Îç±Ïä§ 4Î∂ÄÌÑ∞)
                     const startRow = 4;
                     const dataRows = jsonData.slice(startRow).filter(row => 
                       row && row.length > 0 && row.some(cell => cell !== undefined && cell !== '')
                     );
                     
                     resolve(dataRows);
                   } catch (error) {
                     reject(new Error(`Excel parsing failed: ${error.message}`));
                   }
                 };
                 
                 reader.onerror = () => reject(new Error('File reading failed'));
               reader.readAsArrayBuffer(file);
               });
             }
             
             // Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Ìï®Ïàò
             function validateData(data) {
               if (!data || !Array.isArray(data)) {
                 return [];
               }
               
               const validatedData = [];
               
               data.forEach((row, index) => {
                 try {
                   if (!row || !Array.isArray(row) || row.length < 10) {
                     return;
                   }
                   
                   const rowData = {
                     pallet_no: String(row[1] || '').trim().substring(0, 100),
                     location: String(row[2] || '').trim().substring(0, 100),
                     rack_no: String(row[3] || '').trim().substring(0, 100),
                     tm_no: String(row[4] || '').trim().substring(0, 100),
                     part_no: String(row[5] || '').trim().substring(0, 100),
                     hold_whether: String(row[7] || 'N').trim().substring(0, 10),
                     prod_date: String(row[9] || '').trim().substring(0, 50)
                   };
                   
                   if (rowData.pallet_no && rowData.tm_no) {
                     validatedData.push(rowData);
                   }
                 } catch (rowError) {
                   console.error(`‚ùå Error processing row ${index + 1}:`, rowError);
                 }
               });
               
               return validatedData;
             }

             // STATUS ÌéòÏù¥ÏßÄÎ•º ÏÉà ÌÉ≠ÏóêÏÑú Ïó¥Í∏∞
             function openStatusInNewTab() {
               // Î°úÏª¨Í≥º ÎèôÏùºÌïòÍ≤å ÏûëÎèôÌïòÎèÑÎ°ù ÏÉÅÎåÄ Í≤ΩÎ°ú ÏÇ¨Ïö©
               const statusUrl = './pages/truck/status.html';
               window.open(statusUrl, '_blank');
             }
             
             // ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä Ìï®Ïàò
             function toggleSidebar() {
               const sidebar = document.getElementById('sidebar');
               const mainContent = document.getElementById('mainContent');
               
               if (sidebar.style.display === 'none') {
                 // ÏÇ¨Ïù¥ÎìúÎ∞î ÌëúÏãú
                 sidebar.style.display = 'block';
                 mainContent.style.marginLeft = '256px';
                 mainContent.style.width = 'calc(100% - 256px)';
                 console.log('üìè Sidebar shown');
               } else {
                 // ÏÇ¨Ïù¥ÎìúÎ∞î Ïà®Í∏∞Í∏∞
                 sidebar.style.display = 'none';
                 mainContent.style.marginLeft = '0';
                 mainContent.style.width = '100%';
                 console.log('üìè Sidebar hidden');
               }
             }
             
             // Ï†ÑÏ≤¥ÌôîÎ©¥ Î™®Îìú ÌÜ†Í∏Ä Ìï®Ïàò
             function toggleFullscreenMode() {
               if (!document.fullscreenElement) {
                 // Ï†ÑÏ≤¥ÌôîÎ©¥ Î™®Îìú ÏßÑÏûÖ
                 document.documentElement.requestFullscreen().then(() => {
                   console.log('üñ•Ô∏è Entered fullscreen mode');
                 }).catch(err => {
                   console.error('‚ùå Error entering fullscreen:', err);
                 });
               } else {
                 // Ï†ÑÏ≤¥ÌôîÎ©¥ Î™®Îìú Ï¢ÖÎ£å
                 document.exitFullscreen().then(() => {
                   console.log('üñ•Ô∏è Exited fullscreen mode');
                 }).catch(err => {
                   console.error('‚ùå Error exiting fullscreen:', err);
                 });
               }
             }

             // ÏãúÍ∞Ñ Í∞ÑÍ≤© Í∞êÏßÄ Î∞è Í≥µÎ∞± ÌëúÏãú Ìï®Ïàò
             function detectTimeGaps() {
               if (!window.adminScheduleData || window.adminScheduleData.length === 0) return [];
               
               const gaps = [];
               const sortedData = [...window.adminScheduleData].sort((a, b) => {
                 const timeA = a.work_start_time ? a.work_start_time : '23:59';
                 const timeB = b.work_start_time ? b.work_start_time : '23:59';
                 return timeA.localeCompare(timeB);
               });
               
               // 8Ïãú Í∏∞Ï§Ä ÏãúÏûë ÏãúÍ∞Ñ Í≥ÑÏÇ∞
               const baseTime = '08:00';
               const baseMinutes = timeToMinutes(baseTime);
               
               for (let i = 0; i < sortedData.length; i++) {
                 const current = sortedData[i];
                 const next = sortedData[i + 1];
                 
                 if (current.work_start_time) {
                   const currentMinutes = timeToMinutes(current.work_start_time);
                   const gapMinutes = currentMinutes - baseMinutes;
                   
                   // 8Ïãú Ïù¥ÌõÑ ÏãúÏûëÌïòÎäî Í≤ΩÏö∞ Í≥µÎ∞± Ï∂îÍ∞Ä
                   if (gapMinutes > 0 && i === 0) {
                     gaps.push({
                       type: 'start_gap',
                       startTime: baseTime,
                       endTime: current.work_start_time,
                       duration: gapMinutes,
                       position: 'before_first'
                     });
                   }
                   
                   // Îã§Ïùå Ìï≠Î™©Í≥ºÏùò Í∞ÑÍ≤© ÌôïÏù∏
                   if (next && next.work_start_time) {
                     const nextMinutes = timeToMinutes(next.work_start_time);
                     const currentEndMinutes = current.work_end_time ? timeToMinutes(current.work_end_time) : currentMinutes;
                     const gapBetween = nextMinutes - currentEndMinutes;
                     
                     if (gapBetween > 0) {
                       gaps.push({
                         type: 'between_gaps',
                         startTime: current.work_end_time || current.work_start_time,
                         endTime: next.work_start_time,
                         duration: gapBetween,
                         position: `between_${current.seq_no}_${next.seq_no}`
                       });
                     }
                   }
                 }
               }
               
               return gaps;
             }
             
             // ÏãúÍ∞ÑÏùÑ Î∂ÑÏúºÎ°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
             function timeToMinutes(timeStr) {
               if (!timeStr) return 0;
               const [hours, minutes] = timeStr.split(':').map(Number);
               return hours * 60 + minutes;
             }
             
             // Î∂ÑÏùÑ ÏãúÍ∞Ñ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
             function minutesToTime(minutes) {
               const hours = Math.floor(minutes / 60);
               const mins = minutes % 60;
               return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
             }
             
             // Admin ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
             function initializeAdminPage() {
               console.log('üöÄ Initializing Admin page...');
               
               // Admin ÌéòÏù¥ÏßÄ Î≥ÄÏàòÎì§
               window.adminScheduleData = [];
               window.adminSelectedDate = new Date().toISOString().split('T')[0];
               
               // ÎÇ†Ïßú ÏÑ†ÌÉùÍ∏∞ ÏÑ§Ï†ï
               const dateSelector = document.getElementById('dateSelector');
               if (dateSelector) {
                 dateSelector.value = window.adminSelectedDate;
               }
               
               // Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Supabase + Mock)
               loadAdminScheduleData();
               
               // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë
               setTimeout(() => {
                 toggleAdminAutoRefresh();
               }, 1000); // 1Ï¥à ÌõÑ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë
               
               console.log('‚úÖ Admin page initialization completed');
             }

             // Admin ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ
             function renderAdminTable() {
               const container = document.getElementById('scheduleTable');
               if (!container) {
                 console.error('‚ùå Schedule table container not found');
                 return;
               }
               
               console.log('üî® Rendering Admin table...');
               console.log('All schedule data:', window.adminScheduleData);
               
               // Î™®Îì† Ìï≠Î™©ÏùÑ ID ÏàúÏÑúÎåÄÎ°ú Ï†ïÎ†¨
               const sortedData = window.adminScheduleData.sort((a, b) => {
                 return (a.seq_no || 0) - (b.seq_no || 0);
               });
               
               let tableHTML = `
                 <div class="overflow-x-auto h-full">
                   <table class="min-w-full divide-y divide-gray-200">
                     <thead class="bg-gray-50">
                       <tr>
                         <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                         <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÌååÌä∏</th>
                         <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÏãúÏûë ÏãúÍ∞Ñ</th>
                         <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ï¢ÖÎ£å ÏãúÍ∞Ñ</th>
                         <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÏÉÅÌÉú</th>
                         <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÎπÑÍ≥†</th>
                         <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÏûëÏóÖ</th>
                       </tr>
                     </thead>
                     <tbody class="bg-white divide-y divide-gray-200">
               `;
               
               sortedData.forEach((item, index) => {
                 const work_status = calculateStatus(item);
                 const isGapTime = item.work_status === 'gap';
                 
                 const work_statusColor = isGapTime ? 'bg-blue-100 text-blue-800' :
                                   work_status === 'completed' ? 'bg-green-100 text-green-800' :
                                   work_status === 'active' ? 'bg-yellow-100 text-yellow-800' :
                                   'bg-gray-100 text-gray-800';
                 
                 const gapTime = calculateGapTime(item, sortedData, index);
                 const isPartSelected = item.part_no && item.part_no.trim() !== '';
                 const isCompleted = work_status === 'completed';
                 const rowClass = isGapTime ? 'bg-blue-50 hover:bg-blue-100' :
                                 isPartSelected ? 'hover:bg-gray-50' : 'bg-gray-100 hover:bg-gray-200';
                 
                 tableHTML += `
                   <tr class="${rowClass}" data-index="${sortedData.indexOf(item)}">
                     <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                       ${item.seq_no || 'NEW'}
                     </td>
                     <td class="px-3 py-2 whitespace-nowrap">
                       ${isGapTime ? 
                         `<span class="px-2 py-1 text-sm font-medium text-blue-800 bg-blue-100 rounded">Í≥µÎ∞±</span>` :
                         `<select class="px-2 py-1 text-sm border border-gray-300 rounded ${isCompleted ? 'bg-gray-200 cursor-not-allowed' : ''}" 
                               onchange="updateScheduleData(${sortedData.indexOf(item)}, 'part_no', this.value)"
                               ${isCompleted ? 'disabled' : ''}>
                           <option value="" ${!item.part_no ? 'selected' : ''}>ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                           <option value="24" ${item.part_no === '24' ? 'selected' : ''}>24</option>
                           <option value="33" ${item.part_no === '33' ? 'selected' : ''}>33</option>
                           <option value="34" ${item.part_no === '34' ? 'selected' : ''}>34</option>
                           <option value="35" ${item.part_no === '35' ? 'selected' : ''}>35</option>
                           <option value="79" ${item.part_no === '79' ? 'selected' : ''}>79</option>
                           <option value="80" ${item.part_no === '80' ? 'selected' : ''}>80</option>
                           <option value="4GV3" ${item.part_no === '4GV3' ? 'selected' : ''}>4GV3</option>
                           <option value="4GF8" ${item.part_no === '4GF8' ? 'selected' : ''}>4GF8</option>
                           <option value="SWAP" ${item.part_no === 'SWAP' ? 'selected' : ''}>SWAP</option>
                         </select>`
                       }
                     </td>
                     <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                       ${item.work_start_time || '-'}
                     </td>
                     <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                       ${item.work_end_time || '-'}
                     </td>
                     <td class="px-3 py-2 whitespace-nowrap">
                       <span class="px-2 py-1 text-xs font-semibold rounded-full ${work_statusColor}">
                         ${isGapTime ? 'Í≥µÎ∞±' :
                           isPartSelected ? (work_status === 'completed' ? 'ÏôÑÎ£å' : work_status === 'active' ? 'ÏßÑÌñâÏ§ë' : 'ÎåÄÍ∏∞') : 'ÎØ∏ÏÑ†ÌÉù'}
                       </span>
                     </td>
                     <td class="px-3 py-2 whitespace-nowrap">
                       <div class="flex items-center space-x-3">
                         <input type="text" value="${item.work_note || ''}" placeholder="ÎπÑÍ≥† ÏûÖÎ†•" 
                                class="w-40 px-3 py-2 text-sm border border-gray-300 rounded" 
                                onchange="updateScheduleData(${sortedData.indexOf(item)}, 'work_note', this.value)">
                         ${gapTime ? `
                           <div class="flex items-center space-x-2">
                             <span class="text-sm text-red-600 font-medium">${gapTime}</span>
                             <input type="text" value="${item.delay_reason || ''}" placeholder="Í≥µÎ∞± Ïù¥Ïú†" 
                                    class="w-32 px-2 py-2 text-sm border border-gray-300 rounded" 
                                    onchange="updateScheduleData(${sortedData.indexOf(item)}, 'delay_reason', this.value)">
                           </div>
                         ` : ''}
                       </div>
                     </td>
                     <td class="px-3 py-2 whitespace-nowrap">
                       <button onclick="openTimeEditModal(${sortedData.indexOf(item)})" class="text-blue-600 hover:text-blue-800 text-sm mr-2">ÏàòÏ†ï</button>
                       <button onclick="deleteScheduleRow(${sortedData.indexOf(item)})" class="text-red-600 hover:text-red-800 text-sm">ÏÇ≠Ï†ú</button>
                     </td>
                   </tr>
                 `;
               });
               
               tableHTML += `
                     </tbody>
                   </table>
                 </div>
               `;
               
               container.innerHTML = tableHTML;
               console.log('‚úÖ Admin table rendered with', sortedData.length, 'rows');
             }

             // Admin Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Supabase + Mock)
            async function loadAdminScheduleData() {
              try {
                // SupabaseÍ∞Ä Ï§ÄÎπÑÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
                let retries = 0;
                const maxRetries = 10;
                
                while ((!window.supabase || typeof window.supabase.from !== 'function') && retries < maxRetries) {
                  console.log(`‚è≥ Waiting for Supabase... (attempt ${retries + 1}/${maxRetries})`);
                  await new Promise(resolve => setTimeout(resolve, 200));
                  retries++;
                }
                
                if (!window.supabase || typeof window.supabase.from !== 'function') {
                  throw new Error('Supabase not available after waiting');
                }
                
                const { data, error } = await window.supabase
                  .from('tm_packaging_schedule')
                  .select('*')
                  .eq('work_date', window.adminSelectedDate);
                
                if (error) throw error;
                window.adminScheduleData = data || [];
                console.log('‚úÖ Admin schedule data loaded from Supabase:', window.adminScheduleData);
                
                renderAdminTable();
                updateAdminStatistics();
              } catch (error) {
                console.error('Error loading admin schedule data:', error);
                console.warn('‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. Supabase Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                window.adminScheduleData = [];
                renderAdminTable();
                updateAdminStatistics();
              }
            }


             // ÏÉÅÌÉú ÏûêÎèô Í≥ÑÏÇ∞
             function calculateStatus(item) {
               if (item.work_start_time && item.work_end_time) {
                 return 'completed';
               } else if (item.work_start_time) {
                 return 'active';
               } else {
                 return 'waiting';
               }
             }

             // ÏãúÍ∞Ñ Í∞ÑÍ≤© Í≥ÑÏÇ∞
             function calculateGapTime(item, sortedData, index) {
               if (index === 0) return null;
               
               const prevItem = sortedData[index - 1];
               if (!prevItem || prevItem.part_no !== item.part_no) return null;
               
               if (prevItem.work_end_time && item.work_start_time) {
                 const prevEnd = new Date(`2000-01-01 ${prevItem.work_end_time}`);
                 const currentStart = new Date(`2000-01-01 ${item.work_start_time}`);
                 const diffMinutes = (currentStart - prevEnd) / (1000 * 60);
                 
                 if (diffMinutes > 0) {
                   return `+${Math.round(diffMinutes)}Î∂Ñ`;
                 }
               }
               
               return null;
             }

             // ÏãúÍ∞Ñ ÏàòÏ†ï Î™®Îã¨ Ïó¥Í∏∞
             function openTimeEditModal(index) {
               window.currentEditIndex = index;
               
               const item = window.adminScheduleData[index];
               const modal = document.getElementById('timeEditModal');
               const startTimeInput = document.getElementById('editStartTime');
               const endTimeInput = document.getElementById('editEndTime');
               
               startTimeInput.value = item.work_start_time || '';
               endTimeInput.value = item.work_end_time || '';
               
               modal.classList.remove('hidden');
               modal.classList.add('flex');
             }

             // ÏãúÍ∞Ñ ÏàòÏ†ï Î™®Îã¨ Îã´Í∏∞
             function closeTimeEditModal() {
               const modal = document.getElementById('timeEditModal');
               modal.classList.add('hidden');
               modal.classList.remove('flex');
             }

             // ÏãúÍ∞Ñ ÏàòÏ†ï Ï†ÄÏû•
             function saveTimeEdit() {
               const index = window.currentEditIndex;
               const startTime = document.getElementById('editStartTime').value;
               const endTime = document.getElementById('editEndTime').value;
               
               window.adminScheduleData[index].work_start_time = startTime;
               window.adminScheduleData[index].work_end_time = endTime;
               
               closeTimeEditModal();
               renderAdminTable();
               updateAdminStatistics();
               
               // ÏûêÎèô Ï†ÄÏû•
               autoSaveSchedule();
             }

             // Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
             function updateScheduleData(index, field, value) {
               if (window.adminScheduleData[index]) {
                 window.adminScheduleData[index][field] = value;
                 
                 console.log(`Updated schedule data [${index}].${field} = ${value}`);
                 renderAdminTable();
                 updateAdminStatistics();
                 
                 // ÏûêÎèô Ï†ÄÏû• (ÎîîÎ∞îÏö¥Ïä§ Ï†ÅÏö©)
                 clearTimeout(window.autoSaveTimeout);
                 window.autoSaveTimeout = setTimeout(() => {
                   autoSaveSchedule();
                 }, 1000); // 1Ï¥à ÌõÑ ÏûêÎèô Ï†ÄÏû•
               }
             }

             // Ïä§ÏºÄÏ§Ñ Ìñâ ÏÇ≠Ï†ú
             function deleteScheduleRow(index) {
               if (confirm('Ïù¥ ÌñâÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                 window.adminScheduleData.splice(index, 1);
                 renderAdminTable();
                 updateAdminStatistics();
                 console.log(`Deleted schedule row ${index}`);
                 
                 // ÏûêÎèô Ï†ÄÏû•
                 autoSaveSchedule();
               }
             }

             // Admin ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
             function updateAdminStatistics() {
               // Í≥µÎ∞± ÏãúÍ∞ÑÏùÑ Ï†úÏô∏Ìïú Ïã§Ï†ú ÏûëÏóÖ Ìï≠Î™©Îßå Í≥ÑÏÇ∞
               const workItems = window.adminScheduleData.filter(item => item.work_status !== 'gap');
               
               const totalItems = workItems.length;
               const completedItems = workItems.filter(item => calculateStatus(item) === 'completed').length;
               const activeItems = workItems.filter(item => calculateStatus(item) === 'active').length;
               
               const totalRoundsEl = document.getElementById('totalRounds');
               const completedRoundsEl = document.getElementById('completedRounds');
               const activeRoundsEl = document.getElementById('activeRounds');
               
               if (totalRoundsEl) totalRoundsEl.textContent = totalItems;
               if (completedRoundsEl) completedRoundsEl.textContent = completedItems;
               if (activeRoundsEl) activeRoundsEl.textContent = activeItems;
             }

             // Admin Ìï®ÏàòÎì§
            function addNewRow() {
              console.log('üîÑ Adding new row...');
              console.log('Current data before adding:', window.adminScheduleData);
              
              // Îã§Ïùå ÏãúÌÄÄÏä§ Î≤àÌò∏ ÏÉùÏÑ±
              const maxSeq = Math.max(0, ...window.adminScheduleData.map(item => item.seq_no || 0));
              const nextSequenceNumber = maxSeq + 1;
              
              const newRow = {
                work_date: window.adminSelectedDate,
                seq_no: nextSequenceNumber,
                part_no: '',
                work_start_time: '',
                work_end_time: '',
                work_status: 'waiting', // Í∏∞Î≥∏ ÏÉÅÌÉúÎäî ÎåÄÍ∏∞
                work_note: '',
                delay_reason: '',
                isNew: true // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌñâÏûÑÏùÑ ÌëúÏãú
              };
               
               window.adminScheduleData.push(newRow);
               console.log('New row added:', newRow);
               console.log('Data after adding:', window.adminScheduleData);
               
               renderAdminTable();
               updateAdminStatistics();
               console.log('‚úÖ Added new schedule row');
               
               // ÏûêÎèô Ï†ÄÏû• (ÎîîÎ∞îÏö¥Ïä§ Ï†ÅÏö©)
               clearTimeout(window.autoSaveTimeout);
               window.autoSaveTimeout = setTimeout(() => {
                 autoSaveSchedule();
               }, 1000); // 1Ï¥à ÌõÑ ÏûêÎèô Ï†ÄÏû•
             }

            // ÏûêÎèô Ï†ÄÏû• Ìï®Ïàò (ÏïåÎ¶º ÏóÜÏù¥ Ï°∞Ïö©Ìûà Ï†ÄÏû•)
            async function autoSaveSchedule() {
              try {
                // Î™®Îì† Ìï≠Î™©ÏùÑ Ï†ÄÏû• (ÌååÌä∏Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ Ìï≠Î™©ÎèÑ Ìè¨Ìï®)
                const allData = window.adminScheduleData;
                
                if (allData.length === 0) {
                  console.log('‚ö†Ô∏è No data to save');
                  return;
                }
                
                if (!window.supabase || typeof window.supabase.from !== 'function') {
                  console.log('‚ö†Ô∏è Supabase not available, auto-save skipped');
                  return;
                }
                
                // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                const { error: deleteError } = await window.supabase
                  .from('tm_packaging_schedule')
                  .delete()
                  .eq('work_date', window.adminSelectedDate);
                
                if (deleteError) throw deleteError;
                
                // ÏÉà Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ (seq_no Ìè¨Ìï®)
                const { data: insertedData, error: insertError } = await window.supabase
                  .from('tm_packaging_schedule')
                  .insert(allData.map(item => ({
                    work_date: item.work_date || window.adminSelectedDate,
                    seq_no: item.seq_no,
                    part_no: item.part_no,
                    work_start_time: item.work_start_time || null,
                    work_end_time: item.work_end_time || null,
                    work_status: item.work_status || 'waiting',
                    work_note: item.work_note || '',
                    delay_reason: item.delay_reason || ''
                  })))
                  .select();
                
                if (insertError) throw insertError;
                
                // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î°ú Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                if (insertedData && insertedData.length > 0) {
                  window.adminScheduleData = insertedData;
                  console.log('‚úÖ Auto-saved successfully:', window.adminScheduleData);
                }
                
                updateAdminStatistics();
              } catch (error) {
                console.error('Error auto-saving schedule:', error);
              }
            }

             async function saveSchedule() {
               // Î™®Îì† Ìï≠Î™©ÏùÑ Ï†ÄÏû• (ÌååÌä∏Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ Ìï≠Î™©ÎèÑ Ìè¨Ìï®)
               const allData = window.adminScheduleData;
               
               if (allData.length === 0) {
                 console.warn('‚ö†Ô∏è Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                 return;
               }
               
               try {
                 if (!window.supabase || typeof window.supabase.from !== 'function') {
                   throw new Error('Supabase not available');
                 }
                 
                 // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                 const { error: deleteError } = await window.supabase
                   .from('tm_packaging_schedule')
                   .delete()
                   .eq('work_date', window.adminSelectedDate);
                 
                 if (deleteError) throw deleteError;
                 
                 // ÏÉà Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ (seq_no Ìè¨Ìï®)
                 const { data: insertedData, error: insertError } = await window.supabase
                   .from('tm_packaging_schedule')
                   .insert(allData.map(item => ({
                    work_date: item.work_date || window.adminSelectedDate,
                    seq_no: item.seq_no,
                    part_no: item.part_no,
                    work_start_time: item.work_start_time || null,
                    work_end_time: item.work_end_time || null,
                    work_status: item.work_status || 'waiting',
                    work_note: item.work_note || '',
                    delay_reason: item.delay_reason || ''
                  })))
                   .select();
                 
                 if (insertError) throw insertError;
                 
                 // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î°ú Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                 if (insertedData && insertedData.length > 0) {
                   window.adminScheduleData = insertedData;
                   console.log('‚úÖ Local data updated with saved data:', window.adminScheduleData);
                 }
                 
                 console.log('‚úÖ Schedule saved to Supabase');
                 console.log(`‚úÖ Ïä§ÏºÄÏ§ÑÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§. (${allData.length}Í∞ú Ìï≠Î™©)`);
                 updateAdminStatistics();
               } catch (error) {
                 console.error('Error saving schedule:', error);
                 console.warn('‚ö†Ô∏è Ïä§ÏºÄÏ§Ñ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
               }
             }

             function loadScheduleForDate() {
               const dateSelector = document.getElementById('dateSelector');
               if (dateSelector) {
                 window.adminSelectedDate = dateSelector.value;
               }
               loadAdminScheduleData();
             }

             function loadTodaySchedule() {
               const today = new Date().toISOString().split('T')[0];
               const dateSelector = document.getElementById('dateSelector');
               if (dateSelector) {
                 dateSelector.value = today;
               }
               window.adminSelectedDate = today;
               loadAdminScheduleData();
             }

             function refreshData() {
               loadAdminScheduleData();
             }

             // Admin ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÌÜ†Í∏Ä
             function toggleAdminAutoRefresh() {
               if (window.adminAutoRefreshInterval) {
                 // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ï§ëÏßÄ
                 clearInterval(window.adminAutoRefreshInterval);
                 window.adminAutoRefreshInterval = null;
                 
                 const btn = document.getElementById('adminAutoRefreshBtn');
                 if (btn) {
                   btn.textContent = '‚è∏Ô∏è AUTO: OFF';
                   btn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors';
                 }
                 console.log('‚èπÔ∏è Admin auto-refresh stopped');
               } else {
                 // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë
                 window.adminAutoRefreshInterval = setInterval(() => {
                   console.log('üîÑ Auto-refreshing Admin data...');
                   loadAdminScheduleData();
                 }, 30000); // 30Ï¥àÎßàÎã§
                 
                 const btn = document.getElementById('adminAutoRefreshBtn');
                 if (btn) {
                   btn.textContent = 'üîÑ AUTO: ON';
                   btn.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors';
                 }
                 console.log('üöÄ Admin auto-refresh started (30s interval)');
               }
             }

             // ===== SUPERVISOR CONTROL FUNCTIONS =====
             
             // Ïñ∏Ïñ¥ ÏÑ§Ï†ï (Í∏∞Î≥∏Í∞í: ES)
             window.supervisorLanguage = 'es';
             
             // ÏÑ†ÌÉùÎêú ÏûëÏóÖ Ï∂îÏ†Å
             window.selectedSupervisorTask = null;
             
             // Ï§å Î†àÎ≤® Í¥ÄÎ¶¨
             window.supervisorZoomLevel = 1.1;
             
             // Ï§å Ïù∏ Ìï®Ïàò
             function zoomIn() {
               if (window.supervisorZoomLevel < 3.0) {
                 window.supervisorZoomLevel += 0.2;
                 applyZoom();
               }
             }
             
             // Ï§å ÏïÑÏõÉ Ìï®Ïàò
             function zoomOut() {
               if (window.supervisorZoomLevel > 0.8) {
                 window.supervisorZoomLevel -= 0.2;
                 applyZoom();
               }
             }
             
             // Ï§å Ï†ÅÏö© Ìï®Ïàò
             function applyZoom() {
               const mainContainer = document.querySelector('#mainContent > div');
               if (mainContainer) {
                 mainContainer.style.transform = `scaleY(${window.supervisorZoomLevel})`;
                 
                 // Ï§å Î†àÎ≤® ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                 const zoomLevelEl = document.getElementById('zoomLevel');
                 if (zoomLevelEl) {
                   zoomLevelEl.textContent = Math.round(window.supervisorZoomLevel * 100) + '%';
                 }
                 
                 console.log(`üîç Zoom level: ${Math.round(window.supervisorZoomLevel * 100)}%`);
               }
             }
             
             // Î≤àÏó≠ Îç∞Ïù¥ÌÑ∞
             const supervisorTranslations = {
               en: {
                 title: 'Packaging Work Management',
                 subtitle: 'Supervisor Control Panel',
                 currentTime: 'Current Time',
                 todayDate: 'Today\'s Date',
                 currentId: 'Current ID',
                 currentPart: 'Current Part',
                 elapsedTime: 'Elapsed Time',
                 currentWork: 'Current Work',
                 nextWork: 'Next Work',
                 idSelection: 'üéØ Task ID Selection',
                 startWork: 'üöÄ Start Work',
                 cancelWork: '‚ùå Cancel Start',
                 endWork: '‚èπÔ∏è End Work',
                 startTime: 'Start Time',
                 endTime: 'End Time',
                 scheduleTable: 'Today\'s Schedule',
                 part: 'Part',
                 start: 'Start',
                 end: 'End',
                 work_status: 'Status',
                 completed: 'Completed',
                 active: 'Active',
                 waiting: 'Waiting',
                 anotherActive: 'Another task is already active'
               },
               es: {
                 title: 'Gesti√≥n de Trabajo de Empaque',
                 subtitle: 'Panel de Control del Supervisor',
                 currentTime: 'Hora Actual',
                 todayDate: 'Fecha de Hoy',
                 currentId: 'ID Actual',
                 currentPart: 'Parte Actual',
                 elapsedTime: 'Tiempo Transcurrido',
                 currentWork: 'Trabajo Actual',
                 nextWork: 'Siguiente Trabajo',
                 idSelection: 'üéØ Selecci√≥n de ID de Tarea',
                 startWork: 'üöÄ Iniciar Trabajo',
                 cancelWork: '‚ùå Cancelar Inicio',
                 endWork: '‚èπÔ∏è Finalizar Trabajo',
                 startTime: 'Hora de Inicio',
                 endTime: 'Hora de Finalizaci√≥n',
                 scheduleTable: 'Horario de Hoy',
                 part: 'Parte',
                 start: 'Inicio',
                 end: 'Fin',
                 work_status: 'Estado',
                 completed: 'Completado',
                 active: 'Activo',
                 waiting: 'Esperando',
                 anotherActive: 'Otra tarea ya est√° activa'
               }
             };
             
             // Ïñ∏Ïñ¥ Ï†ÑÌôò Ìï®Ïàò
             function setSupervisorLanguage(lang) {
               window.supervisorLanguage = lang;
               updateSupervisorLanguage();
               
               // Î≤ÑÌäº Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
               document.getElementById('langEn').className = lang === 'en' ? 
                 'px-4 py-2 text-sm font-semibold rounded bg-blue-100 text-blue-800 border border-blue-300' :
                 'px-4 py-2 text-sm font-semibold rounded bg-gray-100 text-gray-600 border border-gray-300';
               document.getElementById('langEs').className = lang === 'es' ? 
                 'px-4 py-2 text-sm font-semibold rounded bg-blue-100 text-blue-800 border border-blue-300' :
                 'px-4 py-2 text-sm font-semibold rounded bg-gray-100 text-gray-600 border border-gray-300';
               
               // ÌÖåÏù¥Î∏î Îã§Ïãú Î†åÎçîÎßÅ
               displaySupervisorScheduleTable();
               
               // ID ÏÑ†ÌÉùÍ∏∞ Îã§Ïãú Î†åÎçîÎßÅ
               displaySupervisorIdSelector();
               
               // ÏÑ†ÌÉùÎêú ÏûëÏóÖÏù¥ ÏûàÏúºÎ©¥ Îã§Ïãú ÌëúÏãú
               if (window.selectedSupervisorTask) {
                 selectSupervisorTask(window.selectedSupervisorTask);
               }
             }
             
             // Ïñ∏Ïñ¥ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
             function updateSupervisorLanguage() {
               const t = supervisorTranslations[window.supervisorLanguage];
               
               // Ìó§Îçî
               document.getElementById('supervisorTitle').textContent = t.title;
               document.getElementById('supervisorSubtitle').textContent = t.subtitle;
               document.getElementById('currentTimeLabel').textContent = t.currentTime;
               
               // ÌòÑÏû¨ ÏûëÏóÖ ÎåÄÏãúÎ≥¥Îìú
               document.getElementById('currentWorkTitle').textContent = t.currentWork;
               document.getElementById('nextWorkTitle').textContent = t.nextWork;
               document.getElementById('todayDateLabel').textContent = t.todayDate;
               document.getElementById('currentIdLabel').textContent = t.currentId;
               document.getElementById('currentPartLabel').textContent = t.currentPart;
               document.getElementById('elapsedTimeLabel').textContent = t.elapsedTime;
               
               // ID ÏÑ†ÌÉù
               document.getElementById('idSelectionTitle').innerHTML = t.idSelection;
               
               // ÏûëÏóÖ Ï†úÏñ¥ Î≤ÑÌäº (ÌòÑÏû¨ ÏûëÏóÖ ÎåÄÏãúÎ≥¥Îìú ÎÇ¥)
               document.getElementById('startWorkText').textContent = t.startWork;
               document.getElementById('cancelWorkText').textContent = t.cancelWork;
               document.getElementById('endWorkText').textContent = t.endWork;
               
               // ÌååÌä∏ ÏöîÏïΩ
               document.getElementById('partSummaryTitle').textContent = 'Part Summary';
             }
             
             // Supervisor ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
             function initializeSupervisorPage() {
               console.log('üë®‚Äçüíº Initializing Supervisor page...');
               
               // Ï†ÑÏó≠ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
               window.supervisorScheduleData = [];
               window.supervisorCurrentWork = null;
               window.supervisorWorkStartTime = null;
               window.supervisorTimerInterval = null;
               window.supervisorClockInterval = null;
               window.supervisorSelectedTaskId = null;
               
               // Ïò§Îäò ÎÇ†Ïßú ÏÑ§Ï†ï
               setSupervisorTodayDate();
               
               // ÏãúÍ≥Ñ ÏãúÏûë
               startSupervisorClock();
               
               // Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
               loadSupervisorScheduleData();
               
               // ÌÉÄÏù¥Î®∏ ÏãúÏûë (Í∏∞Ï°¥ ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏)
               startSupervisorTimer();
               
               // Ïñ∏Ïñ¥ ÏóÖÎç∞Ïù¥Ìä∏
               updateSupervisorLanguage();
               
               // Ï§å Ï†ÅÏö©
               setTimeout(() => {
                 applyZoom();
               }, 100);
               
               // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ Îì±Î°ù
               document.addEventListener('keydown', function(e) {
                 if (e.ctrlKey || e.metaKey) {
                   if (e.key === '=' || e.key === '+') {
                     e.preventDefault();
                     zoomIn();
                   } else if (e.key === '-') {
                     e.preventDefault();
                     zoomOut();
                   }
                 }
               });
               
               // ÏûêÎèôÏúºÎ°ú ÌòÑÏû¨ ÏßÑÌñâÏ§ëÏù∏ ÏûëÏóÖ ÎòêÎäî Îã§Ïùå ÏûëÏóÖ ÏÑ†ÌÉù
               setTimeout(() => {
                 autoSelectCurrentTask();
               }, 500);
               
               // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë
               setTimeout(() => {
                 toggleSupervisorAutoRefresh();
               }, 1000); // 1Ï¥à ÌõÑ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë
               
               console.log('‚úÖ Supervisor page initialization completed');
             }

             // Ïò§Îäò ÎÇ†Ïßú ÏÑ§Ï†ï
             function setSupervisorTodayDate() {
               const today = new Date();
               const todayString = today.toLocaleDateString('ko-KR', {
                 year: 'numeric',
                 month: '2-digit',
                 day: '2-digit'
               });
               const todayDateEl = document.getElementById('todayDate');
               if (todayDateEl) {
                 todayDateEl.textContent = todayString;
               }
             }

             // ÏãúÍ≥Ñ ÏãúÏûë
             function startSupervisorClock() {
               updateSupervisorClock();
               window.supervisorClockInterval = setInterval(updateSupervisorClock, 1000);
             }

             // ÏãúÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
             function updateSupervisorClock() {
               const now = new Date();
               const timeString = now.toLocaleTimeString('ko-KR', { 
                 hour12: false,
                 hour: '2-digit',
                 minute: '2-digit',
                 second: '2-digit'
               });
               const currentTimeEl = document.getElementById('currentTime');
               if (currentTimeEl) {
                 currentTimeEl.textContent = timeString;
               }
             }

             // Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            async function loadSupervisorScheduleData() {
              try {
                // SupabaseÍ∞Ä Ï§ÄÎπÑÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
                let retries = 0;
                const maxRetries = 10;
                
                while ((!window.supabase || typeof window.supabase.from !== 'function') && retries < maxRetries) {
                  console.log(`‚è≥ Waiting for Supabase... (attempt ${retries + 1}/${maxRetries})`);
                  await new Promise(resolve => setTimeout(resolve, 200));
                  retries++;
                }
                
                if (!window.supabase || typeof window.supabase.from !== 'function') {
                  throw new Error('Supabase not available after waiting');
                }
                
                const today = new Date().toISOString().split('T')[0];
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                console.log(`üîÑ Loading schedule data for ${today} and ${tomorrowStr}`);
                
                const { data, error } = await window.supabase
                  .from('tm_packaging_schedule')
                  .select('*')
                  .in('work_date', [today, tomorrowStr])
                  .order('work_date', { ascending: true })
                  .order('seq_no', { ascending: true });
                
                if (error) throw error;
                window.supervisorScheduleData = data || [];
                
                console.log(`‚úÖ Loaded ${window.supervisorScheduleData.length} schedule items`);
                
                // ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖÏù¥ ÏûàÏúºÎ©¥ ÌòÑÏû¨ ÏûëÏóÖÏúºÎ°ú ÏÑ§Ï†ï
                const activeWork = window.supervisorScheduleData.find(item => item.work_status === 'active');
                if (activeWork && activeWork.work_start_time) {
                  // ÏãúÏûë ÏãúÍ∞ÑÏùÑ Date Í∞ùÏ≤¥Î°ú Î≥ÄÌôò (Ïò§Îäò ÎÇ†Ïßú + ÏãúÏûë ÏãúÍ∞Ñ)
                  const today = new Date();
                  const [hours, minutes] = activeWork.work_start_time.split(':');
                  const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parseInt(hours), parseInt(minutes));
                  
                  window.supervisorCurrentWork = activeWork;
                  window.supervisorWorkStartTime = startTime;
                  
                  console.log(`üîÑ Found active work from Supabase: Sequence ${activeWork.seq_no}, started at ${activeWork.work_start_time}`);
                }
                
                console.log('‚úÖ Supervisor schedule data loaded successfully');
                
                displaySupervisorIdSelector();
                displaySupervisorScheduleTable();
                updateSupervisorCurrentStatus();
                
                // ÏûêÎèôÏúºÎ°ú ÌòÑÏû¨ ÏßÑÌñâÏ§ëÏù∏ ÏûëÏóÖ ÎòêÎäî Îã§Ïùå ÏûëÏóÖ ÏÑ†ÌÉù
                autoSelectCurrentTask();
              } catch (error) {
                console.error('Error loading supervisor schedule data:', error);
                console.warn('‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. Supabase Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                window.supervisorScheduleData = [];
                displaySupervisorIdSelector();
                displaySupervisorScheduleTable();
                updateSupervisorCurrentStatus();
              }
            }


             // ID ÏÑ†ÌÉùÍ∏∞ ÌëúÏãú
            function displaySupervisorIdSelector() {
              const container = document.getElementById('idSelector');
              if (!container) return;
              
              const sortedData = [...window.supervisorScheduleData].sort((a, b) => (a.seq_no || 0) - (b.seq_no || 0));
              
              // ÌôúÏÑ±ÌôîÎêú ÏûëÏóÖÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
              const hasActiveWork = sortedData.some(item => {
                const work_status = calculateSupervisorStatus(item);
                return work_status === 'active';
              });
              
              container.innerHTML = sortedData.map(item => {
                const work_status = calculateSupervisorStatus(item);
                const isActive = work_status === 'active';
                const isCompleted = work_status === 'completed';
                const isSelected = window.selectedSupervisorTask === item.seq_no;
                
                // ÌôúÏÑ±ÌôîÎêú ÏûëÏóÖÏù¥ ÏûàÍ≥† ÌòÑÏû¨ ÏûëÏóÖÏù¥ ÌôúÏÑ±ÌôîÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ ÎπÑÌôúÏÑ±Ìôî
                const shouldDisable = hasActiveWork && !isActive && !isCompleted;
                
                let work_statusColor;
                if (isSelected) {
                  // ÏÑ†ÌÉùÎêú Î≤ÑÌäºÏùÄ Îçî Í∞ïÏ°∞Îêú Ïä§ÌÉÄÏùº
                  work_statusColor = work_status === 'completed' ? 
                    'bg-gradient-to-br from-green-300 to-green-400 text-green-900 border-4 border-green-600 shadow-lg' :
                    work_status === 'active' ? 
                    'bg-gradient-to-br from-yellow-300 to-yellow-400 text-yellow-900 border-4 border-yellow-600 shadow-lg animate-pulse' :
                    'bg-gradient-to-br from-purple-300 to-purple-400 text-purple-900 border-4 border-purple-600 shadow-lg';
                } else {
                  // ÏùºÎ∞ò Î≤ÑÌäº Ïä§ÌÉÄÏùº
                  work_statusColor = work_status === 'completed' ? 
                  'bg-gradient-to-br from-green-100 to-green-200 text-green-800 border-2 border-green-400 shadow-sm hover:shadow-lg' :
                  work_status === 'active' ? 
                  'bg-gradient-to-br from-yellow-100 to-yellow-200 text-yellow-800 border-2 border-yellow-400 shadow-sm hover:shadow-lg animate-pulse' :
                  shouldDisable ?
                  'bg-gradient-to-br from-gray-100 to-gray-200 text-gray-500 border-2 border-gray-300 shadow-sm cursor-not-allowed' :
                  'bg-gradient-to-br from-blue-100 to-blue-200 text-blue-800 border-2 border-blue-400 shadow-sm hover:shadow-lg';
                }
                
                return `
                  <button onclick="selectSupervisorTask(${item.seq_no})" 
                          class="p-2 rounded-md font-bold text-lg transition-all duration-200 transform ${shouldDisable ? 'cursor-not-allowed opacity-60' : 'hover:scale-105'} ${work_statusColor} min-h-[40px]"
                          ${shouldDisable ? 'disabled' : ''}>
                    <div class="text-center">
                      <div class="text-xl font-bold">${item.part_no || '-'}</div>
                    </div>
                  </button>
                `;
              }).join('');
            }

             // ÏûêÎèôÏúºÎ°ú ÌòÑÏû¨ ÏßÑÌñâÏ§ëÏù∏ ÏûëÏóÖ ÎòêÎäî Îã§Ïùå ÏûëÏóÖ ÏÑ†ÌÉù
            function autoSelectCurrentTask() {
              if (!window.supervisorScheduleData || window.supervisorScheduleData.length === 0) {
                console.log('‚ö†Ô∏è No schedule data available for auto-selection');
                return;
              }
              
              // 1. ÌòÑÏû¨ ÏßÑÌñâÏ§ëÏù∏ ÏûëÏóÖ Ï∞æÍ∏∞
              const activeTask = window.supervisorScheduleData.find(item => item.work_status === 'active');
              if (activeTask) {
                console.log('üîÑ Auto-selecting active task:', activeTask.seq_no);
                selectSupervisorTask(activeTask.seq_no);
                return;
              }
              
              // 2. ÏßÑÌñâÏ§ëÏù∏ ÏûëÏóÖÏù¥ ÏóÜÏúºÎ©¥ Îã§Ïùå ÎåÄÍ∏∞ ÏûëÏóÖ Ï∞æÍ∏∞
              const nextWaitingTask = window.supervisorScheduleData.find(item => item.work_status === 'waiting');
              if (nextWaitingTask) {
                console.log('‚è≠Ô∏è Auto-selecting next waiting task:', nextWaitingTask.seq_no);
                selectSupervisorTask(nextWaitingTask.seq_no);
                return;
              }
              
              console.log('‚ÑπÔ∏è No suitable task found for auto-selection');
            }

             // ÏûëÏóÖ ÏÑ†ÌÉù
            function selectSupervisorTask(sequenceNumber) {
              // ÏÑ†ÌÉùÎêú ÏûëÏóÖ Ï∂îÏ†Å
              window.selectedSupervisorTask = sequenceNumber;
              
              const item = window.supervisorScheduleData.find(s => s.seq_no === sequenceNumber);
              if (!item) return;
              
              // Îã§Î•∏ ÏûëÏóÖÏù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
              const activeWork = window.supervisorScheduleData.find(s => {
                const work_status = calculateSupervisorStatus(s);
                return work_status === 'active' && s.seq_no !== sequenceNumber;
              });
              
              if (activeWork) {
                const t = supervisorTranslations[window.supervisorLanguage];
                console.warn(`‚ö†Ô∏è ${t.anotherActive} (ID: ${activeWork.seq_no})`);
                return;
              }
              
              // ÏÑ†ÌÉùÎêú ÏûëÏóÖ Ï†ïÎ≥¥Îäî ÌòÑÏû¨ ÏûëÏóÖ ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ÏûêÎèôÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îê®
               
               // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
               updateControlButtons(item);
               
               // ID ÏÑ†ÌÉùÍ∏∞ Îã§Ïãú Î†åÎçîÎßÅ (ÏÑ†ÌÉùÎêú Î≤ÑÌäº Í∞ïÏ°∞ ÌëúÏãú)
               displaySupervisorIdSelector();
               
              // ÏÑ†ÌÉùÎêú ÏûëÏóÖ Ï†ÄÏû•
              window.supervisorSelectedTaskId = sequenceNumber;
             }

             // ÏÑ†ÌÉùÎêú ÏûëÏóÖ ÏãúÏûë
             async function startSelectedWork() {
               if (!window.supervisorSelectedTaskId) return;
               await startSupervisorWork(window.supervisorSelectedTaskId);
             }

             // ÏÑ†ÌÉùÎêú ÏûëÏóÖ Ï∑®ÏÜå
             async function cancelSelectedWork() {
               if (!window.supervisorSelectedTaskId) return;
               await cancelSupervisorWork(window.supervisorSelectedTaskId);
             }

             // ÏÑ†ÌÉùÎêú ÏûëÏóÖ Ï¢ÖÎ£å
             async function endSelectedWork() {
               if (!window.supervisorSelectedTaskId) return;
               await endSupervisorWork(window.supervisorSelectedTaskId);
             }

             // ÏûëÏóÖ ÏãúÏûë
            async function startSupervisorWork(sequenceNumber) {
              const item = window.supervisorScheduleData.find(s => s.seq_no === sequenceNumber);
              if (!item) return;
               
               if (item.work_start_time && item.work_start_time.trim() !== '') {
                 const t = supervisorTranslations[window.supervisorLanguage];
                 console.warn(`‚ö†Ô∏è ${t.active}`);
                 return;
               }
               
               // Îã§Î•∏ ÏûëÏóÖÏù¥ Ïù¥ÎØ∏ ACTIVE ÏÉÅÌÉúÏù∏ÏßÄ ÌôïÏù∏
               const activeWork = window.supervisorScheduleData.find(s => 
                 s.work_status === 'active' && s.seq_no !== sequenceNumber
               );
               
               if (activeWork) {
                 const t = supervisorTranslations[window.supervisorLanguage];
                 console.warn(`‚ö†Ô∏è ${t.anotherActive} (ID: ${activeWork.seq_no})`);
                 return;
               }
               
               try {
                 const now = new Date();
                 const timeString = now.toLocaleTimeString('ko-KR', { 
                   hour12: false,
                   hour: '2-digit',
                   minute: '2-digit'
                 });
                 
                if (!window.supabase || typeof window.supabase.from !== 'function') {
                  throw new Error('Supabase not available');
                }
                
                const { error } = await window.supabase
                  .from('tm_packaging_schedule')
                  .update({ 
                    work_start_time: timeString,
                    work_status: 'active'
                  })
                  .eq('work_date', item.work_date)
                  .eq('seq_no', item.seq_no);
                
                if (error) throw error;
                console.log('‚úÖ Work start time saved to Supabase');
                
                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                const index = window.supervisorScheduleData.findIndex(s => s.seq_no === sequenceNumber);
                window.supervisorScheduleData[index].work_start_time = timeString;
                window.supervisorScheduleData[index].work_status = 'active';
                 
                 // ÌòÑÏû¨ ÏûëÏóÖÏúºÎ°ú ÏÑ§Ï†ïÌïòÍ≥† ÌÉÄÏù¥Î®∏ ÏãúÏûë
                 window.supervisorCurrentWork = item;
                 window.supervisorWorkStartTime = now;
                 
                 displaySupervisorIdSelector();
                 displaySupervisorScheduleTable();
                 updateSupervisorCurrentStatus();
                 startSupervisorTimer();
                 
                console.log(`‚è∞ Timer started for work sequence ${sequenceNumber}`);
                
                // ÏÑ†ÌÉùÎêú ÏûëÏóÖÏù¥ ÏãúÏûëÎêú Í≤ΩÏö∞ ÏóÖÎç∞Ïù¥Ìä∏
                if (window.supervisorSelectedTaskId === sequenceNumber) {
                  selectSupervisorTask(sequenceNumber);
                }
                 
                 console.log(`Work started: ${item.part_no} at ${timeString}`);
               } catch (error) {
                 console.error('Error starting work:', error);
                 const t = supervisorTranslations[window.supervisorLanguage];
                 console.warn(`‚ö†Ô∏è ${window.supervisorLanguage === 'en' ? 'Error starting work' : 'Error al iniciar trabajo'}`);
               }
             }

             // ÏûëÏóÖ Ï∑®ÏÜå (ÏãúÏûë ÏãúÍ∞Ñ ÏÇ≠Ï†ú)
            async function cancelSupervisorWork(sequenceNumber) {
              const item = window.supervisorScheduleData.find(s => s.seq_no === sequenceNumber);
              if (!item) return;
               
               if (!item.work_start_time || item.work_start_time.trim() === '') {
                 const t = supervisorTranslations[window.supervisorLanguage];
                 console.warn('‚ö†Ô∏è ' + t.waiting);
                 return;
               }
               
               if (item.work_end_time && item.work_end_time.trim() !== '') {
                 const t = supervisorTranslations[window.supervisorLanguage];
                 console.warn('‚ö†Ô∏è ' + t.completed);
                 return;
               }
               
               try {
                 if (!window.supabase || typeof window.supabase.from !== 'function') {
                   throw new Error('Supabase not available');
                 }
                 
                 const { error } = await window.supabase
                   .from('tm_packaging_schedule')
                   .update({ 
                     work_start_time: null,
                     work_status: 'waiting'
                   })
                   .eq('work_date', item.work_date)
                   .eq('seq_no', item.seq_no);
                 
                 if (error) throw error;
                 console.log('‚úÖ Work start time cancelled in Supabase');
                  
                 // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                 const index = window.supervisorScheduleData.findIndex(s => s.seq_no === sequenceNumber);
                 window.supervisorScheduleData[index].work_start_time = null;
                 window.supervisorScheduleData[index].work_status = 'waiting';
                  
                 // ÌòÑÏû¨ ÏûëÏóÖÏù¥ Ï∑®ÏÜåÎêú Í≤ΩÏö∞ ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ
                 if (window.supervisorCurrentWork && window.supervisorCurrentWork.seq_no === sequenceNumber) {
                   window.supervisorCurrentWork = null;
                   window.supervisorWorkStartTime = null;
                   stopSupervisorTimer();
                   console.log(`‚èπÔ∏è Timer stopped for cancelled work sequence ${sequenceNumber}`);
                 }
                  
                 displaySupervisorIdSelector();
                 displaySupervisorScheduleTable();
                 updateSupervisorCurrentStatus();
                 
                 // ÏÑ†ÌÉùÎêú ÏûëÏóÖÏù¥ Ï∑®ÏÜåÎêú Í≤ΩÏö∞ ÏóÖÎç∞Ïù¥Ìä∏
                 if (window.supervisorSelectedTaskId === sequenceNumber) {
                   selectSupervisorTask(sequenceNumber);
                 }
                  
                 console.log(`Work cancelled: ${item.part_no}`);
               } catch (error) {
                 console.error('Error cancelling work:', error);
                 const t = supervisorTranslations[window.supervisorLanguage];
                 console.warn('‚ö†Ô∏è ' + (window.supervisorLanguage === 'en' ? 'Error cancelling work' : 'Error al cancelar trabajo'));
               }
             }

             // ÏûëÏóÖ Ï¢ÖÎ£å
            async function endSupervisorWork(sequenceNumber) {
              const item = window.supervisorScheduleData.find(s => s.seq_no === sequenceNumber);
              if (!item) return;
               
               if (!item.work_start_time || item.work_start_time.trim() === '') {
                 console.warn('‚ö†Ô∏è ÏãúÏûë ÏãúÍ∞ÑÏù¥ ÏóÜÏäµÎãàÎã§.');
                 return;
               }
               
               if (item.work_end_time && item.work_end_time.trim() !== '') {
                 console.warn('‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ Ïù¥ÎØ∏ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.');
                 return;
               }
               
               try {
                 const now = new Date();
                 const timeString = now.toLocaleTimeString('ko-KR', { 
                   hour12: false,
                   hour: '2-digit',
                   minute: '2-digit'
                 });
                 
                if (!window.supabase || typeof window.supabase.from !== 'function') {
                  throw new Error('Supabase not available');
                }
                
                const { error } = await window.supabase
                  .from('tm_packaging_schedule')
                  .update({ 
                    work_end_time: timeString,
                    work_status: 'completed'
                  })
                  .eq('work_date', item.work_date)
                  .eq('seq_no', item.seq_no);
                
                if (error) throw error;
                console.log('‚úÖ Work end time saved to Supabase');
                 
                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                const index = window.supervisorScheduleData.findIndex(s => s.seq_no === sequenceNumber);
                window.supervisorScheduleData[index].work_end_time = timeString;
                window.supervisorScheduleData[index].work_status = 'completed';
                 
                // ÌòÑÏû¨ ÏûëÏóÖÏù¥ Ï¢ÖÎ£åÎêú Í≤ΩÏö∞ ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ
                if (window.supervisorCurrentWork && window.supervisorCurrentWork.seq_no === sequenceNumber) {
                  window.supervisorCurrentWork = null;
                  window.supervisorWorkStartTime = null;
                  stopSupervisorTimer();
                  console.log(`‚èπÔ∏è Timer stopped for work sequence ${sequenceNumber}`);
                 }
                 
                 displaySupervisorIdSelector();
                 displaySupervisorScheduleTable();
                 updateSupervisorCurrentStatus();
                 
                // ÏÑ†ÌÉùÎêú ÏûëÏóÖÏù¥ Ï¢ÖÎ£åÎêú Í≤ΩÏö∞ ÏóÖÎç∞Ïù¥Ìä∏
                if (window.supervisorSelectedTaskId === sequenceNumber) {
                  selectSupervisorTask(sequenceNumber);
                }
                 
                 console.log(`Work ended: ${item.part_no} at ${timeString}`);
               } catch (error) {
                 console.error('Error ending work:', error);
                 console.warn('‚ö†Ô∏è ÏûëÏóÖ Ï¢ÖÎ£å Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
               }
             }

             // Ïä§ÏºÄÏ§Ñ ÌÖåÏù¥Î∏î ÌëúÏãú
            function displaySupervisorScheduleTable() {
              const partSummaryGrid = document.getElementById('partSummaryGrid');
              if (!partSummaryGrid) return;
              
              // ÌååÌä∏Î≥ÑÎ°ú Í∑∏Î£πÌôîÌïòÏó¨ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
              const partStats = {};
              
              window.supervisorScheduleData.forEach(item => {
                const partNo = item.part_no || 'Unknown';
                if (!partStats[partNo]) {
                  partStats[partNo] = {
                    total: 0,
                    completed: 0,
                    active: 0,
                    waiting: 0
                  };
                }
                
                partStats[partNo].total++;
                const work_status = calculateSupervisorStatus(item);
                
                if (work_status === 'completed') {
                  partStats[partNo].completed++;
                } else if (work_status === 'active') {
                  partStats[partNo].active++;
                } else {
                  partStats[partNo].waiting++;
                }
              });
              
              // ÌååÌä∏Î≥Ñ Ïπ¥Îìú ÏÉùÏÑ±
              partSummaryGrid.innerHTML = Object.entries(partStats).map(([partNo, stats]) => {
                const remaining = stats.waiting + stats.active;
                const progressPercent = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                
                let cardColor = 'bg-gray-50 border-gray-200';
                let textColor = 'text-gray-700';
                let progressColor = 'bg-gray-300';
                
                if (stats.active > 0) {
                  cardColor = 'bg-yellow-50 border-yellow-200';
                  textColor = 'text-yellow-800';
                  progressColor = 'bg-yellow-400';
                } else if (remaining === 0) {
                  cardColor = 'bg-green-50 border-green-200';
                  textColor = 'text-green-800';
                  progressColor = 'bg-green-400';
                } else if (remaining > 0) {
                  cardColor = 'bg-blue-50 border-blue-200';
                  textColor = 'text-blue-800';
                  progressColor = 'bg-blue-400';
                }
                
                return `
                  <div class="bg-white rounded-lg border-2 ${cardColor} p-2 shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-center">
                      <div class="text-sm font-bold ${textColor} mb-1">${partNo}</div>
                      <div class="text-xl font-bold ${textColor} mb-1">${remaining}</div>
                      <div class="text-xs text-gray-600 mb-2">remaining</div>
                      
                      <!-- Progress Bar -->
                      <div class="w-full bg-gray-200 rounded-full h-1 mb-1">
                        <div class="h-1 rounded-full ${progressColor}" style="width: ${progressPercent}%"></div>
                      </div>
                      
                    </div>
                  </div>
                `;
              }).join('');
            }

             // ÏÉÅÌÉú Í≥ÑÏÇ∞
             function calculateSupervisorStatus(item) {
               if (item.work_start_time && item.work_start_time.trim() !== '' && item.work_end_time && item.work_end_time.trim() !== '') {
                 return 'completed';
               } else if (item.work_start_time && item.work_start_time.trim() !== '') {
                 return 'active';
               } else {
                 return 'waiting';
               }
             }

             // ÌòÑÏû¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
             function updateSupervisorCurrentStatus() {
               const activeItem = window.supervisorScheduleData.find(item => item.work_status === 'active');
               
               const currentRoundEl = document.getElementById('currentRound');
               const currentPartEl = document.getElementById('currentPart');
               
              if (activeItem) {
                if (currentRoundEl) currentRoundEl.textContent = `ID ${activeItem.seq_no}`;
                if (currentPartEl) currentPartEl.textContent = activeItem.part_no;
                
                // ÏÑ†ÌÉùÎêú ÏûëÏóÖÏù¥ ÌôúÏÑ± ÏûëÏóÖÍ≥º Í∞ôÏúºÎ©¥ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                if (window.selectedSupervisorTask === activeItem.seq_no) {
                  updateControlButtons(activeItem);
                }
               } else {
                 if (currentRoundEl) currentRoundEl.textContent = '-';
                 if (currentPartEl) currentPartEl.textContent = '-';
                 
                 // ÏÑ†ÌÉùÎêú ÏûëÏóÖÏù¥ ÏûàÏúºÎ©¥ Ìï¥Îãπ ÏûëÏóÖÏùò Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                 if (window.selectedSupervisorTask) {
                   const selectedItem = window.supervisorScheduleData.find(item => item.seq_no === window.selectedSupervisorTask);
                   if (selectedItem) {
                     updateControlButtons(selectedItem);
                   }
                 }
               }
               
               // Îã§Ïùå ÏûëÏóÖ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
               updateNextWorkPreview();
             }
             
             // Ï†úÏñ¥ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
             function updateControlButtons(item) {
               const work_status = calculateSupervisorStatus(item);
               const hasStartTime = item.work_start_time && item.work_start_time.trim() !== '';
               const hasEndTime = item.work_end_time && item.work_end_time.trim() !== '';
               const isCompleted = work_status === 'completed';
               const t = supervisorTranslations[window.supervisorLanguage];
               
               const startBtn = document.getElementById('startWorkBtn');
               const cancelBtn = document.getElementById('cancelWorkBtn');
               const endBtn = document.getElementById('endWorkBtn');
               
               if (startBtn) {
                 if (hasStartTime) {
                   startBtn.disabled = true;
                   startBtn.innerHTML = `<span id="startWorkText">${t.active}</span>`;
                 } else {
                   startBtn.disabled = false;
                   startBtn.innerHTML = `<span id="startWorkText">${t.startWork}</span>`;
                 }
               }
               
               if (cancelBtn) {
                 if (isCompleted || !hasStartTime) {
                   cancelBtn.disabled = true;
                   cancelBtn.innerHTML = `<span id="cancelWorkText">${isCompleted ? t.completed : t.waiting}</span>`;
                 } else {
                   cancelBtn.disabled = false;
                   cancelBtn.innerHTML = `<span id="cancelWorkText">${t.cancelWork}</span>`;
                 }
               }
               
               if (endBtn) {
                 if (!hasStartTime || hasEndTime) {
                   endBtn.disabled = true;
                   endBtn.innerHTML = `<span id="endWorkText">${hasEndTime ? t.completed : t.waiting}</span>`;
                 } else {
                   endBtn.disabled = false;
                   endBtn.innerHTML = `<span id="endWorkText">${t.endWork}</span>`;
                 }
               }
             }
             
             // Îã§Ïùå ÏûëÏóÖ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
             function updateNextWorkPreview() {
               const nextWorkPreview = document.getElementById('nextWorkPreview');
               if (!nextWorkPreview) return;
               
               // ÎåÄÍ∏∞ Ï§ëÏù∏ ÏûëÏóÖÎì§ÏùÑ ÏãúÍ∞ÑÏàúÏúºÎ°ú Ï†ïÎ†¨
               const waitingItems = window.supervisorScheduleData
                 .filter(item => item.work_status === 'waiting')
                 .sort((a, b) => a.seq_no - b.seq_no)
                 .slice(0, 3); // ÏµúÎåÄ 3Í∞úÎßå ÌëúÏãú
               
               if (waitingItems.length === 0) {
                 nextWorkPreview.innerHTML = '<div class="text-center text-gray-300 text-sm col-span-full" id="noNextWork">No upcoming work</div>';
                 return;
               }
               
               let html = '';
               waitingItems.forEach((item, index) => {
                 const isNext = index === 0;
                 html += `
                   <div class="bg-white bg-opacity-30 rounded-lg p-3 ${isNext ? 'border-2 border-yellow-300 shadow-lg' : 'border border-white border-opacity-30'}">
                     <div class="text-center">
                       <div class="text-sm font-semibold opacity-90 mb-1">Task ${item.seq_no}</div>
                       <div class="text-xl font-bold mb-1">${item.part_no || '-'}</div>
                       <div class="text-xs opacity-80 mb-1">${isNext ? 'NEXT' : 'UPCOMING'}</div>
                       <div class="text-xs font-semibold">${item.work_start_time || '-'}</div>
                     </div>
                   </div>
                 `;
               });
               
               nextWorkPreview.innerHTML = html;
             }

             // ÌÉÄÏù¥Î®∏ ÏãúÏûë
             function startSupervisorTimer() {
               if (window.supervisorTimerInterval) {
                 clearInterval(window.supervisorTimerInterval);
               }
               
               window.supervisorTimerInterval = setInterval(() => {
                 // ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖÏù¥ ÏûàÍ≥† ÏãúÏûë ÏãúÍ∞ÑÏù¥ ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå ÌÉÄÏù¥Î®∏ ÏóÖÎç∞Ïù¥Ìä∏
                 if (window.supervisorCurrentWork && window.supervisorWorkStartTime) {
                   const now = new Date();
                   const elapsed = Math.floor((now - window.supervisorWorkStartTime) / 1000);
                   
                   const hours = Math.floor(elapsed / 3600);
                   const minutes = Math.floor((elapsed % 3600) / 60);
                   const seconds = elapsed % 60;
                   
                   const timeString = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
                   const elapsedTimeEl = document.getElementById('elapsedTime');
                   if (elapsedTimeEl) {
                     elapsedTimeEl.textContent = timeString;
                   }
                   
                  // ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌïú Î°úÍ∑∏ (5Ï¥àÎßàÎã§)
                  if (seconds % 5 === 0) {
                    console.log(`‚è∞ Timer update: Work Sequence ${window.supervisorCurrentWork.seq_no}, Elapsed: ${timeString}`);
                  }
                 } else {
                   // ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖÏù¥ ÏóÜÏúºÎ©¥ 00:00:00ÏúºÎ°ú Î¶¨ÏÖã
                   const elapsedTimeEl = document.getElementById('elapsedTime');
                   if (elapsedTimeEl) {
                     elapsedTimeEl.textContent = '00:00:00';
                   }
                 }
               }, 1000);
             }

             // ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ
             function stopSupervisorTimer() {
               if (window.supervisorTimerInterval) {
                 clearInterval(window.supervisorTimerInterval);
                 window.supervisorTimerInterval = null;
               }
               const elapsedTimeEl = document.getElementById('elapsedTime');
               if (elapsedTimeEl) {
                 elapsedTimeEl.textContent = '00:00:00';
               }
             }

             // ÏÉàÎ°úÍ≥†Ïπ®
             function refreshSupervisorData() {
               loadSupervisorScheduleData();
             }

             // Supervisor ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÌÜ†Í∏Ä
             function toggleSupervisorAutoRefresh() {
               if (window.supervisorAutoRefreshInterval) {
                 // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ï§ëÏßÄ
                 clearInterval(window.supervisorAutoRefreshInterval);
                 window.supervisorAutoRefreshInterval = null;
                 
                 const btn = document.getElementById('supervisorAutoRefreshBtn');
                 if (btn) {
                   btn.textContent = '‚è∏Ô∏è AUTO: OFF';
                   btn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-semibold';
                 }
                 console.log('‚èπÔ∏è Supervisor auto-refresh stopped');
               } else {
                 // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë
                 window.supervisorAutoRefreshInterval = setInterval(() => {
                   console.log('üîÑ Auto-refreshing Supervisor data...');
                   loadSupervisorScheduleData();
                 }, 30000); // 30Ï¥àÎßàÎã§
                 
                 const btn = document.getElementById('supervisorAutoRefreshBtn');
                 if (btn) {
                   btn.textContent = 'üîÑ AUTO: ON';
                   btn.className = 'bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-semibold';
                 }
                 console.log('üöÄ Supervisor auto-refresh started (30s interval)');
               }
             }

             // ===== LIVE DISPLAY NEW WINDOW FUNCTIONS =====

             // ===== LIVE DISPLAY PAGE FUNCTIONS =====
             
             // Live Display ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
             function initializeDisplayPage() {
               console.log('üì∫ Initializing Live Display page...');
               
               // Ï†ÑÏó≠ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
               window.displayStartTime = null;
               window.displayCurrentId = null;
               window.displayCurrentPart = null;
               window.displayScheduleData = [];
               window.displayTimerInterval = null;
               
               // ÎÇ†Ïßú ÌëúÏãú Ï¥àÍ∏∞Ìôî
               updateDisplayDate();
               
               // Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
               loadDisplayScheduleData();
               
               // ÏûêÎèô Î¶¨ÌîÑÎûòÏãú ÏãúÏûë
               startDisplayAutoRefresh();
               
               // ÎÇ†Ïßú ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë (1Î∂ÑÎßàÎã§)
               startDisplayDateUpdate();
             }
             
             // Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Supabase + Mock Îç∞Ïù¥ÌÑ∞)
            async function loadDisplayScheduleData() {
              try {
                // SupabaseÍ∞Ä Ï§ÄÎπÑÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
                let retries = 0;
                const maxRetries = 10;
                
                while ((!window.supabase || typeof window.supabase.from !== 'function') && retries < maxRetries) {
                  console.log(`‚è≥ Waiting for Supabase... (attempt ${retries + 1}/${maxRetries})`);
                  await new Promise(resolve => setTimeout(resolve, 200));
                  retries++;
                }
                
                if (!window.supabase || typeof window.supabase.from !== 'function') {
                  throw new Error('Supabase not available after waiting');
                }
                
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await window.supabase
                  .from('tm_packaging_schedule')
                  .select('*')
                  .eq('work_date', today)
                  .order('seq_no', { ascending: true });
                
                if (error) throw error;
                window.displayScheduleData = data || [];
                console.log('‚úÖ Display schedule data loaded from Supabase:', window.displayScheduleData);
                
                // Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÌõÑ ÌòÑÏû¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (ÌÉÄÏù¥Î®∏ Ïú†ÏßÄ)
                updateDisplayCurrentStatus();
                displaySchedule();
              } catch (error) {
                console.error('Error loading display schedule data:', error);
                console.warn('‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. Supabase Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                window.displayScheduleData = [];
                displaySchedule();
              }
            }
             
             // ÏûêÎèô Î¶¨ÌîÑÎûòÏãú ÏãúÏûë
             function startDisplayAutoRefresh() {
               // 10Ï¥àÎßàÎã§ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
               if (window.displayRefreshInterval) {
                 clearInterval(window.displayRefreshInterval);
               }
               window.displayRefreshInterval = setInterval(() => {
                 console.log('üîÑ Auto-refreshing Live Display data...');
                 loadDisplayScheduleData();
               }, 10000);
             }
             
             // ÏûêÎèô Î¶¨ÌîÑÎûòÏãú Ï§ëÏßÄ
             function stopDisplayAutoRefresh() {
               if (window.displayRefreshInterval) {
                 clearInterval(window.displayRefreshInterval);
                 window.displayRefreshInterval = null;
               }
             }

             // ÎÇ†Ïßú ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉàÎ≤Ω 3ÏãúÍπåÏßÄÎäî Ïù¥Ï†Ñ ÎÇ†Ïßú Ïú†ÏßÄ)
             function updateDisplayDate() {
               const now = new Date();
               let displayDate = new Date(now);
               
               // ÏÉàÎ≤Ω 3Ïãú Ïù¥Ï†ÑÏù¥Î©¥ Ïù¥Ï†Ñ ÎÇ†Ïßú ÏÇ¨Ïö©
               if (now.getHours() < 3) {
                 displayDate.setDate(now.getDate() - 1);
               }
               
               const todayString = displayDate.toLocaleDateString('ko-KR', {
                 year: 'numeric',
                 month: '2-digit',
                 day: '2-digit',
                 weekday: 'long'
               });
               
               const displayDateEl = document.getElementById('displayDate');
               if (displayDateEl) {
                 displayDateEl.textContent = todayString;
               }
             }

             // ÎÇ†Ïßú ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
             function startDisplayDateUpdate() {
               // 1Î∂ÑÎßàÎã§ ÎÇ†Ïßú ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉàÎ≤Ω 3ÏãúÍπåÏßÄÎäî Ïù¥Ï†Ñ ÎÇ†Ïßú Ïú†ÏßÄ)
               if (window.displayDateInterval) {
                 clearInterval(window.displayDateInterval);
               }
               window.displayDateInterval = setInterval(() => {
                 updateDisplayDate();
               }, 60000); // 1Î∂ÑÎßàÎã§
             }

             // ÎÇ†Ïßú ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ Ï§ëÏßÄ
             function stopDisplayDateUpdate() {
               if (window.displayDateInterval) {
                 clearInterval(window.displayDateInterval);
                 window.displayDateInterval = null;
               }
             }
             
             // Mock Îç∞Ïù¥ÌÑ∞ Î°úÎìú
             
             // Ïä§ÏºÄÏ§Ñ ÌëúÏãú
             function displaySchedule() {
               const scheduleList = document.getElementById('scheduleList');
               if (!scheduleList) return;
               
               // ÏÉÅÌÉúÎ≥ÑÎ°ú Ï†ïÎ†¨: ÏßÑÌñâÏ§ë -> ÎåÄÍ∏∞ -> ÏôÑÎ£å ÏàúÏÑú
               const sortedData = [...window.displayScheduleData].sort((a, b) => {
                 const work_statusOrder = { 'active': 0, 'waiting': 1, 'completed': 2 };
                 return work_statusOrder[a.work_status] - work_statusOrder[b.work_status];
               });
               
               // Display schedule list
               scheduleList.innerHTML = '';
               sortedData.forEach(item => {
                 const itemDiv = document.createElement('div');
                 itemDiv.className = `flex justify-between items-center p-4 rounded-lg mb-2 ${
                   item.work_status === 'active' ? 'work_status-active' :
                   item.work_status === 'completed' ? 'work_status-completed' :
                   'work_status-waiting'
                 }`;
                 
                 const work_statusText = item.work_status === 'active' ? 'ACTIVE' : 
                                  item.work_status === 'completed' ? 'COMPLETED' : 'WAITING';
                 
                 // Í≤ΩÍ≥º ÏãúÍ∞Ñ Í≥ÑÏÇ∞
                 let elapsedTimeText = '';
                 let elapsedMinutes = 0;
                 if (item.work_start_time && item.work_end_time) {
                   // ÏôÑÎ£åÎêú ÏûëÏóÖ: ÏãúÏûëÏãúÍ∞ÑÎ∂ÄÌÑ∞ Ï¢ÖÎ£åÏãúÍ∞ÑÍπåÏßÄÏùò Í≤ΩÍ≥ºÏãúÍ∞Ñ
                   const startTime = parseTimeToMinutes(item.work_start_time);
                   const endTime = parseTimeToMinutes(item.work_end_time);
                   elapsedMinutes = endTime - startTime;
                   elapsedTimeText = formatElapsedTime(elapsedMinutes);
                 } else if (item.work_start_time && item.work_status === 'active') {
                   // ÏßÑÌñâÏ§ëÏù∏ ÏûëÏóÖ: ÏãúÏûëÏãúÍ∞ÑÎ∂ÄÌÑ∞ ÌòÑÏû¨ÍπåÏßÄÏùò Í≤ΩÍ≥ºÏãúÍ∞Ñ
                   const startTime = parseTimeToMinutes(item.work_start_time);
                   const currentTime = parseTimeToMinutes(getCurrentTimeString());
                   elapsedMinutes = currentTime - startTime;
                   elapsedTimeText = formatElapsedTime(elapsedMinutes);
                 }
                 
                 itemDiv.innerHTML = `
                   <div class="flex items-center space-x-4">
                     <span class="text-xl font-bold text-white">NO ${item.seq_no}</span>
                     <span class="text-2xl font-bold text-white">${item.part_no}</span>
                     <span class="text-sm px-3 py-1 rounded-full font-bold ${
                       item.work_status === 'active' ? 'bg-green-600 text-white' :
                       item.work_status === 'completed' ? 'bg-gray-600 text-white' :
                       'bg-yellow-600 text-white'
                     }">${work_statusText}</span>
                   </div>
                   <div class="text-xl font-bold">
                     ${elapsedTimeText ? 
                       `<span class="${getElapsedTimeColor(elapsedMinutes)}">ELAPSED: ${elapsedTimeText}</span>` : 
                       '<span class="text-white">WAITING</span>'
                     }
                   </div>
                 `;
                 
                 scheduleList.appendChild(itemDiv);
               });

               // Update current work_status
               updateDisplayCurrentStatus();
             }
             
             // ÏãúÍ∞Ñ Î¨∏ÏûêÏó¥ÏùÑ Î∂ÑÏúºÎ°ú Î≥ÄÌôò (HH:MM -> minutes)
             function parseTimeToMinutes(timeString) {
               if (!timeString) return 0;
               const [hours, minutes] = timeString.split(':').map(Number);
               return hours * 60 + minutes;
             }
             
             // Î∂ÑÏùÑ ÏãúÍ∞Ñ:Î∂Ñ ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
             function formatElapsedTime(minutes) {
               if (minutes < 0) return '00:00';
               const hours = Math.floor(minutes / 60);
               const mins = minutes % 60;
               return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
             }
             
             // Í≤ΩÍ≥º ÏãúÍ∞ÑÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î∞òÌôò (1ÏãúÍ∞Ñ Í∏∞Ï§Ä)
             function getElapsedTimeColor(minutes) {
               if (minutes < 60) {
                 return 'text-green-300'; // 1ÏãúÍ∞Ñ ÎØ∏Îßå: Ï¥àÎ°ùÏÉâ
               } else {
                 return 'text-red-300';   // 1ÏãúÍ∞Ñ Ïù¥ÏÉÅ: Îπ®Í∞ÑÏÉâ
               }
             }
             
             // ÌòÑÏû¨ ÏãúÍ∞ÑÏùÑ HH:MM ÌòïÏãùÏúºÎ°ú Î∞òÌôò
             function getCurrentTimeString() {
               const now = new Date();
               return now.toTimeString().slice(0, 5);
             }
             
             // ÌòÑÏû¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            function updateDisplayCurrentStatus() {
              const activeItem = window.displayScheduleData.find(item => item.work_status === 'active');
              
              if (activeItem) {
                // ÏÉàÎ°úÏö¥ ÌôúÏÑ± ÏûëÏóÖÏù¥Í±∞ÎÇò Í∏∞Ï°¥ ÏûëÏóÖÍ≥º Îã§Î•∏ Í≤ΩÏö∞ÏóêÎßå ÏóÖÎç∞Ïù¥Ìä∏
                if (window.displayCurrentId !== activeItem.seq_no) {
                window.displayCurrentId = activeItem.seq_no;
                window.displayCurrentPart = activeItem.part_no;
                
                document.getElementById('currentId').textContent = `NO ${window.displayCurrentId}`;
                document.getElementById('currentPart').textContent = window.displayCurrentPart;
                 
                  console.log('üîÑ Active work changed to:', activeItem.seq_no);
                }
                 
                 // Start timer if not already started and work has started
                 if (!window.displayStartTime && activeItem.work_start_time) {
                   // ÏãúÏûë ÏãúÍ∞ÑÏùÑ Date Í∞ùÏ≤¥Î°ú Î≥ÄÌôò (Ïò§Îäò ÎÇ†Ïßú + ÏãúÏûë ÏãúÍ∞Ñ)
                   const today = new Date();
                   const [hours, minutes] = activeItem.work_start_time.split(':');
                   window.displayStartTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parseInt(hours), parseInt(minutes));
                   console.log('‚è∞ Timer started for work:', activeItem.seq_no, 'at', activeItem.work_start_time);
                   startDisplayTimer();
                 }
                 
                 // Ïù¥ÎØ∏ ÌÉÄÏù¥Î®∏Í∞Ä ÏãúÏûëÎêòÏóàÍ≥† Í∞ôÏùÄ ÏûëÏóÖÏù¥Î©¥ ÌÉÄÏù¥Î®∏ Ïú†ÏßÄ
                 if (window.displayStartTime && window.displayCurrentId === activeItem.seq_no) {
                   // ÌÉÄÏù¥Î®∏Îäî Í≥ÑÏÜç Ïã§ÌñâÎê® - ÏïÑÎ¨¥Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå
                   // console.log('‚è∞ Timer continuing for work:', activeItem.seq_no);
                 }
               } else {
                 // ÌôúÏÑ± ÏûëÏóÖÏù¥ ÏóÜÏùÑ ÎïåÎßå ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ (Í∏∞Ï°¥Ïóê ÌôúÏÑ± ÏûëÏóÖÏù¥ ÏûàÏóàÎçò Í≤ΩÏö∞ÏóêÎßå)
                 if (window.displayCurrentId && window.displayStartTime) {
                   console.log('‚è∞ No active work, stopping timer');
                 document.getElementById('currentId').textContent = '-';
                 document.getElementById('currentPart').textContent = '-';
                 document.getElementById('elapsedTime').textContent = '00:00:00';
                 
                 if (window.displayTimerInterval) {
                   clearInterval(window.displayTimerInterval);
                   window.displayTimerInterval = null;
                 }
                 window.displayStartTime = null;
                   window.displayCurrentId = null;
                   window.displayCurrentPart = null;
                 }
               }
             }
             
             // ÌÉÄÏù¥Î®∏ ÏãúÏûë
             function startDisplayTimer() {
               if (window.displayTimerInterval) {
                 clearInterval(window.displayTimerInterval);
               }
               
               console.log('‚è∞ Display timer started');
               
               window.displayTimerInterval = setInterval(() => {
                 if (window.displayStartTime) {
                   const now = new Date();
                   const elapsed = Math.floor((now - window.displayStartTime) / 1000);
                   
                   const hours = Math.floor(elapsed / 3600);
                   const minutes = Math.floor((elapsed % 3600) / 60);
                   const seconds = elapsed % 60;
                   
                   const timeString = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
                   const elapsedTimeEl = document.getElementById('elapsedTime');
                   if (elapsedTimeEl) {
                     elapsedTimeEl.textContent = timeString;
                     
                     // Í≤ΩÍ≥º ÏãúÍ∞ÑÏóê Îî∞Îùº ÏÉâÏÉÅ Î≥ÄÍ≤Ω (1ÏãúÍ∞Ñ Í∏∞Ï§Ä)
                     const totalMinutes = hours * 60 + minutes;
                     elapsedTimeEl.className = elapsedTimeEl.className.replace(/text-(green|red)-300/, '');
                     if (totalMinutes < 60) {
                       elapsedTimeEl.classList.add('text-green-300');
                     } else {
                       elapsedTimeEl.classList.add('text-red-300');
                     }
                   }
                   
                   // ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌïú Î°úÍ∑∏ (30Ï¥àÎßàÎã§ - Î°úÍ∑∏ Ïä§Ìå∏ Î∞©ÏßÄ)
                   if (seconds % 30 === 0) {
                     console.log(`‚è∞ Display Timer update: Elapsed: ${timeString}`);
                   }
                   
                   // Ïä§ÏºÄÏ§Ñ Î™©Î°ùÏùò ÏßÑÌñâÏ§ëÏù∏ ÏûëÏóÖ Í≤ΩÍ≥ºÏãúÍ∞ÑÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ (5Ï¥àÎßàÎã§Îßå)
                   if (seconds % 5 === 0) {
                   displaySchedule();
                   }
                 } else {
                   // ÌÉÄÏù¥Î®∏Í∞Ä Ï§ëÏßÄÎêú Í≤ΩÏö∞ÏóêÎßå Î°úÍ∑∏ Ï∂úÎ†•
                   if (window.displayTimerInterval) {
                     console.log('‚è∞ Display timer stopped - no start time');
                   }
                 }
               }, 1000);
             }


    console.log('‚úÖ TM System loaded successfully');
  </script>
</body>
</html>