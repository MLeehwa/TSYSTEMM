<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LEEHWA VW TM System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.css">
</head>
<body class="bg-gray-50">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg border-r border-gray-200">
      <div class="p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
          <span class="text-3xl mr-2">ğŸ”„</span>
          LEEHWA VW TM System
        </h2>
        <nav>
          <ul class="space-y-2">
            <li class="pt-2">
              <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-4">
                FIFO Management
              </div>
              <ul class="space-y-1 ml-2">
                <li><button onclick="loadPage('pages/fifo/upload.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">ğŸ“¤</span>
                  Excel Upload
                </button></li>
                <li><button onclick="loadPage('pages/analysis-new.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">ğŸ“Š</span>
                  Shipping Plan Analysis
                </button></li>
                <li><button onclick="loadPage('pages/packaging-analysis-fixed.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">ğŸ“¦</span>
                  Packaging Analysis
                </button></li>
              </ul>
            </li>
            
            <li class="pt-4">
              <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-4">
                Truck Status
              </div>
              <ul class="space-y-1 ml-2">
                                 <li><button onclick="openStatusInNewTab()" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                   <span class="text-lg mr-3">ğŸ“º</span>
                   Live Status Display
                 </button></li>
                <li><button onclick="loadPage('pages/truck/management.html')" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors duration-200 flex items-center">
                  <span class="text-lg mr-3">ğŸš›</span>
                  Truck Management
                </button></li>
              </ul>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 overflow-hidden">
      <div class="h-full flex flex-col">
        <!-- Content Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-semibold text-gray-800">Welcome to TM System</h1>
            <div class="flex items-center space-x-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                System Status
              </span>
            </div>
          </div>
        </header>
        
        <!-- Content Body -->
        <div class="flex-1 overflow-y-auto p-6" id="mainContent">
          <!-- Welcome Content -->
          <div class="welcome-content">
            <h2 class="text-4xl font-bold text-gray-800 mb-6 text-center">Welcome to TM System</h2>
            <p class="text-xl text-gray-600 text-center mb-12">Efficient FIFO Management and Truck Status Monitoring</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              <!-- FIFO Management -->
              <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
                <div class="text-4xl mb-4">ğŸ“¦</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">FIFO Management</h3>
                <p class="text-gray-600">Upload Excel files and analyze shipping plans efficiently.</p>
              </div>
              
              <!-- Truck Management -->
              <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
                <div class="text-4xl mb-4">ğŸš›</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Truck Management</h3>
                <p class="text-gray-600">Monitor real-time truck status and manage fleet operations.</p>
              </div>
              
              <!-- System Overview -->
              <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
                <div class="text-4xl mb-4">âš™ï¸</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">System Overview</h3>
                <p class="text-gray-600">Comprehensive dashboard for monitoring and controlling operations.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ TM System ì´ˆê¸°í™” ì‹œì‘');
      
      // Supabase ì„¤ì •
      const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
      
      // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (í•œ ë²ˆë§Œ)
      let sb = null;
      if (typeof supabase !== 'undefined') {
        try {
          sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.sb = sb;
          window.supabase = supabase; // ì „ì—­ ì ‘ê·¼ì„ ìœ„í•´
        console.log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì™„ë£Œ');
        } catch (error) {
          console.error('âŒ Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
        }
      } else {
        console.warn('âš ï¸ Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
      }
      
      // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
      window.loadPage = loadPage;
      window.openStatusInNewTab = openStatusInNewTab;
      
      console.log('âœ… TM System ì´ˆê¸°í™” ì™„ë£Œ');
    });

             // ê°„ë‹¨í•œ í˜ì´ì§€ ë¡œë”
             function loadPage(path) {
               console.log('Loading page:', path);
               
               // í˜ì´ì§€ ì œëª© ì—…ë°ì´íŠ¸
               const pageTitle = document.getElementById('pageTitle');
               if (pageTitle) {
                 if (path.includes('upload.html')) {
                   pageTitle.textContent = 'Excel Upload';
                 } else if (path.includes('analysis-new.html')) {
                   pageTitle.textContent = 'Shipping Plan Analysis';
                 } else if (path.includes('packaging-analysis-fixed.html')) {
                   pageTitle.textContent = 'Packaging Analysis';
                 } else if (path.includes('management.html')) {
                   pageTitle.textContent = 'Truck Management';
                 } else {
                   pageTitle.textContent = 'TM System';
                 }
               }
               
               // í˜ì´ì§€ ë‚´ìš©ì„ ì§ì ‘ í‘œì‹œ
               if (path === 'pages/fifo/upload.html') {
                 document.getElementById('mainContent').innerHTML = `
                   <div class="bg-white rounded-lg shadow-md p-8">
                     <h2 class="text-2xl font-bold text-gray-800 mb-6">Excel Upload</h2>
                     <div class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center">
                       <div class="text-4xl mb-4">ğŸ“¤</div>
                       <h3 class="text-xl font-semibold text-gray-700 mb-2">Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
                       <p class="text-gray-600 mb-4">.xlsx ë˜ëŠ” .xls íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
                       <input type="file" id="fileInput" accept=".xlsx,.xls" class="mb-4 block mx-auto" />
                       <button onclick="handleFileUpload()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">ì—…ë¡œë“œ</button>
                     </div>
                     <div id="uploadStatus" class="mt-4"></div>
                     <div id="dataTable" class="mt-6"></div>
                   </div>
                 `;
               } else if (path === 'pages/analysis-new.html') {
                 document.getElementById('mainContent').innerHTML = `
                   <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                     <!-- Header -->
                     <div class="mb-8">
                         <h2 class="text-2xl font-bold text-gray-900 mb-2">Advanced Part No Analysis</h2>
                         <p class="text-gray-600">Advanced pallet analysis with separate Excel sheets for shipping planning</p>
                     </div>

                     <!-- Filter Panel -->
                     <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                         <h3 class="text-lg font-semibold text-gray-900 mb-4">Search Filters</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                             <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                                 <select id="locationFilter" 
                                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                     <option value="">All</option>
                                     <option value="F100">F100</option>
                                     <option value="F101" selected>F101</option>
                                 </select>
                             </div>
                             <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-2">Part No</label>
                                 <select id="partNoFilter" 
                                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                     <option value="">All</option>
                                     <option value="" disabled>Loading...</option>
                                 </select>
                                 <p id="partNoStatus" class="text-xs text-gray-500 mt-1">Loading part numbers...</p>
                             </div>
                             <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-2">Hold Whether</label>
                                 <select id="holdWhetherFilter" 
                                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                     <option value="">All</option>
                                     <option value="Y">Y</option>
                                     <option value="N" selected>N</option>
                                 </select>
                             </div>
                             <div class="flex items-end space-x-2">
                                 <button id="applyFilterBtn" 
                                         class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                     Apply Filter
                                 </button>
                                 <button id="resetFilterBtn" 
                                         class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                     Reset
                                 </button>
                             </div>
                             <div class="col-span-4 mt-2">
                                 <p id="filterStatus" class="text-xs text-gray-500">No filters applied</p>
                             </div>
                         </div>
                     </div>

                     <!-- Summary Cards -->
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">8+ Pallets Summary</h3>
                             <div id="summary8" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">Under 8 Pallets Summary</h3>
                             <div id="summary7" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                     </div>

                     <!-- Data Table -->
                     <div class="bg-white rounded-lg shadow-sm border">
                         <div class="px-6 py-4 border-b border-gray-200">
                             <div class="flex justify-between items-center">
                                 <div>
                                     <h3 class="text-lg font-semibold text-gray-900">Analysis Results</h3>
                                     <p id="resultCount" class="text-sm text-gray-500 mt-1">ë°ì´í„° ë¡œë”© ì¤‘...</p>
                                 </div>
                                 <div class="flex items-center space-x-4">
                                     <div class="flex space-x-2">
                                         <button id="exportExcelBtn" 
                                                 class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                             ğŸ“Š Export to Excel
                                         </button>
                                         <button id="refreshDataBtn" 
                                                 class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                             ğŸ”„ Refresh Data
                                         </button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="overflow-x-auto">
                             <div class="mb-4 text-sm text-gray-600">
                                 <span id="analysisDataInfo">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                             </div>
                             <table class="min-w-full divide-y divide-gray-200">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('palletNo')">
                                             Pallet No
                                             <span id="sort-palletNo" class="ml-1">â†•</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('rackNo')">
                                             Rack No
                                             <span id="sort-rackNo" class="ml-1">â†•</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('dataCount')">
                                             Data Count
                                             <span id="sort-dataCount" class="ml-1">â†•</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('tmCount')">
                                             TM Count
                                             <span id="sort-tmCount" class="ml-1">â†•</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('partNoList')">
                                             Part No List
                                             <span id="sort-partNoList" class="ml-1">â†•</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('earliestDate')">
                                             Earliest Date
                                             <span id="sort-earliestDate" class="ml-1">â†•</span>
                                         </th>
                                     </tr>
                                 </thead>
                                 <tbody id="resultsTable" class="bg-white divide-y divide-gray-200">
                                     <tr>
                                         <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                             ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
                                         </td>
                                     </tr>
                                 </tbody>
                             </table>
                         </div>
                     </div>

                     <!-- Loading State -->
                     <div id="loadingState" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                         <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                             <div class="mt-3 text-center">
                                 <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                                     <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                     </svg>
                                 </div>
                                 <h3 class="text-lg font-medium text-gray-900 mt-4">Loading Data...</h3>
                                 <p class="text-sm text-gray-500 mt-2">Loading all data from database...</p>
                                 <p id="loadingProgress" class="text-xs text-blue-600 mt-1">Please wait...</p>
                             </div>
                         </div>
                     </div>
                   </div>
                 `;
                 
                 // Analysis í˜ì´ì§€ ì´ˆê¸°í™”
                 setTimeout(() => {
                   initializeAnalysisPage();
                 }, 100);
               } else if (path === 'pages/packaging-analysis-fixed.html') {
                 document.getElementById('mainContent').innerHTML = `
                   <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                     <!-- Header -->
                     <div class="mb-8">
                         <h2 class="text-2xl font-bold text-gray-900 mb-2">Packaging Analysis</h2>
                         <p class="text-gray-600">Location-based packaging analysis with RACK NO pattern recognition (Hold Whether 'N' required)</p>
                         <div class="mt-2 text-sm text-gray-500">
                             <p><strong>Before Packaging:</strong> LHSAB, LHSBA, LHSAA, LHSBB</p>
                             <p><strong>After Packaging:</strong> LHSAC, LHSAD, LHSBC, LHSBD</p>
                             <p><strong>No Rack No:</strong> RACK NOê°€ ì—†ëŠ” íŒ”ë ˆíŠ¸</p>
                             <p class="text-blue-600"><strong>Note:</strong> Only records with Hold Whether = 'N' are included in analysis</p>
                         </div>
                     </div>

                     <!-- Filter Panel -->
                     <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                         <h3 class="text-lg font-semibold text-gray-900 mb-4">Search Filters</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                             <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-2">Part No</label>
                                 <select id="packagingPartNoFilter" 
                                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                     <option value="">All</option>
                                     <option value="" disabled>Loading...</option>
                                 </select>
                                 <p id="packagingPartNoStatus" class="text-xs text-gray-500 mt-1">Loading part numbers...</p>
                             </div>
                             <div class="flex items-end space-x-2">
                                 <button id="packagingApplyFilterBtn" 
                                         class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                     Apply Filter
                                 </button>
                                 <button id="packagingResetFilterBtn" 
                                         class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                     Reset
                                 </button>
                             </div>
                             <div class="col-span-3 mt-2">
                                 <p id="packagingFilterStatus" class="text-xs text-gray-500">Fixed filters: Location=F101, Hold Whether=N, RACK NO required (Part No only searchable)</p>
                             </div>
                         </div>
                     </div>

                     <!-- Summary Cards -->
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">Total TM</h3>
                             <div id="packagingTotalPallets" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">Before Packaging TM</h3>
                             <div id="packagingBeforePallets" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">After Packaging TM</h3>
                             <div id="packagingAfterPallets" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">No Rack No TM</h3>
                             <div id="packagingNoRackPallets" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                         <div class="bg-white rounded-lg shadow-sm border p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">Packaging Rate</h3>
                             <div id="packagingRate" class="text-gray-600">
                                 Please load data...
                             </div>
                         </div>
                     </div>

                     <!-- Data Table -->
                     <div class="bg-white rounded-lg shadow-sm border">
                         <div class="px-6 py-4 border-b border-gray-200">
                             <div class="flex justify-between items-center">
                                 <div>
                                     <h3 class="text-lg font-semibold text-gray-900">Packaging Analysis Results</h3>
                                     <p id="packagingResultCount" class="text-sm text-gray-500 mt-1">ë°ì´í„° ë¡œë”© ì¤‘...</p>
                                 </div>
                                 <div class="flex items-center space-x-4">
                                     <div class="flex space-x-2">
                                         <button id="packagingExportExcelBtn" 
                                                 class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                             ğŸ“Š Export to Excel
                                         </button>
                                         <button id="packagingRefreshDataBtn" 
                                                 class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                             ğŸ”„ Refresh Data
                                         </button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="overflow-x-auto">
                             <div class="mb-4 text-sm text-gray-600">
                                 <span id="packagingDataInfo">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                             </div>
                             <table class="min-w-full divide-y divide-gray-200">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('palletNo')">
                                             Pallet No
                                             <span id="packaging-sort-palletNo" class="ml-1">â†•</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('rackNo')">
                                             Rack No
                                             <span id="packaging-sort-rackNo" class="ml-1">â†•</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('partNo')">
                                             Part No
                                             <span id="packaging-sort-partNo" class="ml-1">â†•</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('tmCount')">
                                             TM Count
                                             <span id="packaging-sort-tmCount" class="ml-1">â†•</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('packagingStatus')">
                                             Packaging Status
                                             <span id="packaging-sort-packagingStatus" class="ml-1">â†•</span>
                                         </th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('location')">
                                             Location
                                             <span id="packaging-sort-location" class="ml-1">â†•</span>
                                         </th>
                                     </tr>
                                 </thead>
                                 <tbody id="packagingResultsTable" class="bg-white divide-y divide-gray-200">
                                     <tr>
                                         <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                             ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
                                         </td>
                                     </tr>
                                 </tbody>
                             </table>
                         </div>
                     </div>

                     <!-- Loading State -->
                     <div id="packagingLoadingState" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                         <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                             <div class="mt-3 text-center">
                                 <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                                     <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                     </svg>
                                 </div>
                                 <h3 class="text-lg font-medium text-gray-900 mt-4">Loading Data...</h3>
                                 <p class="text-sm text-gray-500 mt-2">Loading all data from database...</p>
                                 <p id="packagingLoadingProgress" class="text-xs text-blue-600 mt-1">Please wait...</p>
                             </div>
                         </div>
                     </div>
                   </div>
                 `;
                 
                 // Packaging í˜ì´ì§€ ì´ˆê¸°í™”
                 setTimeout(() => {
                   initializePackagingPage();
                 }, 100);
               } else if (path === 'pages/truck/management.html') {
                 document.getElementById('mainContent').innerHTML = `
                   <div class="bg-white rounded-lg shadow-md p-8">
                     <h2 class="text-2xl font-bold text-gray-800 mb-6">Truck Management</h2>
                     <div class="text-center py-8">
                       <div class="text-4xl mb-4">ğŸš›</div>
                       <h3 class="text-xl font-semibold text-gray-700 mb-2">íŠ¸ëŸ­ ê´€ë¦¬</h3>
                       <p class="text-gray-600">íŠ¸ëŸ­ ê´€ë¦¬ ê¸°ëŠ¥ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤</p>
                     </div>
                   </div>
                 `;
               } else {
                 document.getElementById('mainContent').innerHTML = `
                   <div class="text-center p-8">
                     <h2 class="text-2xl font-bold text-gray-600 mb-4">í˜ì´ì§€ ì¤€ë¹„ ì¤‘</h2>
                     <p class="text-gray-500">${path} í˜ì´ì§€ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
                   </div>
                 `;
               }
             }

             // Analysis í˜ì´ì§€ ì´ˆê¸°í™”
             function initializeAnalysisPage() {
               console.log('ğŸ”§ Initializing Analysis page...');
               
               // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
               window.allData = [];
               window.filteredData = [];
               window.currentSortColumn = 'palletNo';
               window.currentSortDirection = 'asc';
               window.lastAnalysisResults = [];
               
               // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
               const refreshBtn = document.getElementById('refreshDataBtn');
               if (refreshBtn) {
                 refreshBtn.onclick = loadAnalysisData;
               }
               
               const applyBtn = document.getElementById('applyFilterBtn');
               if (applyBtn) {
                 applyBtn.onclick = applyAnalysisFilter;
               }
               
               const resetBtn = document.getElementById('resetFilterBtn');
               if (resetBtn) {
                 resetBtn.onclick = resetAnalysisFilter;
               }
               
               const exportBtn = document.getElementById('exportExcelBtn');
               if (exportBtn) {
                 exportBtn.onclick = exportAnalysisData;
               }
               
               // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
               loadAnalysisData();
             }
             
             // Analysis ë°ì´í„° ë¡œë“œ
             function loadAnalysisData() {
               console.log('ğŸ”„ Loading Analysis data...');
               
               // ë¡œë”© ìƒíƒœ í‘œì‹œ
               const loadingState = document.getElementById('loadingState');
               if (loadingState) {
                 loadingState.classList.remove('hidden');
               }
               
               // Supabaseì—ì„œ ëª¨ë“  ë°ì´í„° ë¡œë“œ (í˜ì´ì§€ë„¤ì´ì…˜)
               if (window.sb) {
                 loadAllAnalysisData(0, []);
               } else {
                 console.log('âš ï¸ Supabase not available, using sample data');
                 showAnalysisSampleData();
                 
                 // ë¡œë”© ìƒíƒœ ìˆ¨ê¸°ê¸°
                 if (loadingState) {
                   loadingState.classList.add('hidden');
                 }
               }
             }
             
             // ëª¨ë“  Analysis ë°ì´í„° ë¡œë“œ (í˜ì´ì§€ë„¤ì´ì…˜)
             function loadAllAnalysisData(offset, allData) {
               console.log(`ğŸ”„ Loading Analysis data batch starting from ${offset}...`);
               
               // ë¡œë”© ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
               const progressElement = document.getElementById('loadingProgress');
               if (progressElement) {
                 progressElement.textContent = `Loading batch ${Math.floor(offset / 1000) + 1}... (${allData.length} records loaded)`;
               }
               
               window.sb.from('vwtm_list_data')
                 .select('*')
                 .range(offset, offset + 999) // 1000ê°œì”© ë¡œë“œ
                 .then(({ data, error }) => {
                   if (error) {
                     console.error('âŒ Database error:', error);
                     showAnalysisSampleData();
                     
                     // ë¡œë”© ìƒíƒœ ìˆ¨ê¸°ê¸°
                     const loadingState = document.getElementById('loadingState');
                     if (loadingState) {
                       loadingState.classList.add('hidden');
                     }
                     return;
                   }
                   
                   const batchData = data || [];
                   console.log(`âœ… Loaded batch: ${batchData.length} records (offset: ${offset})`);
                   
                   // ë°ì´í„° ì¶”ê°€
                   allData.push(...batchData);
                   
                   // ë” ë§ì€ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                   if (batchData.length === 1000) {
                     // ë‹¤ìŒ ë°°ì¹˜ ë¡œë“œ
                     setTimeout(() => {
                       loadAllAnalysisData(offset + 1000, allData);
                     }, 100); // 100ms ëŒ€ê¸°
                   } else {
                     // ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ
                     console.log('âœ… All Analysis data loaded:', allData.length, 'records');
                     console.log('Sample data:', allData.slice(0, 3));
                     
                     window.allData = allData;
                     window.filteredData = [...window.allData];
                     populateAnalysisFilterOptions();
                     performAnalysis();
                     
                     // ë¡œë”© ìƒíƒœ ìˆ¨ê¸°ê¸°
                     const loadingState = document.getElementById('loadingState');
                     if (loadingState) {
                       loadingState.classList.add('hidden');
                     }
                   }
                 });
             }
             
             // Analysis ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ
             function showAnalysisSampleData() {
               console.log('ğŸ“Š Showing Analysis sample data...');
               
               // ë” ë§ì€ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
               const sampleData = [];
               const locations = ['F100', 'F101'];
               const partNos = ['3T24', '3T33', '3T34', '3T35', '3T36', '3T37', '3T38', '3T39', '3T40'];
               const holdValues = ['N', 'Y'];
               
               // 50ê°œì˜ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
               for (let i = 1; i <= 50; i++) {
                 const location = locations[Math.floor(Math.random() * locations.length)];
                 const partNo = partNos[Math.floor(Math.random() * partNos.length)];
                 const holdWhether = holdValues[Math.floor(Math.random() * holdValues.length)];
                 
                 sampleData.push({
                   pallet_no: `PAL${String(i).padStart(3, '0')}`,
                   rack_no: `${location}-${String(Math.floor(Math.random() * 20) + 1).padStart(2, '0')}`,
                   part_no: partNo,
                   hold_whether: holdWhether,
                   location: location,
                   upload_time: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
                 });
               }
               
               window.allData = sampleData;
               window.filteredData = [...sampleData];
               populateAnalysisFilterOptions();
               performAnalysis();
             }
             
             // Analysis í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
             function populateAnalysisFilterOptions() {
               console.log('ğŸ”§ Populating Analysis filter options...');
               
               // Part No í•„í„° ì˜µì…˜ ì±„ìš°ê¸° (ì§€ì •ëœ 6ê°œë§Œ)
               const partNoFilter = document.getElementById('partNoFilter');
               if (partNoFilter) {
                 const allowedPartNos = ['3T24', '3T33', '3T34', '3T35', '7Z79', '7Z80'];
                 partNoFilter.innerHTML = '<option value="">All</option>' + 
                   allowedPartNos.map(part => `<option value="${part}">${part}</option>`).join('');
                 
                 const partNoStatus = document.getElementById('partNoStatus');
                 if (partNoStatus) {
                   partNoStatus.textContent = `${allowedPartNos.length} part numbers available`;
                 }
               }
               
               // Location í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
               const locationFilter = document.getElementById('locationFilter');
               if (locationFilter) {
                 const locations = [...new Set(window.allData.map(item => item.location))].filter(Boolean);
                 locationFilter.innerHTML = '<option value="">All</option>' + 
                   locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
               }
               
               // Hold Whether í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
               const holdWhetherFilter = document.getElementById('holdWhetherFilter');
               if (holdWhetherFilter) {
                 const holdValues = [...new Set(window.allData.map(item => item.hold_whether))].filter(Boolean);
                 holdWhetherFilter.innerHTML = '<option value="">All</option>' + 
                   holdValues.map(hold => `<option value="${hold}">${hold}</option>`).join('');
               }
             }
             
             // Analysis í•„í„° ì ìš©
             function applyAnalysisFilter() {
               console.log('ğŸ” Applying Analysis filter...');
               
               const location = document.getElementById('locationFilter')?.value || '';
               const partNo = document.getElementById('partNoFilter')?.value || '';
               const holdWhether = document.getElementById('holdWhetherFilter')?.value || '';
               
               console.log('Filter conditions:', { location, partNo, holdWhether });
               console.log('Original data count:', window.allData.length);
               console.log('Sample data:', window.allData.slice(0, 3));
               
               // í•„í„° ì ìš© ë¡œì§
               let filtered = [...window.allData];
               
               if (location) {
                 filtered = filtered.filter(item => item.location === location);
                 console.log('After location filter:', filtered.length);
               }
               if (partNo) {
                 filtered = filtered.filter(item => item.part_no === partNo);
                 console.log('After partNo filter:', filtered.length);
               }
               if (holdWhether) {
                 filtered = filtered.filter(item => item.hold_whether === holdWhether);
                 console.log('After holdWhether filter:', filtered.length);
                 console.log('Hold whether values in data:', [...new Set(window.allData.map(item => item.hold_whether))]);
               }
               
               window.filteredData = filtered;
               console.log('Final filtered data:', filtered.length, 'records');
               performAnalysis();
               
               // ìƒíƒœ ì—…ë°ì´íŠ¸
               const status = document.getElementById('filterStatus');
               if (status) {
                 status.textContent = `í•„í„° ì ìš©ë¨: ${filtered.length}ê°œ ë ˆì½”ë“œ`;
               }
             }
             
             // Analysis í•„í„° ì´ˆê¸°í™”
             function resetAnalysisFilter() {
               console.log('ğŸ”„ Resetting Analysis filter...');
               
               document.getElementById('locationFilter').value = '';
               document.getElementById('partNoFilter').value = '';
               document.getElementById('holdWhetherFilter').value = '';
               
               window.filteredData = [...window.allData];
               performAnalysis();
               
               const status = document.getElementById('filterStatus');
               if (status) {
                 status.textContent = 'No filters applied';
               }
             }
             
             // Analysis ìˆ˜í–‰
             function performAnalysis() {
               console.log('ğŸ“Š Performing Analysis...');
               
               const data = window.filteredData || [];
               console.log('Analysis data:', data.length, 'records');
               
               // Pallet Noë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ë¶„ì„ (Part Noë³„ì´ ì•„ë‹Œ Palletë³„)
               const palletGroups = {};
               data.forEach(item => {
                 const palletNo = item.pallet_no || 'Unknown';
                 if (!palletGroups[palletNo]) {
                   palletGroups[palletNo] = {
                     palletNo: palletNo,
                     rackNo: new Set(),
                     tmCount: new Set(),
                     partNoList: new Set(),
                     earliestDate: null,
                     items: []
                   };
                 }
                 
                 // Rack No ìˆ˜ì§‘
                 if (item.rack_no && item.rack_no.trim() !== '') {
                   palletGroups[palletNo].rackNo.add(item.rack_no);
                 }
                 
                 // TM No ìˆ˜ì§‘ (ê³ ìœ í•œ TM ê°œìˆ˜ ê³„ì‚°)
                 if (item.tm_no && item.tm_no.trim() !== '') {
                   palletGroups[palletNo].tmCount.add(item.tm_no);
                 }
                 
                 // Part No ìˆ˜ì§‘
                 if (item.part_no && item.part_no.trim() !== '') {
                   palletGroups[palletNo].partNoList.add(item.part_no);
                 }
                 
                 // ì•„ì´í…œ ì €ì¥
                 palletGroups[palletNo].items.push(item);
                 
                 // ê°€ì¥ ë¹ ë¥¸ ë‚ ì§œ ê³„ì‚°
                 if (item.prod_date && item.prod_date.trim() !== '') {
                   const currentDate = palletGroups[palletNo].earliestDate;
                   if (!currentDate || item.prod_date < currentDate) {
                     palletGroups[palletNo].earliestDate = item.prod_date;
                   }
                 }
               });
               
               // ê²°ê³¼ ë°°ì—´ë¡œ ë³€í™˜
               const results = Object.values(palletGroups).map(group => ({
                 palletNo: group.palletNo,
                 rackNo: Array.from(group.rackNo).filter(r => r).join(', ') || 'N/A',
                 dataCount: group.items.length,
                 tmCount: group.tmCount.size, // ê³ ìœ í•œ TM ê°œìˆ˜
                 partNoList: Array.from(group.partNoList).filter(p => p).join(', ') || 'N/A',
                 earliestDate: group.earliestDate || 'N/A',
                 items: group.items
               }));
               
               window.lastAnalysisResults = results;
               displayAnalysisResults(results);
               updateAnalysisSummary(results);
             }
             
             // Analysis ê²°ê³¼ í‘œì‹œ
             function displayAnalysisResults(results) {
               console.log('ğŸ“‹ Displaying Analysis results...');
               
               const tableBody = document.getElementById('resultsTable');
               if (!tableBody) return;
               
               if (results.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                 return;
               }
               
               const tableRows = results.map(result => `
                 <tr class="hover:bg-gray-50">
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.palletNo}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.rackNo}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.dataCount}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.tmCount}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.partNoList}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.earliestDate}</td>
                 </tr>
               `);
               
               tableBody.innerHTML = tableRows.join('');
               
               // ê²°ê³¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
               const resultCount = document.getElementById('resultCount');
               if (resultCount) {
                 resultCount.textContent = `Found ${results.length} pallets`;
               }
               
               // ë°ì´í„° ì •ë³´ ì—…ë°ì´íŠ¸
               const dataInfo = document.getElementById('analysisDataInfo');
               if (dataInfo) {
                 dataInfo.textContent = `ì´ ${window.allData.length}ê°œ ë ˆì½”ë“œ ì¤‘ ${results.length}ê°œ í‘œì‹œ`;
               }
             }
             
             // Analysis ìš”ì•½ ì—…ë°ì´íŠ¸
             function updateAnalysisSummary(results) {
               console.log('ğŸ“Š Updating Analysis summary...');
               
               const summary8 = document.getElementById('summary8');
               const summary7 = document.getElementById('summary7');
               
               if (summary8) {
                 const count8Plus = results.filter(r => r.tmCount >= 8).length;
                 summary8.innerHTML = `<div class="text-2xl font-bold text-blue-600">${count8Plus}</div><div class="text-sm text-gray-500">íŒ”ë ˆíŠ¸</div>`;
               }
               
               if (summary7) {
                 const countUnder8 = results.filter(r => r.tmCount < 8).length;
                 summary7.innerHTML = `<div class="text-2xl font-bold text-orange-600">${countUnder8}</div><div class="text-sm text-gray-500">íŒ”ë ˆíŠ¸</div>`;
               }
             }
             
             // Analysis Excel ë‚´ë³´ë‚´ê¸° (TM COUNT 8ê°œ ë¯¸ë§Œ ë³„ë„ ì‹œíŠ¸)
             function exportAnalysisData() {
               console.log('ğŸ“Š Exporting Analysis data...');
               
               if (!window.lastAnalysisResults || window.lastAnalysisResults.length === 0) {
                 alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                 return;
               }
               
               // ë°ì´í„° ë¶„ë¦¬: TM COUNT 8ê°œ ì´ìƒê³¼ 8ê°œ ë¯¸ë§Œ
               const results8Plus = window.lastAnalysisResults.filter(result => result.tmCount >= 8);
               const resultsUnder8 = window.lastAnalysisResults.filter(result => result.tmCount < 8);
               
               console.log(`ğŸ“Š Exporting: ${results8Plus.length} pallets (8+ TM), ${resultsUnder8.length} pallets (Under 8 TM)`);
               
               // Excel ë‚´ë³´ë‚´ê¸° ë¡œì§
               const workbook = new ExcelJS.Workbook();
               
               // 1. ì „ì²´ ê²°ê³¼ ì‹œíŠ¸ (8ê°œ ì´ìƒ)
               const mainWorksheet = workbook.addWorksheet('8+ TM Pallets');
               mainWorksheet.addRow(['Pallet No', 'Rack No', 'Data Count', 'TM Count', 'Part No List', 'Earliest Date']);
               
               results8Plus.forEach(result => {
                 mainWorksheet.addRow([
                   result.palletNo || '',
                   result.rackNo || '',
                   result.dataCount || 0,
                   result.tmCount || 0,
                   result.partNoList || '',
                   result.earliestDate || ''
                 ]);
               });
               
               // 2. 8ê°œ ë¯¸ë§Œ íŒ”ë ˆíŠ¸ ì‹œíŠ¸
               if (resultsUnder8.length > 0) {
                 const under8Worksheet = workbook.addWorksheet('Under 8 TM Pallets');
                 under8Worksheet.addRow(['Pallet No', 'Rack No', 'Data Count', 'TM Count', 'Part No List', 'Earliest Date']);
                 
                 resultsUnder8.forEach(result => {
                   under8Worksheet.addRow([
                     result.palletNo || '',
                     result.rackNo || '',
                     result.dataCount || 0,
                     result.tmCount || 0,
                     result.partNoList || '',
                     result.earliestDate || ''
                   ]);
                 });
               }
               
               // 3. ìš”ì•½ ì‹œíŠ¸
               const summaryWorksheet = workbook.addWorksheet('Summary');
               summaryWorksheet.addRow(['Category', 'Count', 'Description']);
               summaryWorksheet.addRow(['8+ TM Pallets', results8Plus.length, 'íŒ”ë ˆíŠ¸ë‹¹ 8ê°œ ì´ìƒì˜ TMì„ ê°€ì§„ íŒ”ë ˆíŠ¸']);
               summaryWorksheet.addRow(['Under 8 TM Pallets', resultsUnder8.length, 'íŒ”ë ˆíŠ¸ë‹¹ 8ê°œ ë¯¸ë§Œì˜ TMì„ ê°€ì§„ íŒ”ë ˆíŠ¸']);
               summaryWorksheet.addRow(['Total Pallets', window.lastAnalysisResults.length, 'ì „ì²´ íŒ”ë ˆíŠ¸ ìˆ˜']);
               
               // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
               workbook.xlsx.writeBuffer().then(buffer => {
                 const blob = new Blob([buffer], { 
                   type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                 });
                 const url = window.URL.createObjectURL(blob);
                 const link = document.createElement('a');
                 link.href = url;
                 link.download = `shipping_analysis_${new Date().toISOString().slice(0, 10)}.xlsx`;
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 window.URL.revokeObjectURL(url);
                 
                 console.log(`âœ… Excel export completed: ${results8Plus.length} (8+ TM) + ${resultsUnder8.length} (Under 8 TM) pallets`);
               });
             }
             
             // í…Œì´ë¸” ì •ë ¬
             function sortTable(column) {
               console.log(`ğŸ” Sorting by column: ${column}`);
               
               if (window.currentSortColumn === column) {
                 window.currentSortDirection = window.currentSortDirection === 'asc' ? 'desc' : 'asc';
               } else {
                 window.currentSortColumn = column;
                 window.currentSortDirection = 'asc';
               }
               
               const results = [...window.lastAnalysisResults];
               results.sort((a, b) => {
                 let aVal = a[column] || '';
                 let bVal = b[column] || '';
                 
                 if (['dataCount', 'tmCount'].includes(column)) {
                   aVal = parseFloat(aVal) || 0;
                   bVal = parseFloat(bVal) || 0;
                 } else {
                   aVal = String(aVal).toLowerCase();
                   bVal = String(bVal).toLowerCase();
                 }
                 
                 if (aVal < bVal) return window.currentSortDirection === 'asc' ? -1 : 1;
                 if (aVal > bVal) return window.currentSortDirection === 'asc' ? 1 : -1;
                 return 0;
               });
               
               displayAnalysisResults(results);
               updateSortIcons(column);
             }
             
             // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
             function updateSortIcons(activeColumn) {
               const columns = ['palletNo', 'rackNo', 'dataCount', 'tmCount', 'partNoList', 'earliestDate'];
               columns.forEach(col => {
                 const icon = document.getElementById(`sort-${col}`);
                 if (icon) {
                   if (col === activeColumn) {
                     icon.textContent = window.currentSortDirection === 'asc' ? 'â†‘' : 'â†“';
                   } else {
                     icon.textContent = 'â†•';
                   }
                 }
               });
             }

             // Packaging í˜ì´ì§€ ì´ˆê¸°í™”
             function initializePackagingPage() {
               console.log('ğŸ”§ Initializing Packaging page...');
               
               // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
               window.packagingAllData = [];
               window.packagingFilteredData = [];
               window.packagingCurrentSortColumn = 'palletNo';
               window.packagingCurrentSortDirection = 'asc';
               window.packagingLastResults = [];
               
               // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
               const refreshBtn = document.getElementById('packagingRefreshDataBtn');
               if (refreshBtn) {
                 refreshBtn.onclick = loadPackagingData;
               }
               
               const applyBtn = document.getElementById('packagingApplyFilterBtn');
               if (applyBtn) {
                 applyBtn.onclick = applyPackagingFilter;
               }
               
               const resetBtn = document.getElementById('packagingResetFilterBtn');
               if (resetBtn) {
                 resetBtn.onclick = resetPackagingFilter;
               }
               
               const exportBtn = document.getElementById('packagingExportExcelBtn');
               if (exportBtn) {
                 exportBtn.onclick = exportPackagingData;
               }
               
               // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
               loadPackagingData();
             }
             
             // Packaging ë°ì´í„° ë¡œë“œ
             function loadPackagingData() {
               console.log('ğŸ”„ Loading Packaging data...');
               
               // ë¡œë”© ìƒíƒœ í‘œì‹œ
               const loadingState = document.getElementById('packagingLoadingState');
               if (loadingState) {
                 loadingState.classList.remove('hidden');
               }
               
               // Supabaseì—ì„œ ëª¨ë“  ë°ì´í„° ë¡œë“œ (í˜ì´ì§€ë„¤ì´ì…˜)
               if (window.sb) {
                 loadAllPackagingData(0, []);
               } else {
                 console.log('âš ï¸ Supabase not available, using sample data');
                 showPackagingSampleData();
                 
                 // ë¡œë”© ìƒíƒœ ìˆ¨ê¸°ê¸°
                 if (loadingState) {
                   loadingState.classList.add('hidden');
                 }
               }
             }
             
             // ëª¨ë“  Packaging ë°ì´í„° ë¡œë“œ (í˜ì´ì§€ë„¤ì´ì…˜)
             function loadAllPackagingData(offset, allData) {
               console.log(`ğŸ”„ Loading Packaging data batch starting from ${offset}...`);
               
               // ë¡œë”© ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
               const progressElement = document.getElementById('packagingLoadingProgress');
               if (progressElement) {
                 progressElement.textContent = `Loading batch ${Math.floor(offset / 1000) + 1}... (${allData.length} records loaded)`;
               }
               
               window.sb.from('vwtm_list_data')
                 .select('*')
                 .range(offset, offset + 999) // 1000ê°œì”© ë¡œë“œ
                 .then(({ data, error }) => {
                   if (error) {
                     console.error('âŒ Database error:', error);
                     showPackagingSampleData();
                     
                     // ë¡œë”© ìƒíƒœ ìˆ¨ê¸°ê¸°
                     const loadingState = document.getElementById('packagingLoadingState');
                     if (loadingState) {
                       loadingState.classList.add('hidden');
                     }
                     return;
                   }
                   
                   const batchData = data || [];
                   console.log(`âœ… Loaded batch: ${batchData.length} records (offset: ${offset})`);
                   
                   // ë°ì´í„° ì¶”ê°€
                   allData.push(...batchData);
                   
                   // ë” ë§ì€ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                   if (batchData.length === 1000) {
                     // ë‹¤ìŒ ë°°ì¹˜ ë¡œë“œ
                     setTimeout(() => {
                       loadAllPackagingData(offset + 1000, allData);
                     }, 100); // 100ms ëŒ€ê¸°
                   } else {
                     // ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ
                     console.log('âœ… All Packaging data loaded:', allData.length, 'records');
                     console.log('Sample packaging data:', allData.slice(0, 3));
                     
                     window.packagingAllData = allData;
                     window.packagingFilteredData = [...window.packagingAllData];
                     populatePackagingFilterOptions();
                     performPackagingAnalysis();
                     
                     // ë¡œë”© ìƒíƒœ ìˆ¨ê¸°ê¸°
                     const loadingState = document.getElementById('packagingLoadingState');
                     if (loadingState) {
                       loadingState.classList.add('hidden');
                     }
                   }
                 });
             }
             
             // Packaging ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ
             function showPackagingSampleData() {
               console.log('ğŸ“¦ Showing Packaging sample data...');
               
               // ë” ë§ì€ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
               const sampleData = [];
               const partNos = ['3T24', '3T33', '3T34', '3T35', '3T36', '3T37', '3T38', '3T39', '3T40'];
               const rackPrefixes = ['LHSAB', 'LHSBA', 'LHSAA', 'LHSBB', 'LHSAC', 'LHSAD', 'LHSBC', 'LHSBD'];
               
               // 50ê°œì˜ ìƒ˜í”Œ ë°ì´í„° ìƒì„± (ì¼ë¶€ëŠ” Hold Whether 'Y', ì¼ë¶€ëŠ” RACK NO ì—†ìŒ)
               for (let i = 1; i <= 50; i++) {
                 const location = 'F101'; // ê¸°ë³¸ê°’ F101
                 const partNo = partNos[Math.floor(Math.random() * partNos.length)];
                 const holdWhether = Math.random() < 0.2 ? 'Y' : 'N'; // 20% í™•ë¥ ë¡œ 'Y'
                 
                 // RACK NOê°€ ì—†ëŠ” ë ˆì½”ë“œ ì¶”ê°€ (10% í™•ë¥ )
                 let rackNo = '';
                 if (Math.random() < 0.1) {
                   rackNo = ''; // RACK NO ì—†ìŒ
                 } else {
                   const rackPrefix = rackPrefixes[Math.floor(Math.random() * rackPrefixes.length)];
                   const rackSuffix = String(Math.floor(Math.random() * 20) + 1).padStart(2, '0');
                   rackNo = `${rackPrefix}${rackSuffix}`;
                 }

                 sampleData.push({
                   pallet_no: `PAL${String(i).padStart(3, '0')}`,
                   rack_no: rackNo,
                   part_no: partNo,
                   hold_whether: holdWhether,
                   location: location,
                   upload_time: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
                 });
               }
               
               window.packagingAllData = sampleData;
               window.packagingFilteredData = [...sampleData];
               populatePackagingFilterOptions();
               performPackagingAnalysis();
             }
             
             // Packaging í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
             function populatePackagingFilterOptions() {
               console.log('ğŸ”§ Populating Packaging filter options...');
               
               // Part No í•„í„° ì˜µì…˜ë§Œ ì±„ìš°ê¸° (ì§€ì •ëœ 6ê°œë§Œ, Locationê³¼ Hold WhetherëŠ” ê³ ì •ê°’)
               const partNoFilter = document.getElementById('packagingPartNoFilter');
               if (partNoFilter) {
                 const allowedPartNos = ['3T24', '3T33', '3T34', '3T35', '7Z79', '7Z80'];
                 partNoFilter.innerHTML = '<option value="">All</option>' + 
                   allowedPartNos.map(part => `<option value="${part}">${part}</option>`).join('');
                 
                 const partNoStatus = document.getElementById('packagingPartNoStatus');
                 if (partNoStatus) {
                   partNoStatus.textContent = `${allowedPartNos.length} part numbers available`;
                 }
               }
               
               console.log('Packaging filter options populated (Location=F101, Hold Whether=N fixed)');
             }
             
             // Packaging í•„í„° ì ìš©
             function applyPackagingFilter() {
               console.log('ğŸ” Applying Packaging filter...');
               
               const partNo = document.getElementById('packagingPartNoFilter')?.value || '';
               
               console.log('Packaging filter conditions:', { partNo });
               console.log('Original packaging data count:', window.packagingAllData.length);
               console.log('Sample packaging data:', window.packagingAllData.slice(0, 3));
               
               // í•„í„° ì ìš© ë¡œì§ (Location=F101, Hold Whether=N ê³ ì •)
               let filtered = [...window.packagingAllData];
               
               // Location=F101, Hold Whether=N ê³ ì • í•„í„° ì ìš©
               filtered = filtered.filter(item => item.location === 'F101' && item.hold_whether === 'N');
               console.log('After fixed filters (F101, N):', filtered.length);
               
               // Part No í•„í„°ë§Œ ì‚¬ìš©ìê°€ ë³€ê²½ ê°€ëŠ¥
               if (partNo) {
                 filtered = filtered.filter(item => item.part_no === partNo);
                 console.log('After partNo filter:', filtered.length);
               }
               
               window.packagingFilteredData = filtered;
               console.log('Final packaging filtered data:', filtered.length, 'records');
               performPackagingAnalysis();
               
               // ìƒíƒœ ì—…ë°ì´íŠ¸
               const status = document.getElementById('packagingFilterStatus');
               if (status) {
                 if (partNo) {
                   status.textContent = `Fixed: F101, N, RACK NO | Applied: Part No=${partNo} | ${filtered.length}ê°œ ë ˆì½”ë“œ`;
                 } else {
                   status.textContent = `Fixed filters: Location=F101, Hold Whether=N, RACK NO required (Part No only searchable) | ${filtered.length}ê°œ ë ˆì½”ë“œ`;
                 }
               }
             }
             
             // Packaging í•„í„° ì´ˆê¸°í™”
             function resetPackagingFilter() {
               console.log('ğŸ”„ Resetting Packaging filter...');
               
               document.getElementById('packagingPartNoFilter').value = '';
               
               // Location=F101, Hold Whether=N ê³ ì • í•„í„° ì ìš©
               let filtered = [...window.packagingAllData];
               filtered = filtered.filter(item => item.location === 'F101' && item.hold_whether === 'N');
               
               window.packagingFilteredData = filtered;
               performPackagingAnalysis();
               
               const status = document.getElementById('packagingFilterStatus');
               if (status) {
                 status.textContent = `Fixed filters: Location=F101, Hold Whether=N, RACK NO required (Part No only searchable) | ${filtered.length}ê°œ ë ˆì½”ë“œ`;
               }
             }
             
             // Packaging ë¶„ì„ ìˆ˜í–‰
             function performPackagingAnalysis() {
               console.log('ğŸ“¦ Performing Packaging analysis...');
               
               const data = window.packagingFilteredData || [];
               console.log('Packaging data:', data.length, 'records');
               
               // Hold Whetherê°€ 'N'ì¸ ê²ƒë§Œ í•„í„°ë§ (RACK NO ìœ ë¬´ ê´€ê³„ì—†ì´)
               const validData = data.filter(item => 
                 item.hold_whether === 'N'
               );
               
               console.log(`ğŸ“Š Valid records for packaging analysis: ${validData.length} out of ${data.length}`);
               
               // íŒ”ë ˆíŠ¸ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ TM COUNT ê³„ì‚°
               const palletGroups = {};
               validData.forEach(item => {
                 const palletNo = item.pallet_no || 'Unknown';
                 if (!palletGroups[palletNo]) {
                   palletGroups[palletNo] = {
                     palletNo: palletNo,
                     rackNo: new Set(),
                     tmCount: new Set(),
                     partNo: new Set(),
                     location: item.location || 'Unknown',
                     holdWhether: item.hold_whether,
                     items: []
                   };
                 }
                 
                 // Rack No ìˆ˜ì§‘
                 if (item.rack_no && item.rack_no.trim() !== '') {
                   palletGroups[palletNo].rackNo.add(item.rack_no);
                 }
                 
                 // TM No ìˆ˜ì§‘ (ê³ ìœ í•œ TM ê°œìˆ˜ ê³„ì‚°)
                 if (item.tm_no && item.tm_no.trim() !== '') {
                   palletGroups[palletNo].tmCount.add(item.tm_no);
                 }
                 
                 // Part No ìˆ˜ì§‘
                 if (item.part_no && item.part_no.trim() !== '') {
                   palletGroups[palletNo].partNo.add(item.part_no);
                 }
                 
                 // ì•„ì´í…œ ì €ì¥
                 palletGroups[palletNo].items.push(item);
               });
               
               // Locationë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ í¬ì¥ ì „/í›„ ë¶„ì„
               const locationGroups = {};
               let totalRecords = data.length;
               let filteredRecords = validData.length;
               
               Object.values(palletGroups).forEach(palletGroup => {
                 const location = palletGroup.location;
                 if (!locationGroups[location]) {
                   locationGroups[location] = {
                     location: location,
                     totalPallets: 0,
                     beforePackaging: 0,
                     afterPackaging: 0,
                     pallets: []
                   };
                 }
                 
                 locationGroups[location].totalPallets++;
                 
                 // RACK NOì— ë”°ë¼ í¬ì¥ ì „/í›„ êµ¬ë¶„ (ì²« ë²ˆì§¸ RACK NO ê¸°ì¤€)
                 const rackNo = Array.from(palletGroup.rackNo)[0] || '';
                 let packagingStatus = 'Unknown';
                 
                 if (rackNo === '') {
                   // RACK NOê°€ ì—†ëŠ” ê²½ìš°
                   packagingStatus = 'No Rack No';
                   if (!locationGroups[location].noRackNo) {
                     locationGroups[location].noRackNo = 0;
                   }
                   locationGroups[location].noRackNo++;
                 } else if (rackNo.startsWith('LHSAB') || rackNo.startsWith('LHSBA') || 
                           rackNo.startsWith('LHSAA') || rackNo.startsWith('LHSBB')) {
                   packagingStatus = 'Before Packaging';
                   locationGroups[location].beforePackaging++;
                 } else if (rackNo.startsWith('LHSAC') || rackNo.startsWith('LHSAD') || 
                           rackNo.startsWith('LHSBC') || rackNo.startsWith('LHSBD')) {
                   packagingStatus = 'After Packaging';
                   locationGroups[location].afterPackaging++;
                 } else {
                   // ê¸°íƒ€ RACK NOëŠ” Hold Whether 'N'ì´ë¯€ë¡œ After Packaging
                   packagingStatus = 'After Packaging';
                   locationGroups[location].afterPackaging++;
                 }
                 
                 // íŒ”ë ˆíŠ¸ ì •ë³´ ì €ì¥ (ì‹¤ì œ TM COUNT ì‚¬ìš©)
                 locationGroups[location].pallets.push({
                   palletNo: palletGroup.palletNo,
                   rackNo: Array.from(palletGroup.rackNo).filter(r => r).join(', ') || 'N/A',
                   partNo: Array.from(palletGroup.partNo).filter(p => p).join(', ') || 'N/A',
                   tmCount: palletGroup.tmCount.size, // ì‹¤ì œ ê³ ìœ í•œ TM ê°œìˆ˜
                   packagingStatus: packagingStatus,
                   location: location,
                   holdWhether: palletGroup.holdWhether,
                   items: palletGroup.items
                 });
               });
               
               // ê²°ê³¼ë¥¼ í‰ë©´í™”í•˜ì—¬ í…Œì´ë¸”ì— í‘œì‹œ
               const results = [];
               Object.values(locationGroups).forEach(group => {
                 results.push(...group.pallets);
               });
               
               console.log(`ğŸ“Š Packaging analysis completed: ${totalRecords} total records, ${filteredRecords} valid records (Hold Whether 'N' + RACK NO exists) processed`);
               console.log(`ğŸ“Š Processed ${Object.keys(palletGroups).length} unique pallets`);
               
               window.packagingLastResults = results;
               displayPackagingResults(results);
               updatePackagingSummary(locationGroups);
             }
             
             // íŒ¨í‚¤ì§• íƒ€ì… ê²°ì •
             function determinePackagingType(partNo) {
               if (!partNo) return 'Standard';
               
               // Part Noì— ë”°ë¥¸ íŒ¨í‚¤ì§• íƒ€ì… ê²°ì • ë¡œì§
               if (partNo.includes('3T2')) return 'High Priority';
               if (partNo.includes('3T3')) return 'Standard';
               if (partNo.includes('3T4')) return 'Bulk';
               return 'Standard';
             }
             
             // ìµœì í™” ì ìˆ˜ ê³„ì‚°
             function calculateOptimization(partNo, location) {
               if (!partNo || !location) return 'N/A';
               
               // ê°„ë‹¨í•œ ìµœì í™” ì ìˆ˜ ê³„ì‚°
               let score = 0;
               if (location === 'F101') score += 10; // F101ì€ ë” íš¨ìœ¨ì 
               if (partNo.includes('3T2')) score += 15; // ê³ ìš°ì„ ìˆœìœ„ ë¶€í’ˆ
               if (partNo.includes('3T3')) score += 10; // í‘œì¤€ ë¶€í’ˆ
               if (partNo.includes('3T4')) score += 5; // ë²Œí¬ ë¶€í’ˆ
               
               if (score >= 20) return 'Excellent';
               if (score >= 15) return 'Good';
               if (score >= 10) return 'Fair';
               return 'Poor';
             }
             
             // Packaging ê²°ê³¼ í‘œì‹œ
             function displayPackagingResults(results) {
               console.log('ğŸ“‹ Displaying Packaging results...');
               
               const tableBody = document.getElementById('packagingResultsTable');
               if (!tableBody) return;
               
               if (results.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                 return;
               }
               
               const tableRows = results.map(result => `
                 <tr class="hover:bg-gray-50">
                   <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.palletNo}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.rackNo}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.partNo}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                     <span class="${result.holdWhether === 'Y' ? 'text-red-500 line-through' : 'text-gray-900'}">${result.tmCount}</span>
                     ${result.holdWhether === 'Y' ? '<span class="text-xs text-red-500 ml-1">(HOLD)</span>' : ''}
                   </td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                     <span class="px-2 py-1 text-xs font-medium rounded-full ${
                       result.packagingStatus === 'After Packaging' ? 'bg-green-100 text-green-800' :
                       result.packagingStatus === 'Before Packaging' ? 'bg-yellow-100 text-yellow-800' :
                       result.packagingStatus === 'No Rack No' ? 'bg-red-100 text-red-800' :
                       'bg-gray-100 text-gray-800'
                     }">${result.packagingStatus}</span>
                   </td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                     <span class="px-2 py-1 text-xs font-medium rounded-full ${
                       result.location === 'F101' ? 'bg-blue-100 text-blue-800' :
                       result.location === 'F100' ? 'bg-purple-100 text-purple-800' :
                       'bg-gray-100 text-gray-800'
                     }">${result.location}</span>
                   </td>
                 </tr>
               `);
               
               tableBody.innerHTML = tableRows.join('');
               
               // ê²°ê³¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
               const resultCount = document.getElementById('packagingResultCount');
               if (resultCount) {
                 resultCount.textContent = `Found ${results.length} pallets`;
               }
               
               // ë°ì´í„° ì •ë³´ ì—…ë°ì´íŠ¸
               const dataInfo = document.getElementById('packagingDataInfo');
               if (dataInfo) {
                 const totalData = window.packagingAllData.length;
                 const validCount = window.packagingAllData.filter(item => 
                   item.hold_whether === 'N' && item.rack_no && item.rack_no.trim() !== ''
                 ).length;
                 dataInfo.textContent = `ì´ ${totalData}ê°œ ë ˆì½”ë“œ ì¤‘ ìœ íš¨í•œ ë ˆì½”ë“œ (Hold Whether 'N' + RACK NO): ${validCount}ê°œ, í‘œì‹œ: ${results.length}ê°œ`;
               }
             }
             
             // Packaging ìš”ì•½ ì—…ë°ì´íŠ¸
             function updatePackagingSummary(locationGroups) {
               console.log('ğŸ“Š Updating Packaging summary...');
               
               const totalPallets = document.getElementById('packagingTotalPallets');
               const beforePallets = document.getElementById('packagingBeforePallets');
               const afterPallets = document.getElementById('packagingAfterPallets');
               const noRackPallets = document.getElementById('packagingNoRackPallets');
               const packagingRate = document.getElementById('packagingRate');
               
               // ì „ì²´ í†µê³„ ê³„ì‚°
               let totalCount = 0;
               let beforeCount = 0;
               let afterCount = 0;
               let noRackCount = 0;
               let totalTmCount = 0; // Hold Whether 'Y' ì œì™¸í•œ TM COUNT
               
               Object.values(locationGroups).forEach(group => {
                 totalCount += group.totalPallets;
                 beforeCount += group.beforePackaging;
                 afterCount += group.afterPackaging;
                 noRackCount += group.noRackNo || 0;
                 
                 // TM COUNT ê³„ì‚° (Hold Whether 'Y' ì œì™¸)
                 group.pallets.forEach(pallet => {
                   if (pallet.holdWhether !== 'Y') {
                     totalTmCount += pallet.tmCount;
                   }
                 });
               });
               
               const packagingRatePercent = totalCount > 0 ? Math.round((afterCount / totalCount) * 100) : 0;
               
               if (totalPallets) {
                 totalPallets.innerHTML = `<div class="text-2xl font-bold text-blue-600">${totalTmCount}</div><div class="text-sm text-gray-500">EA</div><div class="text-xs text-gray-400">íŒ”ë ˆíŠ¸: ${totalCount}ê°œ</div>`;
               }
               
               if (beforePallets) {
                 const beforeTmCount = Object.values(locationGroups).reduce((sum, group) => {
                   return sum + group.pallets.filter(p => p.packagingStatus === 'Before Packaging' && p.holdWhether !== 'Y').reduce((pSum, p) => pSum + p.tmCount, 0);
                 }, 0);
                 beforePallets.innerHTML = `<div class="text-2xl font-bold text-yellow-600">${beforeTmCount}</div><div class="text-sm text-gray-500">EA</div><div class="text-xs text-gray-400">íŒ”ë ˆíŠ¸: ${beforeCount}ê°œ</div>`;
               }
               
               if (afterPallets) {
                 const afterTmCount = Object.values(locationGroups).reduce((sum, group) => {
                   return sum + group.pallets.filter(p => p.packagingStatus === 'After Packaging' && p.holdWhether !== 'Y').reduce((pSum, p) => pSum + p.tmCount, 0);
                 }, 0);
                 afterPallets.innerHTML = `<div class="text-2xl font-bold text-green-600">${afterTmCount}</div><div class="text-sm text-gray-500">EA</div><div class="text-xs text-gray-400">íŒ”ë ˆíŠ¸: ${afterCount}ê°œ</div>`;
               }
               
               if (noRackPallets) {
                 const noRackTmCount = Object.values(locationGroups).reduce((sum, group) => {
                   return sum + group.pallets.filter(p => p.packagingStatus === 'No Rack No' && p.holdWhether !== 'Y').reduce((pSum, p) => pSum + p.tmCount, 0);
                 }, 0);
                 noRackPallets.innerHTML = `<div class="text-2xl font-bold text-red-600">${noRackTmCount}</div><div class="text-sm text-gray-500">EA</div><div class="text-xs text-gray-400">íŒ”ë ˆíŠ¸: ${noRackCount}ê°œ</div>`;
               }
               
               if (packagingRate) {
                 packagingRate.innerHTML = `<div class="text-2xl font-bold text-purple-600">${packagingRatePercent}%</div><div class="text-sm text-gray-500">í¬ì¥ë¥ </div>`;
               }
               
               console.log(`ğŸ“Š Packaging summary: ${totalCount} pallets, ${totalTmCount} TMs (EA) - Hold Whether 'Y' excluded`);
             }
             
             // Packaging Excel ë‚´ë³´ë‚´ê¸°
             function exportPackagingData() {
               console.log('ğŸ“Š Exporting Packaging data...');
               
               if (!window.packagingLastResults || window.packagingLastResults.length === 0) {
                 alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                 return;
               }
               
               // Excel ë‚´ë³´ë‚´ê¸° ë¡œì§
               const workbook = new ExcelJS.Workbook();
               const worksheet = workbook.addWorksheet('Packaging Analysis Results');
               
               // í—¤ë” ì¶”ê°€
               worksheet.addRow(['Pallet No', 'Rack No', 'Part No', 'TM Count', 'Packaging Status', 'Location']);
               
               // ë°ì´í„° ì¶”ê°€
               window.packagingLastResults.forEach(result => {
                 worksheet.addRow([
                   result.palletNo || '',
                   result.rackNo || '',
                   result.partNo || '',
                   result.tmCount || 0,
                   result.packagingStatus || '',
                   result.location || ''
                 ]);
               });
               
               // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
               workbook.xlsx.writeBuffer().then(buffer => {
                 const blob = new Blob([buffer], { 
                   type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                 });
                 const url = window.URL.createObjectURL(blob);
                 const link = document.createElement('a');
                 link.href = url;
                 link.download = `packaging_analysis_${new Date().toISOString().slice(0, 10)}.xlsx`;
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 window.URL.revokeObjectURL(url);
               });
             }
             
             // Packaging í…Œì´ë¸” ì •ë ¬
             function sortPackagingTable(column) {
               console.log(`ğŸ” Sorting Packaging table by column: ${column}`);
               
               if (window.packagingCurrentSortColumn === column) {
                 window.packagingCurrentSortDirection = window.packagingCurrentSortDirection === 'asc' ? 'desc' : 'asc';
               } else {
                 window.packagingCurrentSortColumn = column;
                 window.packagingCurrentSortDirection = 'asc';
               }
               
               const results = [...window.packagingLastResults];
               results.sort((a, b) => {
                 let aVal = a[column] || '';
                 let bVal = b[column] || '';
                 
                 if (['tmCount'].includes(column)) {
                   aVal = parseFloat(aVal) || 0;
                   bVal = parseFloat(bVal) || 0;
                 } else {
                   aVal = String(aVal).toLowerCase();
                   bVal = String(bVal).toLowerCase();
                 }
                 
                 if (aVal < bVal) return window.packagingCurrentSortDirection === 'asc' ? -1 : 1;
                 if (aVal > bVal) return window.packagingCurrentSortDirection === 'asc' ? 1 : -1;
                 return 0;
               });
               
               displayPackagingResults(results);
               updatePackagingSortIcons(column);
             }
             
             // Packaging ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
             function updatePackagingSortIcons(activeColumn) {
               const columns = ['palletNo', 'rackNo', 'partNo', 'tmCount', 'packagingStatus', 'location'];
               columns.forEach(col => {
                 const icon = document.getElementById(`packaging-sort-${col}`);
                 if (icon) {
                   if (col === activeColumn) {
                     icon.textContent = window.packagingCurrentSortDirection === 'asc' ? 'â†‘' : 'â†“';
                   } else {
                     icon.textContent = 'â†•';
                   }
                 }
               });
             }

             // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜ (ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™)
             async function handleFileUpload() {
               const fileInput = document.getElementById('fileInput');
               const file = fileInput.files[0];
               const statusDiv = document.getElementById('uploadStatus');
               const tableDiv = document.getElementById('dataTable');
               
               if (!file) {
                 statusDiv.innerHTML = '<div class="text-red-600">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
                 return;
               }
               
               // Supabase ì—°ê²° í™•ì¸
               if (!window.sb) {
                 statusDiv.innerHTML = '<div class="text-red-600">âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</div>';
                 console.error('âŒ Supabase client not available');
                 return;
               }
               
               const supabase = window.sb;
               statusDiv.innerHTML = '<div class="text-blue-600">ğŸ“ íŒŒì¼ ì½ëŠ” ì¤‘...</div>';
               
               try {
                 // 1ë‹¨ê³„: íŒŒì¼ ì½ê¸°
                 const data = await readExcelFile(file);
                 if (!data || data.length === 0) {
                   throw new Error('No data found in file');
                 }
                 
                 statusDiv.innerHTML = '<div class="text-blue-600">ğŸ” ë°ì´í„° ê²€ì¦ ì¤‘...</div>';
                 
                 // 2ë‹¨ê³„: ë°ì´í„° ê²€ì¦
                 const validatedData = validateData(data);
                 if (!validatedData || validatedData.length === 0) {
                   throw new Error('No valid data after validation');
                 }
                 
                 statusDiv.innerHTML = '<div class="text-blue-600">ğŸ—‘ï¸ ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘...</div>';
                 
                 // 3ë‹¨ê³„: ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
                 const { error: deleteError } = await supabase
                   .from('vwtm_list_data')
                   .delete()
                   .neq('id', 0);
                 
                 if (deleteError) {
                   throw new Error(`Delete error: ${deleteError.message}`);
                 }
                 
                 statusDiv.innerHTML = '<div class="text-blue-600">ğŸ“ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ ì¤‘...</div>';
                 
                 // 4ë‹¨ê³„: ìƒˆ ë°ì´í„° ì¶”ê°€ (ë°°ì¹˜ ì²˜ë¦¬)
                 const batchSize = 500;
                 const batches = [];
                 
                 for (let i = 0; i < validatedData.length; i += batchSize) {
                   batches.push(validatedData.slice(i, i + batchSize));
                 }
                 
                 let totalInserted = 0;
                 let failedBatches = [];
                 
                 for (let i = 0; i < batches.length; i++) {
                   const batch = batches[i];
                   statusDiv.innerHTML = `<div class="text-blue-600">ğŸ“¤ ë°°ì¹˜ ${i + 1}/${batches.length} ì²˜ë¦¬ ì¤‘... (${totalInserted}ê°œ ì™„ë£Œ)</div>`;
                   
                   try {
                     const { data: result, error: insertError } = await supabase
                       .from('vwtm_list_data')
                       .insert(batch);
                     
                     if (insertError) {
                       console.error(`âŒ Batch ${i + 1} insert error:`, insertError);
                       failedBatches.push({ batchIndex: i, error: insertError });
                       continue;
                     }
                     
                     if (result) {
                       totalInserted += result.length;
                     }
                   } catch (batchError) {
                     console.error(`âŒ Batch ${i + 1} unexpected error:`, batchError);
                     failedBatches.push({ batchIndex: i, error: batchError });
                   }
                 }
                 
                 // ê²°ê³¼ í‘œì‹œ
                 if (failedBatches.length > 0) {
                   const successRate = ((batches.length - failedBatches.length) / batches.length * 100).toFixed(1);
                   statusDiv.innerHTML = `<div class="text-yellow-600">âš ï¸ ì—…ë¡œë“œ ì™„ë£Œ: ${totalInserted}ê°œ ì„±ê³µ, ${failedBatches.length}ê°œ ë°°ì¹˜ ì‹¤íŒ¨ (${successRate}% ì„±ê³µë¥ )</div>`;
                 } else {
                   statusDiv.innerHTML = `<div class="text-green-600">âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${totalInserted}ê°œ ë ˆì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>`;
                 }
                 
                 // ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ìƒì„±
                 if (validatedData.length > 0) {
                   let tableHTML = '<h3 class="text-lg font-semibold mb-4">ì—…ë¡œë“œëœ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°:</h3>';
                     tableHTML += '<div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-300">';
                     
                     // í—¤ë”
                     tableHTML += '<thead class="bg-gray-50"><tr>';
                   const headers = ['Pallet No', 'Location', 'Rack No', 'TM No', 'Part No', 'Hold Whether', 'Prod Date'];
                   headers.forEach(header => {
                     tableHTML += `<th class="px-4 py-2 border-b text-left">${header}</th>`;
                     });
                     tableHTML += '</tr></thead>';
                     
                   // ë°ì´í„° í–‰ (ì²˜ìŒ 10ê°œë§Œ)
                     tableHTML += '<tbody>';
                   validatedData.slice(0, 10).forEach(row => {
                       tableHTML += '<tr>';
                     tableHTML += `<td class="px-4 py-2 border-b">${row.pallet_no || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.location || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.rack_no || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.tm_no || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.part_no || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.hold_whether || ''}</td>`;
                     tableHTML += `<td class="px-4 py-2 border-b">${row.prod_date || ''}</td>`;
                       tableHTML += '</tr>';
                     });
                     tableHTML += '</tbody></table></div>';
                     
                   if (validatedData.length > 10) {
                     tableHTML += `<p class="text-sm text-gray-600 mt-2">ì´ ${validatedData.length}ê°œ í–‰ ì¤‘ ì²˜ìŒ 10ê°œ í–‰ì„ í‘œì‹œí•©ë‹ˆë‹¤.</p>`;
                     }
                     
                     tableDiv.innerHTML = tableHTML;
                   }
                 
                 } catch (error) {
                 console.error('âŒ Upload failed:', error);
                 statusDiv.innerHTML = `<div class="text-red-600">âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
               }
             }
             
             // Excel íŒŒì¼ ì½ê¸° í•¨ìˆ˜
             function readExcelFile(file) {
               return new Promise((resolve, reject) => {
                 const reader = new FileReader();
                 
                 reader.onload = (e) => {
                   try {
                     const data = new Uint8Array(e.target.result);
                     const workbook = XLSX.read(data, { type: 'array' });
                     const sheetName = workbook.SheetNames[0];
                     const worksheet = workbook.Sheets[sheetName];
                     const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                     
                     // 5í–‰ë¶€í„° ë°ì´í„° ì‹œì‘ (ì¸ë±ìŠ¤ 4ë¶€í„°)
                     const startRow = 4;
                     const dataRows = jsonData.slice(startRow).filter(row => 
                       row && row.length > 0 && row.some(cell => cell !== undefined && cell !== '')
                     );
                     
                     resolve(dataRows);
                   } catch (error) {
                     reject(new Error(`Excel parsing failed: ${error.message}`));
                   }
                 };
                 
                 reader.onerror = () => reject(new Error('File reading failed'));
               reader.readAsArrayBuffer(file);
               });
             }
             
             // ë°ì´í„° ê²€ì¦ í•¨ìˆ˜
             function validateData(data) {
               if (!data || !Array.isArray(data)) {
                 return [];
               }
               
               const validatedData = [];
               
               data.forEach((row, index) => {
                 try {
                   if (!row || !Array.isArray(row) || row.length < 10) {
                     return;
                   }
                   
                   const rowData = {
                     pallet_no: String(row[1] || '').trim().substring(0, 100),
                     location: String(row[2] || '').trim().substring(0, 100),
                     rack_no: String(row[3] || '').trim().substring(0, 100),
                     tm_no: String(row[4] || '').trim().substring(0, 100),
                     part_no: String(row[5] || '').trim().substring(0, 100),
                     hold_whether: String(row[7] || 'N').trim().substring(0, 10),
                     prod_date: String(row[9] || '').trim().substring(0, 50)
                   };
                   
                   if (rowData.pallet_no && rowData.tm_no) {
                     validatedData.push(rowData);
                   }
                 } catch (rowError) {
                   console.error(`âŒ Error processing row ${index + 1}:`, rowError);
                 }
               });
               
               return validatedData;
             }

             // STATUS í˜ì´ì§€ë¥¼ ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
             function openStatusInNewTab() {
               // ë¡œì»¬ê³¼ ë™ì¼í•˜ê²Œ ì‘ë™í•˜ë„ë¡ ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©
               const statusUrl = './pages/truck/status.html';
               window.open(statusUrl, '_blank');
             }

    console.log('âœ… TM System loaded successfully');
  </script>
</body>
</html>