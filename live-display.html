<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Display - Packaging Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #1d4ed8 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        .timer-display {
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .status-active {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .schedule-item {
            transition: all 0.3s ease;
        }
        
        .schedule-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="h-screen p-4 bg-gray-900 text-white overflow-hidden">
        <!-- Header -->
        <div class="text-center mb-4 relative">
            <h2 class="text-3xl font-semibold text-blue-300 mb-1">PACKAGING SCHEDULE STATUS</h2>
            <div class="text-lg font-bold text-yellow-300 mb-2" id="displayDate">-</div>
            <button onclick="toggleFullscreen()" id="fullscreenBtn" class="absolute top-0 right-0 bg-red-500 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg">
                <span id="fullscreenText">🖥️ FULLSCREEN</span>
            </button>
        </div>

        <!-- Current Status Card -->
        <div class="bg-gray-800 rounded-xl shadow-xl p-6 mb-4">
            <div class="text-center">
                <h3 class="text-3xl font-bold mb-6 text-green-300">CURRENT PROGRESS</h3>
                <div class="grid grid-cols-3 gap-6">
                    <!-- Current NO -->
                    <div class="bg-gray-700 rounded-lg p-6 border-2 border-gray-600 flex items-center justify-center">
                        <div class="text-8xl font-bold text-yellow-300" id="currentId">-</div>
                    </div>
                    
                    <!-- Current Part -->
                    <div class="bg-gray-700 rounded-lg p-6 border-2 border-gray-600 flex items-center justify-center">
                        <div class="text-8xl font-bold text-blue-300" id="currentPart">-</div>
                    </div>
                    
                    <!-- Elapsed Time -->
                    <div class="bg-gray-700 rounded-lg p-6 border-2 border-gray-600 flex items-center justify-center">
                        <div class="text-8xl font-bold text-red-300 timer-display" id="elapsedTime">00:00:00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Schedule -->
        <div class="bg-gray-800 rounded-xl shadow-xl p-6 flex-1">
            <h3 class="text-2xl font-bold mb-4 text-center text-green-300">TODAY'S SCHEDULE</h3>
            <div class="overflow-y-auto h-[600px]">
                <div id="scheduleList" class="space-y-2">
                    <!-- Schedule items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
        
        // Supabase 클라이언트 생성
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            autoRefreshToken: true,
            persistSession: true
        });

        // 전역 변수
        let displayScheduleData = [];
        let displayStartTime = null;
        let displayCurrentId = null;
        let displayCurrentPart = null;
        let displayTimerInterval = null;
        let displayRefreshInterval = null;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📺 Live Display page initializing...');
            initializeDisplayPage();
        });

        // Live Display 페이지 초기화
        function initializeDisplayPage() {
            console.log('📺 Initializing Live Display page...');
            
            // 전역 변수 초기화
            displayStartTime = null;
            displayCurrentId = null;
            displayCurrentPart = null;
            
            // 오늘 날짜 표시
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            document.getElementById('displayDate').textContent = dateStr;
            
            // 데이터 로드
            loadDisplayScheduleData();
            
            // 자동 새로고침 시작
            startDisplayAutoRefresh();
        }

        // 스케줄 데이터 로드
        async function loadDisplayScheduleData() {
            try {
                console.log('📊 Loading display schedule data...');
                
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('tm_packaging_schedule')
                    .select('*')
                    .eq('work_date', today)
                    .order('seq_no', { ascending: true });
                
                if (error) throw error;
                
                displayScheduleData = data || [];
                console.log('✅ Display schedule data loaded:', displayScheduleData);
                
                displaySchedule();
                updateDisplayCurrentStatus();
                
            } catch (error) {
                console.error('Error loading display schedule data:', error);
                console.warn('⚠️ Unable to load data. Please check Supabase connection.');
                displayScheduleData = [];
                displaySchedule();
            }
        }

        // 스케줄 표시
        function displaySchedule() {
            const scheduleList = document.getElementById('scheduleList');
            if (!scheduleList) return;
            
            if (displayScheduleData.length === 0) {
                scheduleList.innerHTML = '<div class="text-center text-gray-400 py-8">No schedule for today</div>';
                return;
            }
            
            // 완료된 항목을 아래로 정렬
            const sortedData = [...displayScheduleData].sort((a, b) => {
                const statusA = calculateStatus(a);
                const statusB = calculateStatus(b);
                
                // 진행중 > 대기 > 완료 순서로 정렬
                if (statusA === 'active' && statusB !== 'active') return -1;
                if (statusA !== 'active' && statusB === 'active') return 1;
                if (statusA === 'waiting' && statusB === 'completed') return -1;
                if (statusA === 'completed' && statusB === 'waiting') return 1;
                
                return (a.seq_no || 0) - (b.seq_no || 0);
            });
            
            let html = '';
            sortedData.forEach((item, index) => {
                const workStatus = calculateStatus(item);
                // 상태별 배경색 설정
                const bgColor = workStatus === 'completed' ? 'bg-gray-600' :
                               workStatus === 'active' ? 'bg-green-500' :
                               'bg-orange-500';
                
                const statusText = workStatus === 'completed' ? 'COMPLETED' :
                                 workStatus === 'active' ? 'IN PROGRESS' :
                                 'WAITING';
                
                // 완료된 항목은 투명도 적용
                const opacityClass = workStatus === 'completed' ? 'opacity-60' : '';
                
                html += `
                    <div class="schedule-item ${bgColor} rounded-lg p-4 border-l-4 ${workStatus === 'active' ? 'border-green-300 status-active' : workStatus === 'completed' ? 'border-gray-400' : 'border-orange-300'} ${opacityClass}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-6">
                                <div class="text-2xl font-bold text-white">${item.seq_no}</div>
                                <div class="text-4xl font-bold text-white">${item.part_no || '-'}</div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-700 text-white">
                                    ${statusText}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            scheduleList.innerHTML = html;
        }

        // 현재 상태 업데이트
        function updateDisplayCurrentStatus() {
            const activeItem = displayScheduleData.find(item => item.work_status === 'active');

            if (activeItem) {
                // 새로운 활성 작업이거나 기존 작업과 다른 경우에만 업데이트
                if (displayCurrentId !== activeItem.seq_no) {
                    displayCurrentId = activeItem.seq_no;
                    displayCurrentPart = activeItem.part_no;

                    document.getElementById('currentId').textContent = `NO ${displayCurrentId}`;
                    document.getElementById('currentPart').textContent = displayCurrentPart;

                    console.log('🔄 Active work changed to:', activeItem.seq_no);
                }

                // Start timer if not already started and work has started
                if (!displayStartTime && activeItem.work_start_time) {
                    // 시작 시간을 Date 객체로 변환 (오늘 날짜 + 시작 시간)
                    const today = new Date();
                    const [hours, minutes] = activeItem.work_start_time.split(':');
                    displayStartTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parseInt(hours), parseInt(minutes));
                    console.log('⏰ Timer started for work:', activeItem.seq_no, 'at', activeItem.work_start_time);
                    startDisplayTimer();
                }

                // 이미 타이머가 시작되었고 같은 작업이면 타이머 유지
                if (displayStartTime && displayCurrentId === activeItem.seq_no) {
                    // 타이머는 계속 실행됨 - 아무것도 하지 않음
                }
            } else {
                // 활성 작업이 없을 때만 타이머 중지 (기존에 활성 작업이 있었던 경우에만)
                if (displayCurrentId && displayStartTime) {
                    console.log('⏰ No active work, stopping timer');
                    document.getElementById('currentId').textContent = '-';
                    document.getElementById('currentPart').textContent = '-';
                    document.getElementById('elapsedTime').textContent = '00:00:00';

                    if (displayTimerInterval) {
                        clearInterval(displayTimerInterval);
                        displayTimerInterval = null;
                    }
                    displayStartTime = null;
                    displayCurrentId = null;
                    displayCurrentPart = null;
                }
            }
        }

        // 타이머 시작
        function startDisplayTimer() {
            if (displayTimerInterval) {
                clearInterval(displayTimerInterval);
            }

            console.log('⏰ Display timer started');

            displayTimerInterval = setInterval(() => {
                if (displayStartTime) {
                    const now = new Date();
                    const elapsed = Math.floor((now - displayStartTime) / 1000);

                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const seconds = elapsed % 60;

                    const timeString = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
                    const elapsedTimeEl = document.getElementById('elapsedTime');
                    if (elapsedTimeEl) {
                        elapsedTimeEl.textContent = timeString;

                        // 경과 시간에 따라 색상 변경 (1시간 기준)
                        const totalMinutes = hours * 60 + minutes;
                        elapsedTimeEl.className = elapsedTimeEl.className.replace(/text-(green|red)-300/, '');
                        if (totalMinutes < 60) {
                            elapsedTimeEl.classList.add('text-green-300');
                        } else {
                            elapsedTimeEl.classList.add('text-red-300');
                        }
                    }

                    // 디버깅을 위한 로그 (30초마다 - 로그 스팸 방지)
                    if (seconds % 30 === 0) {
                        console.log(`⏰ Display Timer update: Elapsed: ${timeString}`);
                    }

                    // 스케줄 목록의 진행중인 작업 경과시간도 업데이트 (5초마다만)
                    if (seconds % 5 === 0) {
                        displaySchedule();
                    }
                } else {
                    // 타이머가 중지된 경우에만 로그 출력
                    if (displayTimerInterval) {
                        console.log('⏰ Display timer stopped - no start time');
                    }
                }
            }, 1000);
        }

        // 상태 계산
        function calculateStatus(item) {
            if (item.work_start_time && item.work_end_time) {
                return 'completed';
            } else if (item.work_start_time) {
                return 'active';
            } else {
                return 'waiting';
            }
        }


        // 자동 새로고침 시작
        function startDisplayAutoRefresh() {
            // 10초마다 데이터 새로고침
            if (displayRefreshInterval) {
                clearInterval(displayRefreshInterval);
            }
            displayRefreshInterval = setInterval(() => {
                console.log('🔄 Auto-refreshing Live Display data...');
                loadDisplayScheduleData();
            }, 10000);
        }

        // 전체화면 토글
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    document.getElementById('fullscreenText').textContent = '🖥️ EXIT FULLSCREEN';
                    console.log('🖥️ Entered fullscreen mode');
                }).catch(err => {
                    console.error('❌ Error entering fullscreen:', err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    document.getElementById('fullscreenText').textContent = '🖥️ FULLSCREEN';
                    console.log('🖥️ Exited fullscreen mode');
                }).catch(err => {
                    console.error('❌ Error exiting fullscreen:', err);
                });
            }
        }
    </script>
</body>
</html>
