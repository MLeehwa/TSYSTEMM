<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Display - Packaging Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #1d4ed8 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        .timer-display {
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .status-active {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .schedule-item {
            transition: all 0.3s ease;
        }
        
        .schedule-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="h-screen p-4 bg-gray-900 text-white overflow-hidden">
        <!-- Header -->
        <div class="text-center mb-4 relative">
            <h2 class="text-3xl font-semibold text-blue-300 mb-1">PACKAGING SCHEDULE STATUS</h2>
            <div class="text-lg font-bold text-yellow-300 mb-2" id="displayDate">-</div>
            <button onclick="toggleFullscreen()" id="fullscreenBtn" class="absolute top-0 right-0 bg-red-500 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg">
                <span id="fullscreenText">ğŸ–¥ï¸ FULLSCREEN</span>
            </button>
        </div>

        <!-- Current Status Card -->
        <div class="bg-gray-800 rounded-xl shadow-xl p-6 mb-4">
            <div class="text-center">
                <h3 class="text-3xl font-bold mb-6 text-green-300">CURRENT PROGRESS</h3>
                <div class="grid grid-cols-3 gap-6">
                    <!-- Current NO -->
                    <div class="bg-gray-700 rounded-lg p-6 border-2 border-gray-600 flex items-center justify-center">
                        <div class="text-8xl font-bold text-yellow-300" id="currentId">-</div>
                    </div>
                    
                    <!-- Current Part -->
                    <div class="bg-gray-700 rounded-lg p-6 border-2 border-gray-600 flex items-center justify-center">
                        <div class="text-8xl font-bold text-blue-300" id="currentPart">-</div>
                    </div>
                    
                    <!-- Elapsed Time -->
                    <div class="bg-gray-700 rounded-lg p-6 border-2 border-gray-600 flex items-center justify-center">
                        <div class="text-8xl font-bold text-red-300 timer-display" id="elapsedTime">00:00:00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Schedule -->
        <div class="bg-gray-800 rounded-xl shadow-xl p-6 flex-1">
            <h3 class="text-2xl font-bold mb-4 text-center text-green-300">TODAY'S SCHEDULE</h3>
            <div class="overflow-y-auto h-[600px]">
                <div id="scheduleList" class="space-y-2">
                    <!-- Schedule items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
        
        // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            autoRefreshToken: true,
            persistSession: true
        });

        // ì „ì—­ ë³€ìˆ˜
        let displayScheduleData = [];
        let displayStartTime = null;
        let displayCurrentId = null;
        let displayCurrentPart = null;
        let displayTimerInterval = null;
        let displayRefreshInterval = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“º Live Display page initializing...');
            initializeDisplayPage();
        });

        // Live Display í˜ì´ì§€ ì´ˆê¸°í™”
        function initializeDisplayPage() {
            console.log('ğŸ“º Initializing Live Display page...');
            
            // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
            displayStartTime = null;
            displayCurrentId = null;
            displayCurrentPart = null;
            
            // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            document.getElementById('displayDate').textContent = dateStr;
            
            // ë°ì´í„° ë¡œë“œ
            loadDisplayScheduleData();
            
            // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
            startDisplayAutoRefresh();
        }

        // ìŠ¤ì¼€ì¤„ ë°ì´í„° ë¡œë“œ
        async function loadDisplayScheduleData() {
            try {
                console.log('ğŸ“Š Loading display schedule data...');
                
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('tm_packaging_schedule')
                    .select('*')
                    .eq('work_date', today)
                    .order('seq_no', { ascending: true });
                
                if (error) throw error;
                
                displayScheduleData = data || [];
                console.log('âœ… Display schedule data loaded:', displayScheduleData);
                
                displaySchedule();
                updateDisplayCurrentStatus();
                
            } catch (error) {
                console.error('Error loading display schedule data:', error);
                console.warn('âš ï¸ Unable to load data. Please check Supabase connection.');
                displayScheduleData = [];
                displaySchedule();
            }
        }

        // ìŠ¤ì¼€ì¤„ í‘œì‹œ
        function displaySchedule() {
            const scheduleList = document.getElementById('scheduleList');
            if (!scheduleList) return;
            
            if (displayScheduleData.length === 0) {
                scheduleList.innerHTML = '<div class="text-center text-gray-400 py-8">No schedule for today</div>';
                return;
            }
            
            // ì™„ë£Œëœ í•­ëª©ì„ ì•„ë˜ë¡œ ì •ë ¬
            const sortedData = [...displayScheduleData].sort((a, b) => {
                const statusA = calculateStatus(a);
                const statusB = calculateStatus(b);
                
                // ì§„í–‰ì¤‘ > ëŒ€ê¸° > ì™„ë£Œ ìˆœì„œë¡œ ì •ë ¬
                if (statusA === 'active' && statusB !== 'active') return -1;
                if (statusA !== 'active' && statusB === 'active') return 1;
                if (statusA === 'waiting' && statusB === 'completed') return -1;
                if (statusA === 'completed' && statusB === 'waiting') return 1;
                
                return (a.seq_no || 0) - (b.seq_no || 0);
            });
            
            let html = '';
            sortedData.forEach((item, index) => {
                const workStatus = calculateStatus(item);
                // ìƒíƒœë³„ ë°°ê²½ìƒ‰ ì„¤ì •
                const bgColor = workStatus === 'completed' ? 'bg-gray-600' :
                               workStatus === 'active' ? 'bg-green-500' :
                               'bg-orange-500';
                
                const statusText = workStatus === 'completed' ? 'COMPLETED' :
                                 workStatus === 'active' ? 'IN PROGRESS' :
                                 'WAITING';
                
                // ì™„ë£Œëœ í•­ëª©ì€ íˆ¬ëª…ë„ ì ìš©
                const opacityClass = workStatus === 'completed' ? 'opacity-60' : '';
                
                html += `
                    <div class="schedule-item ${bgColor} rounded-lg p-4 border-l-4 ${workStatus === 'active' ? 'border-green-300 status-active' : workStatus === 'completed' ? 'border-gray-400' : 'border-orange-300'} ${opacityClass}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-6">
                                <div class="text-2xl font-bold text-white">${item.seq_no}</div>
                                <div class="text-4xl font-bold text-white">${item.part_no || '-'}</div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-700 text-white">
                                    ${statusText}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            scheduleList.innerHTML = html;
        }

        // í˜„ì¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateDisplayCurrentStatus() {
            const activeItem = displayScheduleData.find(item => item.work_status === 'active');

            if (activeItem) {
                // ìƒˆë¡œìš´ í™œì„± ì‘ì—…ì´ê±°ë‚˜ ê¸°ì¡´ ì‘ì—…ê³¼ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                if (displayCurrentId !== activeItem.seq_no) {
                    displayCurrentId = activeItem.seq_no;
                    displayCurrentPart = activeItem.part_no;

                    document.getElementById('currentId').textContent = `NO ${displayCurrentId}`;
                    document.getElementById('currentPart').textContent = displayCurrentPart;

                    console.log('ğŸ”„ Active work changed to:', activeItem.seq_no);
                }

                // Start timer if not already started and work has started
                if (!displayStartTime && activeItem.work_start_time) {
                    // ì‹œì‘ ì‹œê°„ì„ Date ê°ì²´ë¡œ ë³€í™˜ (ì˜¤ëŠ˜ ë‚ ì§œ + ì‹œì‘ ì‹œê°„)
                    const today = new Date();
                    const [hours, minutes] = activeItem.work_start_time.split(':');
                    displayStartTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parseInt(hours), parseInt(minutes));
                    console.log('â° Timer started for work:', activeItem.seq_no, 'at', activeItem.work_start_time);
                    startDisplayTimer();
                }

                // ì´ë¯¸ íƒ€ì´ë¨¸ê°€ ì‹œì‘ë˜ì—ˆê³  ê°™ì€ ì‘ì—…ì´ë©´ íƒ€ì´ë¨¸ ìœ ì§€
                if (displayStartTime && displayCurrentId === activeItem.seq_no) {
                    // íƒ€ì´ë¨¸ëŠ” ê³„ì† ì‹¤í–‰ë¨ - ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                }
            } else {
                // í™œì„± ì‘ì—…ì´ ì—†ì„ ë•Œë§Œ íƒ€ì´ë¨¸ ì¤‘ì§€ (ê¸°ì¡´ì— í™œì„± ì‘ì—…ì´ ìˆì—ˆë˜ ê²½ìš°ì—ë§Œ)
                if (displayCurrentId && displayStartTime) {
                    console.log('â° No active work, stopping timer');
                    document.getElementById('currentId').textContent = '-';
                    document.getElementById('currentPart').textContent = '-';
                    document.getElementById('elapsedTime').textContent = '00:00:00';

                    if (displayTimerInterval) {
                        clearInterval(displayTimerInterval);
                        displayTimerInterval = null;
                    }
                    displayStartTime = null;
                    displayCurrentId = null;
                    displayCurrentPart = null;
                }
            }
        }

        // íƒ€ì´ë¨¸ ì‹œì‘
        function startDisplayTimer() {
            if (displayTimerInterval) {
                clearInterval(displayTimerInterval);
            }

            console.log('â° Display timer started');

            displayTimerInterval = setInterval(() => {
                if (displayStartTime) {
                    const now = new Date();
                    const elapsed = Math.floor((now - displayStartTime) / 1000);

                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const seconds = elapsed % 60;

                    const timeString = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
                    const elapsedTimeEl = document.getElementById('elapsedTime');
                    if (elapsedTimeEl) {
                        elapsedTimeEl.textContent = timeString;

                        // ê²½ê³¼ ì‹œê°„ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½ (1ì‹œê°„ ê¸°ì¤€)
                        const totalMinutes = hours * 60 + minutes;
                        elapsedTimeEl.className = elapsedTimeEl.className.replace(/text-(green|red)-300/, '');
                        if (totalMinutes < 60) {
                            elapsedTimeEl.classList.add('text-green-300');
                        } else {
                            elapsedTimeEl.classList.add('text-red-300');
                        }
                    }

                    // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ (30ì´ˆë§ˆë‹¤ - ë¡œê·¸ ìŠ¤íŒ¸ ë°©ì§€)
                    if (seconds % 30 === 0) {
                        console.log(`â° Display Timer update: Elapsed: ${timeString}`);
                    }

                    // ìŠ¤ì¼€ì¤„ ëª©ë¡ì˜ ì§„í–‰ì¤‘ì¸ ì‘ì—… ê²½ê³¼ì‹œê°„ë„ ì—…ë°ì´íŠ¸ (5ì´ˆë§ˆë‹¤ë§Œ)
                    if (seconds % 5 === 0) {
                        displaySchedule();
                    }
                } else {
                    // íƒ€ì´ë¨¸ê°€ ì¤‘ì§€ëœ ê²½ìš°ì—ë§Œ ë¡œê·¸ ì¶œë ¥
                    if (displayTimerInterval) {
                        console.log('â° Display timer stopped - no start time');
                    }
                }
            }, 1000);
        }

        // ìƒíƒœ ê³„ì‚°
        function calculateStatus(item) {
            if (item.work_start_time && item.work_end_time) {
                return 'completed';
            } else if (item.work_start_time) {
                return 'active';
            } else {
                return 'waiting';
            }
        }


        // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
        function startDisplayAutoRefresh() {
            // 10ì´ˆë§ˆë‹¤ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            if (displayRefreshInterval) {
                clearInterval(displayRefreshInterval);
            }
            displayRefreshInterval = setInterval(() => {
                console.log('ğŸ”„ Auto-refreshing Live Display data...');
                loadDisplayScheduleData();
            }, 10000);
        }

        // ì „ì²´í™”ë©´ í† ê¸€
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    document.getElementById('fullscreenText').textContent = 'ğŸ–¥ï¸ EXIT FULLSCREEN';
                    console.log('ğŸ–¥ï¸ Entered fullscreen mode');
                }).catch(err => {
                    console.error('âŒ Error entering fullscreen:', err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    document.getElementById('fullscreenText').textContent = 'ğŸ–¥ï¸ FULLSCREEN';
                    console.log('ğŸ–¥ï¸ Exited fullscreen mode');
                }).catch(err => {
                    console.error('âŒ Error exiting fullscreen:', err);
                });
            }
        }
    </script>
</body>
</html>
