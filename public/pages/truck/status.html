<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Truck Status</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
                 body {
             font-family: 'Courier New', monospace;
             background: #000;
             color: #ffffff;
             overflow: hidden;
             height: 100vh;
         }
         
         .container {
             width: 100vw;
             height: 100vh;
             padding: 5px;
             background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
             overflow: hidden;
         }
        
                 .header {
             text-align: center;
             margin-bottom: 15px;
             border-bottom: 4px solid #00ff00;
             padding-bottom: 10px;
             position: relative;
             background: linear-gradient(135deg, rgba(0, 255, 0, 0.1), rgba(0, 0, 0, 0.3));
             border-radius: 15px;
             box-shadow: 0 0 40px rgba(0, 255, 0, 0.2);
         }
         
         
         
         .header-content {
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap;
             gap: 20px;
         }
         
                   .header h1 {
              font-size: 3.5rem;
              font-weight: bold;
              text-shadow: 0 0 30px #00ff00, 0 0 50px #00ff00;
              margin: 0;
              letter-spacing: 5px;
              position: relative;
              z-index: 1;
          }
         
         .last-update-display {
             display: flex;
             flex-direction: column;
             align-items: flex-end;
             gap: 5px;
             position: relative;
             z-index: 1;
         }
         
         .update-label {
             font-size: 1.2rem;
             color: #00ffff;
             font-weight: bold;
             letter-spacing: 2px;
             text-shadow: 0 0 15px #00ffff;
         }
         
         .update-time {
             font-size: 1.5rem;
             font-weight: bold;
             color: #ffffff;
             font-family: 'Digital-7', monospace;
             text-shadow: 0 0 20px #ffffff;
             letter-spacing: 3px;
         }
         
         .header p {
             font-size: 5rem;
             color: #00ffff;
             letter-spacing: 2px;
             position: relative;
             z-index: 1;
             text-shadow: 0 0 20px #00ffff;
         }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #00ff00;
            border-radius: 8px;
        }
        
        .date-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .date-label {
            font-weight: bold;
            font-size: 1.2rem;
            color: #00ffff;
        }
        
        .date-input {
            padding: 10px 15px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            background: #000;
            color: #00ff00;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
        }
        
        .date-input:focus {
            outline: none;
            box-shadow: 0 0 20px #00ff00;
        }
        
        .btn {
            padding: 12px 24px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            background: #000;
            color: #00ff00;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 20px #00ff00;
        }
        
        .status-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #ffffff;
            box-shadow: 0 0 60px rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        
                 .status-table th {
             background: linear-gradient(135deg, #00cc00, #009900);
             color: #000;
             padding: 12px 8px;
             text-align: center;
             font-size: 1.4rem;
             font-weight: bold;
             letter-spacing: 2px;
             border: 2px solid #ffffff;
             text-transform: uppercase;
             position: relative;
             overflow: hidden;
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif;
         }
         
         /* STATUS ì»¬ëŸ¼ë§Œ ë„“ì´ ì¡°ì • */
         .status-table th:first-child,
         .status-table td:first-child {
             width: 400px !important;
             max-width: 400px !important;
             min-width: 400px !important;
         }
         
         .status-table td {
             padding: 8px 6px;
             text-align: center;
             font-size: 5rem !important;
             border: 2px solid #ffffff;
             vertical-align: middle;
             position: relative;
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
             font-weight: bold !important;
         }
        
        .status-table tr:nth-child(even) {
            background: rgba(0, 255, 0, 0.05);
        }
        
        .status-table tr:hover {
            background: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        .status-row.shipped {
            border-left: 5px solid #00ffff;
            background: rgba(0, 255, 255, 0.05);
        }
        
        .status-row.scheduled {
            border-left: 5px solid #ffff00;
            background: rgba(255, 255, 0, 0.05);
        }
        
        .status-row.onsite {
            border-left: 5px solid #00ff00;
            background: rgba(0, 255, 0, 0.05);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 5rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-family: 'Arial Black', 'Helvetica Bold', sans-serif;
        }
        
        .status-badge.shipped {
            background: #0088cc;
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 136, 204, 0.5);
        }
        
        .status-badge.scheduled {
            background: #cc8800;
            color: #fff;
            box-shadow: 0 0 15px rgba(204, 136, 0, 0.5);
        }
        
        .status-badge.onsite {
            background: #008800;
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 136, 0, 0.5);
        }
        
        .no-status {
            text-align: center;
            padding: 100px 20px;
            font-size: 2rem;
            color: #666;
        }
        
        .auto-refresh {
            background: #00ff00;
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .auto-refresh.off {
            background: #666;
            color: #fff;
        }
        
        
        
        .scrolling-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
                 .time-display {
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
             font-size: 5rem !important;
             color: #00ccff;
             text-shadow: 0 0 15px rgba(0, 204, 255, 0.3);
             font-weight: bold !important;
             letter-spacing: 2px;
         }
         
         /* íŠ¸ëŸ­ ë²ˆí˜¸ ê°•ì¡° ìŠ¤íƒ€ì¼ - ë” êµ¬ì²´ì ì¸ ì„ íƒì ì‚¬ìš© */
         .status-table td:nth-child(5) .truck-id-highlight,
         .status-table td:nth-child(2) .truck-id-highlight,
         .status-table td:nth-child(5),
         .status-table td:nth-child(2) {
             font-size: 5rem !important;
             font-weight: bold !important;
             color: #fff !important;
             text-shadow: 0 0 20px rgba(204, 204, 0, 0.3) !important;
             letter-spacing: 3px !important;
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
         }
         
         /* ê¸°ì¡´ truck-id-highlight í´ë˜ìŠ¤ë„ ìœ ì§€ */
         .truck-id-highlight {
             font-size: 5rem !important;
             font-weight: bold !important;
             color: #fff;
             text-shadow: 0 0 20px rgba(204, 204, 0, 0.3);
             letter-spacing: 3px;
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
         }
         
         /* ETA TIME ê°•ì¡° ìŠ¤íƒ€ì¼ */
         .eta-time-highlight {
             font-size: 5rem !important;
             font-weight: bold !important;
             color: #00cc00;
             text-shadow: 0 0 25px rgba(0, 204, 0, 0.3);
             letter-spacing: 2px;
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
         }
         
                   /* ë” ì„¸ë ¨ëœ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
          .status-table {
              width: 100%;
              border-collapse: collapse;
              background: rgba(0, 0, 0, 0.9);
              border: 3px solid #ffffff;
              box-shadow: 0 0 60px rgba(255, 255, 255, 0.3);
              backdrop-filter: blur(10px);
          }
         
                   .status-table th {
              background: linear-gradient(135deg, #00ff00, #00cc00);
              color: #000;
              padding: 20px 15px;
              text-align: center;
              font-size: 1.8rem;
              font-weight: bold;
              letter-spacing: 3px;
              border: 2px solid #ffffff;
              text-transform: uppercase;
              position: relative;
              overflow: hidden;
              font-family: 'Arial Black', 'Helvetica Bold', sans-serif;
          }
         
         
         
                   .status-table td {
              padding: 18px 12px;
              text-align: center;
              font-size: 1.6rem;
              border: 2px solid #ffffff;
              vertical-align: middle;
              position: relative;
              font-family: 'Arial Black', 'Helvetica Bold', sans-serif;
              font-weight: bold;
          }
         
         /* ìƒíƒœë³„ í–‰ ìŠ¤íƒ€ì¼ ê°œì„  */
         .status-row.shipped {
             border-left: 8px solid #0088cc;
             background: linear-gradient(90deg, rgba(0, 136, 204, 0.1), rgba(0, 136, 204, 0.05));
             box-shadow: inset 0 0 20px rgba(0, 136, 204, 0.1);
             text-decoration: line-through;
             text-decoration-color: #0088cc;
             text-decoration-thickness: 3px;
             text-decoration-style: solid;
         }
         
         .status-row.shipped td {
             text-decoration: line-through !important;
             text-decoration-color: #0088cc !important;
             text-decoration-thickness: 3px !important;
             text-decoration-style: solid !important;
             opacity: 0.7;
         }
         
         .status-row.shipped .status-badge {
             text-decoration: none !important;
             opacity: 1;
         }
         
         .status-row.scheduled {
             border-left: 8px solid #cc8800;
             background: linear-gradient(90deg, rgba(204, 136, 0, 0.1), rgba(204, 136, 0, 0.05));
             box-shadow: inset 0 0 20px rgba(204, 136, 0, 0.1);
         }
         
         .status-row.onsite {
             border-left: 8px solid #008800;
             background: linear-gradient(90deg, rgba(0, 136, 0, 0.1), rgba(0, 136, 0, 0.05));
             box-shadow: inset 0 0 20px rgba(0, 136, 0, 0.1);
         }
         
         /* ìƒíƒœ ë°°ì§€ ê°œì„  */
         .status-badge {
             padding: 12px 20px;
             border-radius: 25px;
             font-weight: bold;
             font-size: 2.5rem !important;
             letter-spacing: 2px;
             text-transform: uppercase;
             position: relative;
             overflow: hidden;
             box-shadow: 0 4px 15px rgba(0,0,0,0.3);
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
         }
         
         
    </style>
</head>
<body>
    <div class="container">
                 <!-- í—¤ë” -->
         <div class="header">
             <div class="header-content">
                 <h1>ğŸš› LIVE TRUCK STATUS BOARD</h1>
                 <div class="last-update-display">
                     <span class="update-label">LAST UPDATE:</span>
                     <span class="update-time" id="headerLastUpdate">--:--:--</span>
                 </div>
             </div>
         </div>
        
        <!-- ì»¨íŠ¸ë¡¤ -->
        <div class="controls">
            <div class="date-controls">
                <label for="statusDate" class="date-label">ğŸ“… DATE:</label>
                <input type="date" id="statusDate" onchange="filterStatusByDate()" class="date-input">
                <button class="btn" onclick="loadDataFromSupabase()">ğŸ”„ REFRESH</button>
                <button class="btn" onclick="clearAllStatus()">ğŸ—‘ï¸ CLEAR</button>
                <button class="btn" onclick="toggleAutoRefresh()" id="autoRefreshBtn">ğŸ”„ AUTO: ON</button>
                <button class="btn" onclick="toggleFullscreenMode()" id="fullscreenBtn">ğŸ–¥ï¸ FULLSCREEN</button>
            </div>
            <div>
                <span class="auto-refresh" id="autoRefreshIndicator">ğŸ”„ ACTIVE</span>
            </div>
        </div>
        
        
        <!-- ì‹¤ì‹œê°„ ìƒíƒœ í…Œì´ë¸” -->
        <div id="statusContainer">
            <table class="status-table">
                                 <thead>
                     <tr>
                         <th>STATUS</th>
                         <th>TIME</th>
                         <th>DEST</th>
                         <th>DELIVERY NO</th>
                         <th>TRUCK #</th>
                         <th>FORZA ID</th>
                         <th>PARTS</th>
                         <th>PAGER NO</th>
                     </tr>
                 </thead>
                                 <tbody id="statusTableBody">
                     <tr>
                         <td colspan="8" class="no-status">NO STATUS INFORMATION AVAILABLE</td>
                     </tr>
                 </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
        
                 // ì „ì—­ ë³€ìˆ˜
         let supabase = null;
         let autoRefreshEnabled = true;
         let autoRefreshInterval = null;
         let lastUpdateTime = null;
         let dateCheckInterval = null; // ë‚ ì§œ ìë™ ë³€ê²½ ì²´í¬ìš©
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Live Truck Status Board loaded');
            initializeStatusPage();
            
            // Fullscreen ëª¨ë“œ ìƒíƒœ ê°ì§€ ë° ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            updateFullscreenButtonText();
            
            // Fullscreen ëª¨ë“œ ë³€ê²½ ê°ì§€
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        updateFullscreenButtonText();
                    }
                });
            });
            
            observer.observe(document.body, {
                attributes: true,
                attributeFilter: ['class']
            });
        });
        
        // ë‚ ì§œë³„ ìƒíƒœ í•„í„°ë§
        function filterStatusByDate() {
            const selectedDate = document.getElementById('statusDate').value;
            if (!selectedDate) {
                console.log('ğŸ“… No date selected');
                return;
            }
            
            console.log('ğŸ” Filtering status by date:', selectedDate);
            loadDataFromSupabase();
        }
        
        // ëª¨ë“  ìƒíƒœ í‘œì‹œ (í˜„ì¬ ë‚ ì§œ)
        function showAllStatus() {
            loadDataFromSupabase();
        }
        
        // Fullscreen ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateFullscreenButtonText() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) {
                const isFullscreen = document.body.classList.contains('fullscreen-mode');
                if (isFullscreen) {
                    fullscreenBtn.innerHTML = 'ğŸ“± EXIT FULLSCREEN';
                    fullscreenBtn.title = 'ì „ì²´ í™”ë©´ ëª¨ë“œ ì¢…ë£Œ - ì‚¬ì´ë“œë°” í‘œì‹œ';
                } else {
                    fullscreenBtn.innerHTML = 'ğŸ–¥ï¸ FULLSCREEN';
                    fullscreenBtn.title = 'ì „ì²´ í™”ë©´ ëª¨ë“œ ì‹œì‘ - ì‚¬ì´ë“œë°” ìˆ¨ê¹€';
                }
            }
        }
        
        // Supabase ì´ˆê¸°í™”
        function initializeSupabase() {
            try {
                console.log('ğŸ”§ Initializing Supabase...');
                
                // Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                if (typeof window.supabase === 'undefined') {
                    console.log('â³ Waiting for Supabase library to load...');
                    setTimeout(initializeSupabase, 500);
                    return;
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('âœ… Supabase client created:', supabase);
                
                // ì—°ê²° í…ŒìŠ¤íŠ¸
                testSupabaseConnection();
                
            } catch (error) {
                console.error('âŒ Supabase initialization failed:', error);
                setTimeout(initializeSupabase, 1000);
            }
        }
        
        // Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testSupabaseConnection() {
            try {
                console.log('ğŸ” Testing Supabase connection...');
                
                // ë¨¼ì € vwtm_truck_management í…Œì´ë¸” í…ŒìŠ¤íŠ¸
                let { data, error } = await supabase
                    .from('vwtm_truck_management')
                    .select('count', { count: 'exact', head: true })
                    .limit(1);
                    
                if (error && (error.message.includes('relation') || error.message.includes('does not exist'))) {
                    console.log('ğŸ” Table vwtm_truck_management not found, trying vwtm_list_data...');
                    
                    const { data: altData, error: altError } = await supabase
                        .from('vwtm_list_data')
                        .select('count', { count: 'exact', head: true })
                        .limit(1);
                    
                    if (altError) {
                        console.log('âŒ Both tables failed, trying to load any available data...');
                        loadDataFromSupabase();
                        return;
                    }
                    
                    console.log('âœ… Alternative table connection successful');
                } else {
                    console.log('âœ… Supabase connection successful');
                }
                
                // ì—°ê²° ì„±ê³µ í›„ ë°ì´í„° ë¡œë“œ
                loadDataFromSupabase();
                
            } catch (error) {
                console.error('âŒ Supabase connection test failed:', error);
                setTimeout(() => {
                    loadDataFromSupabase();
                }, 2000);
            }
        }
        
                 // ìƒíƒœ í˜ì´ì§€ ì´ˆê¸°í™”
         function initializeStatusPage() {
             console.log('ğŸ”§ Initializing status page...');
             
             // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œ)
             setDefaultDate();
             
             // í—¤ë”ì˜ LAST UPDATE ì‹œê°„ ì´ˆê¸°í™”
             updateHeaderLastUpdate();
             
             // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
             startAutoRefresh();
             
             // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ê°ì§€ (íƒ­ ì „í™˜ ì‹œ)
             document.addEventListener('visibilitychange', handleVisibilityChange);
             
             // Supabase ì´ˆê¸°í™” (ë‚ ì§œ ì„¤ì • í›„)
             setTimeout(() => {
                 initializeSupabase();
             }, 1000);
             
             console.log('âœ… Status page initialized successfully');
         }
        
        // ê¸°ë³¸ ë‚ ì§œ ì„¤ì •
        function setDefaultDate() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            
            // ë‚ ì§œ ì…ë ¥ í•„ë“œì— ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            const dateInput = document.getElementById('statusDate');
            if (dateInput) {
                dateInput.value = todayString;
                console.log('ğŸ“… Default date set to:', todayString);
                
                // ë‚ ì§œ ì„¤ì • í›„ ì¦‰ì‹œ ë°ì´í„° ë¡œë“œ ì‹œë„
                setTimeout(() => {
                    if (supabase) {
                        loadDataFromSupabase();
                    }
                }, 500);
            } else {
                console.log('â³ Date input not found, retrying...');
                setTimeout(setDefaultDate, 200);
            }
        }
        
        // ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleStatusChange(event) {
            console.log('ğŸ“¡ Status change event received:', event.detail);
        }
        
        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸ (í…Œì´ë¸” í˜•íƒœ)
        function updateStatusDisplay(statusData) {
            const tbody = document.getElementById('statusTableBody');
            
            // ìƒíƒœë³„ CSS í´ë˜ìŠ¤ ê²°ì •
            let statusClass = '';
            let statusText = '';
            
            switch (statusData.status) {
                case 'Shipped':
                    statusClass = 'shipped';
                    statusText = 'SHIPPED';
                    break;
                case 'Scheduled':
                    statusClass = 'scheduled';
                    statusText = 'SCHEDULED';
                    break;
                case 'On Site':
                    statusClass = 'onsite';
                    statusText = 'ON SITE';
                    break;
                default:
                    statusClass = '';
                    statusText = 'UNKNOWN';
            }
            
                         // ìƒíƒœ í–‰ HTML ìƒì„±
             const statusRowHTML = `
                 <tr class="status-row ${statusClass}" data-row="${statusData.row}">
                     <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                     <td class="eta-time-highlight">${statusData.etdTime || ''}</td>
                     <td>${statusData.destination || ''}</td>
                     <td>${statusData.deliveryNo || ''}</td>
                     <td class="truck-id-highlight">${statusData.truckId || ''}</td>
                     <td class="truck-id-highlight">${statusData.forzaId || ''}</td>
                     <td class="scrolling-text">${statusData.parts || ''}</td>
                     <td>${statusData.pagerNo || ''}</td>
                 </tr>
             `;
            
            // ê¸°ì¡´ ìƒíƒœ í–‰ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€
            const existingRow = tbody.querySelector(`[data-row="${statusData.row}"]`);
            if (existingRow) {
                existingRow.outerHTML = statusRowHTML;
            } else {
                tbody.insertAdjacentHTML('beforeend', statusRowHTML);
            }
            
            // "ìƒíƒœ ì—†ìŒ" ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            const noStatusMessage = tbody.querySelector('.no-status');
            if (noStatusMessage) {
                noStatusMessage.style.display = 'none';
            }
            
            console.log(`âœ… Status row updated for row ${statusData.row}`);
        }
        
                 // í—¤ë”ì˜ LAST UPDATE ì‹œê°„ ì—…ë°ì´íŠ¸
         function updateHeaderLastUpdate() {
             const now = new Date();
             const timeString = now.toLocaleTimeString('en-US', { 
                 hour12: false,
                 hour: '2-digit',
                 minute: '2-digit',
                 second: '2-digit'
             });
             
             const updateTimeElement = document.getElementById('headerLastUpdate');
             if (updateTimeElement) {
                 updateTimeElement.textContent = timeString;
                 console.log('ğŸ• Header last update time updated:', timeString);
             }
         }
         
        // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
        function refreshStatus() {
            console.log('ğŸ”„ Refreshing status from Supabase...');
            loadDataFromSupabase();
        }
        
        // Supabaseì—ì„œ ë°ì´í„° ë¡œë“œ
        async function loadDataFromSupabase() {
            try {
                if (!supabase) {
                    console.log('â³ Supabase not ready yet, retrying...');
                    setTimeout(loadDataFromSupabase, 1000);
                    return;
                }
                
                const selectedDate = document.getElementById('statusDate').value;
                if (!selectedDate) {
                    console.log('ğŸ“… No date selected, setting default date...');
                    setDefaultDate();
                    return;
                }
                
                console.log('ğŸš› Loading data from Supabase for date:', selectedDate);
                
                // ë¨¼ì € vwtm_truck_management í…Œì´ë¸” ì‹œë„
                let { data, error } = await supabase
                    .from('vwtm_truck_management')
                    .select('*')
                    .eq('departure_date', selectedDate)
                    .order('departure_time', { ascending: true })
                    .limit(1000);
                
                // í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° vwtm_list_data ì‹œë„
                if (error && (error.message.includes('relation') || error.message.includes('does not exist'))) {
                    console.log('ğŸ” Table vwtm_truck_management not found, trying vwtm_list_data...');
                    
                    try {
                        const result = await supabase
                            .from('vwtm_list_data')
                            .select('*')
                            .limit(1000);
                        
                        if (result.error) {
                            console.log('âŒ vwtm_list_data also failed:', result.error);
                            displayDataFromSupabase([]);
                            return;
                        }
                        
                        // ë‚ ì§œ í•„í„°ë§ì„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìˆ˜í–‰
                        data = result.data.filter(item => {
                            const itemDate = item.departure_date || item.prod_date || item.date;
                            return itemDate === selectedDate;
                        });
                        
                        // vwtm_list_dataì˜ ì»¬ëŸ¼ì„ truck_management í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                        data = data.map(item => ({
                            departure_date: item.departure_date || item.prod_date || item.date,
                            departure_time: item.departure_time || item.time || '00:00',
                            destination: item.destination || item.location || 'VW US',
                            delivery_no: item.delivery_no || item.delivery || '',
                            truck_id: item.truck_id || item.truck || '',
                            forza_id: item.forza_id || item.forza || '',
                            parts: item.parts || item.part_no || '',
                            pager_no: item.pager_no || '',
                            status: item.status || 'Scheduled'
                        }));
                        
                        error = null;
                        
                    } catch (tableError) {
                        console.log('âŒ Error accessing vwtm_list_data:', tableError);
                        displayDataFromSupabase([]);
                        return;
                    }
                }
                
                if (error) {
                    console.log('âŒ Error with vwtm_truck_management:', error);
                    displayDataFromSupabase([]);
                    return;
                }
                
                console.log('âœ… Data loaded from Supabase:', data?.length || 0, 'records');
                
                                 // ë°ì´í„°ë¥¼ ìƒíƒœ í–‰ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
                 displayDataFromSupabase(data || []);
                 
                 // í—¤ë”ì˜ LAST UPDATE ì‹œê°„ ì—…ë°ì´íŠ¸
                 updateHeaderLastUpdate();
                 
                 // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ ê¸°ë¡
                 lastUpdateTime = new Date();
                
            } catch (error) {
                console.error('âŒ Error loading data from Supabase:', error);
                displayDataFromSupabase([]);
            }
        }
        
        // Supabase ë°ì´í„°ë¥¼ ìƒíƒœ í…Œì´ë¸”ë¡œ í‘œì‹œ
        function displayDataFromSupabase(data) {
            const tbody = document.getElementById('statusTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-status">NO DATA AVAILABLE FOR SELECTED DATE</td>
                    </tr>
                `;
                return;
            }
            
            // ë°ì´í„°ë¥¼ ìƒíƒœë³„ë¡œ ì •ë ¬ (SHIPPEDëŠ” ë§¨ ë°‘ìœ¼ë¡œ)
            const sortedData = data.sort((a, b) => {
                const statusOrder = { 'Scheduled': 1, 'On Site': 2, 'Shipped': 3 };
                const aOrder = statusOrder[a.status] || 4;
                const bOrder = statusOrder[b.status] || 4;
                
                // SHIPPEDëŠ” ë¬´ì¡°ê±´ ë§¨ ë°‘ìœ¼ë¡œ
                if (aOrder === 3 && bOrder !== 3) return 1;
                if (bOrder === 3 && aOrder !== 3) return -1;
                
                // SCHEDULEDì™€ ON SITEëŠ” ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
                if (aOrder !== 3 && bOrder !== 3) {
                    return (a.departure_time || '').localeCompare(b.departure_time || '');
                }
                
                // SHIPPEDë¼ë¦¬ëŠ” ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
                if (aOrder === 3 && bOrder === 3) {
                    return (a.departure_time || '').localeCompare(b.departure_time || '');
                }
                
                return aOrder - bOrder;
            });
            
            // ê¸°ì¡´ ìƒíƒœ í–‰ ì œê±°
            tbody.innerHTML = '';
            
            // ì •ë ¬ëœ ë°ì´í„°ë¥¼ ìƒíƒœ í–‰ìœ¼ë¡œ ë³€í™˜
            sortedData.forEach((item, index) => {
                const statusData = {
                    row: index + 1,
                    departureDate: item.departure_date,
                    etdTime: item.departure_time,
                    destination: item.destination,
                    deliveryNo: item.delivery_no,
                    truckId: item.truck_id,
                    forzaId: item.forza_id,
                    parts: item.parts,
                    pagerNo: item.pager_no,
                    status: item.status,
                    lastUpdated: new Date().toLocaleTimeString('en-US')
                };
                
                updateStatusDisplay(statusData);
            });
        }
        
        // ëª¨ë“  ìƒíƒœ ì§€ìš°ê¸° (í˜„ì¬ ë‚ ì§œ ë°ì´í„°ë§Œ ìƒˆë¡œê³ ì¹¨)
        function clearAllStatus() {
            if (confirm('Do you want to refresh the currently displayed status?')) {
                console.log('ğŸ”„ Refreshing current status...');
                loadDataFromSupabase();
                console.log('âœ… Status refreshed');
            }
        }
        
        // ìë™ ìƒˆë¡œê³ ì¹¨ í† ê¸€
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const button = document.getElementById('autoRefreshBtn');
            const indicator = document.getElementById('autoRefreshIndicator');
            
            if (autoRefreshEnabled) {
                button.textContent = 'ğŸ”„ AUTO: ON';
                button.className = 'btn';
                indicator.textContent = 'ğŸ”„ ACTIVE';
                indicator.className = 'auto-refresh';
                startAutoRefresh();
                console.log('âœ… Auto-refresh enabled');
            } else {
                button.textContent = 'â¸ï¸ AUTO: OFF';
                button.className = 'btn';
                indicator.textContent = 'â¸ï¸ INACTIVE';
                indicator.className = 'auto-refresh off';
                stopAutoRefresh();
                console.log('â¸ï¸ Auto-refresh disabled');
            }
        }
        
                 // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
         function startAutoRefresh() {
             if (autoRefreshInterval) {
                 clearInterval(autoRefreshInterval);
             }
             
             autoRefreshInterval = setInterval(() => {
                 if (autoRefreshEnabled) {
                     console.log('ğŸ”„ Auto-refreshing status from Supabase...');
                     loadDataFromSupabase();
                 }
             }, 15000); // 15ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨ (ë” ì‹¤ì‹œê°„ì„±)
             
             console.log('ğŸš€ Auto-refresh started (15s interval)');
         }
        
        // ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('â¹ï¸ Auto-refresh stopped');
            }
        }
        
        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì²˜ë¦¬
        function handleVisibilityChange() {
            if (document.hidden) {
                console.log('ğŸ“± Page hidden, pausing auto-refresh');
                stopAutoRefresh();
            } else {
                console.log('ğŸ“± Page visible, resuming auto-refresh');
                if (autoRefreshEnabled) {
                    startAutoRefresh();
                }
            }
        }
        
        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            const tbody = document.getElementById('statusTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="no-status">ERROR OCCURRED: ${message}</td>
                </tr>
            `;
        }
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            console.log('ğŸ§¹ Cleaning up status page...');
            stopAutoRefresh();
        });
        
        // ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ
        window.initializeStatusPage = initializeStatusPage;
        window.setDefaultDate = setDefaultDate;
        window.refreshStatus = refreshStatus;
        window.clearAllStatus = clearAllStatus;
        window.toggleAutoRefresh = toggleAutoRefresh;
        window.filterStatusByDate = filterStatusByDate;
        window.showAllStatus = showAllStatus;
        window.loadDataFromSupabase = loadDataFromSupabase;
        
        console.log('âœ… Live Truck Status Board System loaded successfully');
    </script>
</body>
</html>
