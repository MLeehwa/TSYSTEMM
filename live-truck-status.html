<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Truck Status Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        .timer-display {
            font-family: 'Courier New', monospace;
        }
        
        .status-active {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .truck-item {
            transition: all 0.3s ease;
        }
        
        .truck-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="h-screen p-4 bg-gray-900 text-white overflow-hidden">
        <!-- Header -->
        <div class="text-center mb-4 relative">
            <h2 class="text-3xl font-semibold text-blue-300 mb-1">üöõ LIVE TRUCK STATUS</h2>
            <div class="text-sm text-gray-400 mb-2">ESTADO EN VIVO DE TR√ÅNSITO</div>
            <div class="text-lg font-bold text-gray-300 mb-2" id="displayDate">-</div>
            <button onclick="toggleFullscreen()" id="fullscreenBtn" class="absolute top-0 right-0 bg-red-500 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg">
                <span id="fullscreenText">üñ•Ô∏è FULLSCREEN</span>
            </button>
        </div>

        <!-- Current Status Card -->
        <div class="bg-gray-800 rounded-xl shadow-xl p-6 mb-4">
            <div class="text-center">
                <h3 class="text-3xl font-bold mb-2 text-blue-300">CURRENT TRUCK STATUS</h3>
                <div class="text-sm text-gray-400 mb-6">ESTADO ACTUAL</div>
                <div class="grid grid-cols-5 gap-4">
                    <!-- Current Truck -->
                    <div class="bg-gray-700 rounded-lg p-4 border-2 border-gray-600 flex flex-col items-center justify-center">
                        <div class="text-6xl font-bold text-white" id="currentTruck">-</div>
                        <div class="text-sm text-gray-400 mt-2">TRUCK NO</div>
                        <div class="text-xs text-gray-500">N√öMERO</div>
                    </div>
                    
                    <!-- Current Destination -->
                    <div class="bg-gray-700 rounded-lg p-4 border-2 border-gray-600 flex flex-col items-center justify-center">
                        <div class="text-5xl font-bold text-white" id="currentDestination">-</div>
                        <div class="text-sm text-gray-400 mt-2">DESTINATION</div>
                        <div class="text-xs text-gray-500">DESTINO</div>
                    </div>
                    
                    <!-- ETA Time -->
                    <div class="bg-gray-700 rounded-lg p-4 border-2 border-gray-600 flex flex-col items-center justify-center">
                        <div class="text-6xl font-bold text-white timer-display" id="etaTime">-</div>
                        <div class="text-sm text-gray-400 mt-2">ETA TIME</div>
                        <div class="text-xs text-gray-500">HORA ESTIMADA</div>
                    </div>
                    
                    <!-- Status -->
                    <div class="bg-gray-700 rounded-lg p-4 border-2 border-gray-600 flex flex-col items-center justify-center">
                        <div class="text-4xl font-bold text-white" id="currentStatus">WAITING</div>
                        <div class="text-sm text-gray-400 mt-2">STATUS</div>
                        <div class="text-xs text-gray-500">ESTADO</div>
                    </div>
                    
                    <!-- Total Trucks Today -->
                    <div class="bg-gray-700 rounded-lg p-4 border-2 border-gray-600 flex flex-col items-center justify-center">
                        <div class="text-5xl font-bold text-white" id="totalTrucks">0</div>
                        <div class="text-sm text-gray-400 mt-2">TOTAL TODAY</div>
                        <div class="text-xs text-gray-500">TOTAL HOY</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Truck Status List -->
        <div class="bg-gray-800 rounded-xl shadow-xl p-6 flex-1">
            <h3 class="text-2xl font-bold mb-2 text-center text-blue-300">TRUCK STATUS LIST</h3>
            <div class="text-sm text-gray-400 mb-4 text-center">LISTA DE ESTADO DE TR√ÅNSITOS</div>
            <div class="overflow-y-auto h-[600px]">
                <div id="truckList" class="space-y-2">
                    <!-- Truck items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase ÏÑ§Ï†ï
        const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
        
        // Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ±
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            autoRefreshToken: true,
            persistSession: true
        });

        // Ï†ÑÏó≠ Î≥ÄÏàò
        let truckData = [];
        let refreshInterval = null;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöõ Live Truck Status Display initialized');
            updateDisplayDate();
            loadTruckData();
            startAutoRefresh();
            
            // Supabase Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ ÏÑ§Ï†ï
            setupRealtimeSubscription();
        });

        // ÎÇ†Ïßú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateDisplayDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            const spanishDate = now.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            document.getElementById('displayDate').innerHTML = `
                <div>${dateStr}</div>
                <div class="text-sm text-gray-400">${spanishDate}</div>
            `;
        }

        // Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ ÏÑ§Ï†ï
        function setupRealtimeSubscription() {
            const channel = supabase
                .channel('live-truck-status')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'vwtm_truck_management'
                    }, 
                    (payload) => {
                        console.log('üîî Real-time update received:', payload);
                        loadTruckData();
                    }
                )
                .subscribe();

            console.log('üì° Real-time subscription established');
        }

        // Ìä∏Îü≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadTruckData() {
            try {
                console.log('üìä Loading truck data...');
                
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('vwtm_truck_management')
                    .select('*')
                    .eq('departure_date', today)
                    .order('departure_time', { ascending: true });
                
                if (error) throw error;
                
                truckData = data || [];
                console.log('‚úÖ Truck data loaded:', truckData);
                
                displayTruckList();
                updateCurrentStatus();
                
            } catch (error) {
                console.error('Error loading truck data:', error);
                console.warn('‚ö†Ô∏è Unable to load data. Please check Supabase connection.');
                truckData = [];
                displayTruckList();
            }
        }

        // Ìä∏Îü≠ Î™©Î°ù ÌëúÏãú
        function displayTruckList() {
            const truckList = document.getElementById('truckList');
            let html = '';
            
            if (truckData.length === 0) {
                html = '<div class="text-center text-gray-400 py-8">No trucks scheduled for today</div>';
            } else {
                // ÏÉÅÌÉúÎ≥ÑÎ°ú Ï†ïÎ†¨ (On Site -> Scheduled -> Shipped)
                const sortedData = [...truckData].sort((a, b) => {
                    const statusOrder = { 'On Site': 1, 'Scheduled': 2, 'Shipped': 3 };
                    const aOrder = statusOrder[a.status] || 999;
                    const bOrder = statusOrder[b.status] || 999;
                    
                    if (aOrder !== bOrder) return aOrder - bOrder;
                    
                    // Í∞ôÏùÄ ÏÉÅÌÉúÎ©¥ ÏãúÍ∞ÑÏàú Ï†ïÎ†¨
                    return (a.departure_time || '').localeCompare(b.departure_time || '');
                });
                
                sortedData.forEach((truck, index) => {
                    const bgColor = getStatusBgColor(truck.status);
                    const borderColor = getStatusBorderColor(truck.status);
                    const opacityClass = truck.status === 'Shipped' ? 'opacity-60' : '';
                    
                    html += `
                        <div class="truck-item ${bgColor} rounded-lg p-4 border-l-4 ${borderColor} ${opacityClass}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-6">
                                    <div class="text-2xl font-bold text-white">${truck.departure_time || '-'}</div>
                                    <div class="text-4xl font-bold text-white">${truck.truck_id || '-'}</div>
                                    <div class="text-3xl font-bold text-blue-300">${truck.destination || 'VW US'}</div>
                                    <div class="text-2xl font-bold text-yellow-300">${truck.forza_id || '-'}</div>
                                    <div class="text-xl text-gray-300">${truck.parts || '-'}</div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${getStatusBadgeColor(truck.status)}">
                                        ${getStatusText(truck.status)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            truckList.innerHTML = html;
        }

        // ÌòÑÏû¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateCurrentStatus() {
            // On Site ÎòêÎäî Scheduled ÏÉÅÌÉúÏù∏ Ï≤´ Î≤àÏß∏ Ìä∏Îü≠
            const activeTruck = truckData.find(truck => truck.status === 'On Site') || 
                              truckData.find(truck => truck.status === 'Scheduled');
            
            if (activeTruck) {
                document.getElementById('currentTruck').textContent = activeTruck.truck_id || '-';
                document.getElementById('currentDestination').textContent = activeTruck.destination || '-';
                document.getElementById('etaTime').textContent = activeTruck.departure_time || '-';
                document.getElementById('currentStatus').textContent = getStatusText(activeTruck.status);
                document.getElementById('currentStatus').className = 'text-4xl font-bold text-white status-active';
            } else {
                document.getElementById('currentTruck').textContent = '-';
                document.getElementById('currentDestination').textContent = '-';
                document.getElementById('etaTime').textContent = '-';
                document.getElementById('currentStatus').textContent = 'üìã NO TRUCKS';
                document.getElementById('currentStatus').className = 'text-4xl font-bold text-gray-300';
            }
            
            // Ï†ÑÏ≤¥ Ìä∏Îü≠ Ïàò
            document.getElementById('totalTrucks').textContent = truckData.length;
        }

        // ÏÉÅÌÉúÎ≥Ñ Î∞∞Í≤ΩÏÉâ
        function getStatusBgColor(status) {
            switch (status) {
                case 'Shipped': return 'bg-slate-700';
                case 'Scheduled': return 'bg-amber-800';
                case 'On Site': return 'bg-emerald-700';
                default: return 'bg-gray-600';
            }
        }

        // ÏÉÅÌÉúÎ≥Ñ ÌÖåÎëêÎ¶¨ÏÉâ
        function getStatusBorderColor(status) {
            switch (status) {
                case 'Shipped': return 'border-slate-400';
                case 'Scheduled': return 'border-amber-500';
                case 'On Site': return 'border-emerald-400';
                default: return 'border-gray-300';
            }
        }

        // ÏÉÅÌÉú ÌÖçÏä§Ìä∏
        function getStatusText(status) {
            switch (status) {
                case 'Shipped': return 'üöö SHIPPED';
                case 'Scheduled': return '‚è∞ SCHEDULED';
                case 'On Site': return 'üìç ON SITE';
                default: return '‚ùì UNKNOWN';
            }
        }

        // ÏÉÅÌÉúÎ≥Ñ Î∞∞ÏßÄÏÉâ
        function getStatusBadgeColor(status) {
            switch (status) {
                case 'Shipped': return 'bg-cyan-700 text-white';
                case 'Scheduled': return 'bg-yellow-700 text-white';
                case 'On Site': return 'bg-green-700 text-white';
                default: return 'bg-gray-700 text-white';
            }
        }

        // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                console.log('üîÑ Auto-refreshing truck data...');
                loadTruckData();
            }, 5000); // 5Ï¥àÎßàÎã§ ÏÉàÎ°úÍ≥†Ïπ®
            
            console.log('üîÑ Auto-refresh started (5s interval)');
        }

        // Ï†ÑÏ≤¥ÌôîÎ©¥ ÌÜ†Í∏Ä
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    document.getElementById('fullscreenText').textContent = 'üñ•Ô∏è EXIT FULLSCREEN';
                    console.log('üñ•Ô∏è Entered fullscreen mode');
                }).catch(err => {
                    console.error('‚ùå Error entering fullscreen:', err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    document.getElementById('fullscreenText').textContent = 'üñ•Ô∏è FULLSCREEN';
                    console.log('üñ•Ô∏è Exited fullscreen mode');
                }).catch(err => {
                    console.error('‚ùå Error exiting fullscreen:', err);
                });
            }
        }

        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>

