<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDA System - LEEHWA VW TM System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .scan-input {
      font-size: 1.5rem;
      padding: 1rem;
      text-align: center;
      letter-spacing: 0.1em;
    }
    
    .scan-result {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .beep {
      animation: beep 0.2s;
    }
    
    @keyframes beep {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen p-4 md:p-8">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-3 md:p-4 mb-4 md:mb-6">
      <div class="flex items-center justify-between">
        <h1 class="text-xl md:text-2xl font-bold text-gray-800">PDA System</h1>
        <button onclick="goToHome()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 md:px-4 md:py-2 rounded-lg font-semibold flex items-center text-sm md:text-base">
          <span class="mr-1 md:mr-2">ğŸ </span>
          <span>Home</span>
        </button>
      </div>
    </div>

    <!-- PDA Menu Grid -->
    <div id="menuGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
      <!-- Mapping Menu -->
      <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="openPDAMenu('mapping')">
        <div class="text-5xl mb-4 text-center">ğŸ—ºï¸</div>
        <h3 class="text-xl font-bold text-gray-800 text-center">Mapping</h3>
      </div>

      <!-- Shipping Menu -->
      <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="openPDAMenu('shipping')">
        <div class="text-5xl mb-4 text-center">ğŸšš</div>
        <h3 class="text-xl font-bold text-gray-800 text-center">Shipping</h3>
      </div>

      <!-- Find Menu -->
      <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="openPDAMenu('find')">
        <div class="text-5xl mb-4 text-center">ğŸ”</div>
        <h3 class="text-xl font-bold text-gray-800 text-center">Find</h3>
      </div>
    </div>

    <!-- Active Menu Content -->
    <div id="menuContent" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    </div>
  </div>

  <script>
    // Supabase ì„¤ì •
    const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
    
    let supabaseClient = null;
    let scanHistory = [];
    let todayScans = 0;
    let successCount = 0;
    let errorCount = 0;
    
    // Mapping ê´€ë ¨ ë³€ìˆ˜
    let currentPalletNo = null;
    let mappingState = 'pallet'; // 'pallet' ë˜ëŠ” 'tm'
    let scannedTMs = []; // ìŠ¤ìº”ëœ TM ëª©ë¡
    let existingMappedTMs = []; // ê¸°ì¡´ ë§µí•‘ëœ TM ëª©ë¡
    let palletValidated = false; // íŒ”ë › ë²ˆí˜¸ ê²€ì¦ ì—¬ë¶€
    
    // Shipping ê´€ë ¨ ë³€ìˆ˜
    let shippingPallets = []; // Shippingìš© ìŠ¤ìº”í•œ íŒ”ë › ëª©ë¡
    let shippingMappedTMs = []; // Shippingìš© ë§µí•‘ëœ TM ëª©ë¡ (ëª¨ë“  íŒ”ë › í•©ì‚°)
    
    // Find ê´€ë ¨ ë³€ìˆ˜
    let findResults = []; // Find ê²°ê³¼ ëª©ë¡


    // í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸° (ë©”ë‰´ ì„ íƒ í™”ë©´ìœ¼ë¡œ)
    function goToHome() {
      const menuGrid = document.getElementById('menuGrid');
      const menuContent = document.getElementById('menuContent');
      
      if (menuGrid) {
        menuGrid.style.display = 'grid';
      }
      if (menuContent) {
        menuContent.style.display = 'none';
        menuContent.innerHTML = '';
      }
      
      // ìƒíƒœ ì´ˆê¸°í™”
      currentPalletNo = null;
      mappingState = 'pallet';
      scannedTMs = [];
      palletValidated = false;
    }

    // Supabase ì´ˆê¸°í™”
    async function initSupabase() {
      try {
        if (typeof supabase !== 'undefined') {
          supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('âœ… Supabase initialized');
          return true;
        } else {
          console.error('Supabase library not loaded');
          return false;
        }
      } catch (error) {
        console.error('Error initializing Supabase:', error);
        return false;
      }
    }
    
    // PDA ë©”ë‰´ ì—´ê¸°
    window.openPDAMenu = function(menuType) {
      const menuGrid = document.getElementById('menuGrid');
      const menuContent = document.getElementById('menuContent');
      
      // ë©”ë‰´ ê·¸ë¦¬ë“œ ìˆ¨ê¸°ê¸°
      if (menuGrid) {
        menuGrid.style.display = 'none';
      }
      
      // ë©”ë‰´ ì»¨í…ì¸  í‘œì‹œ
      if (menuContent) {
        menuContent.style.display = 'block';
      }
      
      if (menuType === 'mapping') {
        currentPalletNo = null;
        mappingState = 'pallet';
        scannedTMs = [];
        palletValidated = false;
        menuContent.innerHTML = `
          <div class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Mapping</h2>
            
            <!-- TM Count Card (íŒ”ë › ìœ„ìª½) -->
            <div id="tmCountCard" class="bg-blue-600 text-white rounded-lg p-4 mb-4 hidden">
              <div class="text-center">
                <div class="text-sm font-semibold mb-1">TM Count</div>
                <div class="text-4xl font-bold" id="tmCountCardValue">0</div>
              </div>
            </div>
            
            <div id="palletScanSection" class="bg-blue-50 border-2 border-blue-500 rounded-lg p-4">
              <div class="mb-3">
                <label class="block text-base font-semibold text-gray-800 mb-2">1. Pallet No</label>
                <input 
                  type="text" 
                  id="palletInput" 
                  class="scan-input w-full border-2 border-blue-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Scan Pallet"
                  autofocus
                  autocomplete="off"
                />
              </div>
              <div id="palletDisplay" class="mt-3 hidden">
                <div class="bg-white rounded-lg p-3 border-2 border-green-500">
                  <div class="flex justify-between items-center">
                    <div>
                      <div class="text-xl font-bold text-green-700" id="scannedPalletNo"></div>
                    </div>
                    <button onclick="unmappingPallet()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg font-semibold text-xs">
                      UNMAPPING
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="tmScanSection" class="bg-green-50 border-2 border-green-500 rounded-lg p-4 hidden mt-4">
              <!-- Action Buttons (TM Code ìœ„ì— ë°°ì¹˜) -->
              <div id="actionButtons" class="flex space-x-3 mb-3 hidden">
                <button onclick="saveMapping()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-4 rounded-lg font-bold text-base transition-colors">
                  Save
                </button>
                <button onclick="clearMapping()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg font-bold text-base transition-colors">
                  Clear
                </button>
              </div>
              
              <div class="mb-3">
                <label class="block text-base font-semibold text-gray-800 mb-2">2. TM Code</label>
                <input 
                  type="text" 
                  id="tmInput" 
                  class="scan-input w-full border-2 border-green-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                  placeholder="Scan TM"
                  autocomplete="off"
                />
              </div>
              <div id="tmList" class="mt-3 space-y-2 max-h-40 overflow-y-auto"></div>
            </div>
            
            <!-- ê¸°ì¡´ ë§µí•‘ëœ TM ë¦¬ìŠ¤íŠ¸ -->
            <div id="existingMappingsSection" class="bg-yellow-50 border-2 border-yellow-500 rounded-lg p-4 hidden mt-4">
              <div class="mb-2">
                <h3 class="text-base font-bold text-gray-800">Existing Mappings</h3>
              </div>
              <div id="existingMappingsList" class="space-y-1.5 max-h-40 overflow-y-auto"></div>
            </div>
            
            <div id="mappingStatus" class="hidden"></div>
          </div>
        `;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setTimeout(() => {
          const palletInput = document.getElementById('palletInput');
          const tmInput = document.getElementById('tmInput');
          
          if (palletInput) {
            let palletScanTimeout;
            // PDAëŠ” ì—”í„°í‚¤ê°€ ì—†ìœ¼ë¯€ë¡œ ì…ë ¥ê°’ ë³€ê²½ìœ¼ë¡œ ìë™ ì²˜ë¦¬
            palletInput.addEventListener('input', function(e) {
              const value = e.target.value.trim();
              // íŒ”ë › ë²ˆí˜¸ í˜•ì‹: VWRT0001 (8ìë¦¬ ì´ìƒ)
              if (value.length >= 8) {
                clearTimeout(palletScanTimeout);
                palletScanTimeout = setTimeout(() => {
                  handlePalletScan();
                }, 300); // ì…ë ¥ ì™„ë£Œ í›„ 300ms ëŒ€ê¸°
              }
            });
            // ì—”í„°í‚¤ë„ ì§€ì› (í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°)
            palletInput.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                clearTimeout(palletScanTimeout);
                handlePalletScan();
              }
            });
            // í¬ì»¤ìŠ¤ ì„¤ì • (ë” í™•ì‹¤í•˜ê²Œ)
            requestAnimationFrame(() => {
              setTimeout(() => {
                palletInput.focus();
              }, 50);
            });
          }
          
          if (tmInput) {
            let tmScanTimeout;
            // PDAëŠ” ì—”í„°í‚¤ê°€ ì—†ìœ¼ë¯€ë¡œ ì…ë ¥ê°’ ë³€ê²½ìœ¼ë¡œ ìë™ ì²˜ë¦¬
            tmInput.addEventListener('input', function(e) {
              const value = e.target.value.trim();
              // TM ë°”ì½”ë“œëŠ” 12ìë¦¬
              if (value.length === 12) {
                clearTimeout(tmScanTimeout);
                tmScanTimeout = setTimeout(() => {
                  handleTMScan();
                }, 200); // ì…ë ¥ ì™„ë£Œ í›„ 200ms ëŒ€ê¸°
              } else {
                // ì…ë ¥ ì¤‘ì—ë„ í¬ì»¤ìŠ¤ ìœ ì§€ (ì—°ì† ìŠ¤ìº”ì„ ìœ„í•´)
                requestAnimationFrame(() => {
                  if (document.activeElement !== tmInput) {
                    tmInput.focus();
                  }
                });
              }
            });
            // ì—”í„°í‚¤ë„ ì§€ì› (í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°)
            tmInput.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                clearTimeout(tmScanTimeout);
                handleTMScan();
              }
            });
            // í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚¬ì„ ë•Œ ë‹¤ì‹œ í¬ì»¤ìŠ¤ ë³µê·€
            tmInput.addEventListener('blur', function() {
              // ì§§ì€ ì§€ì—° í›„ í¬ì»¤ìŠ¤ ë³µê·€ (ë‹¤ë¥¸ ìš”ì†Œë¡œ í¬ì»¤ìŠ¤ ì´ë™ì´ ì•„ë‹Œ ê²½ìš°)
              setTimeout(() => {
                if (mappingState === 'tm' && palletValidated) {
                  requestAnimationFrame(() => {
                    tmInput.focus();
                  });
                }
              }, 100);
            });
          }
        }, 100);
      } else if (menuType === 'shipping') {
        shippingPallets = [];
        shippingMappedTMs = [];
        menuContent.innerHTML = `
          <div class="space-y-4">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Shipping</h2>
            
            <!-- Summary Card -->
            <div id="shippingSummaryCard" class="bg-blue-600 text-white rounded-lg p-4 mb-4 hidden">
              <div class="text-center">
                <div class="text-sm font-semibold mb-2">Summary</div>
                <div class="flex justify-around">
                  <div>
                    <div class="text-xs mb-1">Pallets</div>
                    <div class="text-2xl font-bold" id="shippingPalletCount">0</div>
                  </div>
                  <div>
                    <div class="text-xs mb-1">Total TMs</div>
                    <div class="text-2xl font-bold" id="shippingTotalTMCount">0</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Pallet Scan Section -->
            <div id="shippingPalletSection" class="bg-blue-50 border-2 border-blue-500 rounded-lg p-4">
              <div class="mb-3">
                <label class="block text-base font-semibold text-gray-800 mb-2">Pallet No (Mapped Only)</label>
                <input 
                  type="text" 
                  id="shippingPalletInput" 
                  class="scan-input w-full border-2 border-blue-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Scan Pallet"
                  autofocus
                  autocomplete="off"
                />
              </div>
            </div>
            
            <!-- Scanned Pallets List -->
            <div id="shippingPalletsListSection" class="bg-yellow-50 border-2 border-yellow-500 rounded-lg p-4 hidden mt-4">
              <div class="mb-2">
                <h3 class="text-base font-bold text-gray-800">Scanned Pallets</h3>
              </div>
              <div id="shippingPalletsList" class="space-y-1.5 max-h-32 overflow-y-auto"></div>
            </div>
            
            
            <!-- Save Button -->
            <div id="shippingSaveButton" class="hidden mt-4">
              <button onclick="saveShipping()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-4 rounded-lg font-bold text-base transition-colors">
                Save Shipping Date
              </button>
            </div>
            
            <!-- Status Message -->
            <div id="shippingStatus" class="hidden"></div>
          </div>
        `;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setTimeout(() => {
          const shippingPalletInput = document.getElementById('shippingPalletInput');
          
          if (shippingPalletInput) {
            let shippingPalletTimeout;
            // PDAëŠ” ì—”í„°í‚¤ê°€ ì—†ìœ¼ë¯€ë¡œ ì…ë ¥ê°’ ë³€ê²½ìœ¼ë¡œ ìë™ ì²˜ë¦¬
            shippingPalletInput.addEventListener('input', function(e) {
              const value = e.target.value.trim();
              // íŒ”ë › ë²ˆí˜¸ í˜•ì‹: VWRT0001 (8ìë¦¬ ì´ìƒ)
              if (value.length >= 8) {
                clearTimeout(shippingPalletTimeout);
                shippingPalletTimeout = setTimeout(() => {
                  handleShippingPalletScan();
                }, 300); // ì…ë ¥ ì™„ë£Œ í›„ 300ms ëŒ€ê¸°
              } else {
                // ì…ë ¥ ì¤‘ì—ë„ í¬ì»¤ìŠ¤ ìœ ì§€ (ì—°ì† ìŠ¤ìº”ì„ ìœ„í•´)
                requestAnimationFrame(() => {
                  if (document.activeElement !== shippingPalletInput) {
                    shippingPalletInput.focus();
                  }
                });
              }
            });
            // ì—”í„°í‚¤ë„ ì§€ì› (í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°)
            shippingPalletInput.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                clearTimeout(shippingPalletTimeout);
                handleShippingPalletScan();
              }
            });
            // í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚¬ì„ ë•Œ ë‹¤ì‹œ í¬ì»¤ìŠ¤ ë³µê·€
            shippingPalletInput.addEventListener('blur', function() {
              // ì§§ì€ ì§€ì—° í›„ í¬ì»¤ìŠ¤ ë³µê·€ (ë‹¤ë¥¸ ìš”ì†Œë¡œ í¬ì»¤ìŠ¤ ì´ë™ì´ ì•„ë‹Œ ê²½ìš°)
              setTimeout(() => {
                requestAnimationFrame(() => {
                  shippingPalletInput.focus();
                });
              }, 100);
            });
            // í¬ì»¤ìŠ¤ ì„¤ì • (ë” í™•ì‹¤í•˜ê²Œ)
            requestAnimationFrame(() => {
              setTimeout(() => {
                shippingPalletInput.focus();
              }, 50);
            });
          }
        }, 100);
      } else if (menuType === 'find') {
        findResults = [];
        menuContent.innerHTML = `
          <div class="space-y-4">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Find</h2>
            
            <!-- TM Scan Section -->
            <div id="findTMSection" class="bg-blue-50 border-2 border-blue-500 rounded-lg p-4">
              <div class="mb-3">
                <label class="block text-base font-semibold text-gray-800 mb-2">TM No</label>
                <input 
                  type="text" 
                  id="findTMInput" 
                  class="scan-input w-full border-2 border-blue-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Scan TM"
                  autofocus
                  autocomplete="off"
                />
              </div>
            </div>
            
            <!-- Results Section -->
            <div id="findResultsSection" class="bg-green-50 border-2 border-green-500 rounded-lg p-4 hidden mt-4">
              <div class="mb-3">
                <h3 class="text-base font-bold text-gray-800 mb-2">Results</h3>
              </div>
              <div id="findResultsList" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
            
            <!-- Clear Button -->
            <div id="findClearButton" class="hidden mt-4">
              <button onclick="clearFindResults()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2.5 px-4 rounded-lg font-bold text-base transition-colors">
                Clear
              </button>
            </div>
            
            <!-- Status Message -->
            <div id="findStatus" class="hidden"></div>
          </div>
        `;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setTimeout(() => {
          const findTMInput = document.getElementById('findTMInput');
          
          if (findTMInput) {
            let findTMTimeout;
            // PDAëŠ” ì—”í„°í‚¤ê°€ ì—†ìœ¼ë¯€ë¡œ ì…ë ¥ê°’ ë³€ê²½ìœ¼ë¡œ ìë™ ì²˜ë¦¬
            findTMInput.addEventListener('input', function(e) {
              const value = e.target.value.trim();
              // TM ë°”ì½”ë“œëŠ” 12ìë¦¬
              if (value.length === 12) {
                clearTimeout(findTMTimeout);
                findTMTimeout = setTimeout(() => {
                  handleFindTMScan();
                }, 200); // ì…ë ¥ ì™„ë£Œ í›„ 200ms ëŒ€ê¸°
              }
            });
            // ì—”í„°í‚¤ë„ ì§€ì› (í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°)
            findTMInput.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                clearTimeout(findTMTimeout);
                handleFindTMScan();
              }
            });
            // í¬ì»¤ìŠ¤ ì„¤ì •
            setTimeout(() => {
              findTMInput.focus();
            }, 50);
          }
        }, 100);
      }
    }

    // ìŠ¤ìº” ì…ë ¥ ì²˜ë¦¬
    function processScan() {
      const input = document.getElementById('scanInput');
      if (!input) return;
      
      const scanValue = input.value.trim();
      
      if (!scanValue) {
        alert('ìŠ¤ìº” ê°’ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      // ìŠ¤ìº” ì²˜ë¦¬ ë¡œì§
      const result = {
        id: Date.now(),
        value: scanValue,
        timestamp: new Date().toLocaleString('ko-KR'),
        status: 'success',
        message: 'ìŠ¤ìº” ì²˜ë¦¬ ì™„ë£Œ'
      };

      // ê²°ê³¼ ì¶”ê°€
      addScanResult(result);
      
      // í†µê³„ ì—…ë°ì´íŠ¸
      todayScans++;
      successCount++;
      updateStatistics();
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      input.value = '';
      input.focus();
      
      // ë¹„í”„ìŒ íš¨ê³¼ (ì‹œê°ì )
      input.classList.add('beep');
      setTimeout(() => {
        input.classList.remove('beep');
      }, 200);
    }

    // ìŠ¤ìº” ê²°ê³¼ ì¶”ê°€
    function addScanResult(result) {
      scanHistory.unshift(result);
      if (scanHistory.length > 50) {
        scanHistory.pop();
      }

      const resultsDiv = document.getElementById('scanResults');
      if (!resultsDiv) return;
      
      // ì²« ë²ˆì§¸ ê²°ê³¼ì¸ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
      if (resultsDiv.children.length === 1 && resultsDiv.children[0].textContent.includes('ìŠ¤ìº” ê²°ê³¼ê°€')) {
        resultsDiv.innerHTML = '';
      }

      const resultDiv = document.createElement('div');
      resultDiv.className = 'scan-result bg-gray-50 rounded-lg p-4 border-l-4 border-blue-500';
      
      const statusClass = result.status === 'success' 
        ? 'bg-green-100 text-green-800' 
        : 'bg-red-100 text-red-800';
      
      resultDiv.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <div class="flex-1">
            <div class="font-bold text-lg text-gray-800 mb-1">${result.value}</div>
            <div class="text-sm text-gray-600">${result.timestamp}</div>
          </div>
          <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
            ${result.status === 'success' ? 'âœ“ ì„±ê³µ' : 'âœ— ì‹¤íŒ¨'}
          </span>
        </div>
        <div class="text-sm text-gray-700">${result.message}</div>
      `;
      
      resultsDiv.insertBefore(resultDiv, resultsDiv.firstChild);
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStatistics() {
      // í†µê³„ê°€ í‘œì‹œë˜ëŠ” ê³³ì´ ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸
    }

    // ì…ë ¥ í•„ë“œ ì§€ìš°ê¸°
    function clearInput() {
      const input = document.getElementById('scanInput');
      if (input) {
        input.value = '';
        input.focus();
      }
    }

    // ê²°ê³¼ ì§€ìš°ê¸°
    function clearResults() {
      if (confirm('ëª¨ë“  ìŠ¤ìº” ê²°ê³¼ë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        scanHistory = [];
        const resultsDiv = document.getElementById('scanResults');
        if (resultsDiv) {
          resultsDiv.innerHTML = `
            <div class="text-center text-gray-500 py-8">
              ìŠ¤ìº” ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
            </div>
          `;
        }
      }
    }

    // íŒ”ë › ë²ˆí˜¸ ê²€ì¦ (PALLET GENERATEë¡œ ìƒì„±ëœ ê²ƒë§Œ)
    async function validatePalletNo(palletNo) {
      try {
        if (!supabaseClient) {
          await initSupabase();
        }
        
        const { data, error } = await supabaseClient
          .from('vwtm_pallet_generate')
          .select('pallet_no')
          .eq('pallet_no', palletNo)
          .single();
        
        if (error) {
          if (error.code === 'PGRST116') {
            return false; // ë ˆì½”ë“œ ì—†ìŒ
          }
          throw error;
        }
        
        return data !== null;
      } catch (error) {
        console.error('Error validating pallet:', error);
        return false;
      }
    }
    
    // íŒ”ë › ë²ˆí˜¸ ìŠ¤ìº” ì²˜ë¦¬
    async function handlePalletScan() {
      const palletInput = document.getElementById('palletInput');
      if (!palletInput) return;
      
      const palletNo = palletInput.value.trim();
      if (!palletNo) {
        showStatus('Enter Pallet No', 'error');
        return;
      }
      
      showStatus('Validating...', 'info');
      const isValid = await validatePalletNo(palletNo);
      
        if (!isValid) {
          showStatus('Invalid Pallet No', 'error');
          palletInput.value = '';
          // í¬ì»¤ìŠ¤ ë³µê·€ (ë” í™•ì‹¤í•˜ê²Œ)
          requestAnimationFrame(() => {
            palletInput.focus();
          });
          return;
        }
      
      currentPalletNo = palletNo;
      mappingState = 'tm';
      palletValidated = true;
      scannedTMs = [];
      
      // íŒ”ë › ë²ˆí˜¸ í‘œì‹œ
      const palletDisplay = document.getElementById('palletDisplay');
      const scannedPalletNo = document.getElementById('scannedPalletNo');
      if (palletDisplay && scannedPalletNo) {
        palletDisplay.classList.remove('hidden');
        scannedPalletNo.textContent = palletNo;
      }
      
      // íŒ”ë › ìŠ¤ìº” ì…ë ¥ì°½ ìˆ¨ê¸°ê¸°
      const palletInputContainer = palletInput.parentElement;
      if (palletInputContainer) {
        palletInputContainer.style.display = 'none';
      }
      
      // TM Count ì¹´ë“œ í‘œì‹œ
      const tmCountCard = document.getElementById('tmCountCard');
      if (tmCountCard) {
        tmCountCard.classList.remove('hidden');
      }
      
      // TM Count ì¹´ë“œ í‘œì‹œ (ì´ë¯¸ ìœ„ì—ì„œ ì„ ì–¸ë¨)
      if (tmCountCard) {
        tmCountCard.classList.remove('hidden');
      }
      
      // TM ìŠ¤ìº” ì„¹ì…˜ í‘œì‹œ
      const tmScanSection = document.getElementById('tmScanSection');
      const actionButtons = document.getElementById('actionButtons');
      if (tmScanSection) {
        tmScanSection.classList.remove('hidden');
      }
      if (actionButtons) {
        actionButtons.classList.remove('hidden');
      }
      
      // TM ê°œìˆ˜ ì—…ë°ì´íŠ¸
      updateTMCount();
      updateTMList();
      
      // ê¸°ì¡´ ë§µí•‘ëœ TM ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
      await loadExistingMappings(palletNo);
      
      // TM ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ (ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì‚¬ìš©ì„ ìœ„í•´ - ë” í™•ì‹¤í•˜ê²Œ)
      requestAnimationFrame(() => {
        setTimeout(() => {
          const tmInput = document.getElementById('tmInput');
          if (tmInput) {
            tmInput.focus();
            tmInput.select(); // ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì„ íƒ ìƒíƒœë¡œ
            // í¬ì»¤ìŠ¤ê°€ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (document.activeElement !== tmInput) {
              setTimeout(() => {
                tmInput.focus();
              }, 50);
            }
          }
        }, 150);
      });
      
      showStatus(`Pallet "${palletNo}" Validated`, 'success');
    }
    
    // TM ë°”ì½”ë“œ ê²€ì¦ (12ìë¦¬, ì‹œì‘: 2/3/7/8)
    function validateTMNo(tmNo) {
      if (!tmNo || tmNo.length !== 12) {
        return false;
      }
      
      const firstChar = tmNo.charAt(0);
      return ['2', '3', '7', '8'].includes(firstChar);
    }
    
    // TM ë°”ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬
    async function handleTMScan() {
      const tmInput = document.getElementById('tmInput');
      if (!tmInput) return;
      
      const tmNo = tmInput.value.trim();
      if (!tmNo) {
        showStatus('Enter TM Code', 'error');
        return;
      }
      
      if (!currentPalletNo || !palletValidated) {
        showStatus('Scan Pallet First', 'error');
        return;
      }
      
      if (!validateTMNo(tmNo)) {
        showStatus('Invalid TM Code', 'error');
        tmInput.value = '';
        // PDAëŠ” ì—”í„°í‚¤ê°€ ì—†ìœ¼ë¯€ë¡œ í¬ì»¤ìŠ¤ ìœ ì§€ í•„ìˆ˜
        requestAnimationFrame(() => {
          tmInput.focus();
        });
        return;
      }
      
      if (scannedTMs.includes(tmNo)) {
        showStatus('Duplicate TM', 'error');
        tmInput.value = '';
        // PDAëŠ” ì—”í„°í‚¤ê°€ ì—†ìœ¼ë¯€ë¡œ í¬ì»¤ìŠ¤ ìœ ì§€ í•„ìˆ˜
        requestAnimationFrame(() => {
          tmInput.focus();
        });
        return;
      }
      
      scannedTMs.push(tmNo);
      updateTMCount();
      updateTMList();
      
      tmInput.value = '';
      // ë‹¤ìŒ ìŠ¤ìº”ì„ ìœ„í•´ ì¦‰ì‹œ í¬ì»¤ìŠ¤ ìœ ì§€ (8-10ê°œ ì—°ì† ìŠ¤ìº”ì„ ìœ„í•´ í•„ìˆ˜)
      // PDAëŠ” ì—”í„°í‚¤ê°€ ì—†ìœ¼ë¯€ë¡œ í¬ì»¤ìŠ¤ê°€ ìœ ì§€ë˜ì–´ì•¼ ë‹¤ìŒ ìŠ¤ìº” ê°€ëŠ¥
      // ì´ì¤‘ ë³´ì¥: requestAnimationFrame + setTimeout
      requestAnimationFrame(() => {
        tmInput.focus();
        // í¬ì»¤ìŠ¤ê°€ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ì¬ì‹œë„
        setTimeout(() => {
          if (document.activeElement !== tmInput && mappingState === 'tm' && palletValidated) {
            tmInput.focus();
          }
        }, 50);
      });
      
      showStatus(`TM "${tmNo}" Scanned (${scannedTMs.length})`, 'success');
    }
    
    // TM ê°œìˆ˜ ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ìŠ¤ìº”í•œ TM + ê¸°ì¡´ ë§µí•‘ëœ TM)
    // TM ê°œìˆ˜ ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ìŠ¤ìº”í•œ TM + ê¸°ì¡´ ë§µí•‘ëœ TM)
    function updateTMCount() {
      const totalCount = scannedTMs.length + existingMappedTMs.length;
      
      // ì¹´ë“œ í˜•ì‹ TM Count ì—…ë°ì´íŠ¸
      const tmCountCard = document.getElementById('tmCountCard');
      const tmCountCardValue = document.getElementById('tmCountCardValue');
      if (tmCountCard && tmCountCardValue) {
        tmCountCardValue.textContent = totalCount;
        // íŒ”ë ›ì´ ê²€ì¦ë˜ë©´ ì¹´ë“œ í‘œì‹œ
        if (palletValidated) {
          tmCountCard.classList.remove('hidden');
        }
      }
      
      // ê¸°ì¡´ TM Count (ìˆ¨ê²¨ì§„ í•„ë“œ, í•„ìš”ì‹œ ì‚¬ìš©)
      const tmCountElement = document.getElementById('tmCount');
      if (tmCountElement) {
        tmCountElement.textContent = totalCount;
      }
    }
    
    // TM ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateTMList() {
      const tmListElement = document.getElementById('tmList');
      if (!tmListElement) return;
      
      if (scannedTMs.length === 0) {
        tmListElement.innerHTML = '';
        return;
      }
      
      tmListElement.innerHTML = scannedTMs.map((tm, index) => `
        <div class="bg-white rounded-lg p-2 border border-gray-300 flex items-center">
          <span class="text-xs text-gray-500 mr-2">${index + 1}.</span>
          <span class="font-semibold text-gray-800 text-sm">${tm}</span>
        </div>
      `).join('');
    }
    
    // ê¸°ì¡´ ë§µí•‘ëœ TM ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    async function loadExistingMappings(palletNo) {
      try {
        if (!supabaseClient) {
          await initSupabase();
        }
        
        const { data, error } = await supabaseClient
          .from('vwtm_mapping')
          .select('tm_no, mapping_date')
          .eq('pallet_no', palletNo)
          .order('mapping_date', { ascending: false });
        
        if (error) {
          if (error.code === 'PGRST116') {
            // ë§µí•‘ ë°ì´í„° ì—†ìŒ
            const existingSection = document.getElementById('existingMappingsSection');
            if (existingSection) {
              existingSection.classList.add('hidden');
            }
            return;
          }
          throw error;
        }
        
        const existingSection = document.getElementById('existingMappingsSection');
        const existingList = document.getElementById('existingMappingsList');
        
        if (data && data.length > 0) {
          // ê¸°ì¡´ ë§µí•‘ëœ TM ëª©ë¡ ì €ì¥
          existingMappedTMs = data.map(mapping => mapping.tm_no);
          
          if (existingSection) {
            existingSection.classList.remove('hidden');
          }
          if (existingList) {
            existingList.innerHTML = data.map((mapping, index) => `
              <div class="bg-white rounded-lg p-2 border border-yellow-400 flex items-center">
                <span class="text-xs text-gray-500 mr-2">${index + 1}.</span>
                <span class="font-semibold text-gray-800 text-sm">${mapping.tm_no}</span>
              </div>
            `).join('');
          }
          
          // TM COUNT ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë§µí•‘ í¬í•¨)
          updateTMCount();
        } else {
          // ê¸°ì¡´ ë§µí•‘ ì—†ìŒ
          existingMappedTMs = [];
          
          if (existingSection) {
            existingSection.classList.add('hidden');
          }
          
          // TM COUNT ì—…ë°ì´íŠ¸
          updateTMCount();
        }
      } catch (error) {
        console.error('Error loading existing mappings:', error);
        const existingSection = document.getElementById('existingMappingsSection');
        if (existingSection) {
          existingSection.classList.add('hidden');
        }
      }
    }
    
    // ë§µí•‘ ì €ì¥
    window.saveMapping = async function() {
      if (!currentPalletNo || scannedTMs.length === 0) {
        showStatus('Pallet and TM Required', 'error');
        return;
      }
      
      try {
        if (!supabaseClient) {
          await initSupabase();
        }
        
        // ì¼ê´„ ì €ì¥
        const insertData = scannedTMs.map(tmNo => ({
          pallet_no: currentPalletNo,
          tm_no: tmNo,
          mapping_date: new Date().toISOString()
        }));
        
        const { data, error } = await supabaseClient
          .from('vwtm_mapping')
          .insert(insertData)
          .select();
        
        if (error) {
          if (error.code === '23505') {
            showStatus('Some TM Already Mapped', 'error');
          } else {
            throw error;
          }
        } else {
          const savedCount = data ? data.length : scannedTMs.length;
          showStatus(`Saved: ${currentPalletNo} â†” ${savedCount} TM`, 'success');
          
          // RECENT ì„¹ì…˜ ìˆ¨ê¸°ê¸°
          const mappingResults = document.getElementById('mappingResults');
          if (mappingResults) {
            mappingResults.classList.add('hidden');
          }
          
          // ê¸°ì¡´ ë§µí•‘ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¡œë“œ
          await loadExistingMappings(currentPalletNo);
          
          // í¼ ì´ˆê¸°í™”
          resetMappingForm();
        }
      } catch (error) {
        console.error('Error saving mapping:', error);
        showStatus('Save Error', 'error');
      }
    }
    
    window.clearMapping = function() {
      if (!confirm('Clear All?')) {
        return;
      }
      
      resetMappingForm();
      showStatus('Cleared', 'info');
    }
    
    window.unmappingPallet = async function() {
      if (!currentPalletNo) {
        showStatus('No Pallet', 'error');
        return;
      }
      
      try {
        if (!supabaseClient) {
          await initSupabase();
        }
        
        // 1. ê¸°ì¡´ ë§µí•‘ ë°ì´í„° ì¡°íšŒ
        const { data: mappings, error: selectError } = await supabaseClient
          .from('vwtm_mapping')
          .select('*')
          .eq('pallet_no', currentPalletNo);
        
        if (selectError) {
          throw selectError;
        }
        
        if (!mappings || mappings.length === 0) {
          showStatus('No Mappings Found', 'error');
          return;
        }
        
        // 2. ì´ë¯¸ shipped ëœ íŒ”ë ›ì¸ì§€ í™•ì¸
        const hasShipped = mappings.some(mapping => mapping.shipping_date !== null);
        if (hasShipped) {
          showStatus('Cannot Unmap: Pallet Already Shipped', 'error');
          return;
        }
        
        if (!confirm(`Move all mappings for "${currentPalletNo}" to history?`)) {
          return;
        }
        
        // 2. íˆìŠ¤í† ë¦¬ í…Œì´ë¸”ë¡œ ë°ì´í„° ì´ì „
        const historyData = mappings.map(mapping => ({
          original_id: mapping.id,
          pallet_no: mapping.pallet_no,
          tm_no: mapping.tm_no,
          mapping_date: mapping.mapping_date,
          unmapping_date: new Date().toISOString(),
          shipping_date: mapping.shipping_date,
          created_at: mapping.created_at,
          updated_at: mapping.updated_at
        }));
        
        const { error: insertError } = await supabaseClient
          .from('vwtm_mapping_history')
          .insert(historyData);
        
        if (insertError) {
          throw insertError;
        }
        
        // 3. ì›ë³¸ í…Œì´ë¸”ì—ì„œ ì‚­ì œ
        const { error: deleteError } = await supabaseClient
          .from('vwtm_mapping')
          .delete()
          .eq('pallet_no', currentPalletNo);
        
        if (deleteError) {
          throw deleteError;
        }
        
        showStatus(`Moved ${mappings.length} mappings to history: ${currentPalletNo}`, 'success');
        
        // í¼ ì´ˆê¸°í™”
        resetMappingForm();
      } catch (error) {
        console.error('Error unmapping pallet:', error);
        showStatus('Unmapping Error', 'error');
      }
    }
    
    // ë§µí•‘ í¼ ì´ˆê¸°í™”
    function resetMappingForm() {
      currentPalletNo = null;
      mappingState = 'pallet';
      scannedTMs = [];
      existingMappedTMs = [];
      palletValidated = false;
      
      const palletInput = document.getElementById('palletInput');
      const tmInput = document.getElementById('tmInput');
      const palletDisplay = document.getElementById('palletDisplay');
      const tmScanSection = document.getElementById('tmScanSection');
      const actionButtons = document.getElementById('actionButtons');
      const palletScanSection = document.getElementById('palletScanSection');
      
      if (palletInput) {
        palletInput.value = '';
        const palletInputContainer = palletInput.parentElement;
        if (palletInputContainer) {
          palletInputContainer.style.display = 'block';
        }
        // í¬ì»¤ìŠ¤ ë³µê·€ (ë” í™•ì‹¤í•˜ê²Œ)
        requestAnimationFrame(() => {
          setTimeout(() => {
            palletInput.focus();
            if (document.activeElement !== palletInput) {
              palletInput.focus();
            }
          }, 50);
        });
      }
      
      if (tmInput) {
        tmInput.value = '';
      }
      
      if (palletDisplay) {
        palletDisplay.classList.add('hidden');
      }
      
      if (tmScanSection) {
        tmScanSection.classList.add('hidden');
      }
      
      if (actionButtons) {
        actionButtons.classList.add('hidden');
      }
      
      // ê¸°ì¡´ ë§µí•‘ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      const existingSection = document.getElementById('existingMappingsSection');
      if (existingSection) {
        existingSection.classList.add('hidden');
      }
      
      updateTMCount();
      updateTMList();
    }
    
    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(message, type) {
      const statusDiv = document.getElementById('mappingStatus');
      if (!statusDiv) return;
      
      statusDiv.classList.remove('hidden');
      let bgColor = 'bg-gray-100 border-gray-500 text-gray-800';
      if (type === 'success') {
        bgColor = 'bg-green-100 border-green-500 text-green-800';
      } else if (type === 'error') {
        bgColor = 'bg-red-100 border-red-500 text-red-800';
      } else if (type === 'info') {
        bgColor = 'bg-blue-100 border-blue-500 text-blue-800';
      }
      
      statusDiv.className = `rounded-lg p-4 border-2 ${bgColor}`;
      statusDiv.innerHTML = `
        <div class="flex items-center">
          <span class="text-lg font-semibold">${message}</span>
        </div>
      `;
      
      // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
      setTimeout(() => {
        statusDiv.classList.add('hidden');
      }, 3000);
    }
    
    // ë§µí•‘ ê²°ê³¼ ì¶”ê°€
    function addMappingResult(mapping) {
      const resultsDiv = document.getElementById('mappingResults');
      const resultsList = document.getElementById('mappingResultsList');
      
      if (!resultsDiv || !resultsList) return;
      
      resultsDiv.classList.remove('hidden');
      
      const resultDiv = document.createElement('div');
      resultDiv.className = 'scan-result bg-gray-50 rounded-lg p-4 border-l-4 border-blue-500';
      
      const mappingDate = new Date(mapping.mapping_date).toLocaleString('ko-KR');
      
      resultDiv.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <div class="flex-1">
            <div class="font-bold text-lg text-gray-800 mb-1">
              <span class="text-blue-600">${mapping.pallet_no}</span> â†” <span class="text-green-600">${mapping.tm_no}</span>
            </div>
            <div class="text-sm text-gray-600">${mappingDate}</div>
          </div>
          <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
            âœ“
          </span>
        </div>
      `;
      
      resultsList.insertBefore(resultDiv, resultsList.firstChild);
    }
    
    // ìµœê·¼ ë§µí•‘ ë‚´ì—­ ë¡œë“œ
    async function loadRecentMappings() {
      try {
        if (!supabaseClient) {
          await initSupabase();
        }
        
        const { data, error } = await supabaseClient
          .from('vwtm_mapping')
          .select('*')
          .order('mapping_date', { ascending: false })
          .limit(10);
        
        if (error) {
          if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
            console.warn('Mapping table does not exist');
            return;
          }
          throw error;
        }
        
        if (data && data.length > 0) {
          const resultsDiv = document.getElementById('mappingResults');
          const resultsList = document.getElementById('mappingResultsList');
          
          if (resultsDiv && resultsList) {
            resultsDiv.classList.remove('hidden');
            resultsList.innerHTML = '';
            
            data.forEach(mapping => {
              addMappingResult(mapping);
            });
          }
        }
      } catch (error) {
        console.error('Error loading recent mappings:', error);
      }
    }
    
    // ë§µí•‘ ê²°ê³¼ ì§€ìš°ê¸°
    function clearMappingResults() {
      const resultsList = document.getElementById('mappingResultsList');
      if (resultsList) {
        resultsList.innerHTML = '';
        const resultsDiv = document.getElementById('mappingResults');
        if (resultsDiv) {
          resultsDiv.classList.add('hidden');
        }
      }
    }
    
    // ì´ˆê¸°í™”
    // Shipping íŒ”ë › ìŠ¤ìº” ì²˜ë¦¬
    async function handleShippingPalletScan() {
      const shippingPalletInput = document.getElementById('shippingPalletInput');
      if (!shippingPalletInput) return;
      
      const palletNo = shippingPalletInput.value.trim();
      if (!palletNo) {
        showShippingStatus('Enter Pallet No', 'error');
        return;
      }
      
      // ì´ë¯¸ ìŠ¤ìº”í•œ íŒ”ë ›ì¸ì§€ í™•ì¸
      if (shippingPallets.includes(palletNo)) {
        showShippingStatus('Pallet Already Scanned', 'error');
        shippingPalletInput.value = '';
        // í¬ì»¤ìŠ¤ ë³µê·€ (ë” í™•ì‹¤í•˜ê²Œ)
        requestAnimationFrame(() => {
          shippingPalletInput.focus();
        });
        return;
      }
      
      showShippingStatus('Checking...', 'info');
      
      try {
        if (!supabaseClient) {
          await initSupabase();
        }
        
        // ë§µí•‘ëœ íŒ”ë ›ì¸ì§€ í™•ì¸ (vwtm_mappingì— ìˆëŠ”ì§€)
        const { data, error } = await supabaseClient
          .from('vwtm_mapping')
          .select('tm_no, shipping_date')
          .eq('pallet_no', palletNo);
        
        if (error) {
          throw error;
        }
        
        if (!data || data.length === 0) {
          showShippingStatus('Pallet Not Mapped', 'error');
          shippingPalletInput.value = '';
          // í¬ì»¤ìŠ¤ ë³µê·€ (ë” í™•ì‹¤í•˜ê²Œ)
          requestAnimationFrame(() => {
            shippingPalletInput.focus();
          });
          return;
        }
        
        // ì´ë¯¸ ë°°ì†¡ëœ íŒ”ë ›ì¸ì§€ í™•ì¸
        const hasShipped = data.some(mapping => mapping.shipping_date !== null);
        if (hasShipped) {
          showShippingStatus('Pallet Already Shipped', 'error');
          shippingPalletInput.value = '';
          // í¬ì»¤ìŠ¤ ë³µê·€ (ë” í™•ì‹¤í•˜ê²Œ)
          requestAnimationFrame(() => {
            shippingPalletInput.focus();
          });
          return;
        }
        
        // íŒ”ë › ì¶”ê°€
        shippingPallets.push(palletNo);
        
        // TM ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
        data.forEach(mapping => {
          if (!shippingMappedTMs.find(tm => tm.tm_no === mapping.tm_no && tm.pallet_no === palletNo)) {
            shippingMappedTMs.push({
              ...mapping,
              pallet_no: palletNo
            });
          }
        });
        
        // ì…ë ¥ì°½ ì´ˆê¸°í™” ë° í¬ì»¤ìŠ¤ ìœ ì§€ (ì—°ì† ìŠ¤ìº”ì„ ìœ„í•´ í•„ìˆ˜)
        shippingPalletInput.value = '';
        // ì´ì¤‘ ë³´ì¥: requestAnimationFrame + setTimeout
        requestAnimationFrame(() => {
          shippingPalletInput.focus();
          // í¬ì»¤ìŠ¤ê°€ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ì¬ì‹œë„
          setTimeout(() => {
            if (document.activeElement !== shippingPalletInput) {
              shippingPalletInput.focus();
            }
          }, 50);
        });
        
        // UI ì—…ë°ì´íŠ¸
        updateShippingSummary();
        updateShippingPalletsList();
        
        // ì„¹ì…˜ í‘œì‹œ
        const shippingSummaryCard = document.getElementById('shippingSummaryCard');
        const shippingPalletsListSection = document.getElementById('shippingPalletsListSection');
        const shippingSaveButton = document.getElementById('shippingSaveButton');
        
        if (shippingSummaryCard) {
          shippingSummaryCard.classList.remove('hidden');
        }
        if (shippingPalletsListSection) {
          shippingPalletsListSection.classList.remove('hidden');
        }
        if (shippingSaveButton) {
          shippingSaveButton.classList.remove('hidden');
        }
        
        showShippingStatus(`Pallet "${palletNo}" Added (${data.length} TMs)`, 'success');
      } catch (error) {
        console.error('Error checking pallet:', error);
        showShippingStatus('Check Error', 'error');
        shippingPalletInput.value = '';
        // í¬ì»¤ìŠ¤ ë³µê·€ (ë” í™•ì‹¤í•˜ê²Œ)
        requestAnimationFrame(() => {
          shippingPalletInput.focus();
        });
      }
    }
    
    // Shipping ìš”ì•½ ì—…ë°ì´íŠ¸
    function updateShippingSummary() {
      const palletCount = document.getElementById('shippingPalletCount');
      const totalTMCount = document.getElementById('shippingTotalTMCount');
      
      if (palletCount) {
        palletCount.textContent = shippingPallets.length;
      }
      if (totalTMCount) {
        totalTMCount.textContent = shippingMappedTMs.length;
      }
    }
    
    // Shipping íŒ”ë › ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    function updateShippingPalletsList() {
      const shippingPalletsList = document.getElementById('shippingPalletsList');
      if (!shippingPalletsList) return;
      
      if (shippingPallets.length === 0) {
        shippingPalletsList.innerHTML = '';
        return;
      }
      
      shippingPalletsList.innerHTML = shippingPallets.map((pallet, index) => `
        <div class="bg-white rounded-lg p-2 border border-yellow-400 flex items-center justify-between">
          <div class="flex items-center">
            <span class="text-xs text-gray-500 mr-2">${index + 1}.</span>
            <span class="font-semibold text-gray-800 text-sm">${pallet}</span>
          </div>
          <button onclick="removeShippingPallet('${pallet}')" class="text-red-500 hover:text-red-700 text-xs font-semibold">
            Remove
          </button>
        </div>
      `).join('');
    }
    
    // Shipping íŒ”ë › ì œê±°
    window.removeShippingPallet = function(palletNo) {
      // íŒ”ë › ì œê±°
      shippingPallets = shippingPallets.filter(p => p !== palletNo);
      
      // í•´ë‹¹ íŒ”ë ›ì˜ TM ì œê±°
      shippingMappedTMs = shippingMappedTMs.filter(tm => tm.pallet_no !== palletNo);
      
      // UI ì—…ë°ì´íŠ¸
      updateShippingSummary();
      updateShippingPalletsList();
      
      // í¬ì»¤ìŠ¤ ìœ ì§€
      const shippingPalletInput = document.getElementById('shippingPalletInput');
      if (shippingPalletInput) {
        shippingPalletInput.focus();
      }
      
      showShippingStatus(`Pallet "${palletNo}" Removed`, 'info');
    }
    
    // Shipping TM ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    function updateShippingTMList() {
      const shippingTMList = document.getElementById('shippingTMList');
      const shippingTMCount = document.getElementById('shippingTMCount');
      
      if (shippingTMCount) {
        shippingTMCount.textContent = shippingMappedTMs.length;
      }
      
      if (!shippingTMList) return;
      
      if (shippingMappedTMs.length === 0) {
        shippingTMList.innerHTML = '';
        return;
      }
      
      shippingTMList.innerHTML = shippingMappedTMs.map((mapping, index) => {
        const hasShippingDate = mapping.shipping_date ? 'âœ…' : 'â³';
        const shippingDateText = mapping.shipping_date 
          ? new Date(mapping.shipping_date).toLocaleString() 
          : 'Not Shipped';
        
        return `
          <div class="bg-white rounded-lg p-2 border border-gray-300 flex items-center justify-between">
            <div class="flex items-center">
              <span class="text-xs text-gray-500 mr-2">${index + 1}.</span>
              <span class="font-semibold text-gray-800 text-sm">${mapping.tm_no}</span>
              <span class="text-xs text-gray-400 ml-2">(${mapping.pallet_no})</span>
            </div>
            <div class="flex items-center text-xs text-gray-600">
              <span class="mr-2">${hasShippingDate}</span>
              <span>${shippingDateText}</span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Shipping ì €ì¥
    window.saveShipping = async function() {
      if (shippingPallets.length === 0 || shippingMappedTMs.length === 0) {
        showShippingStatus('No Pallets Scanned', 'error');
        return;
      }
      
      try {
        if (!supabaseClient) {
          await initSupabase();
        }
        
        const shippingDate = new Date();
        const shippingDateStr = shippingDate.toISOString();
        const today = new Date(shippingDate.getFullYear(), shippingDate.getMonth(), shippingDate.getDate());
        const todayStart = new Date(today).toISOString();
        const todayEnd = new Date(today);
        todayEnd.setHours(23, 59, 59, 999);
        const todayEndStr = todayEnd.toISOString();
        
        // ì˜¤ëŠ˜ ë‚ ì§œì˜ ìµœëŒ€ ë°°ì°¨ ë²ˆí˜¸ ì¡°íšŒ
        const { data: todayData, error: batchError } = await supabaseClient
          .from('vwtm_mapping')
          .select('shipping_batch')
          .gte('shipping_date', todayStart)
          .lte('shipping_date', todayEndStr)
          .not('shipping_batch', 'is', null);
        
        if (batchError && batchError.code !== 'PGRST116') {
          throw batchError;
        }
        
        // ë°°ì°¨ ë²ˆí˜¸ ê³„ì‚° (ì˜¤ëŠ˜ ë‚ ì§œì˜ ìµœëŒ€ ë°°ì°¨ + 1)
        let nextBatch = 1;
        if (todayData && todayData.length > 0) {
          const maxBatch = Math.max(...todayData.map(d => d.shipping_batch || 0));
          nextBatch = maxBatch + 1;
        }
        
        // ëª¨ë“  ìŠ¤ìº”í•œ íŒ”ë ›ì˜ TMì— shipping_dateì™€ shipping_batch ì—…ë°ì´íŠ¸
        const updatePromises = shippingPallets.map(palletNo => 
          supabaseClient
            .from('vwtm_mapping')
            .update({ 
              shipping_date: shippingDateStr,
              shipping_batch: nextBatch
            })
            .eq('pallet_no', palletNo)
        );
        
        const results = await Promise.all(updatePromises);
        
        // ì—ëŸ¬ í™•ì¸
        const errors = results.filter(r => r.error);
        if (errors.length > 0) {
          throw errors[0].error;
        }
        
        showShippingStatus(`Saved: ${shippingPallets.length} Pallets, ${shippingMappedTMs.length} TMs (${nextBatch}ì°¨)`, 'success');
        
        // TM ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¡œë“œ
        const { data, error: reloadError } = await supabaseClient
          .from('vwtm_mapping')
          .select('tm_no, shipping_date, shipping_batch, pallet_no')
          .in('pallet_no', shippingPallets);
        
        if (!reloadError && data) {
          shippingMappedTMs = data;
          updateShippingSummary();
        }
        
        // í¼ ì´ˆê¸°í™” (ë‹¤ìŒ ë°°ì¹˜ë¥¼ ìœ„í•´)
        setTimeout(() => {
          resetShippingForm();
        }, 2000);
      } catch (error) {
        console.error('Error saving shipping:', error);
        showShippingStatus('Save Error', 'error');
      }
    }
    
    // Shipping í¼ ì´ˆê¸°í™”
    function resetShippingForm() {
      shippingPallets = [];
      shippingMappedTMs = [];
      
      const shippingPalletInput = document.getElementById('shippingPalletInput');
      const shippingSummaryCard = document.getElementById('shippingSummaryCard');
      const shippingPalletsListSection = document.getElementById('shippingPalletsListSection');
      const shippingTMsSection = document.getElementById('shippingTMsSection');
      const shippingSaveButton = document.getElementById('shippingSaveButton');
      
      if (shippingPalletInput) {
        shippingPalletInput.value = '';
        // í¬ì»¤ìŠ¤ ë³µê·€ (ë” í™•ì‹¤í•˜ê²Œ)
        requestAnimationFrame(() => {
          setTimeout(() => {
            shippingPalletInput.focus();
            if (document.activeElement !== shippingPalletInput) {
              shippingPalletInput.focus();
            }
          }, 50);
        });
      }
      
      if (shippingSummaryCard) {
        shippingSummaryCard.classList.add('hidden');
      }
      
      if (shippingPalletsListSection) {
        shippingPalletsListSection.classList.add('hidden');
      }
      
      if (shippingTMsSection) {
        shippingTMsSection.classList.add('hidden');
      }
      
      if (shippingSaveButton) {
        shippingSaveButton.classList.add('hidden');
      }
    }
    
    // Shipping ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showShippingStatus(message, type) {
      const statusDiv = document.getElementById('shippingStatus');
      if (!statusDiv) return;
      
      statusDiv.classList.remove('hidden');
      
      const colors = {
        success: 'bg-green-100 border-green-500 text-green-800',
        error: 'bg-red-100 border-red-500 text-red-800',
        info: 'bg-blue-100 border-blue-500 text-blue-800'
      };
      
      statusDiv.className = `rounded-lg p-3 border-2 ${colors[type] || colors.info} font-semibold text-sm`;
      statusDiv.textContent = message;
      
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 3000);
      }
    }
    
    // Find TM ìŠ¤ìº” ì²˜ë¦¬
    async function handleFindTMScan() {
      const findTMInput = document.getElementById('findTMInput');
      if (!findTMInput) return;
      
      const tmNo = findTMInput.value.trim();
      if (!tmNo) {
        showFindStatus('Enter TM No', 'error');
        return;
      }
      
      // TM ë²ˆí˜¸ ê²€ì¦ (12ìë¦¬, ì‹œì‘: 2/3/7/8)
      if (!validateTMNo(tmNo)) {
        showFindStatus('Invalid TM Code', 'error');
        findTMInput.value = '';
        findTMInput.focus();
        return;
      }
      
      showFindStatus('Searching...', 'info');
      
      try {
        if (!supabaseClient) {
          await initSupabase();
        }
        
        // TMì´ ë§µí•‘ëœ íŒ”ë › ì¡°íšŒ
        const { data, error } = await supabaseClient
          .from('vwtm_mapping')
          .select('pallet_no, mapping_date, shipping_date')
          .eq('tm_no', tmNo);
        
        if (error) {
          throw error;
        }
        
        if (!data || data.length === 0) {
          showFindStatus(`TM "${tmNo}" Not Mapped`, 'error');
          findTMInput.value = '';
          findTMInput.focus();
          return;
        }
        
        // ê²°ê³¼ ì´ˆê¸°í™” í›„ ìƒˆ ê²°ê³¼ë§Œ ì¶”ê°€ (1ê°œë§Œ í‘œì‹œ)
        findResults = [];
        data.forEach(mapping => {
          findResults.push({
            tm_no: tmNo,
            pallet_no: mapping.pallet_no,
            mapping_date: mapping.mapping_date,
            shipping_date: mapping.shipping_date
          });
        });
        
        // ì…ë ¥ì°½ ì´ˆê¸°í™” ë° í¬ì»¤ìŠ¤ ìœ ì§€
        findTMInput.value = '';
        requestAnimationFrame(() => {
          findTMInput.focus();
        });
        
        // UI ì—…ë°ì´íŠ¸
        updateFindResults();
        
        // ì„¹ì…˜ í‘œì‹œ
        const findResultsSection = document.getElementById('findResultsSection');
        const findClearButton = document.getElementById('findClearButton');
        
        if (findResultsSection) {
          findResultsSection.classList.remove('hidden');
        }
        if (findClearButton) {
          findClearButton.classList.remove('hidden');
        }
        
        const palletCount = data.length;
        showFindStatus(`TM "${tmNo}" Found (${palletCount} Pallet${palletCount > 1 ? 's' : ''})`, 'success');
      } catch (error) {
        console.error('Error finding TM:', error);
        showFindStatus('Search Error', 'error');
        findTMInput.value = '';
        findTMInput.focus();
      }
    }
    
    // Find ê²°ê³¼ ì—…ë°ì´íŠ¸
    function updateFindResults() {
      const findResultsList = document.getElementById('findResultsList');
      
      if (!findResultsList) return;
      
      if (findResults.length === 0) {
        findResultsList.innerHTML = '';
        return;
      }
      
      findResultsList.innerHTML = findResults.map((result, index) => {
        return `
          <div class="bg-white rounded-lg p-3 border border-gray-300">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <span class="text-xs text-gray-500 mr-2">${index + 1}.</span>
                <span class="font-bold text-gray-800 text-base">${result.tm_no}</span>
              </div>
              <span class="text-blue-600 font-bold text-base">${result.pallet_no}</span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Find ê²°ê³¼ ì§€ìš°ê¸°
    window.clearFindResults = function() {
      findResults = [];
      
      const findResultsSection = document.getElementById('findResultsSection');
      const findClearButton = document.getElementById('findClearButton');
      const findTMInput = document.getElementById('findTMInput');
      
      if (findResultsSection) {
        findResultsSection.classList.add('hidden');
      }
      if (findClearButton) {
        findClearButton.classList.add('hidden');
      }
      if (findTMInput) {
        findTMInput.focus();
      }
      
      showFindStatus('Cleared', 'info');
    }
    
    // Find ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showFindStatus(message, type) {
      const statusDiv = document.getElementById('findStatus');
      if (!statusDiv) return;
      
      statusDiv.classList.remove('hidden');
      
      const colors = {
        success: 'bg-green-100 border-green-500 text-green-800',
        error: 'bg-red-100 border-red-500 text-red-800',
        info: 'bg-blue-100 border-blue-500 text-blue-800'
      };
      
      statusDiv.className = `rounded-lg p-3 border-2 ${colors[type] || colors.info} font-semibold text-sm`;
      statusDiv.textContent = message;
      
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 3000);
      }
    }
    
    document.addEventListener('DOMContentLoaded', async function() {
      await initSupabase();
    });
  </script>
</body>
</html>
