<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Management</title>
    
    <!-- Handsontable CDN -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12.3.3/dist/handsontable.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.3.3/dist/handsontable.full.min.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .date-filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .date-filters input[type="date"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
            min-height: 700px; /* 최소 높이 증가 */
            overflow-x: hidden; /* 가로 스크롤 방지 */
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .table-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Handsontable 커스텀 스타일 */
        .handsontable {
            font-size: 14px;
            overflow-x: hidden !important; /* 가로 스크롤 방지 */
        }
        
        .handsontable th {
            background: #f8f9fa !important;
            font-weight: 600 !important;
            color: #495057 !important;
        }
        
        .handsontable td {
            padding: 8px 12px !important;
        }
        
        /* 드롭다운 가시성 문제 해결 */
        .handsontable .htAutocompleteArrow {
            z-index: 1000 !important;
        }
        
        /* 드롭다운 메뉴 통합 스타일링 - 중복 제거 */
        .htDropdownMenu,
        .handsontable .htDropdownMenu,
        div[class*="htDropdownMenu"] {
            z-index: 99999 !important;
            position: absolute !important;
            background: white !important;
            border: 1px solid #ccc !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
            max-height: 600px !important; /* 4개 옵션이 보이도록 높이 증가 */
            min-height: 300px !important; /* 최소 높이도 증가 */
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }
        
        .htDropdownMenu table,
        .handsontable .htDropdownMenu table,
        div[class*="htDropdownMenu"] table {
            width: 100% !important;
            border-collapse: collapse !important;
        }
        
        .htDropdownMenu td,
        .handsontable .htDropdownMenu td,
        div[class*="htDropdownMenu"] td {
            padding: 12px 16px !important;
            border-bottom: 1px solid #eee !important;
            cursor: pointer !important;
            white-space: nowrap !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
            background: white !important;
            color: #333 !important;
        }
        
        .htDropdownMenu td:hover,
        .handsontable .htDropdownMenu td:hover,
        div[class*="htDropdownMenu"] td:hover {
            background-color: #f5f5f5 !important;
            color: #000 !important;
        }
        
        .htDropdownMenu td:last-child,
        .handsontable .htDropdownMenu td:last-child,
        div[class*="htDropdownMenu"] td:last-child {
            border-bottom: none !important;
        }
        
        /* 테이블 전체 크기 조정 */
        #truckTable {
            width: 100% !important;
            height: 600px !important;
            min-height: 600px;
            overflow-x: hidden !important; /* 가로 스크롤 방지 */
        }
        
        .handsontable-container {
            min-height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow-x: hidden !important; /* 가로 스크롤 방지 */
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }
        
        .status-scheduled {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-onsite {
            background: #d4edda;
            color: #155724;
        }
        
        .status-shipped {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-delayed {
            background: #f8d7da;
            color: #721c24;
        }
        
                 .status-cancelled {
             background: #e2e3e5;
             color: #383d41;
         }
         
         /* 상태별 색상 스타일 - 더 진한 색상으로 개선 */
         .status-shipped {
             background: #b8daff;
             color: #004085;
             font-weight: bold;
         }
         
         .status-scheduled {
             background: #fff3cd;
             color: #856404;
             font-weight: bold;
         }
         
         .status-onsite {
             background: #c3e6cb;
             color: #155724;
             font-weight: bold;
         }
         
         /* STATUS 컬럼 헤더 색상 */
         .status-header-shipped {
             background: #007bff !important;
             color: white !important;
         }
         
         .status-header-scheduled {
             background: #ffc107 !important;
             color: #212529 !important;
         }
         
         .status-header-onsite {
             background: #28a745 !important;
             color: white !important;
         }
         
         /* 행 전체 색상 스타일 */
         .row-shipped {
             background-color: #e3f2fd !important;
         }
         
         .row-shipped td {
             background-color: #e3f2fd !important;
             border-color: #2196f3 !important;
         }
         
         .row-scheduled {
             background-color: #fff8e1 !important;
         }
         
         .row-scheduled td {
             background-color: #fff8e1 !important;
             border-color: #ff9800 !important;
         }
         
         .row-onsite {
             background-color: #e8f5e8 !important;
         }
         
         .row-onsite td {
             background-color: #e8f5e8 !important;
             border-color: #4caf50 !important;
         }
         
         /* 실시간 상태 표시 스타일 */
         .live-status-container {
             background: white;
             border-radius: 8px;
             box-shadow: 0 2px 10px rgba(0,0,0,0.1);
             padding: 20px;
             margin-bottom: 20px;
         }
         
         .live-status-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 20px;
             padding-bottom: 15px;
             border-bottom: 2px solid #e9ecef;
         }
         
         .live-status-header h3 {
             margin: 0;
             color: #495057;
             font-size: 1.3rem;
         }
         
         .status-controls {
             display: flex;
             gap: 10px;
         }
         
         .btn-sm {
             padding: 6px 12px;
             font-size: 12px;
         }
         
         .btn-outline-info {
             background: transparent;
             color: #17a2b8;
             border: 1px solid #17a2b8;
         }
         
         .btn-outline-info:hover {
             background: #17a2b8;
             color: white;
         }
         
         .btn-outline-secondary {
             background: transparent;
             color: #6c757d;
             border: 1px solid #6c757d;
         }
         
         .btn-outline-secondary:hover {
             background: #6c757d;
             color: white;
         }
         
         .live-status-content {
             min-height: 200px;
             max-height: 400px;
             overflow-y: auto;
         }
         
         .no-status-message {
             text-align: center;
             padding: 40px;
             color: #6c757d;
             font-style: italic;
         }
         
         .live-status-item {
             background: #f8f9fa;
             border-radius: 8px;
             padding: 15px;
             margin-bottom: 15px;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1);
             transition: all 0.3s ease;
         }
         
         .live-status-item:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 10px rgba(0,0,0,0.15);
         }
         
         .status-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 15px;
             padding-bottom: 10px;
             border-bottom: 1px solid #dee2e6;
         }
         
         .status-icon {
             font-size: 1.5rem;
             margin-right: 10px;
         }
         
         .status-text {
             font-weight: bold;
             font-size: 1.1rem;
             flex-grow: 1;
         }
         
         .update-time {
             color: #6c757d;
             font-size: 0.9rem;
             font-style: italic;
         }
         
         .status-details {
             display: flex;
             flex-direction: column;
             gap: 8px;
         }
         
         .detail-row {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 5px 0;
         }
         
         .label {
             font-weight: 600;
             color: #495057;
             min-width: 80px;
         }
         
         .value {
             color: #212529;
             font-weight: 500;
             text-align: right;
             flex-grow: 1;
             margin-left: 10px;
         }
         
         .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }
        
        .error-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>🚛 Truck Management</h1>
            <p>Comprehensive truck delivery tracking and management system</p>
        </div>
        
                 <!-- 컨트롤 -->
         <div class="controls">
             <div class="date-filters">
                 <label>Select Date:</label>
                <input type="date" id="startDate" onchange="autoFilterByDate()">
                                   <button class="btn btn-warning" onclick="refreshCurrentDateData()">🔄 현재 날짜 새로고침</button>
             </div>
                         <div>
                 <button class="btn btn-success" onclick="addNewRow()">➕ Add New Row</button>
                 <button class="btn btn-warning" onclick="refreshData()">🔄 Refresh</button>
             </div>
         </div>
        

         
         <!-- 테이블 컨테이너 -->
         <div class="table-container">
             <div class="table-header">
                 <h3 class="table-title">📋 Current Truck Status</h3>
                 <div class="table-actions">
                     <button class="btn btn-success" onclick="addNewRow()">➕ Add New Row</button>
                     <button class="btn btn-danger" onclick="deleteLastRow()">🗑️ Delete Row</button>
                     <button class="btn btn-primary" onclick="saveAllChanges()">💾 Save All Changes</button>
                 </div>
             </div>
             <div id="truckTableContainer">
                 <div class="loading">
                     <div class="loading-icon">🔄</div>
                     <div>Loading truck data...</div>
                 </div>
              </div>
          </div>
     </div>
    
    <script>
        // Supabase 설정
         const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
         const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
        
                 // 전역 변수
         let supabase = null;
         let hot = null;
         let currentData = [];
         let originalData = []; // 원본 데이터 백업
         let hasUnsavedChanges = false;
         let currentDate = '';
        
        // 페이지 로드 시 초기화
         console.log('🚀 Truck Management page script executing...');
         
         // DOM이 준비되었는지 확인하고 초기화
         if (document.readyState === 'loading') {
             document.addEventListener('DOMContentLoaded', initializePage);
         } else {
             // DOM이 이미 로드된 경우 즉시 실행
             setTimeout(initializePage, 100);
         }
         
         // 페이지 초기화 함수
         function initializePage() {
             console.log('🚀 Initializing Truck Management page...');
             
             // 기존 실시간 상태 복원
             restoreLiveStatus();
             
             // Supabase 라이브러리가 로드될 때까지 대기
             waitForSupabase();
             setDefaultDates();
             
             // 페이지 로드 시 드롭다운 스타일 강제 적용
             setTimeout(forceDropdownStyling, 100);
             
             // 주기적으로 드롭다운 스타일 확인 및 적용
             setInterval(forceDropdownStyling, 2000);
             
             console.log('✅ 드롭다운 스타일 자동 적용 설정 완료');
         }
         
         // Supabase 라이브러리 로드 대기
         function waitForSupabase() {
             console.log('🔍 Checking Supabase library status...');
             
             // supabase-config.js에서 초기화된 클라이언트 사용
             if (typeof window.sb !== 'undefined' && window.sb) {
                 console.log('✅ Supabase client ready from config, using it...');
                 supabase = window.sb;
                 testSupabaseConnection();
             } else if (typeof window.supabase !== 'undefined' && window.supabase) {
                 console.log('✅ Supabase library ready, initializing...');
                 initializeSupabase();
             } else {
                 console.log('⏳ Waiting for Supabase library... (attempt in 200ms)');
                 setTimeout(waitForSupabase, 200);
             }
         }
        
                 // Supabase 초기화
         function initializeSupabase() {
             try {
                 console.log('🔧 Initializing Supabase...');
                 
                 // supabase 라이브러리가 로드되었는지 확인
                 if (typeof window.supabase === 'undefined') {
                     throw new Error('Supabase library not loaded yet');
                 }
                 
                 // 클라이언트 생성
                 supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                 console.log('✅ Supabase client created:', supabase);
                 
                 // 연결 테스트
                 testSupabaseConnection();
                 
             } catch (error) {
                 console.error('❌ Supabase initialization failed:', error);
                 showError('Supabase 초기화 실패: ' + error.message);
             }
         }
         
         // Supabase 연결 테스트
         async function testSupabaseConnection() {
             try {
                 console.log('🔍 Testing Supabase connection...');
                 
                 // 먼저 간단한 테이블 존재 여부 확인
                 const { data, error } = await supabase
                     .from('vwtm_truck_management')
                     .select('count', { count: 'exact', head: true })
                     .limit(1);
                     
                     // 테이블이 존재하지 않는 경우 다른 테이블로 시도
                if (error && (error.message.includes('relation') || error.message.includes('does not exist'))) {
                         console.log('🔍 Table vwtm_truck_management not found, trying vwtm_list_data...');
                    
                         const { data: altData, error: altError } = await supabase
                             .from('vwtm_list_data')
                             .select('count', { count: 'exact', head: true })
                             .limit(1);
                         
                         if (altError) {
                             throw altError;
                         }
                         
                         console.log('✅ Alternative table connection successful');
                 } else {
                     console.log('✅ Supabase connection successful');
                 }
                 
                // 연결 성공 후 기본 날짜로 필터링된 데이터 로딩
                await autoFilterByDate();
                 
             } catch (error) {
                 console.error('❌ Supabase connection test failed:', error);
                 showError('데이터베이스 연결 실패: ' + error.message);
             }
         }
        
                 // 기본 날짜 설정
         function setDefaultDates() {
             const today = new Date();
            const todayString = today.toISOString().split('T')[0];
             
             // 오늘 날짜를 기본값으로 설정
            document.getElementById('startDate').value = todayString;
            console.log('📅 Default date set to:', todayString);
            
            // 페이지 로드 시 자동으로 오늘 날짜 데이터 로드
            if (supabase) {
                console.log('🚀 Auto-loading data for default date...');
                setTimeout(() => {
                    autoFilterByDate();
                }, 100);
            }
         }
        
                 // 트럭 데이터 로드
         async function loadTruckData() {
             try {
                 console.log('📊 Loading truck data...');
                 
                 // Supabase 클라이언트 상태 확인
                 if (!supabase) {
                     throw new Error('Supabase client not initialized');
                 }
                 
                 console.log('🔍 Supabase client status:', !!supabase);
                 showLoading();
                 
                 // 먼저 vwtm_truck_management 테이블 시도 (모든 데이터 로드)
                 let { data, error } = await supabase
                     .from('vwtm_truck_management')
                     .select('*')
                     .order('departure_date', { ascending: false })
                     .order('departure_time', { ascending: true })
                    .limit(1000);
                 
                 // 테이블이 존재하지 않는 경우 vwtm_list_data 시도
                 if (error && (error.message.includes('relation') || error.message.includes('does not exist'))) {
                     console.log('🔍 Table vwtm_truck_management not found, trying vwtm_list_data...');
                     
                     const result = await supabase
                         .from('vwtm_list_data')
                         .select('*')
                         .order('departure_date', { ascending: false })
                         .order('departure_time', { ascending: true })
                        .limit(1000);
                    
                    if (result.error) {
                        throw result.error;
                    }
                    
                    // vwtm_list_data의 컬럼을 truck_management 형식으로 변환
                    data = result.data.map(item => ({
                        departure_date: item.departure_date || item.departure_date,
                        departure_time: item.departure_time || item.departure_time,
                        destination: item.destination || item.location || 'VW US',
                        delivery_no: item.delivery_no || item.delivery_no || '',
                        truck_id: item.truck_id || item.truck_id || '',
                        forza_id: item.forza_id || item.forza_id || '',
                        parts: item.parts || item.parts || '',
                        status: item.status || 'Scheduled'
                    }));
                    
                    error = null;
                 }
                 
                 if (error) throw error;
                 
                 currentData = data || [];
                originalData = [...currentData]; // 원본 데이터 백업
                 console.log('✅ Loaded', currentData.length, 'truck records');
                console.log('📅 Sample data dates:', currentData.slice(0, 3).map(item => item.departure_date));
                 
                 if (currentData.length === 0) {
                     showNoData();
                 } else {
                     displayTable();
                 }
                 
             } catch (error) {
                 console.error('❌ Error loading data:', error);
                 showError('데이터 로딩 실패: ' + error.message);
             }
         }
        
        // 자동 날짜 필터링 (날짜 변경 시 자동 실행)
        async function autoFilterByDate() {
            let selectedDate = document.getElementById('startDate').value;
            
            // 날짜가 없으면 기본 날짜 설정
            if (!selectedDate) {
                const today = new Date();
                selectedDate = today.toISOString().split('T')[0];
                document.getElementById('startDate').value = selectedDate;
                console.log('📅 No date selected, setting default date:', selectedDate);
            }
            
            console.log('🔍 Auto-filtering by date:', selectedDate);
            
            try {
                if (!supabase) {
                    throw new Error('Supabase client not initialized');
                }
                
                showLoading();
                
                // 날짜 형식을 YYYY-MM-DD로 통일
                const formattedDate = new Date(selectedDate).toISOString().split('T')[0];
                console.log('📅 Formatted date for filtering:', formattedDate);
                
                // 선택된 날짜의 데이터만 로드
                let { data, error } = await supabase
                    .from('vwtm_truck_management')
                    .select('*')
                    .eq('departure_date', formattedDate)
                    .order('departure_time', { ascending: true })
                    .limit(1000);
                
                // 테이블이 존재하지 않는 경우 vwtm_list_data 시도
                if (error && (error.message.includes('relation') || error.message.includes('does not exist'))) {
                    console.log('🔍 Table vwtm_truck_management not found, trying vwtm_list_data...');
                    
                    // vwtm_list_data 테이블에서 데이터 로드 (컬럼 매핑 조정)
                    const result = await supabase
                        .from('vwtm_list_data')
                        .select('*')
                        .eq('departure_date', formattedDate)
                        .order('departure_time', { ascending: true })
                        .limit(1000);
                    
                    if (result.error) {
                        throw result.error;
                    }
                    
                    // vwtm_list_data의 컬럼을 truck_management 형식으로 변환
                    data = result.data.map(item => ({
                        departure_date: item.departure_date || item.departure_date,
                        departure_time: item.departure_time || item.departure_time,
                        destination: item.destination || item.location || 'VW US',
                        delivery_no: item.delivery_no || item.delivery_no || '',
                        truck_id: item.truck_id || item.truck_id || '',
                        forza_id: item.forza_id || item.forza_id || '',
                        parts: item.parts || item.parts || '',
                        status: item.status || 'Scheduled'
                    }));
                    
                    error = null;
                }
                
                if (error) throw error;
                
                currentData = data || [];
                originalData = [...currentData]; // 원본 데이터 백업
                console.log('✅ Auto-filtered data loaded:', currentData.length, 'records for', formattedDate);
                console.log('📊 Current data structure:', currentData.slice(0, 2));
                
                if (currentData.length === 0) {
                    console.log('📭 No data found for date:', formattedDate);
                    // 데이터가 없어도 테이블 표시 (빈 행들로)
                    displayTable();
                } else {
                    displayTable();
                }
                
                // Handsontable 인스턴스 상태 확인
                if (hot) {
                    console.log('🔍 Handsontable instance after filtering:', !!hot);
                    console.log('🔍 Handsontable data length:', hot.getData().length);
                }
                
            } catch (error) {
                console.error('❌ Error auto-filtering data:', error);
                showError('자동 필터링 실패: ' + error.message);
            }
        }
        
        // 테이블 표시
        function displayTable() {
            const container = document.getElementById('truckTableContainer');
            
            // Handsontable로 테이블 생성
            try {
             if (hot) {
                 hot.destroy();
                    hot = null;
                }
                
                                 // 테이블 데이터 준비 (8개 컬럼)
                 const tableData = currentData.map(truck => [
                     truck.departure_time || '',
                     truck.destination || '',
                     truck.pager_no || '', // pager_no 추가
                     truck.delivery_no || '',
                     truck.truck_id || '',
                     truck.forza_id || '',
                     truck.parts || '',
                     truck.status || ''
                 ]);
                
                // 데이터가 없으면 기본 6행 표시, 있으면 1행 추가
                if (currentData.length === 0) {
                                         for (let i = 0; i < 6; i++) {
                         tableData.push([
                             '',            // departure_time
                             'VW US',      // destination (기본값)
                             '',            // pager_no
                             '',            // delivery_no
                             '',            // truck_id
                             '',            // forza_id
                             '',            // parts
                             'Scheduled'    // status (기본값)
                         ]);
                     }
                } else {
                                         // 기존 데이터가 있으면 1행만 추가
                     tableData.push([
                         '',            // departure_time
                         'VW US',      // destination (기본값)
                         '',            // pager_no
                         '',            // delivery_no
                         '',            // truck_id
                         '',            // forza_id
                         '',            // parts
                         'Scheduled'    // status (기본값)
                     ]);
                }
             
             hot = new Handsontable(container, {
                    data: tableData,
                    rowHeaders: true,
                    colHeaders: ['ETD Time', 'Destination', 'Pager No', 'Delivery No', 'Truck ID', 'Forza ID', 'Parts', 'Status'],
                    columns: [
                        { type: 'time', timeFormat: 'HH:mm', correctFormat: true, width: 120 },
                        { 
                            type: 'dropdown', 
                            source: ['VW US', 'VW MX', 'KMX'],
                            strict: false,
                            width: 180,
                            allowInvalid: false,
                            allowEmpty: false,
                            renderer: function(instance, td, row, col, prop, value, cellProperties) {
                                // ETD 시간이 입력되지 않았으면 비활성화 표시
                                const etdTime = instance.getDataAtRowProp(row, '0');
                                if (!etdTime || etdTime.trim() === '') {
                                    td.innerHTML = '⏰ ETD 입력';
                                    td.style.backgroundColor = '#f8f9fa';
                                    td.style.color = '#6c757d';
                                    td.style.fontStyle = 'italic';
                                    td.style.cursor = 'not-allowed';
                                    return td;
                                }
                                // ETD 시간이 있으면 정상적으로 드롭다운 표시
                                Handsontable.renderers.DropdownRenderer.apply(this, arguments);
                                td.style.cursor = 'pointer';
                                return td;
                            }
                        },
                        { type: 'text', width: 100 },
                        { type: 'text', width: 120 },
                        { type: 'text', width: 100 },
                        { type: 'text', width: 100 },
                        { type: 'text', width: 150 },
                        { 
                            type: 'dropdown', 
                            source: ['Shipped', 'Scheduled', 'On Site'],
                            strict: false,
                            width: 180,
                            allowInvalid: false,
                            allowEmpty: false,
                            renderer: function(instance, td, row, col, prop, value, cellProperties) {
                                 // ETD 시간이 입력되지 않았으면 비활성화 표시
                                 const etdTime = instance.getDataAtRowProp(row, '0');
                                 if (!etdTime || etdTime.trim() !== '') {
                                     // ETD 시간이 있으면 상태별 색상 적용 (더 진한 색상)
                                     if (value && value.trim() !== '') {
                                         switch (value) {
                                             case 'Shipped':
                                                 td.style.backgroundColor = '#b8daff'; // 진한 파란색
                                                 td.style.color = '#004085';
                                                 td.style.fontWeight = 'bold';
                                                 td.style.border = '2px solid #007bff';
                                                 break;
                                             case 'Scheduled':
                                                 td.style.backgroundColor = '#fff3cd'; // 노란색
                                                 td.style.color = '#856404';
                                                 td.style.fontWeight = 'bold';
                                                 td.style.border = '2px solid #ffc107';
                                                 break;
                                             case 'On Site':
                                                 td.style.backgroundColor = '#c3e6cb'; // 진한 초록색
                                                 td.style.color = '#155724';
                                                 td.style.fontWeight = 'bold';
                                                 td.style.border = '2px solid #28a745';
                                                 break;
                                             default:
                                                 td.style.backgroundColor = '#ffffff';
                                                 td.style.color = '#000000';
                                                 td.style.border = '1px solid #dee2e6';
                                         }
                                     } else {
                                         td.style.backgroundColor = '#ffffff';
                                         td.style.color = '#000000';
                                         td.style.border = '1px solid #dee2e6';
                                     }
                                 } else {
                                     // ETD 시간이 없으면 비활성화 표시
                                     td.innerHTML = '⏰ ETD 입력';
                                     td.style.backgroundColor = '#f8f9fa';
                                     td.style.color = '#6c757d';
                                     td.style.fontStyle = 'italic';
                                     td.style.cursor = 'not-allowed';
                                     td.style.border = '1px solid #dee2e6';
                                     return td;
                                 }
                                 
                                 // 드롭다운 렌더러 적용
                                 Handsontable.renderers.DropdownRenderer.apply(this, arguments);
                                 td.style.cursor = 'pointer';
                                 return td;
                             }
                         }
                    ],
                width: '100%',
                height: 600, // 높이를 600px로 증가
                minSpareRows: 1,
                stretchH: 'last', // 마지막 컬럼을 늘려서 가로 스크롤 방지
                autoWrapRow: true,
                afterChange: function(changes, source) {
                    if (source === 'edit' && changes && changes.length > 0) {
                        console.log('🔄 afterChange triggered:', changes);
                        changes.forEach(change => {
                            const [row, prop, oldValue, newValue] = change;
                            console.log(`📝 Change: Row ${row}, Prop ${prop}, Old: "${oldValue}", New: "${newValue}"`);
                            
                            // Pager No 컬럼 (인덱스 2)에 값이 입력되면
                            if (prop === 2 && newValue && newValue.trim() !== '') {
                                console.log(`📱 Pager No entered: "${newValue}" in row ${row}`);
                                // 현재 Status 확인
                                const currentStatus = hot.getDataAtRowProp(row, 7);
                                console.log(`📊 Current status in row ${row}: "${currentStatus}"`);
                                
                                if (currentStatus === 'Scheduled') {
                                    console.log(`🔄 Changing status from 'Scheduled' to 'On Site' in row ${row}`);
                                    hot.setDataAtRowProp(row, 7, 'On Site');
                                    console.log(`✅ Status changed successfully in row ${row}`);
                                }
                            }
                            
                            // Status 컬럼 (인덱스 7)이 Shipped로 변경되면
                            if (prop === 7 && newValue === 'Shipped') {
                                console.log(`🚚 Status changed to 'Shipped' in row ${row}`);
                                // Pager No를 공란으로 변경
                                const currentPagerNo = hot.getDataAtRowProp(row, 2);
                                if (currentPagerNo && currentPagerNo.trim() !== '') {
                                    console.log(`🗑️ Clearing Pager No "${currentPagerNo}" in row ${row}`);
                                    hot.setDataAtRowProp(row, 2, '');
                                    console.log(`✅ Pager No cleared successfully in row ${row}`);
                                }
                            }
                        });
                    }
                },
                licenseKey: 'non-commercial-and-evaluation',
                                 afterChange: function(changes, source) {
                         if (source === 'loadData') return;
                         
                         hasUnsavedChanges = true;
                         updateSaveButton();
                         
                         // ETD 시간이 변경되면 해당 행의 다른 컬럼들을 활성화
                         if (changes && changes.length > 0) {
                             changes.forEach(([row, prop, oldValue, newValue]) => {
                                 if (prop === '0' && newValue && newValue.trim() !== '') {
                                     // ETD 시간이 입력되면 해당 행의 destination과 status를 활성화
                                     console.log(`⏰ ETD 시간 입력됨: 행 ${row}, 시간: ${newValue}`);
                                     // 테이블 새로고침으로 컬럼 상태 업데이트
                                     setTimeout(() => {
                                         if (hot) {
                                             hot.render();
                                         }
                                     }, 100);
                                 }
                                 
                                 // STATUS 변경 시 해당 행 전체 색상 변경 및 실시간 상태 업데이트
                                 if (prop === '7' && newValue && newValue.trim() !== '') {
                                     console.log(`🎨 Status 변경됨: 행 ${row}, 상태: ${newValue}`);
                                     updateRowColor(row, newValue);
                                     
                                     // 실시간 상태 표시 업데이트
                                     updateLiveStatusDisplay(row, newValue);
                                 }
                             });
                         }
                         
                         // 자동 저장 기능 (5초 후) - 설정에 따라 활성화/비활성화
                         // if (autoSaveEnabled && hasUnsavedChanges) {
                         //     if (window.autoSaveTimer) {
                         //         clearTimeout(window.autoSaveTimer);
                         //     }
                         
                         //     window.autoSaveTimer = setTimeout(() => {
                         //         if (hasUnsavedChanges) {
                         if (hasUnsavedChanges) {
                             if (window.autoSaveTimer) {
                                 clearTimeout(window.autoSaveTimer);
                             }
                             
                             window.autoSaveTimer = setTimeout(() => {
                                 if (hasUnsavedChanges) {
                                     console.log('🔄 Auto-saving changes...');
                                     saveAllChanges();
                                 }
                             }, 5000); // 5초 후 자동 저장
                         }
                     }
                });
                
                                 console.log('✅ Handsontable initialized successfully');
                 console.log('🔍 Table data length:', tableData.length);
                 console.log('🔍 Hot instance created:', !!hot);
                 console.log('🔍 Empty rows added:', currentData.length === 0 ? 6 : 1);
                 
                 // 전역 변수 상태 확인
                 console.log('🔍 Global currentData length:', currentData.length);
                 console.log('🔍 Global originalData length:', originalData.length);
                 
                                                     // 초기 데이터에 대한 행 색상 적용 및 실시간 상태 업데이트
                  setTimeout(() => {
                      if (hot) {
                          tableData.forEach((row, index) => {
                              if (row[7] && row[7].trim() !== '') { // STATUS 컬럼
                                  updateRowColor(index, row[7]);
                                  
                                  // 기존 데이터에 대한 실시간 상태도 업데이트
                                  if (row[0] && row[0].trim() !== '') { // ETD 시간이 있는 경우만
                                      console.log(`📡 Initializing live status for row ${index + 1}: ${row[7]}`);
                                      updateLiveStatusDisplay(index, row[7]);
                                  }
                              }
                          });
                          
                                                     // 드롭다운 스타일 강제 적용
                           forceDropdownStyling();
                           
                           // 드롭다운 표시 시 자동 스타일 적용
                           if (hot) {
                               hot.updateSettings({
                                   afterDropdownMenuShow: function() {
                                       setTimeout(forceDropdownStyling, 50);
                                   }
                               });
                               
                               // 추가 이벤트 리스너들
                               document.addEventListener('click', function(e) {
                                   if (e.target.closest('.htDropdownMenu') || e.target.closest('[class*="htDropdownMenu"]')) {
                                       setTimeout(forceDropdownStyling, 10);
                                   }
                               });
                               
                               // DOM 변경 감지하여 드롭다운 스타일 자동 적용
                               const observer = new MutationObserver(function(mutations) {
                                   mutations.forEach(function(mutation) {
                                       if (mutation.type === 'childList') {
                                           mutation.addedNodes.forEach(function(node) {
                                               if (node.nodeType === 1 && (node.classList.contains('htDropdownMenu') || node.className.includes('htDropdownMenu'))) {
                                                   setTimeout(forceDropdownStyling, 10);
                                               }
                                           });
                                       }
                                   });
                               });
                               
                               observer.observe(document.body, {
                                   childList: true,
                                   subtree: true
                               });
                               
                               console.log('✅ 드롭다운 이벤트 리스너 설정 완료');
                           }
                      }
                  }, 200);
                
            } catch (error) {
                console.error('❌ Error creating table:', error);
                showError('테이블 생성 실패: ' + error.message);
            }
        }
        
                 // 마지막 행 삭제
         function deleteLastRow() {
             if (!hot) {
                 console.warn('⚠️ 테이블이 로드되지 않았습니다.');
                 return;
             }
             
             const currentTableData = hot.getData();
             if (currentTableData.length <= 1) {
                 console.warn('⚠️ 최소 1행은 유지해야 합니다.');
                 return;
             }
             
             console.log('🗑️ Deleting last row...');
             
             // 마지막 행 제거
             currentTableData.pop();
             hot.loadData(currentTableData);
             
             // 전역 상태 업데이트
             currentData = currentTableData;
             hasUnsavedChanges = true;
             updateSaveButton();
             
             console.log('✅ Last row deleted successfully');
         }
         
                 // 실시간 상태 표시 업데이트
        function updateLiveStatusDisplay(row, status) {
            if (!hot) return;
            
            try {
                // 현재 행의 데이터 가져오기
                const rowData = hot.getDataAtRow(row);
                const etdTime = rowData[0];
                const destination = rowData[1];
                const pagerNo = rowData[2];
                const deliveryNo = rowData[3];
                const truckId = rowData[4];
                const forzaId = rowData[5];
                const parts = rowData[6];
                
                // 현재 선택된 날짜 가져오기
                const selectedDate = document.getElementById('startDate').value;
                
                // 상태 변경 시간 기록
                const statusChangeTime = new Date().toLocaleTimeString('ko-KR');
                
                // 실시간 상태 정보 객체 생성 (날짜 정보 포함)
                const liveStatus = {
                    row: row + 1, // 사용자 친화적인 행 번호 (1부터 시작)
                    departureDate: selectedDate, // 현재 선택된 날짜
                    etdTime: etdTime,
                    destination: destination,
                    pagerNo: pagerNo,
                    deliveryNo: deliveryNo,
                    truckId: truckId,
                    forzaId: forzaId,
                    parts: parts,
                    status: status,
                    lastUpdated: statusChangeTime,
                    timestamp: Date.now()
                };
                
                // 전역 상태 저장 (다른 페이지에서 접근 가능)
                if (!window.liveTruckStatus) {
                    window.liveTruckStatus = {};
                }
                window.liveTruckStatus[row] = liveStatus;
                
                // 로컬 스토리지에 저장 (페이지 새로고침 후에도 유지)
                localStorage.setItem('liveTruckStatus', JSON.stringify(window.liveTruckStatus));
                
                // 상태 변경 이벤트 발생 (다른 컴포넌트에서 감지 가능)
                const statusChangeEvent = new CustomEvent('truckStatusChanged', {
                    detail: liveStatus
                });
                window.dispatchEvent(statusChangeEvent);
                
                console.log(`📡 Live status updated for row ${row + 1}:`, liveStatus);
                
                // 실시간 상태 표시 영역 업데이트 (있는 경우)
                updateStatusDisplayArea(liveStatus);
                
            } catch (error) {
                console.error('❌ Error updating live status display:', error);
            }
        }
         
         // 행 전체 색상 업데이트
         function updateRowColor(row, status) {
             if (!hot) return;
             
             const rowElement = hot.getCell(row, 0).parentElement;
             if (!rowElement) return;
             
             // 기존 색상 클래스 제거
             rowElement.classList.remove('row-shipped', 'row-scheduled', 'row-onsite');
             
             // 새로운 상태에 따른 색상 클래스 추가
             switch (status) {
                 case 'Shipped':
                     rowElement.classList.add('row-shipped');
                     break;
                 case 'Scheduled':
                     rowElement.classList.add('row-scheduled');
                     break;
                 case 'On Site':
                     rowElement.classList.add('row-onsite');
                     break;
             }
             
                              console.log(`🎨 Row ${row} 색상 업데이트: ${status}`);
         }
         
         // 실시간 상태 새로고침
         function refreshLiveStatus() {
             try {
                 // 로컬 스토리지에서 상태 정보 복원
                 const storedStatus = localStorage.getItem('liveTruckStatus');
                 if (storedStatus) {
                     window.liveTruckStatus = JSON.parse(storedStatus);
                     
                     // 모든 상태 항목을 표시 영역에 다시 그리기
                     const statusDisplayArea = document.getElementById('liveStatusDisplay');
                     if (statusDisplayArea) {
                         statusDisplayArea.innerHTML = '';
                         
                         Object.values(window.liveTruckStatus).forEach(status => {
                             updateStatusDisplayArea(status);
                         });
                         
                         if (Object.keys(window.liveTruckStatus).length === 0) {
                             showNoStatusMessage();
                         }
                     }
                     
                     console.log('🔄 Live status refreshed');
                 } else {
                     showNoStatusMessage();
                 }
             } catch (error) {
                 console.error('❌ Error refreshing live status:', error);
                 showNoStatusMessage();
             }
         }
         
         // 실시간 상태 지우기
         function clearLiveStatus() {
             if (confirm('모든 실시간 상태 정보를 지우시겠습니까?')) {
                 window.liveTruckStatus = {};
                 localStorage.removeItem('liveTruckStatus');
                 
                 const statusDisplayArea = document.getElementById('liveStatusDisplay');
                 if (statusDisplayArea) {
                     showNoStatusMessage();
                 }
                 
                 console.log('🗑️ Live status cleared');
             }
         }
         
         // 기존 실시간 상태 복원
         function restoreLiveStatus() {
             try {
                 // 로컬 스토리지에서 상태 정보 복원
                 const storedStatus = localStorage.getItem('liveTruckStatus');
                 if (storedStatus) {
                     window.liveTruckStatus = JSON.parse(storedStatus);
                     console.log('📡 Live status restored from storage');
                     
                     // 페이지 로드 후 상태 표시 영역에 표시
                     setTimeout(() => {
                         if (Object.keys(window.liveTruckStatus).length > 0) {
                             Object.values(window.liveTruckStatus).forEach(status => {
                                 updateStatusDisplayArea(status);
                             });
                         }
                     }, 500);
                 } else {
                     console.log('📡 No stored live status found');
                 }
             } catch (error) {
                 console.error('❌ Error restoring live status:', error);
             }
         }
         
         // 상태 없음 메시지 표시
         function showNoStatusMessage() {
             const statusDisplayArea = document.getElementById('liveStatusDisplay');
             if (statusDisplayArea) {
                 statusDisplayArea.innerHTML = `
                     <div class="no-status-message">
                         <div style="font-size: 2rem; margin-bottom: 10px;">📡</div>
                         <div>상태 변경 시 실시간으로 표시됩니다</div>
                     </div>
                 `;
             }
         }
         
         // 실시간 상태 표시 영역 업데이트
         function updateStatusDisplayArea(liveStatus) {
             // 실시간 상태 표시 영역이 있는지 확인
             const statusDisplayArea = document.getElementById('liveStatusDisplay');
             if (!statusDisplayArea) return;
             
             try {
                 // 상태별 아이콘과 색상 설정
                 let statusIcon, statusColor, statusText;
                 switch (liveStatus.status) {
                     case 'Shipped':
                         statusIcon = '🚚';
                         statusColor = '#007bff';
                         statusText = '배송 중';
                         break;
                     case 'Scheduled':
                         statusIcon = '⏰';
                         statusColor = '#ffc107';
                         statusText = '예정됨';
                         break;
                     case 'On Site':
                         statusIcon = '📍';
                         statusColor = '#28a745';
                         statusText = '현장 도착';
                         break;
                     default:
                         statusIcon = '❓';
                         statusColor = '#6c757d';
                         statusText = '알 수 없음';
                 }
                 
                 // 실시간 상태 표시 HTML 생성
                 const statusHTML = `
                     <div class="live-status-item" style="border-left: 4px solid ${statusColor};">
                         <div class="status-header">
                             <span class="status-icon">${statusIcon}</span>
                             <span class="status-text" style="color: ${statusColor};">${statusText}</span>
                             <span class="update-time">${liveStatus.lastUpdated}</span>
                         </div>
                         <div class="status-details">
                             <div class="detail-row">
                                 <span class="label">행:</span>
                                 <span class="value">${liveStatus.row}</span>
                                 <span class="label">ETD:</span>
                                 <span class="value">${liveStatus.etdTime || '미설정'}</span>
                             </div>
                             <div class="detail-row">
                                 <span class="label">목적지:</span>
                                 <span class="value">${liveStatus.destination || '미설정'}</span>
                                 <span class="label">Pager:</span>
                                 <span class="value">${liveStatus.pagerNo || '미설정'}</span>
                             </div>
                             <div class="detail-row">
                                 <span class="label">배송번호:</span>
                                 <span class="value">${liveStatus.deliveryNo || '미설정'}</span>
                                 <span class="label">트럭ID:</span>
                                 <span class="value">${liveStatus.truckId || '미설정'}</span>
                             </div>
                         </div>
                     </div>
                 `;
                 
                 // 기존 상태 항목이 있으면 업데이트, 없으면 추가
                 const existingItem = statusDisplayArea.querySelector(`[data-row="${liveStatus.row}"]`);
                 if (existingItem) {
                     existingItem.outerHTML = statusHTML;
                 } else {
                     statusDisplayArea.insertAdjacentHTML('afterbegin', statusHTML);
                 }
                 
                 // 최신 상태를 맨 위로 이동
                 const newItem = statusDisplayArea.querySelector(`[data-row="${liveStatus.row}"]`);
                 if (newItem && statusDisplayArea.firstChild !== newItem) {
                     statusDisplayArea.insertBefore(newItem, statusDisplayArea.firstChild);
                 }
                 
                 console.log(`📺 Status display area updated for row ${liveStatus.row}`);
                 
             } catch (error) {
                 console.error('❌ Error updating status display area:', error);
             }
         }
         
         // 자동 저장 토글 함수 제거 - 더 이상 필요하지 않음
         // function toggleAutoSave() {
         //     // 자동 저장 기능이 제거됨
         // }
         
         // 새 행 추가
         function addNewRow() {
            if (!hot) {
                console.warn('⚠️ 테이블이 로드되지 않았습니다.');
                return;
            }
            
            console.log('➕ Adding new row...');
            
            const currentTableData = hot.getData();
                         const newRow = [
                 '',            // departure_time
                 'VW US',      // destination (기본값)
                 '',            // pager_no
                 '',            // delivery_no
                 '',            // truck_id
                 '',            // forza_id
                 '',            // parts
                 'Scheduled'    // status (기본값)
             ];
            
            currentTableData.push(newRow);
            hot.loadData(currentTableData);
            
            // 전역 상태 업데이트
            currentData = currentTableData;
            hasUnsavedChanges = true;
            updateSaveButton();
            
            console.log('✅ New row added successfully');
        }
        
        // 모든 변경사항 저장
        async function saveAllChanges() {
            try {
                if (!hot) {
                    console.warn('⚠️ 테이블이 로드되지 않았습니다.');
                    return;
                }
                
                const data = hot.getData();
                if (!data || data.length === 0) {
                    console.warn('⚠️ 저장할 데이터가 없습니다.');
                    return;
                }
                
                console.log('💾 Saving all changes...');
                console.log('📊 Raw table data:', data);
                
                // 저장 가능한 데이터만 필터링 (ETD 시간이 있는 행만)
                const validData = data.filter((row, index) => {
                    const hasEtdTime = row[0] && row[0].trim() !== '';
                    console.log(`🔍 Row ${index}: ETD Time = "${row[0]}", Valid = ${hasEtdTime}`);
                    return hasEtdTime; // departure_time이 있는 행만
                });
                
                if (validData.length === 0) {
                    console.warn('⚠️ 저장할 데이터가 없습니다. ETD 시간을 입력해주세요.');
                    return;
                }
                
                console.log(`📊 Valid data found: ${validData.length} rows with ETD time`);
                console.log('📊 Valid rows:', validData);
                
                // 변경된 데이터만 찾기
                const changedData = [];
                const newData = [];
                
                validData.forEach((row, index) => {
                    const selectedDate = document.getElementById('startDate').value;
                    const formattedDate = new Date(selectedDate).toISOString().split('T')[0];
                    
                                             // 8개 컬럼 데이터로 DB 저장 (공란도 빈 문자열로 저장)
                         const truckData = {
                             departure_date: formattedDate, // 날짜는 상단 필터에서 관리하고 형식 통일
                             departure_time: row[0], // ETD 시간 (필수)
                             destination: row[1] || '', // 공란이면 빈 문자열
                             pager_no: row[2] || '', // 공란이면 빈 문자열
                             delivery_no: row[3] || '', // 공란이면 빈 문자열
                             truck_id: row[4] || '', // 공란이면 빈 문자열
                             forza_id: row[5] || '', // 공란이면 빈 문자열
                             parts: row[6] || '', // 공란이면 빈 문자열
                             status: row[7] || 'Scheduled' // 기본값 또는 공란이면 기본값
                         };
                    
                    console.log(`📝 Processing row ${index}:`, truckData);
                    console.log(`📝 Row ${index} details:`, {
                        'ETD Time': `"${row[0]}"`,
                        'Destination': `"${row[1] || '공란'}"`,
                        'Pager No': `"${row[2] || '공란'}"`,
                        'Delivery No': `"${row[3] || '공란'}"`,
                        'Truck ID': `"${row[4] || '공란'}"`,
                        'Forza ID': `"${row[5] || '공란'}"`,
                        'Parts': `"${row[6] || '공란'}"`,
                        'Status': `"${row[7] || '공란'}"`
                    });
                    
                    // 새 데이터인지 기존 데이터 수정인지 확인
                    if (index < originalData.length) {
                        // 기존 데이터 수정
                        const original = originalData[index];
                        if (JSON.stringify(truckData) !== JSON.stringify(original)) {
                            changedData.push({
                                ...truckData,
                                id: original.id
                            });
                            console.log(`📝 Row ${index} marked for UPDATE`);
                        } else {
                            console.log(`📝 Row ${index} unchanged, skipping`);
                        }
                    } else {
                        // 새 데이터
                        newData.push(truckData);
                        console.log(`📝 Row ${index} marked for INSERT`);
                    }
                });
                
                console.log(`📊 Changes detected: ${changedData.length} updates, ${newData.length} new records`);
                
                if (changedData.length > 0) {
                    console.log('📝 Data to UPDATE:', changedData);
                }
                if (newData.length > 0) {
                    console.log('📝 Data to INSERT:', newData);
                }
                
                let successCount = 0;
                
                // 기존 데이터 업데이트
                if (changedData.length > 0) {
                    console.log('🔄 Updating existing records...');
                    for (const truck of changedData) {
                        const { error } = await supabase
                            .from('vwtm_truck_management')
                            .update(truck)
                            .eq('id', truck.id);
                        
                        if (error) {
                            console.error(`❌ Update error for ID ${truck.id}:`, error);
                            throw error;
                        }
                        successCount++;
                        console.log(`✅ Updated record ID ${truck.id}`);
                    }
                }
                
                // 새 데이터 추가
                if (newData.length > 0) {
                    console.log('➕ Inserting new records...');
                    const { error } = await supabase
                        .from('vwtm_truck_management')
                        .insert(newData);
                    
                    if (error) {
                        console.error('❌ Insert error:', error);
                        throw error;
                    }
                    successCount += newData.length;
                    console.log(`✅ Inserted ${newData.length} new records`);
                }
                
                console.log('✅ All changes saved successfully');
                console.log(`✅ 저장 완료! ${successCount}개 항목이 처리되었습니다.`);
                
                // 데이터 새로고침
                await autoFilterByDate();
                hasUnsavedChanges = false;
                updateSaveButton();
                
            } catch (error) {
                console.error('❌ Save error:', error);
                console.warn('⚠️ 저장 실패: ' + error.message);
            }
        }
        
        // 저장 버튼 상태 업데이트
        function updateSaveButton() {
            const saveButton = document.querySelector('button[onclick="saveAllChanges()"]');
            if (saveButton) {
                if (hasUnsavedChanges) {
                    saveButton.textContent = '💾 Save All Changes*';
                    saveButton.className = 'btn btn-warning';
                } else {
                    saveButton.textContent = '💾 Save All Changes';
                    saveButton.className = 'btn btn-success';
                }
            }
        }
        
        // 트럭 삭제
        async function deleteTruck(index) {
            if (!confirm('정말 이 트럭 데이터를 삭제하시겠습니까?')) return;
            
            try {
                const truck = currentData[index];
                const { error } = await supabase
                    .from('vwtm_truck_management')
                    .delete()
                    .eq('id', truck.id);
                
                if (error) throw error;
                
                console.log('✅ Truck deleted successfully');
                console.log('✅ 트럭이 삭제되었습니다!');
                
                await loadTruckData();
                
            } catch (error) {
                console.error('❌ Delete error:', error);
                console.warn('⚠️ 삭제 실패: ' + error.message);
             }
         }

        // 빈 행 삭제
        async function deleteEmptyRow(row) {
            if (!confirm('정말 이 빈 행을 삭제하시겠습니까?')) return;

            try {
                const emptyRow = hot.getDataAtRow(row);
                const { error } = await supabase
                    .from('vwtm_truck_management')
                    .delete()
                    .eq('id', emptyRow.id);
                
                if (error) throw error;

                console.log('✅ Empty row deleted successfully');
                console.log('✅ 빈 행이 삭제되었습니다!');

                await loadTruckData();

            } catch (error) {
                console.error('❌ Delete error:', error);
                console.warn('⚠️ 빈 행 삭제 실패: ' + error.message);
            }
        }
        
                 // 데이터 새로고침
         function refreshData() {
             console.log('🔄 Refreshing data...');
             loadTruckData();
         }
         
         // 현재 날짜 데이터 새로고침
         async function refreshCurrentDateData() {
             console.log('🔄 Refreshing current date data...');
             await autoFilterByDate();
         }
        
        // 로딩 상태 표시
        function showLoading() {
            const container = document.getElementById('truckTableContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-icon">🔄</div>
                    <div>Loading truck data...</div>
                </div>
            `;
        }
        
        // 에러 상태 표시
        function showError(message) {
            const container = document.getElementById('truckTableContainer');
            container.innerHTML = `
                <div class="error">
                    <div class="error-icon">❌</div>
                    <div>${message}</div>
                </div>
            `;
        }
        
        // 데이터 없음 상태 표시
        function showNoData() {
            const container = document.getElementById('truckTableContainer');
            container.innerHTML = `
                <div class="loading">
                    <div style="font-size: 3rem; margin-bottom: 20px;">📭</div>
                    <div>트럭 데이터가 없습니다.</div>
                </div>
            `;
        }
        
        // 1시간 단위 시간 옵션 생성
        function generateTimeOptions() {
            const options = [];
            for (let hour = 0; hour < 24; hour++) {
                const timeString = hour.toString().padStart(2, '0') + ':00';
                options.push(timeString);
            }
            return options;
        }
        
         // 드롭다운 스타일 강제 적용 - 더 강력한 선택자 사용
         function forceDropdownStyling() {
             console.log('🎨 드롭다운 스타일 강제 적용 중...');
             
             // 모든 가능한 드롭다운 메뉴 요소 찾기 (더 포괄적인 선택자)
             const dropdownMenus = document.querySelectorAll('.htDropdownMenu, [class*="htDropdownMenu"], .handsontable .htDropdownMenu');
             
             console.log(`🔍 발견된 드롭다운 메뉴: ${dropdownMenus.length}개`);
             
             dropdownMenus.forEach((menu, index) => {
                 console.log(`🎨 메뉴 ${index + 1} 스타일 적용 중...`);
                 
                 // 기본 스타일 강제 적용 (더 강력한 방식)
                 Object.assign(menu.style, {
                     zIndex: '99999',
                     maxHeight: '600px',
                     minHeight: '300px',
                     overflowY: 'auto',
                     background: 'white',
                     border: '1px solid #ccc',
                     boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                     position: 'absolute',
                     display: 'block'
                 });
                 
                 // 내부 테이블 요소들 스타일 적용
                 const tableElements = menu.querySelectorAll('td');
                 console.log(`🔍 메뉴 ${index + 1}의 테이블 요소: ${tableElements.length}개`);
                 
                 tableElements.forEach((element, tdIndex) => {
                     Object.assign(element.style, {
                         padding: '12px 16px',
                         borderBottom: '1px solid #eee',
                         cursor: 'pointer',
                         whiteSpace: 'nowrap',
                         fontSize: '14px',
                         lineHeight: '1.4',
                         background: 'white',
                         color: '#333',
                         display: 'table-cell'
                     });
                 });
                 
                 // 추가로 CSS 클래스도 강제 적용
                 menu.classList.add('htDropdownMenu');
                 
                 console.log(`✅ 메뉴 ${index + 1} 스타일 적용 완료`);
             });
             
             // 추가로 CSS 스타일을 head에 주입하여 우선순위 높이기
             if (!document.getElementById('force-dropdown-styles')) {
                 const style = document.createElement('style');
                 style.id = 'force-dropdown-styles';
                 style.textContent = `
                     .htDropdownMenu, [class*="htDropdownMenu"], .handsontable .htDropdownMenu {
                         z-index: 99999 !important;
                         max-height: 600px !important;
                         min-height: 300px !important;
                         background: white !important;
                         border: 1px solid #ccc !important;
                         box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
                     }
                     .htDropdownMenu td, [class*="htDropdownMenu"] td, .handsontable .htDropdownMenu td {
                         padding: 12px 16px !important;
                         font-size: 14px !important;
                         line-height: 1.4 !important;
                     }
                 `;
                 document.head.appendChild(style);
                 console.log('✅ 강제 CSS 스타일 주입 완료');
             }
         }
        
                                                                     // 전역 함수 노출
          window.addNewRow = addNewRow;
          window.deleteLastRow = deleteLastRow;
          window.saveAllChanges = saveAllChanges;
          window.autoFilterByDate = autoFilterByDate;
          window.deleteTruck = deleteTruck;
          window.refreshData = refreshData;
          window.refreshCurrentDateData = refreshCurrentDateData;
          window.generateTimeOptions = generateTimeOptions;
          window.forceDropdownStyling = forceDropdownStyling;
        
        console.log('✅ Truck Management System loaded successfully');
    </script>
</body>
</html>
