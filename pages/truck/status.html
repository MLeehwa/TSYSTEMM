<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Truck Status</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
                 body {
             font-family: 'Courier New', monospace;
             background: #000;
             color: #ffffff;
             overflow: hidden;
             height: 100vh;
         }
         
         .container {
             width: 100vw;
             height: 100vh;
             padding: 5px;
             background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
             overflow: hidden;
         }
        
                 .header {
             text-align: center;
             margin-bottom: 15px;
             border-bottom: 4px solid #00ff00;
             padding-bottom: 10px;
             position: relative;
             background: linear-gradient(135deg, rgba(0, 255, 0, 0.1), rgba(0, 0, 0, 0.3));
             border-radius: 15px;
             box-shadow: 0 0 40px rgba(0, 255, 0, 0.2);
         }
         
         
         
         .header-content {
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap;
             gap: 20px;
         }
         
                   .header h1 {
              font-size: 3.5rem;
              font-weight: bold;
              text-shadow: 0 0 30px #00ff00, 0 0 50px #00ff00;
              margin: 0;
              letter-spacing: 5px;
              position: relative;
              z-index: 1;
          }
         
         .last-update-display {
             display: flex;
             flex-direction: column;
             align-items: flex-end;
             gap: 5px;
             position: relative;
             z-index: 1;
         }
         
         .update-label {
             font-size: 1.2rem;
             color: #00ffff;
             font-weight: bold;
             letter-spacing: 2px;
             text-shadow: 0 0 15px #00ffff;
         }
         
         .update-time {
             font-size: 1.5rem;
             font-weight: bold;
             color: #ffffff;
             font-family: 'Digital-7', monospace;
             text-shadow: 0 0 20px #ffffff;
             letter-spacing: 3px;
         }
         
         .header p {
             font-size: 5rem;
             color: #00ffff;
             letter-spacing: 2px;
             position: relative;
             z-index: 1;
             text-shadow: 0 0 20px #00ffff;
         }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #00ff00;
            border-radius: 8px;
        }
        
        .date-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .date-label {
            font-weight: bold;
            font-size: 1.2rem;
            color: #00ffff;
        }
        
        .date-input {
            padding: 10px 15px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            background: #000;
            color: #00ff00;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
        }
        
        .date-input:focus {
            outline: none;
            box-shadow: 0 0 20px #00ff00;
        }
        
        .btn {
            padding: 12px 24px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            background: #000;
            color: #00ff00;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 20px #00ff00;
        }
        
        .status-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #ffffff;
            box-shadow: 0 0 60px rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        
                 .status-table th {
             background: linear-gradient(135deg, #00cc00, #009900);
             color: #000;
             padding: 12px 8px;
             text-align: center;
             font-size: 1.4rem;
             font-weight: bold;
             letter-spacing: 2px;
             border: 2px solid #ffffff;
             text-transform: uppercase;
             position: relative;
             overflow: hidden;
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif;
         }
         
         /* STATUS 컬럼만 넓이 조정 */
         .status-table th:first-child,
         .status-table td:first-child {
             width: 400px !important;
             max-width: 400px !important;
             min-width: 400px !important;
         }
         
         .status-table td {
             padding: 8px 6px;
             text-align: center;
             font-size: 5rem !important;
             border: 2px solid #ffffff;
             vertical-align: middle;
             position: relative;
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
             font-weight: bold !important;
         }
        
        .status-table tr:nth-child(even) {
            background: rgba(0, 255, 0, 0.05);
        }
        
        .status-table tr:hover {
            background: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        .status-row.shipped {
            border-left: 5px solid #00ffff;
            background: rgba(0, 255, 255, 0.05);
        }
        
        .status-row.scheduled {
            border-left: 5px solid #ffff00;
            background: rgba(255, 255, 0, 0.05);
        }
        
        .status-row.onsite {
            border-left: 5px solid #00ff00;
            background: rgba(0, 255, 0, 0.05);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 5rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-family: 'Arial Black', 'Helvetica Bold', sans-serif;
        }
        
        .status-badge.shipped {
            background: #0088cc;
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 136, 204, 0.5);
        }
        
        .status-badge.scheduled {
            background: #cc8800;
            color: #fff;
            box-shadow: 0 0 15px rgba(204, 136, 0, 0.5);
        }
        
        .status-badge.onsite {
            background: #008800;
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 136, 0, 0.5);
        }
        
        .no-status {
            text-align: center;
            padding: 100px 20px;
            font-size: 2rem;
            color: #666;
        }
        
        .auto-refresh {
            background: #00ff00;
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .auto-refresh.off {
            background: #666;
            color: #fff;
        }
        
        
        
        .scrolling-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
                 .time-display {
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
             font-size: 5rem !important;
             color: #00ccff;
             text-shadow: 0 0 15px rgba(0, 204, 255, 0.3);
             font-weight: bold !important;
             letter-spacing: 2px;
         }
         
         /* 트럭 번호 강조 스타일 - 더 구체적인 선택자 사용 */
         .status-table td:nth-child(5) .truck-id-highlight,
         .status-table td:nth-child(2) .truck-id-highlight,
         .status-table td:nth-child(5),
         .status-table td:nth-child(2) {
             font-size: 5rem !important;
             font-weight: bold !important;
             color: #fff !important;
             text-shadow: 0 0 20px rgba(204, 204, 0, 0.3) !important;
             letter-spacing: 3px !important;
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
         }
         
         /* 기존 truck-id-highlight 클래스도 유지 */
         .truck-id-highlight {
             font-size: 5rem !important;
             font-weight: bold !important;
             color: #fff;
             text-shadow: 0 0 20px rgba(204, 204, 0, 0.3);
             letter-spacing: 3px;
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
         }
         
         /* ETA TIME 강조 스타일 */
         .eta-time-highlight {
             font-size: 5rem !important;
             font-weight: bold !important;
             color: #00cc00;
             text-shadow: 0 0 25px rgba(0, 204, 0, 0.3);
             letter-spacing: 2px;
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
         }
         
                   /* 더 세련된 테이블 스타일 */
          .status-table {
              width: 100%;
              border-collapse: collapse;
              background: rgba(0, 0, 0, 0.9);
              border: 3px solid #ffffff;
              box-shadow: 0 0 60px rgba(255, 255, 255, 0.3);
              backdrop-filter: blur(10px);
          }
         
                   .status-table th {
              background: linear-gradient(135deg, #00ff00, #00cc00);
              color: #000;
              padding: 20px 15px;
              text-align: center;
              font-size: 1.8rem;
              font-weight: bold;
              letter-spacing: 3px;
              border: 2px solid #ffffff;
              text-transform: uppercase;
              position: relative;
              overflow: hidden;
              font-family: 'Arial Black', 'Helvetica Bold', sans-serif;
          }
         
         
         
                   .status-table td {
              padding: 18px 12px;
              text-align: center;
              font-size: 1.6rem;
              border: 2px solid #ffffff;
              vertical-align: middle;
              position: relative;
              font-family: 'Arial Black', 'Helvetica Bold', sans-serif;
              font-weight: bold;
          }
         
         /* 상태별 행 스타일 개선 */
         .status-row.shipped {
             border-left: 8px solid #0088cc;
             background: linear-gradient(90deg, rgba(0, 136, 204, 0.1), rgba(0, 136, 204, 0.05));
             box-shadow: inset 0 0 20px rgba(0, 136, 204, 0.1);
             text-decoration: line-through;
             text-decoration-color: #0088cc;
             text-decoration-thickness: 3px;
             text-decoration-style: solid;
         }
         
         .status-row.shipped td {
             text-decoration: line-through !important;
             text-decoration-color: #0088cc !important;
             text-decoration-thickness: 3px !important;
             text-decoration-style: solid !important;
             opacity: 0.7;
         }
         
         .status-row.shipped .status-badge {
             text-decoration: none !important;
             opacity: 1;
         }
         
         .status-row.scheduled {
             border-left: 8px solid #cc8800;
             background: linear-gradient(90deg, rgba(204, 136, 0, 0.1), rgba(204, 136, 0, 0.05));
             box-shadow: inset 0 0 20px rgba(204, 136, 0, 0.1);
         }
         
         .status-row.onsite {
             border-left: 8px solid #008800;
             background: linear-gradient(90deg, rgba(0, 136, 0, 0.1), rgba(0, 136, 0, 0.05));
             box-shadow: inset 0 0 20px rgba(0, 136, 0, 0.1);
         }
         
         /* 상태 배지 개선 */
         .status-badge {
             padding: 12px 20px;
             border-radius: 25px;
             font-weight: bold;
             font-size: 2.5rem !important;
             letter-spacing: 2px;
             text-transform: uppercase;
             position: relative;
             overflow: hidden;
             box-shadow: 0 4px 15px rgba(0,0,0,0.3);
             font-family: 'Arial Black', 'Helvetica Bold', sans-serif !important;
         }
         
         
    </style>
</head>
<body>
    <div class="container">
                 <!-- 헤더 -->
         <div class="header">
             <div class="header-content">
                 <h1>🚛 LIVE TRUCK STATUS BOARD</h1>
                 <div class="last-update-display">
                     <span class="update-label">LAST UPDATE:</span>
                     <span class="update-time" id="headerLastUpdate">--:--:--</span>
                 </div>
             </div>
         </div>
        
        <!-- 컨트롤 -->
        <div class="controls">
            <div class="date-controls">
                <label for="statusDate" class="date-label">📅 DATE:</label>
                <input type="date" id="statusDate" onchange="filterStatusByDate()" class="date-input">
                <button class="btn" onclick="loadDataFromSupabase()">🔄 REFRESH</button>
                <button class="btn" onclick="clearAllStatus()">🗑️ CLEAR</button>
                <button class="btn" onclick="toggleAutoRefresh()" id="autoRefreshBtn">🔄 AUTO: ON</button>
                <button class="btn" onclick="toggleFullscreenMode()" id="fullscreenBtn">🖥️ FULLSCREEN</button>
            </div>
            <div>
                <span class="auto-refresh" id="autoRefreshIndicator">🔄 ACTIVE</span>
            </div>
        </div>
        
        
        <!-- 실시간 상태 테이블 -->
        <div id="statusContainer">
            <table class="status-table">
                                 <thead>
                     <tr>
                         <th>STATUS</th>
                         <th>TIME</th>
                         <th>DEST</th>
                         <th>DELIVERY NO</th>
                         <th>TRUCK #</th>
                         <th>FORZA ID</th>
                         <th>PARTS</th>
                         <th>PAGER NO</th>
                     </tr>
                 </thead>
                                 <tbody id="statusTableBody">
                     <tr>
                         <td colspan="8" class="no-status">NO STATUS INFORMATION AVAILABLE</td>
                     </tr>
                 </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
        
                 // 전역 변수
         let supabase = null;
         let autoRefreshEnabled = true;
         let autoRefreshInterval = null;
         let lastUpdateTime = null;
         let dateCheckInterval = null; // 날짜 자동 변경 체크용
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Live Truck Status Board loaded');
            initializeStatusPage();
            
            // Fullscreen 모드 상태 감지 및 버튼 텍스트 업데이트
            updateFullscreenButtonText();
            
            // Fullscreen 모드 변경 감지
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        updateFullscreenButtonText();
                    }
                });
            });
            
            observer.observe(document.body, {
                attributes: true,
                attributeFilter: ['class']
            });
        });
        
        // 날짜별 상태 필터링
        function filterStatusByDate() {
            const selectedDate = document.getElementById('statusDate').value;
            if (!selectedDate) {
                console.log('📅 No date selected');
                return;
            }
            
            console.log('🔍 Filtering status by date:', selectedDate);
            loadDataFromSupabase();
        }
        
        // 모든 상태 표시 (현재 날짜)
        function showAllStatus() {
            loadDataFromSupabase();
        }
        
        // Fullscreen 버튼 텍스트 업데이트
        function updateFullscreenButtonText() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) {
                const isFullscreen = document.body.classList.contains('fullscreen-mode');
                if (isFullscreen) {
                    fullscreenBtn.innerHTML = '📱 EXIT FULLSCREEN';
                    fullscreenBtn.title = '전체 화면 모드 종료 - 사이드바 표시';
                } else {
                    fullscreenBtn.innerHTML = '🖥️ FULLSCREEN';
                    fullscreenBtn.title = '전체 화면 모드 시작 - 사이드바 숨김';
                }
            }
        }
        
        // Supabase 초기화
        function initializeSupabase() {
            try {
                console.log('🔧 Initializing Supabase...');
                
                // Supabase 라이브러리가 로드될 때까지 대기
                if (typeof window.supabase === 'undefined') {
                    console.log('⏳ Waiting for Supabase library to load...');
                    setTimeout(initializeSupabase, 500);
                    return;
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase client created:', supabase);
                
                // 연결 테스트
                testSupabaseConnection();
                
            } catch (error) {
                console.error('❌ Supabase initialization failed:', error);
                setTimeout(initializeSupabase, 1000);
            }
        }
        
        // Supabase 연결 테스트
        async function testSupabaseConnection() {
            try {
                console.log('🔍 Testing Supabase connection...');
                
                // 먼저 vwtm_truck_management 테이블 테스트
                let { data, error } = await supabase
                    .from('vwtm_truck_management')
                    .select('count', { count: 'exact', head: true })
                    .limit(1);
                    
                if (error && (error.message.includes('relation') || error.message.includes('does not exist'))) {
                    console.log('🔍 Table vwtm_truck_management not found, trying vwtm_list_data...');
                    
                    const { data: altData, error: altError } = await supabase
                        .from('vwtm_list_data')
                        .select('count', { count: 'exact', head: true })
                        .limit(1);
                    
                    if (altError) {
                        console.log('❌ Both tables failed, trying to load any available data...');
                        loadDataFromSupabase();
                        return;
                    }
                    
                    console.log('✅ Alternative table connection successful');
                } else {
                    console.log('✅ Supabase connection successful');
                }
                
                // 연결 성공 후 데이터 로드
                loadDataFromSupabase();
                
            } catch (error) {
                console.error('❌ Supabase connection test failed:', error);
                setTimeout(() => {
                    loadDataFromSupabase();
                }, 2000);
            }
        }
        
                 // 상태 페이지 초기화
         function initializeStatusPage() {
             console.log('🔧 Initializing status page...');
             
             // 기본 날짜 설정 (오늘 날짜)
             setDefaultDate();
             
             // 헤더의 LAST UPDATE 시간 초기화
             updateHeaderLastUpdate();
             
             // 자동 새로고침 시작
             startAutoRefresh();
             
             // 페이지 가시성 변경 감지 (탭 전환 시)
             document.addEventListener('visibilitychange', handleVisibilityChange);
             
             // Supabase 초기화 (날짜 설정 후)
             setTimeout(() => {
                 initializeSupabase();
             }, 1000);
             
             console.log('✅ Status page initialized successfully');
         }
        
        // 기본 날짜 설정
        function setDefaultDate() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            
            // 날짜 입력 필드에 오늘 날짜 설정
            const dateInput = document.getElementById('statusDate');
            if (dateInput) {
                dateInput.value = todayString;
                console.log('📅 Default date set to:', todayString);
                
                // 날짜 설정 후 즉시 데이터 로드 시도
                setTimeout(() => {
                    if (supabase) {
                        loadDataFromSupabase();
                    }
                }, 500);
            } else {
                console.log('⏳ Date input not found, retrying...');
                setTimeout(setDefaultDate, 200);
            }
        }
        
        // 상태 변경 이벤트 처리
        function handleStatusChange(event) {
            console.log('📡 Status change event received:', event.detail);
        }
        
        // 상태 표시 업데이트 (테이블 형태)
        function updateStatusDisplay(statusData) {
            const tbody = document.getElementById('statusTableBody');
            
            // 상태별 CSS 클래스 결정
            let statusClass = '';
            let statusText = '';
            
            switch (statusData.status) {
                case 'Shipped':
                    statusClass = 'shipped';
                    statusText = 'SHIPPED';
                    break;
                case 'Scheduled':
                    statusClass = 'scheduled';
                    statusText = 'SCHEDULED';
                    break;
                case 'On Site':
                    statusClass = 'onsite';
                    statusText = 'ON SITE';
                    break;
                default:
                    statusClass = '';
                    statusText = 'UNKNOWN';
            }
            
                         // 상태 행 HTML 생성
             const statusRowHTML = `
                 <tr class="status-row ${statusClass}" data-row="${statusData.row}">
                     <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                     <td class="eta-time-highlight">${statusData.etdTime || ''}</td>
                     <td>${statusData.destination || ''}</td>
                     <td>${statusData.deliveryNo || ''}</td>
                     <td class="truck-id-highlight">${statusData.truckId || ''}</td>
                     <td class="truck-id-highlight">${statusData.forzaId || ''}</td>
                     <td class="scrolling-text">${statusData.parts || ''}</td>
                     <td>${statusData.pagerNo || ''}</td>
                 </tr>
             `;
            
            // 기존 상태 행이 있으면 업데이트, 없으면 추가
            const existingRow = tbody.querySelector(`[data-row="${statusData.row}"]`);
            if (existingRow) {
                existingRow.outerHTML = statusRowHTML;
            } else {
                tbody.insertAdjacentHTML('beforeend', statusRowHTML);
            }
            
            // "상태 없음" 메시지 숨기기
            const noStatusMessage = tbody.querySelector('.no-status');
            if (noStatusMessage) {
                noStatusMessage.style.display = 'none';
            }
            
            console.log(`✅ Status row updated for row ${statusData.row}`);
        }
        
                 // 헤더의 LAST UPDATE 시간 업데이트
         function updateHeaderLastUpdate() {
             const now = new Date();
             const timeString = now.toLocaleTimeString('en-US', { 
                 hour12: false,
                 hour: '2-digit',
                 minute: '2-digit',
                 second: '2-digit'
             });
             
             const updateTimeElement = document.getElementById('headerLastUpdate');
             if (updateTimeElement) {
                 updateTimeElement.textContent = timeString;
                 console.log('🕐 Header last update time updated:', timeString);
             }
         }
         
        // 상태 새로고침
        function refreshStatus() {
            console.log('🔄 Refreshing status from Supabase...');
            loadDataFromSupabase();
        }
        
        // Supabase에서 데이터 로드
        async function loadDataFromSupabase() {
            try {
                if (!supabase) {
                    console.log('⏳ Supabase not ready yet, retrying...');
                    setTimeout(loadDataFromSupabase, 1000);
                    return;
                }
                
                const selectedDate = document.getElementById('statusDate').value;
                if (!selectedDate) {
                    console.log('📅 No date selected, setting default date...');
                    setDefaultDate();
                    return;
                }
                
                console.log('🚛 Loading data from Supabase for date:', selectedDate);
                
                // 먼저 vwtm_truck_management 테이블 시도
                let { data, error } = await supabase
                    .from('vwtm_truck_management')
                    .select('*')
                    .eq('departure_date', selectedDate)
                    .order('departure_time', { ascending: true })
                    .limit(1000);
                
                // 테이블이 존재하지 않는 경우 vwtm_list_data 시도
                if (error && (error.message.includes('relation') || error.message.includes('does not exist'))) {
                    console.log('🔍 Table vwtm_truck_management not found, trying vwtm_list_data...');
                    
                    try {
                        const result = await supabase
                            .from('vwtm_list_data')
                            .select('*')
                            .limit(1000);
                        
                        if (result.error) {
                            console.log('❌ vwtm_list_data also failed:', result.error);
                            displayDataFromSupabase([]);
                            return;
                        }
                        
                        // 날짜 필터링을 클라이언트에서 수행
                        data = result.data.filter(item => {
                            const itemDate = item.departure_date || item.prod_date || item.date;
                            return itemDate === selectedDate;
                        });
                        
                        // vwtm_list_data의 컬럼을 truck_management 형식으로 변환
                        data = data.map(item => ({
                            departure_date: item.departure_date || item.prod_date || item.date,
                            departure_time: item.departure_time || item.time || '00:00',
                            destination: item.destination || item.location || 'VW US',
                            delivery_no: item.delivery_no || item.delivery || '',
                            truck_id: item.truck_id || item.truck || '',
                            forza_id: item.forza_id || item.forza || '',
                            parts: item.parts || item.part_no || '',
                            pager_no: item.pager_no || '',
                            status: item.status || 'Scheduled'
                        }));
                        
                        error = null;
                        
                    } catch (tableError) {
                        console.log('❌ Error accessing vwtm_list_data:', tableError);
                        displayDataFromSupabase([]);
                        return;
                    }
                }
                
                if (error) {
                    console.log('❌ Error with vwtm_truck_management:', error);
                    displayDataFromSupabase([]);
                    return;
                }
                
                console.log('✅ Data loaded from Supabase:', data?.length || 0, 'records');
                
                                 // 데이터를 상태 행으로 변환하여 표시
                 displayDataFromSupabase(data || []);
                 
                 // 헤더의 LAST UPDATE 시간 업데이트
                 updateHeaderLastUpdate();
                 
                 // 마지막 업데이트 시간 기록
                 lastUpdateTime = new Date();
                
            } catch (error) {
                console.error('❌ Error loading data from Supabase:', error);
                displayDataFromSupabase([]);
            }
        }
        
        // Supabase 데이터를 상태 테이블로 표시
        function displayDataFromSupabase(data) {
            const tbody = document.getElementById('statusTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-status">NO DATA AVAILABLE FOR SELECTED DATE</td>
                    </tr>
                `;
                return;
            }
            
            // 데이터를 상태별로 정렬 (SHIPPED는 맨 밑으로)
            const sortedData = data.sort((a, b) => {
                const statusOrder = { 'Scheduled': 1, 'On Site': 2, 'Shipped': 3 };
                const aOrder = statusOrder[a.status] || 4;
                const bOrder = statusOrder[b.status] || 4;
                
                // SHIPPED는 무조건 맨 밑으로
                if (aOrder === 3 && bOrder !== 3) return 1;
                if (bOrder === 3 && aOrder !== 3) return -1;
                
                // SCHEDULED와 ON SITE는 시간순으로 정렬
                if (aOrder !== 3 && bOrder !== 3) {
                    return (a.departure_time || '').localeCompare(b.departure_time || '');
                }
                
                // SHIPPED끼리는 시간순으로 정렬
                if (aOrder === 3 && bOrder === 3) {
                    return (a.departure_time || '').localeCompare(b.departure_time || '');
                }
                
                return aOrder - bOrder;
            });
            
            // 기존 상태 행 제거
            tbody.innerHTML = '';
            
            // 정렬된 데이터를 상태 행으로 변환
            sortedData.forEach((item, index) => {
                const statusData = {
                    row: index + 1,
                    departureDate: item.departure_date,
                    etdTime: item.departure_time,
                    destination: item.destination,
                    deliveryNo: item.delivery_no,
                    truckId: item.truck_id,
                    forzaId: item.forza_id,
                    parts: item.parts,
                    pagerNo: item.pager_no,
                    status: item.status,
                    lastUpdated: new Date().toLocaleTimeString('en-US')
                };
                
                updateStatusDisplay(statusData);
            });
        }
        
        // 모든 상태 지우기 (현재 날짜 데이터만 새로고침)
        function clearAllStatus() {
            if (confirm('Do you want to refresh the currently displayed status?')) {
                console.log('🔄 Refreshing current status...');
                loadDataFromSupabase();
                console.log('✅ Status refreshed');
            }
        }
        
        // 자동 새로고침 토글
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const button = document.getElementById('autoRefreshBtn');
            const indicator = document.getElementById('autoRefreshIndicator');
            
            if (autoRefreshEnabled) {
                button.textContent = '🔄 AUTO: ON';
                button.className = 'btn';
                indicator.textContent = '🔄 ACTIVE';
                indicator.className = 'auto-refresh';
                startAutoRefresh();
                console.log('✅ Auto-refresh enabled');
            } else {
                button.textContent = '⏸️ AUTO: OFF';
                button.className = 'btn';
                indicator.textContent = '⏸️ INACTIVE';
                indicator.className = 'auto-refresh off';
                stopAutoRefresh();
                console.log('⏸️ Auto-refresh disabled');
            }
        }
        
                 // 자동 새로고침 시작
         function startAutoRefresh() {
             if (autoRefreshInterval) {
                 clearInterval(autoRefreshInterval);
             }
             
             autoRefreshInterval = setInterval(() => {
                 if (autoRefreshEnabled) {
                     console.log('🔄 Auto-refreshing status from Supabase...');
                     loadDataFromSupabase();
                 }
             }, 15000); // 15초마다 새로고침 (더 실시간성)
             
             console.log('🚀 Auto-refresh started (15s interval)');
         }
        
        // 자동 새로고침 중지
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('⏹️ Auto-refresh stopped');
            }
        }
        
        // 페이지 가시성 변경 처리
        function handleVisibilityChange() {
            if (document.hidden) {
                console.log('📱 Page hidden, pausing auto-refresh');
                stopAutoRefresh();
            } else {
                console.log('📱 Page visible, resuming auto-refresh');
                if (autoRefreshEnabled) {
                    startAutoRefresh();
                }
            }
        }
        
        // 에러 표시
        function showError(message) {
            const tbody = document.getElementById('statusTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="no-status">ERROR OCCURRED: ${message}</td>
                </tr>
            `;
        }
        
        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', function() {
            console.log('🧹 Cleaning up status page...');
            stopAutoRefresh();
        });
        
        // 전역 함수 노출
        window.initializeStatusPage = initializeStatusPage;
        window.setDefaultDate = setDefaultDate;
        window.refreshStatus = refreshStatus;
        window.clearAllStatus = clearAllStatus;
        window.toggleAutoRefresh = toggleAutoRefresh;
        window.filterStatusByDate = filterStatusByDate;
        window.showAllStatus = showAllStatus;
        window.loadDataFromSupabase = loadDataFromSupabase;
        
        console.log('✅ Live Truck Status Board System loaded successfully');
    </script>
</body>
</html>
