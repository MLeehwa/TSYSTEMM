<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒŒíŠ¸ë³„ í¬ì¥ ìƒíƒœ ë¶„ì„ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <h1 class="text-3xl font-bold text-gray-900">íŒŒíŠ¸ë³„ í¬ì¥ ìƒíƒœ ë¶„ì„ ì‹œìŠ¤í…œ</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="analysis-new.html" class="text-gray-500 hover:text-gray-700">FIFO ë¶„ì„</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Packaging Status Information -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="text-sm font-medium text-blue-900 mb-2">ğŸ“¦ í¬ì¥ ìƒíƒœ ë¶„ë¥˜ ê¸°ì¤€</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-orange-700">í¬ì¥ ì „ (ë¯¸í¬ì¥):</span>
                        <span class="text-orange-600">LHSAA, LHSAB, LHSBA, LHSBB</span>
                    </div>
                    <div>
                        <span class="font-medium text-green-700">í¬ì¥ í›„ (ì™„ë£Œ):</span>
                        <span class="text-green-600">LHSAC, LHSAD, LHSBC, LHSBD</span>
                    </div>
                </div>
                <p class="text-xs text-gray-600 mt-2">â€¢ ê° íŒŒíŠ¸ë³„ë¡œ í¬ì¥ ì „/í›„ ì•„ì´í…œ ê°œìˆ˜ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤</p>
            </div>

            <!-- Filter Section -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">í•„í„° ì¡°ê±´</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="locationFilter" class="block text-sm font-medium text-gray-700 mb-2">RACK NO</label>
                        <select id="locationFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All RACK NO</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <h4 class="text-sm font-medium text-gray-900 mb-2">ê³ ì • í•„í„° ì¡°ê±´</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>â€¢ RACK NO: LHSAA, LHSAB, LHSBA, LHSBB, LHSAC, LHSAD, LHSBC, LHSBDë§Œ ë¶„ì„</li>
                        <li>â€¢ Hold Whether: N (ê³ ì •)</li>
                        <li>â€¢ Part No: ëª¨ë“  Part Noë³„ í¬ì¥ ìƒíƒœ ë¶„ì„</li>
                        <li>â€¢ í¬ì¥ í›„: Hold=Nì´ê³  ê°™ì€ PALLET NOì— TM 8ê°œ ì´ìƒì¸ ê²ƒë§Œ ì§‘ê³„ (8ê°œ ë¯¸ë§Œì€ ì¬í¬ì¥ í•„ìš”ë¡œ í¬ì¥ ì „ ë¶„ë¥˜)</li>
                    </ul>
                </div>
                
                <div class="mt-4">
                    <button id="refreshDataBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    </button>
                    <p class="text-xs text-gray-500 mt-2" id="filterStatus">í•„í„°ë¥¼ ì ìš©í•´ì£¼ì„¸ìš”</p>
                </div>
                
                <!-- ì˜¤ëŠ˜ ì¶œí•˜ ìˆ˜ëŸ‰ ì…ë ¥ ì„¹ì…˜ -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="text-sm font-medium text-gray-900 mb-3">ì˜¤ëŠ˜ ì¶œí•˜ ìˆ˜ëŸ‰ ì…ë ¥ (íŠ¸ëŸ­ ìˆ˜ëŸ‰ë³„)</h4>
                    <div class="mb-4">
                        <button id="addShipmentRowBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            íŠ¸ëŸ­ ì¶”ê°€
                        </button>
                        <button id="calculateShortageBtn" class="ml-2 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                            ë¶€ì¡± ìˆ˜ëŸ‰ ê³„ì‚°
                        </button>
                    </div>
                    
                    <!-- íŠ¸ëŸ­ë³„ ì¶œí•˜ ìˆ˜ëŸ‰ ì…ë ¥ í…Œì´ë¸” -->
                    <div id="shipmentInputTable" class="overflow-x-auto mb-4">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Part No</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">íŠ¸ëŸ­ ìˆ˜ëŸ‰</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì°¨ëŸ‰ë‹¹ ìˆ˜ëŸ‰</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì´ ì¶œí•˜ ìˆ˜ëŸ‰</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="shipmentInputBody" class="bg-white divide-y divide-gray-200">
                                <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë  í–‰ë“¤ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="shortageResult" class="mt-4 hidden">
                        <h5 class="text-sm font-medium text-gray-900 mb-2">ë¶€ì¡± ìˆ˜ëŸ‰ ë¶„ì„ ê²°ê³¼</h5>
                        <div id="shortageTable" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Before Packaging -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div id="summaryBefore" class="flex items-center">
                            <div class="text-2xl font-bold text-orange-600">0</div>
                            <div class="ml-3">
                                <div class="text-sm text-gray-500">í¬ì¥ ì „</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- After Packaging -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div id="summaryAfter" class="flex items-center">
                            <div class="text-2xl font-bold text-green-600">0</div>
                            <div class="ml-3">
                                <div class="text-sm text-gray-500">í¬ì¥ í›„</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div id="summaryTotal" class="flex items-center">
                            <div class="text-2xl font-bold text-blue-600">0</div>
                            <div class="ml-3">
                                <div class="text-sm text-gray-500">í•©ê³„</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900">í¬ì¥ ì „í›„ ë¶„ì„ ê²°ê³¼</h3>
                        <div class="flex space-x-3">
                            <span id="resultCount" class="text-sm text-gray-500">ê²°ê³¼ ì—†ìŒ</span>
                            <button id="exportExcelBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                                Excel ë‚´ë³´ë‚´ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('partNo')">
                                    Part No <span id="sort-partNo" class="ml-1 text-gray-400">â†•</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('beforePackaging')">
                                    í¬ì¥ ì „ <span id="sort-beforePackaging" class="ml-1 text-gray-400">â†•</span>
                                    <div class="text-xs text-gray-400 font-normal">(ê°œìˆ˜/íŠ¸ëŸ­ëŒ“ìˆ˜)</div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('afterPackaging')">
                                    í¬ì¥ í›„ <span id="sort-afterPackaging" class="ml-1 text-gray-400">â†•</span>
                                    <div class="text-xs text-gray-400 font-normal">(ê°œìˆ˜/íŠ¸ëŸ­ëŒ“ìˆ˜)</div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortPackagingTable('total')">
                                    í•©ê³„ <span id="sort-total" class="ml-1 text-gray-400">â†•</span>
                                    <div class="text-xs text-gray-400 font-normal">(ê°œìˆ˜/íŠ¸ëŸ­ëŒ“ìˆ˜)</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                                    í•„í„°ë¥¼ ì ìš©í•˜ì—¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Supabase config removed - using direct initialization -->
    <script>
        // í¬ì¥ ë¶„ì„ ì‹œìŠ¤í…œ ì§ì ‘ í¬í•¨
        console.log('ğŸ“¦ ===== PACKAGING ANALYSIS SYSTEM LOADING =====');
        
        // ì „ì—­ ë³€ìˆ˜ ì •ì˜
        window.PackagingAnalysis = {
            allData: [],
            filteredData: [],
            currentSortColumn: 'partNo',
            currentSortDirection: 'asc',
            lastAnalysisResults: [],
            initialized: false
        };
        
        // í¬ì¥ ì „í›„ êµ¬ì—­ ì •ì˜
        const PACKAGING_ZONES = {
            BEFORE: ['LHSAA', 'LHSAB', 'LHSBA', 'LHSBB'],
            AFTER: ['LHSAC', 'LHSAD', 'LHSBC', 'LHSBD']
        };
        
        // í¬ì¥ ìƒíƒœ íŒë‹¨ í•¨ìˆ˜
        function determinePackagingStatus(rackNo, location) {
            const rack = rackNo || '';
            const loc = location || '';
            
            if (rack) {
                const beforeByRack = PACKAGING_ZONES.BEFORE.some(prefix => rack.startsWith(prefix));
                const afterByRack = PACKAGING_ZONES.AFTER.some(prefix => rack.startsWith(prefix));
                
                if (beforeByRack) return 'before';
                if (afterByRack) return 'after';
            }
            
            if (loc) {
                const beforeByLoc = PACKAGING_ZONES.BEFORE.some(prefix => loc.startsWith(prefix));
                const afterByLoc = PACKAGING_ZONES.AFTER.some(prefix => loc.startsWith(prefix));
                
                if (beforeByLoc) return 'before';
                if (afterByLoc) return 'after';
            }
            
            return 'unknown';
        }
        
        // í¬ì¥ í›„ TM ê°œìˆ˜ í™•ì¸ í•¨ìˆ˜ (ê°™ì€ PALLET NOì— 8ê°œì”© ë¬¶ì—¬ìˆëŠ”ì§€ í™•ì¸)
        function isPackagingAfterValid(item) {
            // í¬ì¥ í›„ ìƒíƒœì¸ì§€ ë¨¼ì € í™•ì¸
            const packagingStatus = determinePackagingStatus(item.rack_no, item.location);
            if (packagingStatus !== 'after') {
                return false;
            }
            
            // Holdê°€ Nì¸ì§€ í™•ì¸
            if (item.hold_whether !== 'N') {
                console.log(`âš ï¸ Holdê°€ Nì´ ì•„ë‹˜: ${item.part_no} - hold_whether: ${item.hold_whether}`);
                return false;
            }
            
            // PALLET NOê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!item.pallet_no) {
                console.log(`âš ï¸ PALLET NOê°€ ì—†ìŒ: ${item.part_no}`);
                return false;
            }
            
            // ê°™ì€ PALLET NOì— ìˆëŠ” TM ê°œìˆ˜ í™•ì¸
            const samePalletTMs = window.PackagingAnalysis.filteredData.filter(tm => 
                tm.pallet_no === item.pallet_no && 
                tm.hold_whether === 'N' &&
                tm.part_no === item.part_no
            );
            
            const tmCount = samePalletTMs.length;
            
            console.log(`ğŸ” Checking PALLET ${item.pallet_no} for ${item.part_no}: ${tmCount}ê°œ TM (8ê°œ í•„ìš”)`);
            
            // 8ê°œê°€ ìˆëŠ”ì§€ í™•ì¸
            return tmCount >= 8;
        }
        
        // ë©”ì¸ ì´ˆê¸°í™” í•¨ìˆ˜
        function initPackagingAnalysis() {
            try {
                console.log('ğŸš€ ===== INITIALIZING PACKAGING ANALYSIS =====');
                console.log('ğŸš€ Current page:', window.location.pathname);
                
                if (window.PackagingAnalysis.initialized) {
                    console.log('âš ï¸ Already initialized, skipping...');
                    return;
                }
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupPackagingEventListeners();
                
                // Supabase ì´ˆê¸°í™” ëŒ€ê¸° í›„ ë°ì´í„° ë¡œë“œ
                waitForSupabaseAndLoadData();
                
                window.PackagingAnalysis.initialized = true;
                console.log('âœ… Packaging analysis system initialized');
                
            } catch (error) {
                console.error('âŒ Error initializing packaging analysis:', error);
            }
        }
        
        // Supabase ë¡œë”© ëŒ€ê¸° ë° ë°ì´í„° ë¡œë“œ
        function waitForSupabaseAndLoadData() {
            let attempts = 0;
            const maxAttempts = 30; // ë” ë§ì€ ì‹œë„
            
            const checkSupabase = () => {
                attempts++;
                console.log(`ğŸ” Checking Supabase availability (attempt ${attempts}/${maxAttempts})...`);
                console.log('ğŸ” window.supabase:', typeof window.supabase);
                console.log('ğŸ” window.supabase.createClient:', typeof window.supabase?.createClient);
                
                // Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (typeof window.supabase !== 'undefined' && window.supabase && window.supabase.createClient) {
                    console.log('âœ… Supabase library loaded, creating FRESH client...');
                    
                    try {
                        // Supabase í´ë¼ì´ì–¸íŠ¸ ì§ì ‘ ì´ˆê¸°í™”
                        const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
                        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
                        
                        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        window.sb = supabaseClient;
                        window.supabase = supabaseClient;
                        console.log('âœ… FRESH Supabase client created successfully');
                        console.log('âœ… Client methods:', Object.keys(supabaseClient));
                        
                        // ë°ì´í„° ë¡œë“œ
                        loadPackagingData();
                    } catch (error) {
                        console.error('âŒ Error creating Supabase client:', error);
                        console.log('ğŸ”„ Falling back to sample data...');
                        loadPackagingData(); // ìƒ˜í”Œ ë°ì´í„°ë¡œ í´ë°±
                    }
                } else if (attempts < maxAttempts) {
                    console.log('â³ Supabase not ready yet, waiting...');
                    console.log('â³ Current state:', {
                        'window.supabase': typeof window.supabase,
                        'window.supabase.createClient': typeof window.supabase?.createClient
                    });
                    setTimeout(checkSupabase, 2000); // 2ì´ˆ ëŒ€ê¸°
                } else {
                    console.log('âš ï¸ Supabase not available after maximum attempts, using sample data');
                    console.log('âš ï¸ Final state:', {
                        'window.supabase': typeof window.supabase,
                        'window.supabase.createClient': typeof window.supabase?.createClient
                    });
                    loadPackagingData(); // ìƒ˜í”Œ ë°ì´í„°ë¡œ í´ë°±
                }
            };
            
            // ì¦‰ì‹œ ì‹œë„
            checkSupabase();
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupPackagingEventListeners() {
            try {
                console.log('ğŸ”§ Setting up packaging event listeners...');
                
                // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
                const refreshBtn = document.getElementById('refreshDataBtn');
                if (refreshBtn) {
                    refreshBtn.onclick = loadPackagingData;
                    console.log('âœ… Refresh button listener added');
                }
                
                // Location í•„í„°
                const locationFilter = document.getElementById('locationFilter');
                if (locationFilter) {
                    locationFilter.onchange = applyPackagingFilter;
                    console.log('âœ… Location filter listener added');
                }
                
                // Excel ë‚´ë³´ë‚´ê¸° ë²„íŠ¼
                const exportBtn = document.getElementById('exportExcelBtn');
                if (exportBtn) {
                    exportBtn.onclick = exportPackagingData;
                    console.log('âœ… Export button listener added');
                }
                
                // ë¶€ì¡± ìˆ˜ëŸ‰ ê³„ì‚° ë²„íŠ¼
                const calculateBtn = document.getElementById('calculateShortageBtn');
                if (calculateBtn) {
                    calculateBtn.onclick = calculateShortage;
                    console.log('âœ… Calculate shortage button listener added');
                }
                
                // Part No ì¶”ê°€ ë²„íŠ¼
                const addRowBtn = document.getElementById('addShipmentRowBtn');
                if (addRowBtn) {
                    addRowBtn.onclick = addShipmentRow;
                    console.log('âœ… Add shipment row button listener added');
                }
                
                console.log('âœ… All event listeners set up');
                
            } catch (error) {
                console.error('âŒ Error setting up event listeners:', error);
            }
        }
        
        // Supabase í´ë¼ì´ì–¸íŠ¸ í™•ì¸ ë° ì´ˆê¸°í™”
        function checkSupabaseClient() {
            console.log('ğŸ” Checking Supabase client...');
            console.log('ğŸ” window.sb:', window.sb);
            console.log('ğŸ” window.supabase:', window.supabase);
            
            // ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
            let supabaseClient = window.sb || window.supabase;
            
            if (supabaseClient && typeof supabaseClient.from === 'function') {
                console.log('âœ… Existing Supabase client found and functional');
                console.log('âœ… Client methods available:', Object.keys(supabaseClient));
                return supabaseClient;
            }
            
            // ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
                console.log('ğŸ”§ Creating new Supabase client...');
                try {
                    const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
                    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
                    
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    window.sb = supabaseClient;
                    window.supabase = supabaseClient;
                    
                    console.log('âœ… New Supabase client created successfully');
                    console.log('âœ… Client methods available:', Object.keys(supabaseClient));
                    return supabaseClient;
                } catch (error) {
                    console.error('âŒ Error creating Supabase client:', error);
                    return null;
                }
            } else {
                console.log('âŒ Supabase library not available');
                return null;
            }
        }
        
        // í˜ì´ì§€ë„¤ì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ë°ì´í„° ë¡œë”©
        async function loadAllDataWithPagination(supabaseClient) {
            try {
                console.log('ğŸ“Š Starting paginated data loading...');
                const allData = [];
                let page = 0;
                const pageSize = 1000; // Supabase ê¸°ë³¸ ì œí•œ
                let hasMore = true;
                
                while (hasMore) {
                    console.log(`ğŸ“Š Loading page ${page + 1}...`);
                    updateStatus(`ë°ì´í„° ë¡œë”© ì¤‘... (í˜ì´ì§€ ${page + 1})`, 'info');
                    
                    const { data, error } = await supabaseClient
                        .from('vwtm_list_data')
                        .select('*')
                        .order('upload_time', { ascending: false })
                        .range(page * pageSize, (page + 1) * pageSize - 1);
                    
                    if (error) {
                        throw new Error(`Database error on page ${page + 1}: ${error.message}`);
                    }
                    
                    if (data && data.length > 0) {
                        allData.push(...data);
                        console.log(`ğŸ“Š Page ${page + 1}: ${data.length} records loaded (Total: ${allData.length})`);
                        
                        // 1000ê°œ ë¯¸ë§Œì´ë©´ ë§ˆì§€ë§‰ í˜ì´ì§€
                        if (data.length < pageSize) {
                            hasMore = false;
                            console.log(`ğŸ“Š Last page reached (${data.length} < ${pageSize})`);
                        } else {
                            page++;
                        }
                    } else {
                        hasMore = false;
                        console.log(`ğŸ“Š No more data on page ${page + 1}`);
                    }
                    
                    // ë„ˆë¬´ ë§ì€ í˜ì´ì§€ ë°©ì§€ (ì•ˆì „ì¥ì¹˜)
                    if (page > 100) {
                        console.warn('âš ï¸ Too many pages, stopping at page 100');
                        hasMore = false;
                    }
                }
                
                console.log(`ğŸ“Š Pagination completed: ${allData.length} total records loaded`);
                updateStatus(`ì „ì²´ ë°ì´í„° ë¡œë”© ì™„ë£Œ: ${allData.length}ê°œ ë ˆì½”ë“œ`, 'success');
                
                return allData;
                
            } catch (error) {
                console.error('âŒ Error in paginated loading:', error);
                throw error;
            }
        }
        
        // ë°ì´í„° ë¡œë“œ
        async function loadPackagingData() {
            try {
                console.log('ğŸ“Š ===== LOADING PACKAGING DATA =====');
                
                // Supabase í´ë¼ì´ì–¸íŠ¸ í™•ì¸
                const supabaseClient = checkSupabaseClient();
                let allData = [];
                let dataSource = 'sample';
                
                if (supabaseClient) {
                    try {
                        console.log('ğŸ“Š Loading data from Supabase...');
                        updateStatus('ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì „ì²´ ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘...', 'info');
                        
                        // ì „ì²´ ë°ì´í„° ë¡œë”© (í˜ì´ì§€ë„¤ì´ì…˜ ì‚¬ìš©)
                        console.log('ğŸ“Š Executing query with pagination: SELECT * FROM vwtm_list_data ORDER BY upload_time DESC');
                        allData = await loadAllDataWithPagination(supabaseClient);
                        dataSource = 'database';
                        console.log(`ğŸ“Š Loaded ${allData.length} records from database (NO LIMIT)`);
                        
                        // ë¡œë”©ëœ ë°ì´í„°ì˜ Location ë¶„í¬ í™•ì¸
                        const locationCounts = {};
                        const rackCounts = {};
                        allData.forEach(item => {
                            const location = item.location || 'NULL';
                            const rack = item.rack_no || 'NULL';
                            locationCounts[location] = (locationCounts[location] || 0) + 1;
                            rackCounts[rack] = (rackCounts[rack] || 0) + 1;
                        });
                        
                        console.log('ğŸ“Š Location ë¶„í¬:', locationCounts);
                        console.log('ğŸ“Š Rack ë¶„í¬ (ìƒìœ„ 10ê°œ):', Object.entries(rackCounts)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10));
                        
                        // ì²˜ìŒ 10ê°œ ì•„ì´í…œ ìƒì„¸ ì •ë³´ (PALLET ê´€ë ¨ í•„ë“œ í¬í•¨)
                        console.log('ğŸ“Š ì²˜ìŒ 10ê°œ ì•„ì´í…œ:');
                        allData.slice(0, 10).forEach((item, index) => {
                            console.log(`ğŸ“Š Item ${index}: Part=${item.part_no}, Rack=${item.rack_no}, Location=${item.location}, Hold=${item.hold_whether}`);
                            console.log(`ğŸ“Š Item ${index} PALLET í•„ë“œ:`, {
                                pallet_count: item.pallet_count,
                                pallet_qty: item.pallet_qty,
                                pallet_no: item.pallet_no,
                                tm_count: item.tm_count,
                                tm_qty: item.tm_qty,
                                quantity: item.quantity
                            });
                        });
                        
                        updateStatus(`ì „ì²´ ë°ì´í„° ë¡œë”© ì™„ë£Œ: ${allData.length}ê°œ ë ˆì½”ë“œ`, 'success');
                        
                    } catch (dbError) {
                        console.warn('âš ï¸ Database error, using sample data:', dbError.message);
                        allData = [];
                    }
                } else {
                    console.log('âš ï¸ Supabase client not available, using sample data');
                    allData = [];
                }
                
                // ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ëŠ”ì§€ í™•ì¸
                if (allData.length === 0) {
                    console.log('ğŸ“­ No data found, creating sample data for demonstration...');
                    // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
                    allData = [
                        { part_no: 'SAMPLE001', rack_no: 'LHSAA01', location: 'LHSAA', pallet_no: 'P001', hold_whether: 'N' },
                        { part_no: 'SAMPLE002', rack_no: 'LHSAB01', location: 'LHSAB', pallet_no: 'P002', hold_whether: 'N' },
                        { part_no: 'SAMPLE003', rack_no: 'LHSAC01', location: 'LHSAC', pallet_no: 'P003', hold_whether: 'N' },
                        { part_no: 'SAMPLE004', rack_no: 'LHSAD01', location: 'LHSAD', pallet_no: 'P004', hold_whether: 'N' },
                        { part_no: 'SAMPLE005', rack_no: 'LHSBA01', location: 'LHSBA', pallet_no: 'P005', hold_whether: 'N' },
                        { part_no: 'SAMPLE006', rack_no: 'LHSBB01', location: 'LHSBB', pallet_no: 'P006', hold_whether: 'N' },
                        { part_no: 'SAMPLE007', rack_no: 'LHSBC01', location: 'LHSBC', pallet_no: 'P007', hold_whether: 'N' },
                        { part_no: 'SAMPLE008', rack_no: 'LHSBD01', location: 'LHSBD', pallet_no: 'P008', hold_whether: 'N' }
                    ];
                    dataSource = 'sample';
                    updateStatus(`ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©: ${allData.length}ê°œ ë ˆì½”ë“œ`, 'warning');
                }
                
                window.PackagingAnalysis.allData = allData;
                
                // í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
                populateFilterOptions();
                
                // í•„í„° ì ìš©
                applyPackagingFilter();
                
                console.log('âœ… Data loading completed');
                const statusMessage = dataSource === 'database' 
                    ? `ì „ì²´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${allData.length}ê°œ ë ˆì½”ë“œ (ì‹¤ì œ ë°ì´í„°)`
                    : `ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${allData.length}ê°œ ë ˆì½”ë“œ (ìƒ˜í”Œ ë°ì´í„°)`;
                updateStatus(statusMessage, 'success');
                
            } catch (error) {
                console.error('âŒ Error loading packaging data:', error);
                updateStatus('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + error.message, 'error');
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìƒ˜í”Œ ë°ì´í„°ë¡œ ì„¤ì •
                console.log('ğŸ”„ Using fallback sample data...');
                const fallbackData = [
                    { part_no: 'FALLBACK001', rack_no: 'LHSAA01', location: 'LHSAA', pallet_no: 'P001', hold_whether: 'N' },
                    { part_no: 'FALLBACK002', rack_no: 'LHSAC01', location: 'LHSAC', pallet_no: 'P002', hold_whether: 'N' }
                ];
                window.PackagingAnalysis.allData = fallbackData;
                populateFilterOptions();
                applyPackagingFilter();
            }
        }
        
        // í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
        function populateFilterOptions() {
            try {
                console.log('ğŸ”§ Populating filter options...');
                
                // ìœ íš¨í•œ í¬ì¥ì „/í¬ì¥í›„ RACK NOë§Œ ì¶”ì¶œ (LHSSP ë“± ì œì™¸)
                const validRackPrefixes = [
                    'LHSAA', 'LHSAB', 'LHSBA', 'LHSBB',  // í¬ì¥ì „
                    'LHSAC', 'LHSAD', 'LHSBC', 'LHSBD'   // í¬ì¥í›„
                ];
                
                const uniqueRackPrefixes = [...new Set(
                    window.PackagingAnalysis.allData
                        .filter(item => {
                            const rackNo = item.rack_no || '';
                            return validRackPrefixes.some(prefix => rackNo.startsWith(prefix));
                        })
                        .map(item => item.rack_no.substring(0, 5)) // LHSAA, LHSAB ë“±
                )].sort();
                
                const locationFilter = document.getElementById('locationFilter');
                if (locationFilter) {
                    locationFilter.innerHTML = '<option value="">All RACK NO</option>';
                    uniqueRackPrefixes.forEach(prefix => {
                        const option = document.createElement('option');
                        option.value = prefix;
                        option.textContent = prefix;
                        locationFilter.appendChild(option);
                    });
                }
                
                console.log(`âœ… Filter options populated: ${uniqueRackPrefixes.length} valid RACK NO prefixes`);
                console.log(`âœ… Available RACK NO prefixes:`, uniqueRackPrefixes);
                console.log(`âœ… Valid prefixes defined:`, validRackPrefixes);
                
            } catch (error) {
                console.error('âŒ Error populating filter options:', error);
            }
        }
        
        // í•„í„° ì ìš©
        function applyPackagingFilter() {
            try {
                console.log('ğŸ” ===== APPLYING PACKAGING FILTER =====');
                console.log(`ğŸ” ì›ë³¸ ë°ì´í„°: ${window.PackagingAnalysis.allData.length}ê°œ ë ˆì½”ë“œ`);
                
                let filtered = [...window.PackagingAnalysis.allData];
                
                // ì •í™•í•œ í¬ì¥ì „/í¬ì¥í›„ RACK NOë§Œ í•„í„°ë§ (LHSSP ë“± ì œì™¸)
                const validRackPrefixes = [
                    'LHSAA', 'LHSAB', 'LHSBA', 'LHSBB',  // í¬ì¥ì „
                    'LHSAC', 'LHSAD', 'LHSBC', 'LHSBD'   // í¬ì¥í›„
                ];
                
                const beforeRackCount = filtered.length;
                filtered = filtered.filter(item => {
                    const rackNo = item.rack_no || '';
                    return validRackPrefixes.some(prefix => rackNo.startsWith(prefix));
                });
                console.log(`ğŸ” ìœ íš¨í•œ RACK NO í•„í„° ì ìš©: ${beforeRackCount} â†’ ${filtered.length}ê°œ ë ˆì½”ë“œ`);
                console.log(`ğŸ” í—ˆìš©ëœ RACK NO: ${validRackPrefixes.join(', ')}`);
                
                // RACK NO í•„í„° ì ìš© (ì„ íƒëœ ê²½ìš°)
                const rackFilter = document.getElementById('locationFilter');
                if (rackFilter && rackFilter.value) {
                    const beforeRackFilterCount = filtered.length;
                    filtered = filtered.filter(item => {
                        const rackNo = item.rack_no || '';
                        return rackNo.startsWith(rackFilter.value);
                    });
                    console.log(`ğŸ” RACK NO ${rackFilter.value} í•„í„° ì ìš©: ${beforeRackFilterCount} â†’ ${filtered.length}ê°œ ë ˆì½”ë“œ`);
                } else {
                    console.log('ğŸ” RACK NO í•„í„° ì—†ìŒ - ëª¨ë“  LHS RACK NO í¬í•¨');
                }
                
                // Hold Whether 'N' í•„í„° ì ìš©
                const beforeHoldCount = filtered.length;
                filtered = filtered.filter(item => item.hold_whether === 'N');
                console.log(`ğŸ” Hold Whether 'N' í•„í„° ì ìš©: ${beforeHoldCount} â†’ ${filtered.length}ê°œ ë ˆì½”ë“œ`);
                
                // í•„í„°ë§ëœ ë°ì´í„°ì˜ RACK NO ë¶„í¬ í™•ì¸
                const filteredRackCounts = {};
                filtered.forEach(item => {
                    const rackNo = item.rack_no || 'NULL';
                    const rackPrefix = rackNo.substring(0, 5); // LHSAA, LHSAB ë“±
                    filteredRackCounts[rackPrefix] = (filteredRackCounts[rackPrefix] || 0) + 1;
                });
                console.log('ğŸ” í•„í„°ë§ëœ ë°ì´í„° RACK NO ë¶„í¬:', filteredRackCounts);
                
                window.PackagingAnalysis.filteredData = filtered;
                console.log(`ğŸ” Filter applied: ${filtered.length} records`);
                
                // ë¶„ì„ ìˆ˜í–‰
                performPackagingAnalysis();
                
                updateStatus(`í•„í„° ì ìš©ë¨: ${filtered.length}ê°œ ë ˆì½”ë“œ (LHS RACK NOë§Œ)`);
                
            } catch (error) {
                console.error('âŒ Error applying filter:', error);
                updateStatus('í•„í„° ì ìš© ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // í¬ì¥ ë¶„ì„ ìˆ˜í–‰
        function performPackagingAnalysis() {
            try {
                console.log('ğŸ“Š ===== PERFORMING PACKAGING ANALYSIS =====');
                console.log('ğŸ“Š ë¶„ì„ ê¸°ì¤€:');
                console.log('ğŸ“Š - Part Noë³„ë¡œ ê·¸ë£¹í™”');
                console.log('ğŸ“Š - ê° TM(ê°œë³„ ì•„ì´í…œ)ì„ í¬ì¥ ì „/í›„ë¡œ ë¶„ë¥˜');
                console.log('ğŸ“Š - í¬ì¥ ì „: LHSAA, LHSAB, LHSBA, LHSBB (rack_no ë˜ëŠ” location ê¸°ì¤€)');
                console.log('ğŸ“Š - í¬ì¥ í›„: LHSAC, LHSAD, LHSBC, LHSBD (rack_no ë˜ëŠ” location ê¸°ì¤€)');
                console.log('ğŸ“Š - Hold Whether = "N"ì¸ ì•„ì´í…œë§Œ ë¶„ì„');
                
                const data = window.PackagingAnalysis.filteredData;
                console.log(`ğŸ“Š ë¶„ì„ ëŒ€ìƒ ë°ì´í„°: ${data.length}ê°œ TM ë ˆì½”ë“œ`);
                
                if (!data || data.length === 0) {
                    console.log('ğŸ“­ No data to analyze');
                    displayPackagingResults([]);
                    updatePackagingSummary([]);
                    return;
                }
                
                // Part Noë³„ë¡œ ê·¸ë£¹í™”
                const partGroups = {};
                let totalBeforeCount = 0;
                let totalAfterCount = 0;
                let totalUnknownCount = 0;
                
                data.forEach((item, index) => {
                    const partNo = item.part_no;
                    if (!partNo) {
                        console.log(`âš ï¸ Item ${index} has no part_no:`, item);
                        return;
                    }
                    
                    if (!partGroups[partNo]) {
                        partGroups[partNo] = {
                            partNo: partNo,
                            beforePackaging: 0,
                            afterPackaging: 0,
                            total: 0,
                            items: []
                        };
                    }
                    
                    const packagingStatus = determinePackagingStatus(item.rack_no, item.location);
                    const isBefore = packagingStatus === 'before';
                    const isAfter = packagingStatus === 'after';
                    
                    // ìƒì„¸ ë¡œê¹… (ì²˜ìŒ 5ê°œë§Œ)
                    if (index < 5) {
                        console.log(`ğŸ“Š Item ${index}: Part=${partNo}, Rack=${item.rack_no}, Location=${item.location}, Status=${packagingStatus}`);
                    }
                    
                    partGroups[partNo].items.push({
                        palletNo: item.pallet_no,
                        rackNo: item.rack_no,
                        location: item.location,
                        isBeforePackaging: isBefore,
                        isAfterPackaging: isAfter
                    });
                    
                    if (isBefore) {
                        partGroups[partNo].beforePackaging++;
                        totalBeforeCount++;
                    } else if (isAfter) {
                        // í¬ì¥ í›„ì¸ ê²½ìš° ê°™ì€ PALLET NOì— 8ê°œì”© ë¬¶ì—¬ìˆëŠ”ì§€ í™•ì¸
                        const samePalletTMs = window.PackagingAnalysis.filteredData.filter(tm => 
                            tm.pallet_no === item.pallet_no && 
                            tm.hold_whether === 'N' &&
                            tm.part_no === item.part_no
                        );
                        
                        const tmCount = samePalletTMs.length;
                        
                        if (tmCount >= 8) {
                            // 8ê°œ ì´ìƒì¸ ê²½ìš° í¬ì¥ í›„ë¡œ ì§‘ê³„
                            const palletCount = Math.floor(tmCount / 8);
                            partGroups[partNo].afterPackaging += palletCount;
                            totalAfterCount += palletCount;
                            
                            console.log(`âœ… í¬ì¥ í›„ ì§‘ê³„: ${item.part_no} PALLET ${item.pallet_no} - ${tmCount}ê°œ TM â†’ ${palletCount}ê°œ PALLET`);
                            
                            // 8ê°œë¡œ ë‚˜ëˆ„ì–´ë–¨ì–´ì§€ì§€ ì•ŠëŠ” ë‚˜ë¨¸ì§€ TMë“¤ì€ í¬ì¥ ì „ìœ¼ë¡œ ë¶„ë¥˜
                            const remainderTMs = tmCount % 8;
                            if (remainderTMs > 0) {
                                partGroups[partNo].beforePackaging += remainderTMs;
                                totalBeforeCount += remainderTMs;
                                console.log(`ğŸ”„ ì¬í¬ì¥ í•„ìš”: ${item.part_no} PALLET ${item.pallet_no} - ë‚˜ë¨¸ì§€ ${remainderTMs}ê°œ TMì„ í¬ì¥ ì „ìœ¼ë¡œ ë¶„ë¥˜`);
                            }
                        } else {
                            // 8ê°œ ë¯¸ë§Œì¸ ê²½ìš° ëª¨ë‘ í¬ì¥ ì „ìœ¼ë¡œ ë¶„ë¥˜ (ì¬í¬ì¥ í•„ìš”)
                            partGroups[partNo].beforePackaging += tmCount;
                            totalBeforeCount += tmCount;
                            console.log(`ğŸ”„ ì¬í¬ì¥ í•„ìš”: ${item.part_no} PALLET ${item.pallet_no} - ${tmCount}ê°œ TMì„ í¬ì¥ ì „ìœ¼ë¡œ ë¶„ë¥˜`);
                        }
                    } else {
                        totalUnknownCount++;
                    }
                    
                    partGroups[partNo].total++;
                });
                
                const results = Object.values(partGroups).sort((a, b) => a.partNo.localeCompare(b.partNo));
                
                console.log(`ğŸ“Š ë¶„ì„ ê²°ê³¼ ìš”ì•½:`);
                console.log(`ğŸ“Š - ì´ Part No ê°œìˆ˜: ${results.length}ê°œ`);
                console.log(`ğŸ“Š - í¬ì¥ ì „ TM ê°œìˆ˜: ${totalBeforeCount}ê°œ`);
                console.log(`ğŸ“Š - í¬ì¥ í›„ TM ê°œìˆ˜: ${totalAfterCount}ê°œ`);
                console.log(`ğŸ“Š - ë¶„ë¥˜ ë¶ˆê°€ TM ê°œìˆ˜: ${totalUnknownCount}ê°œ`);
                console.log(`ğŸ“Š - ì´ TM ê°œìˆ˜: ${totalBeforeCount + totalAfterCount + totalUnknownCount}ê°œ`);
                
                // ê²°ê³¼ í‘œì‹œ
                displayPackagingResults(results);
                updatePackagingSummary(results);
                
                // ê²°ê³¼ ìºì‹œ
                window.PackagingAnalysis.lastAnalysisResults = results;
                
            } catch (error) {
                console.error('âŒ Error performing packaging analysis:', error);
                updateStatus('ë¶„ì„ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ê²°ê³¼ í‘œì‹œ
        function displayPackagingResults(results) {
            try {
                console.log('ğŸ“‹ ===== DISPLAYING PACKAGING RESULTS =====');
                console.log('ğŸ“‹ Results:', results);
                
                const tableBody = document.getElementById('resultsTable');
                const resultCount = document.getElementById('resultCount');
                
                if (!tableBody || !resultCount) {
                    console.error('âŒ Required DOM elements not found');
                    return;
                }
                
                if (results.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                                ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    resultCount.textContent = 'ê²°ê³¼ ì—†ìŒ';
                    return;
                }
                
                resultCount.textContent = `Found ${results.length} part numbers`;
                
                const tableRows = results.map(result => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${result.partNo || 'N/A'}
                        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
          <div class="flex flex-col space-y-1">
            <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs">
              ${result.beforePackaging || 0}ê°œ
            </span>
            <span class="text-xs text-gray-500">
              ${calculateTruckCount(result.partNo, result.beforePackaging || 0)}ëŒ€
            </span>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
          <div class="flex flex-col space-y-1">
            <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">
              ${result.afterPackaging || 0}ê°œ
            </span>
            <span class="text-xs text-gray-500">
              ${calculateTruckCount(result.partNo, result.afterPackaging || 0)}ëŒ€
            </span>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
          <div class="flex flex-col space-y-1">
            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
              ${result.total || 0}ê°œ
            </span>
            <span class="text-xs text-gray-500">
              ${calculateTruckCount(result.partNo, result.total || 0)}ëŒ€
            </span>
          </div>
        </td>
                    </tr>
                `);
                
                tableBody.innerHTML = tableRows.join('');
                
                console.log(`âœ… Results displayed: ${results.length} rows`);
                
            } catch (error) {
                console.error('âŒ Error displaying results:', error);
            }
        }
        
        // ìš”ì•½ ì—…ë°ì´íŠ¸
        function updatePackagingSummary(results) {
            try {
                console.log('ğŸ“Š Updating packaging summary...');
                
                const totalBefore = results.reduce((sum, r) => sum + (r.beforePackaging || 0), 0);
                const totalAfter = results.reduce((sum, r) => sum + (r.afterPackaging || 0), 0);
                const totalItems = results.reduce((sum, r) => sum + (r.total || 0), 0);
                
                const summaryBefore = document.getElementById('summaryBefore');
                const summaryAfter = document.getElementById('summaryAfter');
                const summaryTotal = document.getElementById('summaryTotal');
                
                if (summaryBefore) {
                    summaryBefore.innerHTML = `
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-orange-600">${totalBefore}</div>
                            <div class="ml-3">
                                <div class="text-sm text-gray-500">í¬ì¥ ì „</div>
                                <div class="text-xs text-gray-400">ì•½ ${Math.floor(totalBefore / 176)}ëŒ€</div>
                            </div>
                        </div>
                    `;
                }
                
                if (summaryAfter) {
                    summaryAfter.innerHTML = `
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-green-600">${totalAfter}</div>
                            <div class="ml-3">
                                <div class="text-sm text-gray-500">í¬ì¥ í›„</div>
                                <div class="text-xs text-gray-400">ì•½ ${Math.floor(totalAfter / 176)}ëŒ€</div>
                            </div>
                        </div>
                    `;
                }
                
                if (summaryTotal) {
                    summaryTotal.innerHTML = `
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-blue-600">${totalItems}</div>
                            <div class="ml-3">
                                <div class="text-sm text-gray-500">í•©ê³„</div>
                                <div class="text-xs text-gray-400">ì•½ ${Math.floor(totalItems / 176)}ëŒ€</div>
                            </div>
                        </div>
                    `;
                }
                
                console.log(`âœ… Summary updated: Before: ${totalBefore}, After: ${totalAfter}, Total: ${totalItems}`);
                
            } catch (error) {
                console.error('âŒ Error updating summary:', error);
            }
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(message, type = 'info') {
            try {
                const filterStatus = document.getElementById('filterStatus');
                if (filterStatus) {
                    const bgColor = {
                        'info': 'text-gray-500',
                        'success': 'text-green-600',
                        'error': 'text-red-600',
                        'warning': 'text-yellow-600'
                    }[type] || 'text-gray-500';
                    
                    filterStatus.className = `text-xs ${bgColor}`;
                    filterStatus.textContent = message;
                }
            } catch (error) {
                console.error('âŒ Error updating status:', error);
            }
        }
        
        // Excel ë‚´ë³´ë‚´ê¸°
        async function exportPackagingData() {
            try {
                console.log('ğŸ“¦ Exporting packaging data...');
                
                const results = window.PackagingAnalysis.lastAnalysisResults;
                if (!results || results.length === 0) {
                    console.warn('âš ï¸ ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('í¬ì¥ ë¶„ì„ ê²°ê³¼');
                
                // í—¤ë” ì¶”ê°€
                const headers = ['Part No', 'í¬ì¥ ì „', 'í¬ì¥ í›„', 'í•©ê³„'];
                const headerRow = worksheet.addRow(headers);
                headerRow.font = { bold: true };
                headerRow.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFE0E0E0' }
                };
                
                // ë°ì´í„° ì¶”ê°€
                results.forEach(result => {
                    worksheet.addRow([
                        result.partNo,
                        result.beforePackaging,
                        result.afterPackaging,
                        result.total
                    ]);
                });
                
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `í¬ì¥ë¶„ì„ê²°ê³¼_${new Date().toISOString().slice(0, 10)}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                console.log('âœ… Export completed');
                updateStatus('Excel ë‚´ë³´ë‚´ê¸° ì™„ë£Œ', 'success');
                
            } catch (error) {
                console.error('âŒ Error exporting data:', error);
                updateStatus('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // í…Œì´ë¸” ì •ë ¬
        function sortPackagingTable(column) {
            try {
                console.log(`ğŸ” Sorting by column: ${column}`);
                
                if (window.PackagingAnalysis.currentSortColumn === column) {
                    window.PackagingAnalysis.currentSortDirection = 
                        window.PackagingAnalysis.currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    window.PackagingAnalysis.currentSortColumn = column;
                    window.PackagingAnalysis.currentSortDirection = 'asc';
                }
                
                const results = [...window.PackagingAnalysis.lastAnalysisResults];
                results.sort((a, b) => {
                    let aVal = a[column] || '';
                    let bVal = b[column] || '';
                    
                    if (['beforePackaging', 'afterPackaging', 'total'].includes(column)) {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                    }
                    
                    if (aVal < bVal) return window.PackagingAnalysis.currentSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return window.PackagingAnalysis.currentSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
                
                displayPackagingResults(results);
                updatePackagingSummary(results);
                
                console.log(`âœ… Sorted by ${column} (${window.PackagingAnalysis.currentSortDirection})`);
                
            } catch (error) {
                console.error('âŒ Error sorting table:', error);
            }
        }
        
        // Part Noë³„ ì°¨ëŸ‰ë‹¹ ìˆ˜ëŸ‰ ì •ì˜
        const PART_NO_TRUCK_CAPACITY = {
            '3T24': 152,  // 3T24ëŠ” ì°¨ëŸ‰ë‹¹ 152ê°œ
            '3T33': 176,  // ë‚˜ë¨¸ì§€ëŠ” ì°¨ëŸ‰ë‹¹ 176ê°œ
            '3T34': 176,
            '3T35': 176
        };
        
        // íŠ¸ëŸ­ ëŒ“ìˆ˜ ê³„ì‚° í•¨ìˆ˜
        function calculateTruckCount(partNo, quantity) {
            if (!partNo || !quantity || quantity <= 0) return '0';
            
            const capacityPerTruck = PART_NO_TRUCK_CAPACITY[partNo] || 176; // ê¸°ë³¸ê°’ 176
            const truckCount = Math.floor(quantity / capacityPerTruck);
            return truckCount.toLocaleString();
        }
        
        // Part No ì¶”ê°€ í•¨ìˆ˜
        function addShipmentRow() {
            try {
                console.log('â• Adding shipment row...');
                
                const tbody = document.getElementById('shipmentInputBody');
                if (!tbody) {
                    console.error('âŒ Shipment input body not found');
                    return;
                }
                
                const rowId = 'shipment_row_' + Date.now();
                const rowHTML = `
                    <tr id="${rowId}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" data-part-no onchange="updateTruckCapacity('${rowId}')">
                                <option value="">Part No ì„ íƒ</option>
                                <option value="3T24">3T24</option>
                                <option value="3T33">3T33</option>
                                <option value="3T34">3T34</option>
                                <option value="3T35">3T35</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="íŠ¸ëŸ­ ìˆ˜ëŸ‰" data-truck-count min="0" onchange="calculateTotalQuantity('${rowId}')">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-900" data-capacity-per-truck">-</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-medium text-gray-900" data-total-quantity>0</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="removeShipmentRow('${rowId}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                ì‚­ì œ
                            </button>
                        </td>
                    </tr>
                `;
                
                tbody.insertAdjacentHTML('beforeend', rowHTML);
                console.log('âœ… Shipment row added');
                
            } catch (error) {
                console.error('âŒ Error adding shipment row:', error);
            }
        }
        
        // Part No ì„ íƒ ì‹œ ì°¨ëŸ‰ë‹¹ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
        function updateTruckCapacity(rowId) {
            try {
                const row = document.getElementById(rowId);
                if (!row) return;
                
                const partNoSelect = row.querySelector('[data-part-no]');
                const capacitySpan = row.querySelector('[data-capacity-per-truck]');
                
                if (partNoSelect && capacitySpan) {
                    const partNo = partNoSelect.value;
                    const capacity = PART_NO_TRUCK_CAPACITY[partNo] || 0;
                    capacitySpan.textContent = capacity > 0 ? capacity.toLocaleString() + 'ê°œ' : '-';
                    
                    // ì´ ìˆ˜ëŸ‰ë„ ë‹¤ì‹œ ê³„ì‚°
                    calculateTotalQuantity(rowId);
                }
            } catch (error) {
                console.error('âŒ Error updating truck capacity:', error);
            }
        }
        
        // ì´ ì¶œí•˜ ìˆ˜ëŸ‰ ê³„ì‚°
        function calculateTotalQuantity(rowId) {
            try {
                const row = document.getElementById(rowId);
                if (!row) return;
                
                const partNoSelect = row.querySelector('[data-part-no]');
                const truckCountInput = row.querySelector('[data-truck-count]');
                const totalQuantitySpan = row.querySelector('[data-total-quantity]');
                
                if (partNoSelect && truckCountInput && totalQuantitySpan) {
                    const partNo = partNoSelect.value;
                    const truckCount = parseInt(truckCountInput.value) || 0;
                    const capacityPerTruck = PART_NO_TRUCK_CAPACITY[partNo] || 0;
                    
                    const totalQuantity = truckCount * capacityPerTruck;
                    totalQuantitySpan.textContent = totalQuantity.toLocaleString();
                }
            } catch (error) {
                console.error('âŒ Error calculating total quantity:', error);
            }
        }
        
        // Part No í–‰ ì‚­ì œ í•¨ìˆ˜
        function removeShipmentRow(rowId) {
            try {
                const row = document.getElementById(rowId);
                if (row) {
                    row.remove();
                    console.log(`âœ… Shipment row ${rowId} removed`);
                }
            } catch (error) {
                console.error('âŒ Error removing shipment row:', error);
            }
        }
        
        // ë¶€ì¡± ìˆ˜ëŸ‰ ê³„ì‚° (Part Noë³„)
        function calculateShortage() {
            try {
                console.log('ğŸ“Š ===== CALCULATING SHORTAGE (Part Noë³„) =====');
                
                const shortageResult = document.getElementById('shortageResult');
                const shortageTable = document.getElementById('shortageTable');
                
                if (!shortageResult || !shortageTable) {
                    console.error('âŒ Required DOM elements not found');
                    return;
                }
                
                const results = window.PackagingAnalysis.lastAnalysisResults;
                if (!results || results.length === 0) {
                    console.warn('âš ï¸ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ì…ë ¥ëœ Part Noë³„ ì¶œí•˜ ìˆ˜ëŸ‰ ìˆ˜ì§‘ (íŠ¸ëŸ­ ìˆ˜ëŸ‰ ê¸°ë°˜)
                const shipmentInputs = document.querySelectorAll('#shipmentInputBody tr');
                const shipmentData = {};
                let totalShipment = 0;
                
                shipmentInputs.forEach(row => {
                    const partNoSelect = row.querySelector('[data-part-no]');
                    const truckCountInput = row.querySelector('[data-truck-count]');
                    
                    if (partNoSelect && truckCountInput && partNoSelect.value && truckCountInput.value) {
                        const partNo = partNoSelect.value;
                        const truckCount = parseInt(truckCountInput.value);
                        const capacityPerTruck = PART_NO_TRUCK_CAPACITY[partNo] || 0;
                        
                        if (!isNaN(truckCount) && truckCount > 0 && capacityPerTruck > 0) {
                            const totalQuantity = truckCount * capacityPerTruck;
                            shipmentData[partNo] = (shipmentData[partNo] || 0) + totalQuantity;
                            totalShipment += totalQuantity;
                        }
                    }
                });
                
                if (Object.keys(shipmentData).length === 0) {
                    console.warn('âš ï¸ Part Noì™€ ì¶œí•˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // Part Noë³„ ë¶€ì¡± ìˆ˜ëŸ‰ ê³„ì‚°
                const shortageAnalysis = [];
                let totalShortage = 0;
                
                Object.keys(shipmentData).forEach(partNo => {
                    const shipmentQty = shipmentData[partNo];
                    const result = results.find(r => r.partNo === partNo);
                    
                    if (result) {
                        const afterPackaging = result.afterPackaging || 0;
                        const shortage = Math.max(0, shipmentQty - afterPackaging);
                        shortageAnalysis.push({
                            partNo: partNo,
                            shipmentQty: shipmentQty,
                            afterPackaging: afterPackaging,
                            shortage: shortage
                        });
                        totalShortage += shortage;
                    }
                });
                
                // ê²°ê³¼ í…Œì´ë¸” ìƒì„±
                let tableHTML = `
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Part No</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">íŠ¸ëŸ­ ìˆ˜ëŸ‰</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì¶œí•˜ ìˆ˜ëŸ‰</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í¬ì¥ í›„</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë¶€ì¡± ìˆ˜ëŸ‰</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                shortageAnalysis.forEach(item => {
                    const status = item.shortage > 0 ? 'ë¶€ì¡±' : 'ì¶©ë¶„';
                    const statusColor = item.shortage > 0 ? 'text-red-600' : 'text-green-600';
                    const statusBadge = item.shortage > 0 ? 
                        '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">ë¶€ì¡±</span>' : 
                        '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">ì¶©ë¶„</span>';
                    
                    // íŠ¸ëŸ­ ìˆ˜ëŸ‰ ê³„ì‚°
                    const capacityPerTruck = PART_NO_TRUCK_CAPACITY[item.partNo] || 0;
                    const truckCount = capacityPerTruck > 0 ? Math.ceil(item.shipmentQty / capacityPerTruck) : 0;
                    
                    tableHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.partNo}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${truckCount}ëŒ€</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.shipmentQty.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.afterPackaging.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${statusColor}">${item.shortage.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                        </tr>
                    `;
                });
                
                // ì´ê³„ í–‰ ì¶”ê°€
                const totalTrucks = shortageAnalysis.reduce((sum, item) => {
                    const capacityPerTruck = PART_NO_TRUCK_CAPACITY[item.partNo] || 0;
                    return sum + (capacityPerTruck > 0 ? Math.ceil(item.shipmentQty / capacityPerTruck) : 0);
                }, 0);
                
                tableHTML += `
                    <tr class="bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">ì´ê³„</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${totalTrucks}ëŒ€</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${totalShipment.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">-</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${totalShortage > 0 ? 'text-red-600' : 'text-green-600'}">${totalShortage.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${totalShortage > 0 ? 
                                '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">ë¶€ì¡±</span>' : 
                                '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">ì¶©ë¶„</span>'
                            }
                        </td>
                    </tr>
                `;
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                shortageTable.innerHTML = tableHTML;
                shortageResult.classList.remove('hidden');
                
                console.log(`âœ… Shortage calculation completed: ${totalShortage} units shortage across ${shortageAnalysis.length} parts`);
                updateStatus(`ë¶€ì¡± ìˆ˜ëŸ‰ ê³„ì‚° ì™„ë£Œ: ${totalShortage > 0 ? totalShortage.toLocaleString() + 'ê°œ ë¶€ì¡±' : 'ì¶©ë¶„í•œ ì¬ê³ '}`, totalShortage > 0 ? 'warning' : 'success');
                
            } catch (error) {
                console.error('âŒ Error calculating shortage:', error);
                updateStatus('ë¶€ì¡± ìˆ˜ëŸ‰ ê³„ì‚° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.initPackagingAnalysis = initPackagingAnalysis;
        window.loadPackagingData = loadPackagingData;
        window.applyPackagingFilter = applyPackagingFilter;
        window.displayPackagingResults = displayPackagingResults;
        window.exportPackagingData = exportPackagingData;
        window.sortPackagingTable = sortPackagingTable;
        window.addShipmentRow = addShipmentRow;
        window.removeShipmentRow = removeShipmentRow;
        window.calculateShortage = calculateShortage;
        window.updateTruckCapacity = updateTruckCapacity;
        window.calculateTotalQuantity = calculateTotalQuantity;
        window.calculateTruckCount = calculateTruckCount;
        
        // DOM ë¡œë“œ í›„ ì´ˆê¸°í™”
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPackagingAnalysis);
        } else {
            initPackagingAnalysis();
        }
        
        console.log('ğŸ“¦ ===== PACKAGING ANALYSIS SYSTEM LOADED =====');
    </script>
</body>
</html>
