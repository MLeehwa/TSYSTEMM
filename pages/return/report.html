<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report - Return TM Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Report</h2>
      <p class="text-gray-600">Return TM Management - ë¦¬í¬íŠ¸ ì¡°íšŒ ë° ìƒì„±</p>
    </div>

    <!-- Search/Filter Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">ê²€ìƒ‰ ì¡°ê±´</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Pallet No -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Pallet No</label>
          <input 
            type="text" 
            id="filterPalletNo" 
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="íŒ”ë › ë²ˆí˜¸"
          />
        </div>
        
        <!-- TM No -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">TM No</label>
          <input 
            type="text" 
            id="filterTMNo" 
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="TM ë²ˆí˜¸"
          />
        </div>
        
        <!-- Mapping Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Mapping Date</label>
          <input 
            type="date" 
            id="filterMappingDate" 
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        
        <!-- Shipped Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Shipped Date</label>
          <input 
            type="date" 
            id="filterShippedDate" 
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="flex justify-end gap-3 mt-4">
        <button 
          onclick="clearFilters()" 
          class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors"
        >
          ì´ˆê¸°í™”
        </button>
        <button 
          onclick="searchData()" 
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors"
        >
          ê²€ìƒ‰
        </button>
        <button 
          onclick="showExportDateDialog()" 
          class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors"
        >
          Excel ë‹¤ìš´ë¡œë“œ
        </button>
      </div>
    </div>

    <!-- Results Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">ì¡°íšŒ ê²°ê³¼</h3>
        <div class="text-sm text-gray-600">
          ì´ <span id="resultCount" class="font-bold text-blue-600">0</span> ê±´
        </div>
      </div>
      
      <!-- Status Message -->
      <div id="statusMessage" class="hidden mb-4 p-3 rounded-lg"></div>
      
      <!-- Loading -->
      <div id="loadingIndicator" class="hidden text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-gray-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
      
      <!-- Data Table -->
      <div id="dataTableContainer" class="hidden overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pallet No</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TM No</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mapping Date</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shipped Date</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Batch</th>
            </tr>
          </thead>
          <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Data will be inserted here -->
          </tbody>
        </table>
      </div>
      
      <!-- Empty State -->
      <div id="emptyState" class="text-center py-12">
        <div class="text-6xl mb-4">ğŸ“Š</div>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="text-gray-600">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
      </div>
    </div>
  </div>

  <!-- Export Date Dialog -->
  <div id="exportDateDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
      <h3 class="text-lg font-bold text-gray-800 mb-4">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë‚ ì§œ ì„ íƒ</h3>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Shipped Date</label>
        <input 
          type="date" 
          id="exportShippedDate" 
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        />
      </div>
      <div class="flex justify-end gap-3">
        <button 
          onclick="closeExportDateDialog()" 
          class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors"
        >
          ì·¨ì†Œ
        </button>
        <button 
          onclick="exportToExcel()" 
          class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors"
        >
          ë‹¤ìš´ë¡œë“œ
        </button>
      </div>
    </div>
  </div>

  <script>
    // Supabase ì„¤ì •
    const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
    
    let supabaseClient = null;
    let currentData = [];
    
    // Supabase ì´ˆê¸°í™”
    async function initSupabase() {
      try {
        if (typeof supabase !== 'undefined') {
          supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('âœ… Supabase initialized');
          return true;
        } else {
          console.error('Supabase library not loaded');
          return false;
        }
      } catch (error) {
        console.error('Error initializing Supabase:', error);
        return false;
      }
    }
    
    // ë°ì´í„° ê²€ìƒ‰
    async function searchData() {
      try {
        if (!supabaseClient) {
          await initSupabase();
        }
        
        // ê²€ìƒ‰ ì¡°ê±´ ê°€ì ¸ì˜¤ê¸°
        const palletNo = document.getElementById('filterPalletNo').value.trim();
        const tmNo = document.getElementById('filterTMNo').value.trim();
        const mappingDate = document.getElementById('filterMappingDate').value;
        const shippedDate = document.getElementById('filterShippedDate').value;
        
        // ë¡œë”© í‘œì‹œ
        showLoading(true);
        hideStatus();
        
        // ì¿¼ë¦¬ ë¹Œë”
        let query = supabaseClient
          .from('vwtm_mapping')
          .select('*, shipping_batch')
          .order('mapping_date', { ascending: false });
        
        // í•„í„° ì ìš©
        if (palletNo) {
          query = query.ilike('pallet_no', `%${palletNo}%`);
        }
        
        if (tmNo) {
          query = query.ilike('tm_no', `%${tmNo}%`);
        }
        
        if (mappingDate) {
          const startDate = new Date(mappingDate);
          startDate.setHours(0, 0, 0, 0);
          const endDate = new Date(mappingDate);
          endDate.setHours(23, 59, 59, 999);
          
          query = query
            .gte('mapping_date', startDate.toISOString())
            .lte('mapping_date', endDate.toISOString());
        }
        
        if (shippedDate) {
          const startDate = new Date(shippedDate);
          startDate.setHours(0, 0, 0, 0);
          const endDate = new Date(shippedDate);
          endDate.setHours(23, 59, 59, 999);
          
          query = query
            .gte('shipping_date', startDate.toISOString())
            .lte('shipping_date', endDate.toISOString());
        }
        
        const { data, error } = await query;
        
        if (error) {
          throw error;
        }
        
        currentData = data || [];
        displayData(currentData);
        showStatus(`ê²€ìƒ‰ ì™„ë£Œ: ${currentData.length}ê±´`, 'success');
        
      } catch (error) {
        console.error('Error searching data:', error);
        showStatus('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        displayData([]);
      } finally {
        showLoading(false);
      }
    }
    
    // ë°ì´í„° í‘œì‹œ
    function displayData(data) {
      const tableBody = document.getElementById('dataTableBody');
      const tableContainer = document.getElementById('dataTableContainer');
      const emptyState = document.getElementById('emptyState');
      const resultCount = document.getElementById('resultCount');
      
      resultCount.textContent = data.length;
      
      if (data.length === 0) {
        tableContainer.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }
      
      tableContainer.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      tableBody.innerHTML = data.map(item => {
        const mappingDate = item.mapping_date 
          ? new Date(item.mapping_date).toISOString().slice(0, 10)
          : '-';
        const shippedDate = item.shipping_date 
          ? new Date(item.shipping_date).toISOString().slice(0, 10)
          : '-';
        const batch = item.shipping_batch ? `${item.shipping_batch}ì°¨` : '-';
        
        return `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${item.pallet_no || '-'}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${item.tm_no || '-'}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${mappingDate}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${shippedDate}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${batch}</td>
          </tr>
        `;
      }).join('');
    }
    
    // í•„í„° ì´ˆê¸°í™”
    function clearFilters() {
      document.getElementById('filterPalletNo').value = '';
      document.getElementById('filterTMNo').value = '';
      document.getElementById('filterMappingDate').value = '';
      document.getElementById('filterShippedDate').value = '';
      currentData = [];
      displayData([]);
      hideStatus();
    }
    
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë‚ ì§œ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
    window.showExportDateDialog = function() {
      // í•„í„° ê²€ìƒ‰ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
      const palletNo = document.getElementById('filterPalletNo').value.trim();
      const tmNo = document.getElementById('filterTMNo').value.trim();
      const mappingDate = document.getElementById('filterMappingDate').value;
      const shippedDate = document.getElementById('filterShippedDate').value;
      
      const hasFilter = palletNo || tmNo || mappingDate || shippedDate;
      
      // í•„í„°ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ëœ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
      if (hasFilter) {
        if (!currentData || currentData.length === 0) {
          showStatus('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ì„¸ìš”.', 'error');
          return;
        }
      }
      
      // í•­ìƒ ë‚ ì§œ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
      const dialog = document.getElementById('exportDateDialog');
      if (dialog) {
        dialog.classList.remove('hidden');
        // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        const today = new Date().toISOString().slice(0, 10);
        const dateInput = document.getElementById('exportShippedDate');
        if (dateInput) {
          dateInput.value = today;
        }
      }
    }
    
    // ì „ì²´ ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (í•„í„° ì—†ì„ ë•Œ)
    async function exportAllDataToExcel() {
      try {
        showStatus('ì „ì²´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
        
        if (!supabaseClient) {
          await initSupabase();
        }
        
        // ì „ì²´ ë°ì´í„° ì¡°íšŒ
        const { data, error } = await supabaseClient
          .from('vwtm_mapping')
          .select('*, shipping_batch')
          .order('mapping_date', { ascending: false });
        
        if (error) {
          throw error;
        }
        
        if (!data || data.length === 0) {
          showStatus('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
          return;
        }
        
        showStatus('Excel íŒŒì¼ ìƒì„± ì¤‘...', 'info');
        
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('All Data');
        
        // í—¤ë” ì¶”ê°€
        const headers = ['Pallet No', 'TM No', 'Mapping Date', 'Shipped Date', 'Batch'];
        const headerRow = worksheet.addRow(headers);
        headerRow.font = { bold: true };
        headerRow.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFE0E0E0' }
        };
        headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
        
        // ë°ì´í„° ì¶”ê°€
        data.forEach(item => {
          const mappingDate = item.mapping_date 
            ? new Date(item.mapping_date).toISOString().slice(0, 10)
            : '-';
          const shippedDate = item.shipping_date 
            ? new Date(item.shipping_date).toISOString().slice(0, 10)
            : '-';
          const batch = item.shipping_batch ? `${item.shipping_batch}ì°¨` : '-';
          
          worksheet.addRow([
            item.pallet_no || '-',
            item.tm_no || '-',
            mappingDate,
            shippedDate,
            batch
          ]);
        });
        
        // ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì •
        worksheet.columns[0].width = 15; // Pallet No
        worksheet.columns[1].width = 15; // TM No
        worksheet.columns[2].width = 15; // Mapping Date
        worksheet.columns[3].width = 15; // Shipped Date
        worksheet.columns[4].width = 10; // Batch
        
        // ë‚ ì§œ ì»¬ëŸ¼ í˜•ì‹ ì„¤ì •
        const mappingDateCol = worksheet.getColumn(3);
        const shippedDateCol = worksheet.getColumn(4);
        mappingDateCol.numFmt = 'yyyy-mm-dd';
        shippedDateCol.numFmt = 'yyyy-mm-dd';
        
        // ìë™ í•„í„° ì„¤ì •
        const headerRowNumber = worksheet.getRow(1).number;
        const lastRowNumber = worksheet.rowCount;
        worksheet.autoFilter = {
          from: { row: headerRowNumber, column: 1 },
          to: { row: lastRowNumber, column: 5 }
        };
        
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { 
          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        link.download = `Mapping_Report_All_${dateStr}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        showStatus('Excel ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
        
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        showStatus('Excel ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
      }
    }
    
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë‚ ì§œ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
    function closeExportDateDialog() {
      const dialog = document.getElementById('exportDateDialog');
      if (dialog) {
        dialog.classList.add('hidden');
      }
    }
    
    // Excel ë‹¤ìš´ë¡œë“œ
    async function exportToExcel() {
      const exportDateInput = document.getElementById('exportShippedDate');
      if (!exportDateInput || !exportDateInput.value) {
        showStatus('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      const selectedDate = exportDateInput.value;
      
      try {
        showStatus('Excel íŒŒì¼ ìƒì„± ì¤‘...', 'info');
        closeExportDateDialog();
        
        const workbook = new ExcelJS.Workbook();
        
        // 1. ì „ì²´ ë°ì´í„° ì‹œíŠ¸
        const worksheet = workbook.addWorksheet('All Data');
        
        // í—¤ë” ì¶”ê°€
        const headers = ['Pallet No', 'TM No', 'Mapping Date', 'Shipped Date', 'Batch'];
        const headerRow = worksheet.addRow(headers);
        headerRow.font = { bold: true };
        headerRow.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFE0E0E0' }
        };
        headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
        
        // í•„í„°ê°€ ì—†ìœ¼ë©´ ì „ì²´ ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ
        const palletNo = document.getElementById('filterPalletNo').value.trim();
        const tmNo = document.getElementById('filterTMNo').value.trim();
        const mappingDate = document.getElementById('filterMappingDate').value;
        const shippedDate = document.getElementById('filterShippedDate').value;
        
        const hasFilter = palletNo || tmNo || mappingDate || shippedDate;
        
        let dataToExport = currentData;
        
        // í•„í„°ê°€ ì—†ìœ¼ë©´ ì „ì²´ ë°ì´í„° ì¡°íšŒ
        if (!hasFilter) {
          if (!supabaseClient) {
            await initSupabase();
          }
          
          const { data, error } = await supabaseClient
            .from('vwtm_mapping')
            .select('*, shipping_batch')
            .order('mapping_date', { ascending: false });
          
          if (error) {
            throw error;
          }
          
          dataToExport = data || [];
        }
        
        // ë°ì´í„° ì¶”ê°€
        dataToExport.forEach(item => {
          const mappingDate = item.mapping_date 
            ? new Date(item.mapping_date).toISOString().slice(0, 10)
            : '-';
          const shippedDate = item.shipping_date 
            ? new Date(item.shipping_date).toISOString().slice(0, 10)
            : '-';
          const batch = item.shipping_batch ? `${item.shipping_batch}ì°¨` : '-';
          
          worksheet.addRow([
            item.pallet_no || '-',
            item.tm_no || '-',
            mappingDate,
            shippedDate,
            batch
          ]);
        });
        
        // ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì •
        worksheet.columns[0].width = 15; // Pallet No
        worksheet.columns[1].width = 15; // TM No
        worksheet.columns[2].width = 15; // Mapping Date
        worksheet.columns[3].width = 15; // Shipped Date
        worksheet.columns[4].width = 10; // Batch
        
        // ë‚ ì§œ ì»¬ëŸ¼ í˜•ì‹ ì„¤ì •
        const mappingDateCol = worksheet.getColumn(3);
        const shippedDateCol = worksheet.getColumn(4);
        mappingDateCol.numFmt = 'yyyy-mm-dd';
        shippedDateCol.numFmt = 'yyyy-mm-dd';
        
        // ìë™ í•„í„° ì„¤ì •
        const headerRowNumber = worksheet.getRow(1).number;
        const lastRowNumber = worksheet.rowCount;
        worksheet.autoFilter = {
          from: { row: headerRowNumber, column: 1 },
          to: { row: lastRowNumber, column: 5 }
        };
        
        // 2. ì„ íƒí•œ ë‚ ì§œì˜ Shipped Date ë§¤ì¹­ ë°ì´í„° ì‹œíŠ¸
        // ì„ íƒí•œ ë‚ ì§œì˜ shipped dateê°€ ìˆëŠ” ë°ì´í„° í•„í„°ë§ (ë‚ ì§œ ë¬¸ìì—´ë¡œ ë¹„êµ)
        const shippedData = dataToExport.filter(item => {
          if (!item.shipping_date) return false;
          
          // shipping_dateë¥¼ ë‚ ì§œ ë¬¸ìì—´ë¡œ ë³€í™˜ (YYYY-MM-DD í˜•ì‹)
          let shippingDateStr = '';
          try {
            if (item.shipping_date instanceof Date) {
              shippingDateStr = item.shipping_date.toISOString().slice(0, 10);
            } else if (typeof item.shipping_date === 'string') {
              // ISO ë¬¸ìì—´ì´ê±°ë‚˜ ë‚ ì§œ ë¬¸ìì—´ì¸ ê²½ìš°
              const dateObj = new Date(item.shipping_date);
              if (isNaN(dateObj.getTime())) {
                // ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ
                return false;
              }
              shippingDateStr = dateObj.toISOString().slice(0, 10);
            } else {
              return false;
            }
          } catch (e) {
            console.error('Error parsing shipping_date:', item.shipping_date, e);
            return false;
          }
          
          // ì„ íƒí•œ ë‚ ì§œì™€ ë¹„êµ (YYYY-MM-DD í˜•ì‹)
          const matches = shippingDateStr === selectedDate;
          return matches;
        });
        
        console.log(`Selected date: ${selectedDate}, Found ${shippedData.length} matching records out of ${dataToExport.length} total`);
        
        // ë‚ ì§œì™€ ì°¨ìˆ˜ë³„ë¡œ ê·¸ë£¹í™”
        const groupedData = {};
        shippedData.forEach(item => {
          const shippingDate = new Date(item.shipping_date).toISOString().slice(0, 10);
          const batch = item.shipping_batch || 0;
          const key = `${shippingDate}_${batch}`;
          
          if (!groupedData[key]) {
            groupedData[key] = {
              date: shippingDate,
              batch: batch,
              items: []
            };
          }
          groupedData[key].items.push(item);
        });
        
        // ë‚ ì§œì™€ ì°¨ìˆ˜ë³„ë¡œ ì •ë ¬
        const sortedGroups = Object.values(groupedData).sort((a, b) => {
          if (a.date !== b.date) {
            return a.date.localeCompare(b.date);
          }
          return a.batch - b.batch;
        });
        
        // ë³„ë„ ì‹œíŠ¸ ìƒì„± (ì„ íƒí•œ ë‚ ì§œë¡œ ì‹œíŠ¸ ì´ë¦„ ì„¤ì •) - í•­ìƒ ìƒì„±
        const shippedWorksheet = workbook.addWorksheet(selectedDate);
        
        if (sortedGroups.length > 0) {
          // ì „ì²´ í—¤ë” ì¶”ê°€ (í•„í„° ì ìš©ì„ ìœ„í•´)
          const headers = ['Date', 'Batch', 'Pallet No', 'TM No'];
          const headerRow = shippedWorksheet.addRow(headers);
          headerRow.font = { bold: true };
          headerRow.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE0E0E0' }
          };
          headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
          
          // ë°ì´í„° ì¶”ê°€ (ë‚ ì§œ, ì°¨ìˆ˜, íŒ”ë › ë²ˆí˜¸, TM ë²ˆí˜¸)
          sortedGroups.forEach(group => {
            group.items.forEach(item => {
              shippedWorksheet.addRow([
                group.date,
                `${group.batch}ì°¨`,
                item.pallet_no || '-',
                item.tm_no || '-'
              ]);
            });
          });
          
          // ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì •
          shippedWorksheet.columns[0].width = 15; // Date
          shippedWorksheet.columns[1].width = 12; // Batch
          shippedWorksheet.columns[2].width = 20; // Pallet No
          shippedWorksheet.columns[3].width = 20; // TM No
          
          // ë‚ ì§œ ì»¬ëŸ¼ í˜•ì‹ ì„¤ì •
          const shippedDateCol = shippedWorksheet.getColumn(1);
          shippedDateCol.numFmt = 'yyyy-mm-dd';
          
          // ìë™ í•„í„° ì„¤ì • (ì‹œíŠ¸ 2)
          const shippedHeaderRowNumber = headerRow.number;
          const shippedLastRowNumber = shippedWorksheet.rowCount;
          shippedWorksheet.autoFilter = {
            from: { row: shippedHeaderRowNumber, column: 1 },
            to: { row: shippedLastRowNumber, column: 4 }
          };
        } else {
          // ë°ì´í„°ê°€ ì—†ì„ ë•Œë„ ì‹œíŠ¸ëŠ” ìƒì„±í•˜ë˜ ë©”ì‹œì§€ í‘œì‹œ
          shippedWorksheet.addRow(['ì„ íƒí•œ ë‚ ì§œì— ë°°ì†¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.']);
        }
        
        // 3. ë‚ ì§œë³„ ìš”ì•½ ì‹œíŠ¸ (Shipping Date Summary)
        const summaryWorksheet = workbook.addWorksheet('Shipping Summary');
        
        // ì „ì²´ ë°ì´í„°ì—ì„œ shipping_dateê°€ ìˆëŠ” ë°ì´í„°ë§Œ í•„í„°ë§
        const allShippedData = dataToExport.filter(item => {
          if (!item.shipping_date) return false;
          try {
            const dateObj = new Date(item.shipping_date);
            return !isNaN(dateObj.getTime());
          } catch (e) {
            return false;
          }
        });
        
        // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ìš”ì•½ ë°ì´í„° ìƒì„±
        const dateSummary = {};
        allShippedData.forEach(item => {
          try {
            const shippingDate = new Date(item.shipping_date).toISOString().slice(0, 10);
            const batch = item.shipping_batch || 0;
            
            if (!dateSummary[shippingDate]) {
              dateSummary[shippingDate] = {
                date: shippingDate,
                batches: new Set(),
                tmCount: 0
              };
            }
            
            dateSummary[shippingDate].batches.add(batch);
            dateSummary[shippingDate].tmCount++;
          } catch (e) {
            console.error('Error processing item for summary:', item, e);
          }
        });
        
        // ë‚ ì§œë³„ë¡œ ì •ë ¬
        const sortedSummary = Object.values(dateSummary).sort((a, b) => {
          return a.date.localeCompare(b.date);
        });
        
        // í—¤ë” ì¶”ê°€
        const summaryHeaders = ['Shipping Date', 'ì°¨ëŸ‰ìˆ˜', 'TM Qty'];
        const summaryHeaderRow = summaryWorksheet.addRow(summaryHeaders);
        summaryHeaderRow.font = { bold: true };
        summaryHeaderRow.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFE0E0E0' }
        };
        summaryHeaderRow.alignment = { horizontal: 'center', vertical: 'middle' };
        
        // ë°ì´í„° ì¶”ê°€
        sortedSummary.forEach(summary => {
          const batchCount = summary.batches.size;
          summaryWorksheet.addRow([
            summary.date,
            batchCount,
            summary.tmCount
          ]);
        });
        
        // ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì •
        summaryWorksheet.columns[0].width = 15; // Shipping Date
        summaryWorksheet.columns[1].width = 12; // ì°¨ëŸ‰ìˆ˜
        summaryWorksheet.columns[2].width = 12; // TM Qty
        
        // ë‚ ì§œ ì»¬ëŸ¼ í˜•ì‹ ì„¤ì •
        const summaryDateCol = summaryWorksheet.getColumn(1);
        summaryDateCol.numFmt = 'yyyy-mm-dd';
        
        // ìˆ«ì ì»¬ëŸ¼ í˜•ì‹ ì„¤ì •
        const batchCountCol = summaryWorksheet.getColumn(2);
        const tmQtyCol = summaryWorksheet.getColumn(3);
        batchCountCol.numFmt = '0';
        tmQtyCol.numFmt = '0';
        
        // ìë™ í•„í„° ì„¤ì • (ì‹œíŠ¸ 3)
        const summaryHeaderRowNumber = summaryWorksheet.getRow(1).number;
        const summaryLastRowNumber = summaryWorksheet.rowCount;
        summaryWorksheet.autoFilter = {
          from: { row: summaryHeaderRowNumber, column: 1 },
          to: { row: summaryLastRowNumber, column: 3 }
        };
        
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { 
          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const dateStr = selectedDate.replace(/-/g, '');
        link.download = `Mapping_Report_${dateStr}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        showStatus('Excel ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
        
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        showStatus('Excel ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
      }
    }
    
    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      if (!statusDiv) return;
      
      statusDiv.classList.remove('hidden');
      
      const colors = {
        success: 'bg-green-100 border-green-500 text-green-800',
        error: 'bg-red-100 border-red-500 text-red-800',
        info: 'bg-blue-100 border-blue-500 text-blue-800'
      };
      
      statusDiv.className = `p-3 rounded-lg border-2 ${colors[type] || colors.info} font-semibold text-sm`;
      statusDiv.textContent = message;
    }
    
    // ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
    function hideStatus() {
      const statusDiv = document.getElementById('statusMessage');
      if (statusDiv) {
        statusDiv.classList.add('hidden');
      }
    }
    
    // ë¡œë”© í‘œì‹œ
    function showLoading(show) {
      const loading = document.getElementById('loadingIndicator');
      const tableContainer = document.getElementById('dataTableContainer');
      const emptyState = document.getElementById('emptyState');
      
      if (show) {
        loading.classList.remove('hidden');
        tableContainer.classList.add('hidden');
        emptyState.classList.add('hidden');
      } else {
        loading.classList.add('hidden');
      }
    }
    
    // Enter í‚¤ë¡œ ê²€ìƒ‰
    document.addEventListener('DOMContentLoaded', async function() {
      await initSupabase();
      
      // Enter í‚¤ ì´ë²¤íŠ¸
      const inputs = ['filterPalletNo', 'filterTMNo', 'filterMappingDate', 'filterShippedDate'];
      inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              searchData();
            }
          });
        }
      });
    });
  </script>
</body>
</html>
