<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pallet Generate - Return TM Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    @media print {
      @page {
        size: letter landscape; /* ê¸°ë³¸ê°’, JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë³€ê²½ë¨ */
        margin: 0 !important;
        /* í—¤ë”ì™€ í‘¸í„° ì™„ì „ ì œê±° */
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        /* ë¸Œë¼ìš°ì € ê¸°ë³¸ í—¤ë”/í‘¸í„° ì œê±° */
        marks: none;
      }
      /* ë¸Œë¼ìš°ì € ê¸°ë³¸ í—¤ë”/í‘¸í„° ì œê±° */
      @page {
        @top-center { content: ""; }
        @top-left { content: ""; }
        @top-right { content: ""; }
        @bottom-center { content: ""; }
        @bottom-left { content: ""; }
        @bottom-right { content: ""; }
      }
      html, body {
        margin: 0 !important;
        padding: 0 !important;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      body * {
        visibility: hidden;
      }
      #printArea, #printArea * {
        visibility: visible;
      }
      #printArea {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: block;
        page-break-inside: avoid;
        box-sizing: border-box;
        margin: 0 !important;
        padding: 0 !important;
      }
      .no-print {
        display: none !important;
      }
      /* ë ˆí„°ìš©ì§€ í¬ê¸° (ê¸°ë³¸) */
      .pallet-label.paper-letter {
        width: 11in;
        height: 8.5in;
        padding: 0.5in;
      }
      /* 8ì¸ì¹˜ x 6ì¸ì¹˜ í¬ê¸° */
      .pallet-label.paper-8x6 {
        width: 8in;
        height: 6in;
        padding: 0.3in;
      }
      .pallet-label {
        page-break-after: always;
        page-break-before: auto;
        page-break-inside: avoid;
        break-after: page;
        break-inside: avoid;
        margin: 0 !important;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
      }
      .pallet-label:last-child {
        page-break-after: auto;
        break-after: auto;
      }
    }
    
    .pallet-label {
      /* ê¸°ë³¸ í¬ê¸° (ë ˆí„°ìš©ì§€) */
      width: 11in;
      height: 8.5in;
      padding: 0.5in;
      border: 3px solid #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
      margin: 0 auto;
    }
    
    /* 8ì¸ì¹˜ x 6ì¸ì¹˜ í¬ê¸° */
    .pallet-label.paper-8x6 {
      width: 8in;
      height: 6in;
      padding: 0.3in;
    }
    
    /* ë ˆí„°ìš©ì§€ í¬ê¸° */
    .pallet-label.paper-letter {
      width: 11in;
      height: 8.5in;
      padding: 0.5in;
    }
    
    .pallet-number {
      font-size: 96px;
      font-weight: bold;
      margin-bottom: 40px;
      letter-spacing: 4px;
    }
    
    .barcode-container {
      margin-top: 30px;
    }
    
    .barcode-container svg {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Pallet Generate</h2>
      <p class="text-gray-600">Return TM Management - Pallet ìƒì„± ë° ê´€ë¦¬</p>
    </div>

    <!-- Generate Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
      <h3 class="text-xl font-bold text-gray-800 mb-4">íŒ”ë › ìƒì„±</h3>
      <div class="space-y-4">
        <div class="flex items-end space-x-4">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">ìƒì„±í•  ê°œìˆ˜</label>
            <input 
              type="number" 
              id="generateCount" 
              min="1" 
              max="1000" 
              value="1" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="ìƒì„±í•  íŒ”ë › ê°œìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <button 
            onclick="generatePallets()" 
            id="generateBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors"
          >
            ìƒì„±
          </button>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">í”„ë¦°íŠ¸ ìš©ì§€ í¬ê¸°</label>
          <div class="flex space-x-4">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input 
                type="radio" 
                name="paperSize" 
                value="letter" 
                checked
                onchange="updatePaperSize('letter')"
                class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
              />
              <span class="text-sm text-gray-700">ë ˆí„°ìš©ì§€ (8.5" x 11")</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input 
                type="radio" 
                name="paperSize" 
                value="8x6" 
                onchange="updatePaperSize('8x6')"
                class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
              />
              <span class="text-sm text-gray-700">8" x 6"</span>
            </label>
          </div>
        </div>
      </div>
      <div id="generateStatus" class="mt-4"></div>
    </div>

    <!-- Generated Pallets List -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center space-x-4">
          <h3 class="text-xl font-bold text-gray-800">ìƒì„±ëœ íŒ”ë › ëª©ë¡</h3>
          <button 
            onclick="loadPallets()" 
            class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors"
          >
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
        <div class="flex items-center space-x-2">
          <button 
            onclick="printSelectedPallets()" 
            id="printSelectedBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            ì„ íƒ í”„ë¦°íŠ¸
          </button>
          <button 
            onclick="printAllPallets()" 
            id="printAllBtn"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            ì „ì²´ í”„ë¦°íŠ¸
          </button>
        </div>
      </div>
      <div class="mb-4 flex items-center space-x-2">
        <input 
          type="checkbox" 
          id="selectAllCheckbox" 
          onchange="toggleSelectAll(this.checked)"
          class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
        />
        <label for="selectAllCheckbox" class="text-sm font-medium text-gray-700 cursor-pointer">
          ì „ì²´ ì„ íƒ
        </label>
        <span id="selectedCount" class="text-sm text-gray-600 ml-4"></span>
      </div>
      <div id="palletList" class="space-y-2">
        <div class="text-center text-gray-500 py-8">
          ìƒì„±ëœ íŒ”ë ›ì´ ì—†ìŠµë‹ˆë‹¤
        </div>
      </div>
    </div>

    <!-- Print Area (Hidden until print) -->
    <div id="printArea" class="print-area hidden"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://wfnihtmmaebgjtdmazmo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmbmlodG1tYWViZ2p0ZG1hem1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTY3NTcsImV4cCI6MjA2NTMzMjc1N30.FYfdgSvOT1qUvANGlqXCEGvSR2JujggU7T_Sjzys3HQ';
    
    let supabaseClient = null;
    let generatedPallets = [];
    let currentPaperSize = 'letter'; // 'letter' ë˜ëŠ” '8x6'

    // Supabase ì´ˆê¸°í™”
    async function initSupabase() {
      try {
        if (typeof window.supabase !== 'undefined') {
          supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else if (typeof supabase !== 'undefined') {
          supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
          throw new Error('Supabase library not loaded');
        }
        console.log('âœ… Supabase initialized');
        return true;
      } catch (error) {
        console.error('âŒ Supabase initialization failed:', error);
        return false;
      }
    }

    // ë‹¤ìŒ íŒ”ë › ë²ˆí˜¸ë“¤ ê°€ì ¸ì˜¤ê¸° (ì¼ê´„ ìƒì„±ìš©)
    async function getNextPalletNumbers(count) {
      try {
        // DBì—ì„œ ê°€ì¥ í° ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        const { data, error } = await supabaseClient
          .from('vwtm_pallet_generate')
          .select('pallet_no')
          .order('id', { ascending: false })
          .limit(1);

        if (error && error.code !== 'PGRST116') { // PGRST116ì€ í…Œì´ë¸”ì´ ì—†ì„ ë•Œ
          throw error;
        }

        let startNumber = 1;
        if (data && data.length > 0) {
          const lastPalletNo = data[0].pallet_no;
          if (lastPalletNo && lastPalletNo.startsWith('VWRT')) {
            const numberPart = parseInt(lastPalletNo.substring(4));
            if (!isNaN(numberPart)) {
              startNumber = numberPart + 1;
            }
          }
        }

        // ì—°ì†ëœ ë²ˆí˜¸ë“¤ ìƒì„±
        const palletNumbers = [];
        for (let i = 0; i < count; i++) {
          palletNumbers.push(`VWRT${String(startNumber + i).padStart(4, '0')}`);
        }

        return palletNumbers;
      } catch (error) {
        console.error('Error getting next pallet numbers:', error);
        // í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ 1ë¶€í„° ì‹œì‘
        const palletNumbers = [];
        for (let i = 0; i < count; i++) {
          palletNumbers.push(`VWRT${String(i + 1).padStart(4, '0')}`);
        }
        return palletNumbers;
      }
    }

    // íŒ”ë › ìƒì„±
    async function generatePallets() {
      const countInput = document.getElementById('generateCount');
      const generateBtn = document.getElementById('generateBtn');
      const statusDiv = document.getElementById('generateStatus');
      
      const count = parseInt(countInput.value);
      
      if (!count || count < 1 || count > 1000) {
        statusDiv.innerHTML = '<div class="text-red-600">1ë¶€í„° 1000ê¹Œì§€ì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>';
        return;
      }

      generateBtn.disabled = true;
      generateBtn.textContent = 'ìƒì„± ì¤‘...';
      statusDiv.innerHTML = '<div class="text-blue-600">íŒ”ë › ìƒì„± ì¤‘...</div>';

      try {
        if (!supabaseClient) {
          await initSupabase();
        }

        // ì¼ê´„ë¡œ íŒ”ë › ë²ˆí˜¸ ìƒì„±
        const palletNumbers = await getNextPalletNumbers(count);
        
        // DBì— ì¼ê´„ ì €ì¥
        const insertData = palletNumbers.map(palletNo => ({
          pallet_no: palletNo,
          created_at: new Date().toISOString(),
          print_count: 0
        }));

        const { data, error } = await supabaseClient
          .from('vwtm_pallet_generate')
          .insert(insertData)
          .select();

        if (error) {
          // í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„± ì‹œë„
          if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
            console.warn('Table does not exist, creating...');
            // í…Œì´ë¸” ìƒì„±ì€ ìˆ˜ë™ìœ¼ë¡œ í•´ì•¼ í•¨
            throw new Error('íŒ”ë › í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ì— vwtm_pallet_generate í…Œì´ë¸”ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
          }
          throw error;
        }

        const newPallets = data.map(item => ({
          id: item.id,
          pallet_no: item.pallet_no,
          created_at: item.created_at,
          print_count: item.print_count || 0
        }));

        generatedPallets = [...generatedPallets, ...newPallets];
        updatePalletList();
        
        statusDiv.innerHTML = `<div class="text-green-600">âœ… ${count}ê°œì˜ íŒ”ë ›ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í”„ë¦°íŠ¸ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤...</div>`;
        countInput.value = '1';
        
        // ìƒì„± í›„ ìë™ìœ¼ë¡œ í”„ë¦°íŠ¸
        setTimeout(() => {
          printNewPallets(newPallets);
        }, 500);
        
      } catch (error) {
        console.error('Error generating pallets:', error);
        statusDiv.innerHTML = `<div class="text-red-600">âŒ ì˜¤ë¥˜: ${error.message}</div>`;
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'ìƒì„±';
      }
    }

    // íŒ”ë › ëª©ë¡ ì—…ë°ì´íŠ¸
    function updatePalletList() {
      const listDiv = document.getElementById('palletList');
      const printAllBtn = document.getElementById('printAllBtn');
      
      if (generatedPallets.length === 0) {
        listDiv.innerHTML = '<div class="text-center text-gray-500 py-8">ìƒì„±ëœ íŒ”ë ›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        printAllBtn.disabled = true;
        return;
      }

      printAllBtn.disabled = false;
      
      listDiv.innerHTML = generatedPallets.map((pallet, index) => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
          <div class="flex items-center space-x-4">
            <input 
              type="checkbox" 
              class="pallet-checkbox w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
              data-index="${index}"
              onchange="updateSelectedCount()"
            />
            <div class="text-2xl">ğŸ“¦</div>
            <div>
              <div class="font-bold text-lg text-gray-800">${pallet.pallet_no}</div>
              <div class="text-sm text-gray-600">
                ìƒì„±ì¼: ${new Date(pallet.created_at).toLocaleString('ko-KR')} | 
                í”„ë¦°íŠ¸: ${pallet.print_count || 0}íšŒ
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <button 
              onclick="printPallet(${index})" 
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors"
            >
              ${pallet.print_count > 0 ? 'ë¦¬í”„ë¦°íŠ¸' : 'í”„ë¦°íŠ¸'}
            </button>
            <button 
              onclick="deletePallet(${index})" 
              class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors"
            >
              ì‚­ì œ
            </button>
          </div>
        </div>
      `).join('');
      
      updateSelectedCount();
    }
    
    // ì „ì²´ ì„ íƒ/í•´ì œ
    function toggleSelectAll(checked) {
      const checkboxes = document.querySelectorAll('.pallet-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
      });
      updateSelectedCount();
    }
    
    // ì„ íƒëœ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.pallet-checkbox:checked');
      const selectedCount = checkboxes.length;
      const countSpan = document.getElementById('selectedCount');
      const printSelectedBtn = document.getElementById('printSelectedBtn');
      
      if (countSpan) {
        if (selectedCount > 0) {
          countSpan.textContent = `${selectedCount}ê°œ ì„ íƒë¨`;
        } else {
          countSpan.textContent = '';
        }
      }
      
      if (printSelectedBtn) {
        printSelectedBtn.disabled = selectedCount === 0;
      }
      
      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) {
        const allCheckboxes = document.querySelectorAll('.pallet-checkbox');
        selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedCount === allCheckboxes.length;
        selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < allCheckboxes.length;
      }
    }
    
    // ì„ íƒëœ íŒ”ë ›ë“¤ í”„ë¦°íŠ¸
    function printSelectedPallets() {
      const checkboxes = document.querySelectorAll('.pallet-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('ì„ íƒëœ íŒ”ë ›ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const selectedPallets = Array.from(checkboxes).map(checkbox => {
        const index = parseInt(checkbox.getAttribute('data-index'));
        return generatedPallets[index];
      }).filter(pallet => pallet !== undefined);
      
      if (selectedPallets.length === 0) {
        alert('ì„ íƒëœ íŒ”ë ›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      printPallets(selectedPallets);
    }
    
    // ìš©ì§€ í¬ê¸° ì—…ë°ì´íŠ¸
    function updatePaperSize(size) {
      currentPaperSize = size;
    }
    
    // íŒ”ë ›ë“¤ í”„ë¦°íŠ¸ (ê³µí†µ í•¨ìˆ˜)
    function printPallets(pallets) {
      if (!pallets || pallets.length === 0) return;

      const printArea = document.getElementById('printArea');
      printArea.innerHTML = '';
      printArea.classList.remove('hidden');
      printArea.style.display = 'block';
      printArea.style.width = '100%';
      printArea.style.boxSizing = 'border-box';
      
      // ë™ì ìœ¼ë¡œ @page ìŠ¤íƒ€ì¼ ì¶”ê°€
      let styleId = 'dynamic-page-size';
      let existingStyle = document.getElementById(styleId);
      if (existingStyle) {
        existingStyle.remove();
      }
      
      const style = document.createElement('style');
      style.id = styleId;
      if (currentPaperSize === '8x6') {
        style.textContent = `
          @media print {
            @page {
              size: 8in 6in;
              margin: 0 !important;
              marks: none;
            }
            @page {
              @top-center { content: ""; }
              @top-left { content: ""; }
              @top-right { content: ""; }
              @bottom-center { content: ""; }
              @bottom-left { content: ""; }
              @bottom-right { content: ""; }
            }
          }
        `;
      } else {
        style.textContent = `
          @media print {
            @page {
              size: letter landscape;
              margin: 0 !important;
              marks: none;
            }
            @page {
              @top-center { content: ""; }
              @top-left { content: ""; }
              @top-right { content: ""; }
              @bottom-center { content: ""; }
              @bottom-left { content: ""; }
              @bottom-right { content: ""; }
            }
          }
        `;
      }
      document.head.appendChild(style);
      
      // ê° íŒ”ë › ë¼ë²¨ ì¶”ê°€
      pallets.forEach(pallet => {
        const labelDiv = document.createElement('div');
        labelDiv.className = `pallet-label paper-${currentPaperSize}`;
        labelDiv.innerHTML = `
          <div class="pallet-number">${pallet.pallet_no}</div>
          <div class="barcode-container">
            <svg id="barcode-${pallet.pallet_no}"></svg>
          </div>
        `;
        printArea.appendChild(labelDiv);
      });

      // DOMì´ ì™„ì „íˆ ë Œë”ë§ëœ í›„ ë°”ì½”ë“œ ìƒì„±
      requestAnimationFrame(() => {
        setTimeout(() => {
          // ë°”ì½”ë“œ ìƒì„±
          pallets.forEach(pallet => {
            generateBarcode(`#barcode-${pallet.pallet_no}`, pallet.pallet_no);
          });
          
          // ë°”ì½”ë“œ ìƒì„± í›„ í”„ë¦°íŠ¸
          setTimeout(() => {
            window.print();
            
            // í”„ë¦°íŠ¸ íšŸìˆ˜ ì—…ë°ì´íŠ¸
            pallets.forEach(pallet => {
              updatePrintCount(pallet.id);
            });
            
            // í”„ë¦°íŠ¸ í›„ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
              printArea.classList.add('hidden');
              printArea.innerHTML = '';
              printArea.style.display = '';
            }, 500);
          }, 300);
        }, 200);
      });
    }

    // ìƒˆë¡œ ìƒì„±ëœ íŒ”ë ›ë“¤ í”„ë¦°íŠ¸
    function printNewPallets(pallets) {
      if (!pallets || pallets.length === 0) return;

      const printArea = document.getElementById('printArea');
      printArea.innerHTML = '';
      printArea.classList.remove('hidden');
      printArea.style.display = 'block';
      printArea.style.width = '100%';
      printArea.style.boxSizing = 'border-box';
      
      // ê° íŒ”ë › ë¼ë²¨ ì¶”ê°€
      pallets.forEach(pallet => {
        const labelDiv = document.createElement('div');
        labelDiv.className = `pallet-label paper-${currentPaperSize}`;
        labelDiv.innerHTML = `
          <div class="pallet-number">${pallet.pallet_no}</div>
          <div class="barcode-container">
            <svg id="barcode-${pallet.pallet_no}"></svg>
          </div>
        `;
        printArea.appendChild(labelDiv);
      });

      // DOMì´ ì™„ì „íˆ ë Œë”ë§ëœ í›„ ë°”ì½”ë“œ ìƒì„±
      requestAnimationFrame(() => {
        setTimeout(() => {
          // ë°”ì½”ë“œ ìƒì„±
          pallets.forEach(pallet => {
            generateBarcode(`#barcode-${pallet.pallet_no}`, pallet.pallet_no);
          });
          
          // ë°”ì½”ë“œ ìƒì„± í›„ í”„ë¦°íŠ¸
          setTimeout(() => {
            window.print();
            
            // í”„ë¦°íŠ¸ íšŸìˆ˜ ì—…ë°ì´íŠ¸
            pallets.forEach(pallet => {
              updatePrintCount(pallet.id);
            });
            
            // í”„ë¦°íŠ¸ í›„ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
              printArea.classList.add('hidden');
              printArea.innerHTML = '';
              printArea.style.display = '';
            }, 500);
          }, 300);
        }, 200);
      });
    }

    // íŒ”ë › í”„ë¦°íŠ¸
    function printPallet(index) {
      const pallet = generatedPallets[index];
      if (!pallet) return;

      const printArea = document.getElementById('printArea');
      printArea.innerHTML = '';
      printArea.classList.remove('hidden');
      printArea.style.display = 'block';
      printArea.style.width = '100%';
      printArea.style.boxSizing = 'border-box';
      
      const labelDiv = document.createElement('div');
      labelDiv.className = 'pallet-label';
        labelDiv.innerHTML = `
          <div class="pallet-number">${pallet.pallet_no}</div>
          <div class="barcode-container">
            <svg id="barcode-${pallet.pallet_no}"></svg>
          </div>
        `;
      printArea.appendChild(labelDiv);
      
      // DOMì´ ì™„ì „íˆ ë Œë”ë§ëœ í›„ ë°”ì½”ë“œ ìƒì„±
      requestAnimationFrame(() => {
        setTimeout(() => {
            // ë°”ì½”ë“œ ìƒì„± í›„ í”„ë¦°íŠ¸
            setTimeout(() => {
              if (generateBarcode(`#barcode-${pallet.pallet_no}`, pallet.pallet_no)) {
                // ë°”ì½”ë“œ ìƒì„± í›„ í”„ë¦°íŠ¸
                setTimeout(() => {
                  // í”„ë¦°íŠ¸ ì „ì— í—¤ë”/í‘¸í„° ì œê±°ë¥¼ ìœ„í•œ ì„¤ì •
                  window.print();
                  
                  // í”„ë¦°íŠ¸ íšŸìˆ˜ ì—…ë°ì´íŠ¸
                  updatePrintCount(pallet.id);
                  
                  // í”„ë¦°íŠ¸ í›„ ìˆ¨ê¸°ê¸°
                  setTimeout(() => {
                    printArea.classList.add('hidden');
                    printArea.innerHTML = '';
                    printArea.style.display = '';
                  }, 500);
                }, 300);
              } else {
                alert('ë°”ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              }
            }, 200);
        }, 200);
      });
    }

    // ì „ì²´ íŒ”ë › í”„ë¦°íŠ¸
    function printAllPallets() {
      if (generatedPallets.length === 0) return;
      printPallets(generatedPallets);
    }


    // í”„ë¦°íŠ¸ íšŸìˆ˜ ì—…ë°ì´íŠ¸
    async function updatePrintCount(palletId) {
      try {
        const pallet = generatedPallets.find(p => p.id === palletId);
        if (!pallet) return;

        pallet.print_count = (pallet.print_count || 0) + 1;

        await supabaseClient
          .from('vwtm_pallet_generate')
          .update({ print_count: pallet.print_count })
          .eq('id', palletId);
      } catch (error) {
        console.error('Error updating print count:', error);
      }
    }

    // íŒ”ë › ì‚­ì œ
    async function deletePallet(index) {
      if (!confirm('ì´ íŒ”ë ›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const pallet = generatedPallets[index];
      if (!pallet) return;

      try {
        await supabaseClient
          .from('vwtm_pallet_generate')
          .delete()
          .eq('id', pallet.id);

        generatedPallets.splice(index, 1);
        updatePalletList();
      } catch (error) {
        console.error('Error deleting pallet:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // íŒ”ë › ëª©ë¡ ë¡œë“œ
    async function loadPallets() {
      try {
        if (!supabaseClient) {
          await initSupabase();
        }

        const { data, error } = await supabaseClient
          .from('vwtm_pallet_generate')
          .select('*')
          .order('id', { ascending: false })
          .limit(100);

        if (error) {
          if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
            generatedPallets = [];
            updatePalletList();
            return;
          }
          throw error;
        }

        generatedPallets = data.map(item => ({
          id: item.id,
          pallet_no: item.pallet_no,
          created_at: item.created_at,
          print_count: item.print_count || 0
        }));

        updatePalletList();
      } catch (error) {
        console.error('Error loading pallets:', error);
        generatedPallets = [];
        updatePalletList();
      }
    }

    // 1D ë°”ì½”ë“œ ìƒì„± í•¨ìˆ˜
    function generateBarcode(svgId, text) {
      try {
        if (typeof JsBarcode === 'undefined') {
          console.error('JsBarcode library not loaded');
          return false;
        }

        JsBarcode(svgId, text, {
          format: "CODE128",
          width: 2.5,
          height: 120,
          displayValue: true,
          fontSize: 32,
          margin: 15
        });
        return true;
      } catch (error) {
        console.error('Error generating barcode:', error);
        return false;
      }
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', async function() {
      await initSupabase();
      await loadPallets();
      
      // JsBarcode ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
      if (typeof JsBarcode !== 'undefined') {
        console.log('âœ… JsBarcode library loaded');
      } else {
        console.warn('âš ï¸ JsBarcode library not loaded');
      }
      
      // ì—”í„° í‚¤ë¡œ ìƒì„±
      document.getElementById('generateCount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          generatePallets();
        }
      });
    });
  </script>
</body>
</html>
