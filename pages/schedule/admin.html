<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packaging Schedule - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
    <style>
        .schedule-item {
            transition: all 0.3s ease;
        }
        
        .schedule-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .status-badge {
            transition: all 0.3s ease;
        }
        
        .status-completed {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .status-active {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .status-waiting {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }
        
        .round-header {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="h-screen flex flex-col p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border p-4 mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">포장 스케줄 관리</h1>
                    <p class="text-gray-600 text-sm">Packaging Schedule Administration</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="addNewSchedule()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                        + 새 스케줄
                    </button>
                    <button onclick="refreshData()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                        🔄 새로고침
                    </button>
                </div>
            </div>
        </div>

        <!-- Date Selector and Statistics -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
            <!-- Date Selector -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="space-y-2">
                    <label class="text-sm font-semibold text-gray-700">날짜 선택</label>
                    <div class="flex space-x-2">
                        <input type="date" id="dateSelector" class="border border-gray-300 rounded-lg px-3 py-2 text-sm flex-1" onchange="loadScheduleForDate()">
                        <button onclick="loadTodaySchedule()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-semibold">
                            오늘
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="text-2xl font-bold text-blue-600" id="totalRounds">0</div>
                <div class="text-sm text-gray-600">총 차수</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="text-2xl font-bold text-green-600" id="completedRounds">0</div>
                <div class="text-sm text-gray-600">완료된 차수</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="text-2xl font-bold text-yellow-600" id="activeRounds">0</div>
                <div class="text-sm text-gray-600">진행 중인 차수</div>
            </div>
        </div>

        <!-- Schedule Management -->
        <div class="bg-white rounded-lg shadow-sm border flex-1 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">스케줄 편집 테이블</h2>
                        <p class="text-gray-600 text-sm">차수별 파트 스케줄을 관리하세요</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="addNewRow()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-semibold">
                            + 행 추가
                        </button>
                        <button onclick="saveSchedule()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-semibold">
                            💾 저장
                        </button>
                        <button onclick="loadScheduleToTable()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm font-semibold">
                            🔄 새로고침
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 p-4">
                <div id="scheduleTable" class="h-full border border-gray-300 rounded-lg">
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                            <p>테이블 로딩 중...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden schedule container for compatibility -->
        <div id="scheduleContainer" style="display: none;"></div>

        <!-- Add/Edit Schedule Modal -->
        <div id="scheduleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 w-full max-w-md mx-4">
                <h3 class="text-2xl font-bold text-gray-900 mb-6" id="modalTitle">새 스케줄 추가</h3>
                
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">차수</label>
                        <input type="number" id="roundNumber" class="w-full border border-gray-300 rounded-lg px-4 py-2" min="1" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">파트 번호</label>
                        <select id="partNumber" class="w-full border border-gray-300 rounded-lg px-4 py-2" required>
                            <option value="">파트 선택</option>
                            <option value="3T24">3T24</option>
                            <option value="3T33">3T33</option>
                            <option value="3T34">3T34</option>
                            <option value="3T35">3T35</option>
                            <option value="7Z79">7Z79</option>
                            <option value="7Z80">7Z80</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">시작 시간</label>
                            <input type="time" id="startTime" class="w-full border border-gray-300 rounded-lg px-4 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">종료 시간</label>
                            <input type="time" id="endTime" class="w-full border border-gray-300 rounded-lg px-4 py-2" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">상태</label>
                        <select id="status" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            <option value="waiting">대기</option>
                            <option value="active">진행 중</option>
                            <option value="completed">완료</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            취소
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            저장
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        let supabase;
        let scheduleData = [];
        let selectedDate = new Date().toISOString().split('T')[0];
        let editingItem = null;
        let hot = null; // Handsontable instance

        // Initialize the admin page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin page DOM loaded');
            initializeSupabase();
            setupDateSelector();
            
            // Try to initialize Handsontable immediately
            const handsontableSuccess = initializeHandsontable();
            if (!handsontableSuccess) {
                console.log('Handsontable failed, will use fallback table');
            }
            loadScheduleForDate();
        });

        // Initialize Supabase connection
        async function initializeSupabase() {
            try {
                const { createClient } = supabase;
                supabase = createClient(
                    'https://your-project.supabase.co',
                    'your-anon-key'
                );
                console.log('Supabase initialized for schedule admin');
            } catch (error) {
                console.error('Supabase initialization failed:', error);
                // Use mock data for development
                loadMockData();
            }
        }

        // Setup date selector
        function setupDateSelector() {
            const dateSelector = document.getElementById('dateSelector');
            dateSelector.value = selectedDate;
        }

        // Load schedule for selected date
        async function loadScheduleForDate() {
            selectedDate = document.getElementById('dateSelector').value;
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('packaging_schedule')
                        .select('*')
                        .eq('date', selectedDate)
                        .order('round_number', { ascending: true });
                    
                    if (error) throw error;
                    scheduleData = data || [];
                } else {
                    loadMockData();
                }
                
                displaySchedule();
                loadScheduleToTable();
                updateStatistics();
            } catch (error) {
                console.error('Error loading schedule data:', error);
                loadMockData();
            }
        }

        // Load today's schedule
        function loadTodaySchedule() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateSelector').value = today;
            selectedDate = today;
            loadScheduleForDate();
        }

        // Initialize Handsontable
        function initializeHandsontable() {
            const container = document.getElementById('scheduleTable');
            
            if (!container) {
                console.error('Schedule table container not found');
                return false;
            }
            
            console.log('Initializing Handsontable...');
            
            // Check if Handsontable is available
            if (typeof Handsontable === 'undefined') {
                console.error('Handsontable is not loaded');
                return false;
            }
            
            try {
                hot = new Handsontable(container, {
                data: [],
                colHeaders: ['차수', '파트', '시작', '종료', '상태', 'ID'],
                columns: [
                    {
                        type: 'numeric',
                        data: 'round_number',
                        width: 60,
                        validator: function(value, callback) {
                            if (value === null || value === undefined || value === '') {
                                callback(false);
                            } else if (value < 1) {
                                callback(false);
                            } else {
                                callback(true);
                            }
                        }
                    },
                    {
                        type: 'dropdown',
                        data: 'part_number',
                        source: ['3T24', '3T33', '3T34', '3T35', '7Z79', '7Z80'],
                        width: 100,
                        strict: true
                    },
                    {
                        type: 'time',
                        data: 'start_time',
                        width: 100,
                        timeFormat: 'HH:mm',
                        correctFormat: true
                    },
                    {
                        type: 'time',
                        data: 'end_time',
                        width: 100,
                        timeFormat: 'HH:mm',
                        correctFormat: true
                    },
                    {
                        type: 'dropdown',
                        data: 'status',
                        source: ['waiting', 'active', 'completed'],
                        width: 80,
                        strict: true,
                        renderer: function(instance, td, row, col, prop, value, cellProperties) {
                            const statusMap = {
                                'waiting': '대기',
                                'active': '진행 중',
                                'completed': '완료'
                            };
                            td.textContent = statusMap[value] || value;
                            td.style.textAlign = 'center';
                            
                            // 상태별 색상 적용
                            if (value === 'active') {
                                td.style.backgroundColor = '#fef3c7';
                                td.style.color = '#92400e';
                            } else if (value === 'completed') {
                                td.style.backgroundColor = '#d1fae5';
                                td.style.color = '#065f46';
                            } else {
                                td.style.backgroundColor = '#f3f4f6';
                                td.style.color = '#374151';
                            }
                        }
                    },
                    {
                        data: 'id',
                        width: 50,
                        readOnly: true,
                        renderer: function(instance, td, row, col, prop, value, cellProperties) {
                            td.textContent = value || '';
                            td.style.textAlign = 'center';
                            td.style.color = '#6b7280';
                        }
                    }
                ],
                width: '100%',
                height: '100%',
                rowHeaders: true,
                colWidths: [60, 100, 100, 100, 80, 50],
                contextMenu: true,
                manualColumnResize: true,
                manualRowResize: false,
                stretchH: 'all',
                maxRows: 10,
                minRows: 10,
                licenseKey: 'non-commercial-and-evaluation',
                afterChange: function(changes, source) {
                    if (source !== 'loadData') {
                        console.log('Table changed:', changes);
                    }
                },
                afterValidate: function(isValid, value, row, prop, source) {
                    if (!isValid) {
                        console.log('Validation failed for:', prop, 'value:', value, 'row:', row);
                    }
                },
                afterInit: function() {
                    console.log('Handsontable initialized successfully');
                    // Remove loading message
                    const container = document.getElementById('scheduleTable');
                    if (container) {
                        container.innerHTML = '';
                    }
                }
            });
            
            console.log('Handsontable instance created:', hot);
            return true;
            } catch (error) {
                console.error('Error creating Handsontable:', error);
                return false;
            }
        }

        // Load schedule data to Handsontable
        function loadScheduleToTable() {
            console.log('Loading schedule data to table...');
            
            if (!hot) {
                console.log('Handsontable not available, showing fallback table');
                showFallbackTable();
                return;
            }
            
            // Convert schedule data to table format
            const tableData = scheduleData.map(item => ({
                round_number: item.round_number,
                part_number: item.part_number,
                start_time: item.start_time,
                end_time: item.end_time,
                status: item.status,
                id: item.id
            }));
            
            console.log('Loading data to Handsontable:', tableData);
            try {
                hot.loadData(tableData);
                console.log('Schedule data loaded to Handsontable:', tableData.length, 'rows');
            } catch (error) {
                console.error('Error loading data to Handsontable:', error);
                showFallbackTable();
            }
        }

        // Show fallback table if Handsontable fails
        function showFallbackTable() {
            const container = document.getElementById('scheduleTable');
            if (!container) {
                console.error('Schedule table container not found for fallback');
                return;
            }
            
            console.log('Creating fallback table...');
            
            const tableData = scheduleData.map(item => ({
                round_number: item.round_number,
                part_number: item.part_number,
                start_time: item.start_time,
                end_time: item.end_time,
                status: item.status,
                id: item.id
            }));
            
            let tableHTML = `
                <div class="overflow-x-auto h-full">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">차수</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">파트</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">시작</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">종료</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            tableData.forEach((item, index) => {
                const statusColor = item.status === 'active' ? 'bg-yellow-100 text-yellow-800' :
                                  item.status === 'completed' ? 'bg-green-100 text-green-800' :
                                  'bg-gray-100 text-gray-800';
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${item.round_number}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.part_number}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${item.start_time}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${item.end_time}</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                ${item.status === 'active' ? '진행 중' : item.status === 'completed' ? '완료' : '대기'}
                            </span>
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${item.id || ''}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
            console.log('Fallback table displayed with', tableData.length, 'rows');
            
            // Remove any loading messages
            const loadingElements = container.querySelectorAll('.animate-spin, .text-gray-500');
            loadingElements.forEach(el => el.remove());
        }

        // Add new row to table
        function addNewRow() {
            if (!hot) return;
            
            // Check if we already have 10 rows
            if (hot.countRows() >= 10) {
                alert('최대 10개 행까지만 추가할 수 있습니다.');
                return;
            }
            
            const newRow = {
                round_number: 1,
                part_number: '3T24',
                start_time: '09:00',
                end_time: '10:00',
                status: 'waiting',
                id: null
            };
            
            hot.alter('insert_row', hot.countRows());
            hot.setDataAtCell(hot.countRows() - 1, 0, newRow.round_number);
            hot.setDataAtCell(hot.countRows() - 1, 1, newRow.part_number);
            hot.setDataAtCell(hot.countRows() - 1, 2, newRow.start_time);
            hot.setDataAtCell(hot.countRows() - 1, 3, newRow.end_time);
            hot.setDataAtCell(hot.countRows() - 1, 4, newRow.status);
            hot.setDataAtCell(hot.countRows() - 1, 5, newRow.id);
        }

        // Save schedule from table
        async function saveSchedule() {
            if (!hot) return;
            
            const tableData = hot.getData();
            const changes = [];
            
            for (let i = 0; i < tableData.length; i++) {
                const row = tableData[i];
                if (!row[0] || !row[1] || !row[2] || !row[3]) continue; // Skip incomplete rows
                
                const scheduleItem = {
                    round_number: parseInt(row[0]),
                    part_number: row[1],
                    start_time: row[2],
                    end_time: row[3],
                    status: row[4] || 'waiting',
                    date: selectedDate,
                    id: row[5] || null
                };
                
                changes.push(scheduleItem);
            }
            
            try {
                // Clear existing data for the selected date
                if (supabase) {
                    const { error: deleteError } = await supabase
                        .from('packaging_schedule')
                        .delete()
                        .eq('date', selectedDate);
                    
                    if (deleteError) throw deleteError;
                }
                
                // Insert new data
                if (supabase && changes.length > 0) {
                    const { error: insertError } = await supabase
                        .from('packaging_schedule')
                        .insert(changes);
                    
                    if (insertError) throw insertError;
                }
                
                // Update local data
                scheduleData = changes.map((item, index) => ({
                    ...item,
                    id: item.id || (Math.max(...scheduleData.map(s => s.id), 0) + index + 1)
                }));
                
                displaySchedule();
                updateStatistics();
                alert(`스케줄이 성공적으로 저장되었습니다. (${changes.length}개 항목)`);
                
            } catch (error) {
                console.error('Error saving schedule:', error);
                alert('스케줄 저장 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // Load mock data for development
        function loadMockData() {
            scheduleData = [
                { id: 1, round_number: 1, part_number: '3T24', start_time: '09:00', end_time: '10:00', status: 'completed', date: selectedDate },
                { id: 2, round_number: 1, part_number: '3T33', start_time: '10:00', end_time: '11:00', status: 'completed', date: selectedDate },
                { id: 3, round_number: 1, part_number: '3T34', start_time: '11:00', end_time: '12:00', status: 'completed', date: selectedDate },
                { id: 4, round_number: 2, part_number: '3T35', start_time: '13:00', end_time: '14:00', status: 'active', date: selectedDate },
                { id: 5, round_number: 2, part_number: '7Z79', start_time: '14:00', end_time: '15:00', status: 'waiting', date: selectedDate },
                { id: 6, round_number: 2, part_number: '7Z80', start_time: '15:00', end_time: '16:00', status: 'waiting', date: selectedDate },
                { id: 7, round_number: 3, part_number: '3T24', start_time: '16:00', end_time: '17:00', status: 'waiting', date: selectedDate },
                { id: 8, round_number: 3, part_number: '3T33', start_time: '17:00', end_time: '18:00', status: 'waiting', date: selectedDate },
                { id: 9, round_number: 3, part_number: '3T34', start_time: '18:00', end_time: '19:00', status: 'waiting', date: selectedDate },
                { id: 10, round_number: 4, part_number: '3T35', start_time: '19:00', end_time: '20:00', status: 'waiting', date: selectedDate }
            ];
            displaySchedule();
            loadScheduleToTable();
            updateStatistics();
        }

        // Display schedule
        function displaySchedule() {
            const container = document.getElementById('scheduleContainer');
            if (!container) {
                console.log('scheduleContainer not found, skipping displaySchedule');
                return;
            }
            
            // Group by rounds
            const rounds = {};
            scheduleData.forEach(item => {
                if (!rounds[item.round_number]) {
                    rounds[item.round_number] = [];
                }
                rounds[item.round_number].push(item);
            });

            container.innerHTML = '';
            
            Object.keys(rounds).sort((a, b) => parseInt(a) - parseInt(b)).forEach(roundNum => {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'mb-8';
                
                // Round header
                const roundHeader = document.createElement('div');
                roundHeader.className = 'round-header text-white rounded-lg p-4 mb-4';
                roundHeader.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold">${roundNum}차</h3>
                        <div class="flex space-x-2">
                            <button onclick="addPartToRound(${roundNum})" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm font-semibold">
                                + 파트 추가
                            </button>
                        </div>
                    </div>
                `;
                
                // Parts list
                const partsList = document.createElement('div');
                partsList.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
                
                rounds[roundNum].forEach(item => {
                    const partDiv = document.createElement('div');
                    partDiv.className = 'schedule-item bg-white border border-gray-200 rounded-lg p-4';
                    
                    partDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="font-bold text-lg text-gray-900">${item.part_number}</div>
                            <span class="status-badge px-3 py-1 rounded-full text-xs font-semibold text-white ${
                                item.status === 'completed' ? 'status-completed' :
                                item.status === 'active' ? 'status-active' :
                                'status-waiting'
                            }">
                                ${item.status === 'completed' ? '완료' :
                                  item.status === 'active' ? '진행 중' : '대기'}
                            </span>
                        </div>
                        <div class="text-gray-600 mb-3">
                            <div class="text-sm">${item.start_time} - ${item.end_time}</div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editSchedule(${item.id})" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                수정
                            </button>
                            <button onclick="deleteSchedule(${item.id})" class="text-red-600 hover:text-red-800 text-sm font-semibold">
                                삭제
                            </button>
                        </div>
                    `;
                    
                    partsList.appendChild(partDiv);
                });
                
                roundDiv.appendChild(roundHeader);
                roundDiv.appendChild(partsList);
                container.appendChild(roundDiv);
            });
        }

        // Update statistics
        function updateStatistics() {
            const totalRounds = new Set(scheduleData.map(item => item.round_number)).size;
            const completedRounds = new Set(scheduleData.filter(item => item.status === 'completed').map(item => item.round_number)).size;
            const activeRounds = new Set(scheduleData.filter(item => item.status === 'active').map(item => item.round_number)).size;
            const totalParts = scheduleData.length;
            
            document.getElementById('totalRounds').textContent = totalRounds;
            document.getElementById('completedRounds').textContent = completedRounds;
            document.getElementById('activeRounds').textContent = activeRounds;
            document.getElementById('totalParts').textContent = totalParts;
        }

        // Add new schedule
        function addNewSchedule() {
            editingItem = null;
            document.getElementById('modalTitle').textContent = '새 스케줄 추가';
            document.getElementById('scheduleForm').reset();
            document.getElementById('scheduleModal').classList.remove('hidden');
            document.getElementById('scheduleModal').classList.add('flex');
        }

        // Add part to specific round
        function addPartToRound(roundNumber) {
            editingItem = null;
            document.getElementById('modalTitle').textContent = `${roundNumber}차 파트 추가`;
            document.getElementById('scheduleForm').reset();
            document.getElementById('roundNumber').value = roundNumber;
            document.getElementById('scheduleModal').classList.remove('hidden');
            document.getElementById('scheduleModal').classList.add('flex');
        }

        // Edit schedule
        function editSchedule(id) {
            const item = scheduleData.find(item => item.id === id);
            if (!item) return;
            
            editingItem = item;
            document.getElementById('modalTitle').textContent = '스케줄 수정';
            document.getElementById('roundNumber').value = item.round_number;
            document.getElementById('partNumber').value = item.part_number;
            document.getElementById('startTime').value = item.start_time;
            document.getElementById('endTime').value = item.end_time;
            document.getElementById('status').value = item.status;
            
            document.getElementById('scheduleModal').classList.remove('hidden');
            document.getElementById('scheduleModal').classList.add('flex');
        }

        // Delete schedule
        async function deleteSchedule(id) {
            if (!confirm('정말로 이 스케줄을 삭제하시겠습니까?')) return;
            
            try {
                if (supabase) {
                    const { error } = await supabase
                        .from('packaging_schedule')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                }
                
                scheduleData = scheduleData.filter(item => item.id !== id);
                displaySchedule();
                updateStatistics();
            } catch (error) {
                console.error('Error deleting schedule:', error);
                alert('스케줄 삭제 중 오류가 발생했습니다.');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('scheduleModal').classList.add('hidden');
            document.getElementById('scheduleModal').classList.remove('flex');
            editingItem = null;
        }

        // Handle form submission
        document.getElementById('scheduleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                round_number: parseInt(document.getElementById('roundNumber').value),
                part_number: document.getElementById('partNumber').value,
                start_time: document.getElementById('startTime').value,
                end_time: document.getElementById('endTime').value,
                status: document.getElementById('status').value,
                date: selectedDate
            };
            
            try {
                if (editingItem) {
                    // Update existing item
                    if (supabase) {
                        const { error } = await supabase
                            .from('packaging_schedule')
                            .update(formData)
                            .eq('id', editingItem.id);
                        
                        if (error) throw error;
                    }
                    
                    const index = scheduleData.findIndex(item => item.id === editingItem.id);
                    scheduleData[index] = { ...editingItem, ...formData };
                } else {
                    // Add new item
                    if (supabase) {
                        const { data, error } = await supabase
                            .from('packaging_schedule')
                            .insert([formData])
                            .select();
                        
                        if (error) throw error;
                        scheduleData.push(data[0]);
                    } else {
                        // Mock data
                        const newId = Math.max(...scheduleData.map(item => item.id), 0) + 1;
                        scheduleData.push({ id: newId, ...formData });
                    }
                }
                
                displaySchedule();
                updateStatistics();
                closeModal();
            } catch (error) {
                console.error('Error saving schedule:', error);
                alert('스케줄 저장 중 오류가 발생했습니다.');
            }
        });

        // Refresh data
        function refreshData() {
            loadScheduleForDate();
        }
    </script>
</body>
</html>
