<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packaging Schedule - Supervisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .control-button {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        
        .control-button:hover {
            transform: scale(1.05);
        }
        
        .control-button:active {
            transform: scale(0.95);
        }
        
        .status-active {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .status-completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .status-waiting {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }
        
        .timer-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="h-screen flex flex-col p-2 bg-gray-50">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border p-3 mb-2">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">포장 작업 관리</h1>
                    <p class="text-gray-600 text-sm">Supervisor Control Panel</p>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="text-right">
                        <div class="text-xs text-gray-500">현재 시간</div>
                        <div class="text-lg font-bold text-blue-600" id="currentTime">00:00:00</div>
                    </div>
                    <button onclick="refreshData()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm font-semibold">
                        🔄
                    </button>
                </div>
            </div>
        </div>

        <!-- Current Status -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-2 mb-2">
            <div class="bg-white rounded-lg shadow-sm border p-3">
                <div class="text-xs text-gray-600 mb-1">오늘 날짜</div>
                <div class="text-lg font-bold text-blue-600" id="todayDate">-</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-3">
                <div class="text-xs text-gray-600 mb-1">현재 ID</div>
                <div class="text-lg font-bold text-blue-600" id="currentRound">-</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-3">
                <div class="text-xs text-gray-600 mb-1">현재 파트</div>
                <div class="text-lg font-bold text-green-600" id="currentPart">-</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-3">
                <div class="text-xs text-gray-600 mb-1">경과 시간</div>
                <div class="text-lg font-bold text-red-600 timer-display" id="elapsedTime">00:00:00</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- ID Selection -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-2">
                <h2 class="text-lg font-bold text-gray-900 mb-3">작업 ID 선택</h2>
                <div class="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-9 gap-2" id="idSelector">
                    <!-- ID buttons will be populated here -->
                </div>
            </div>

            <!-- Selected Task Control -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-2" id="taskControl" style="display: none;">
                <h2 class="text-lg font-bold text-gray-900 mb-3">선택된 작업 제어</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Task Info -->
                    <div class="space-y-3">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-sm text-gray-600 mb-1">선택된 ID</div>
                            <div class="text-xl font-bold text-blue-600" id="selectedId">-</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-sm text-gray-600 mb-1">파트 번호</div>
                            <div class="text-xl font-bold text-green-600" id="selectedPart">-</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-sm text-gray-600 mb-1">현재 상태</div>
                            <div class="text-xl font-bold" id="selectedStatus">-</div>
                        </div>
                    </div>
                    
                    <!-- Control Buttons -->
                    <div class="space-y-3">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-sm text-gray-600 mb-2">작업 제어</div>
                            <div class="space-y-2">
                                <button id="startWorkBtn" onclick="startSelectedWork()" 
                                        class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold text-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed">
                                    🚀 작업 시작
                                </button>
                                <button id="endWorkBtn" onclick="endSelectedWork()" 
                                        class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold text-lg transition-all disabled:bg-gray-300 disabled:cursor-not-allowed">
                                    ⏹️ 작업 종료
                                </button>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-sm text-gray-600 mb-1">시작 시간</div>
                            <div class="text-lg font-bold text-gray-900" id="selectedStartTime">-</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-sm text-gray-600 mb-1">종료 시간</div>
                            <div class="text-lg font-bold text-gray-900" id="selectedEndTime">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Schedule Table -->
            <div class="bg-white rounded-lg shadow-sm border flex-1 flex flex-col">
                <div class="p-3 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-gray-900">금일 스케줄</h2>
                </div>
                <div class="flex-1 overflow-hidden">
                    <div class="h-full overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-gray-50">
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2 px-2 font-semibold text-gray-700">ID</th>
                                    <th class="text-left py-2 px-2 font-semibold text-gray-700">파트</th>
                                    <th class="text-left py-2 px-2 font-semibold text-gray-700">시작</th>
                                    <th class="text-left py-2 px-2 font-semibold text-gray-700">종료</th>
                                    <th class="text-left py-2 px-2 font-semibold text-gray-700">상태</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTable">
                                <!-- Schedule items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize variables
        let scheduleData = [];
        let selectedRound = null;
        let currentWork = null;
        let workStartTime = null;
        let timerInterval = null;
        let clockInterval = null;

        // Initialize the supervisor page
        document.addEventListener('DOMContentLoaded', function() {
            initializeSupabase();
            startClock();
            setTodayDate();
            loadScheduleData();
        });

        // Initialize Supabase connection
        async function initializeSupabase() {
            try {
                // Use global supabase if available, otherwise use mock data
                if (window.supabase) {
                    console.log('Using global Supabase client for schedule supervisor');
                } else {
                    console.log('No global Supabase client, using mock data');
                    loadMockData();
                }
            } catch (error) {
                console.error('Supabase initialization failed:', error);
                // Use mock data for development
                loadMockData();
            }
        }

        // Start the digital clock
        function startClock() {
            updateClock();
            clockInterval = setInterval(updateClock, 1000);
        }

        // Update clock display
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        // Set today's date display
        function setTodayDate() {
            const today = new Date();
            const todayString = today.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            document.getElementById('todayDate').textContent = todayString;
        }

        // Load schedule data
        async function loadScheduleData() {
            try {
                if (window.supabase) {
                    const today = new Date().toISOString().split('T')[0];
                    const { data, error } = await window.supabase
                        .from('packaging_schedule')
                        .select('*')
                        .eq('date', today)
                        .order('id', { ascending: true });
                    
                    if (error) throw error;
                    scheduleData = data || [];
                } else {
                    loadMockData();
                }
                
                displayIdSelector();
                displayScheduleTable();
                updateCurrentStatus();
            } catch (error) {
                console.error('Error loading schedule data:', error);
                loadMockData();
            }
        }

        // Load mock data for development
        function loadMockData() {
            scheduleData = [
                { id: 1, part_number: '24', start_time: '08:00', end_time: '09:00', status: 'completed', date: new Date().toISOString().split('T')[0] },
                { id: 2, part_number: '33', start_time: '09:00', end_time: '', status: 'active', date: new Date().toISOString().split('T')[0] },
                { id: 3, part_number: '34', start_time: '', end_time: '', status: 'waiting', date: new Date().toISOString().split('T')[0] },
                { id: 4, part_number: '35', start_time: '', end_time: '', status: 'waiting', date: new Date().toISOString().split('T')[0] },
                { id: 5, part_number: '79', start_time: '', end_time: '', status: 'waiting', date: new Date().toISOString().split('T')[0] },
                { id: 6, part_number: '80', start_time: '', end_time: '', status: 'waiting', date: new Date().toISOString().split('T')[0] },
                { id: 7, part_number: '4GV3', start_time: '', end_time: '', status: 'waiting', date: new Date().toISOString().split('T')[0] },
                { id: 8, part_number: '4GF8', start_time: '', end_time: '', status: 'waiting', date: new Date().toISOString().split('T')[0] },
                { id: 9, part_number: 'SWAP', start_time: '', end_time: '', status: 'waiting', date: new Date().toISOString().split('T')[0] }
            ];
            displayIdSelector();
            displayScheduleTable();
            updateCurrentStatus();
        }

        // Display ID selector buttons
        function displayIdSelector() {
            const container = document.getElementById('idSelector');
            const sortedData = [...scheduleData].sort((a, b) => a.id - b.id);
            
            container.innerHTML = sortedData.map(item => {
                const status = calculateStatus(item);
                const statusColor = status === 'completed' ? 'bg-green-100 text-green-800 border-green-300' :
                                  status === 'active' ? 'bg-yellow-100 text-yellow-800 border-yellow-300' :
                                  'bg-gray-100 text-gray-800 border-gray-300';
                
                return `
                    <button onclick="selectTask(${item.id})" 
                            class="p-3 rounded-lg border-2 font-bold text-lg transition-all hover:shadow-md ${statusColor}">
                        ${item.id}
                    </button>
                `;
            }).join('');
        }

        // Select a task
        function selectTask(itemId) {
            const item = scheduleData.find(s => s.id === itemId);
            if (!item) return;
            
            // Update selected task display
            document.getElementById('selectedId').textContent = item.id;
            document.getElementById('selectedPart').textContent = item.part_number;
            
            const status = calculateStatus(item);
            const statusText = status === 'completed' ? '완료' : 
                             status === 'active' ? '진행중' : '대기';
            const statusColor = status === 'completed' ? 'text-green-600' :
                              status === 'active' ? 'text-yellow-600' : 'text-gray-600';
            
            document.getElementById('selectedStatus').textContent = statusText;
            document.getElementById('selectedStatus').className = `text-xl font-bold ${statusColor}`;
            
            document.getElementById('selectedStartTime').textContent = item.start_time || '-';
            document.getElementById('selectedEndTime').textContent = item.end_time || '-';
            
            // Update button states
            const hasStartTime = item.start_time && item.start_time.trim() !== '';
            const hasEndTime = item.end_time && item.end_time.trim() !== '';
            
            const startBtn = document.getElementById('startWorkBtn');
            const endBtn = document.getElementById('endWorkBtn');
            
            if (hasStartTime) {
                startBtn.disabled = true;
                startBtn.textContent = '시작됨';
            } else {
                startBtn.disabled = false;
                startBtn.textContent = '🚀 작업 시작';
            }
            
            if (!hasStartTime || hasEndTime) {
                endBtn.disabled = true;
                endBtn.textContent = hasEndTime ? '완료됨' : '대기중';
            } else {
                endBtn.disabled = false;
                endBtn.textContent = '⏹️ 작업 종료';
            }
            
            // Show task control panel
            document.getElementById('taskControl').style.display = 'block';
            
            // Store selected task
            window.selectedTaskId = itemId;
        }

        // Start selected work
        async function startSelectedWork() {
            if (!window.selectedTaskId) return;
            await startWork(window.selectedTaskId);
        }

        // End selected work
        async function endSelectedWork() {
            if (!window.selectedTaskId) return;
            await endWork(window.selectedTaskId);
        }

        // Display schedule table
        function displayScheduleTable() {
            const tbody = document.getElementById('scheduleTable');
            
            // Sort by ID to show sequential order
            const sortedData = [...scheduleData].sort((a, b) => a.id - b.id);
            
            tbody.innerHTML = sortedData.map(item => {
                const status = calculateStatus(item);
                const statusColor = status === 'completed' ? 'bg-green-100 text-green-800' :
                                  status === 'active' ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-gray-100 text-gray-800';
                
                const statusText = status === 'completed' ? '완료' : 
                                 status === 'active' ? '진행중' : '대기';
                
                // Row styling based on status
                let rowClass = "border-b border-gray-100 hover:bg-gray-50 cursor-pointer";
                if (status === 'active') {
                    rowClass = "border-b border-gray-100 bg-yellow-50 border-l-4 border-l-yellow-500 cursor-pointer";
                } else if (status === 'completed') {
                    rowClass = "border-b border-gray-100 bg-green-50 border-l-4 border-l-green-500 cursor-pointer";
                }
                
                return `
                    <tr class="${rowClass}" onclick="selectTask(${item.id})">
                        <td class="py-2 px-2 font-semibold text-sm">${item.id}</td>
                        <td class="py-2 px-2 font-semibold text-sm">${item.part_number}</td>
                        <td class="py-2 px-2 text-sm">${item.start_time || '-'}</td>
                        <td class="py-2 px-2 text-sm">${item.end_time || '-'}</td>
                        <td class="py-2 px-2">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Calculate status based on start and end times
        function calculateStatus(item) {
            if (item.start_time && item.start_time.trim() !== '' && item.end_time && item.end_time.trim() !== '') {
                return 'completed';
            } else if (item.start_time && item.start_time.trim() !== '') {
                return 'active';
            } else {
                return 'waiting';
            }
        }

        // Start work for specific item
        async function startWork(itemId) {
            const item = scheduleData.find(s => s.id === itemId);
            if (!item) return;
            
            if (item.start_time && item.start_time.trim() !== '') {
                alert('이 작업은 이미 시작되었습니다.');
                return;
            }
            
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                if (window.supabase) {
                    const { error } = await window.supabase
                        .from('packaging_schedule')
                        .update({ 
                            start_time: timeString,
                            status: 'active'
                        })
                        .eq('id', itemId);
                    
                    if (error) throw error;
                }
                
                // Update local data
                const index = scheduleData.findIndex(s => s.id === itemId);
                scheduleData[index].start_time = timeString;
                scheduleData[index].status = 'active';
                
                currentWork = item;
                workStartTime = now;
                
                displayIdSelector();
                displayScheduleTable();
                updateCurrentStatus();
                startTimer();
                
                // Update selected task if it's the one being started
                if (window.selectedTaskId === itemId) {
                    selectTask(itemId);
                }
                
                console.log(`Work started: ${item.part_number} at ${timeString}`);
            } catch (error) {
                console.error('Error starting work:', error);
                alert('작업 시작 중 오류가 발생했습니다.');
            }
        }

        // End work for specific item
        async function endWork(itemId) {
            const item = scheduleData.find(s => s.id === itemId);
            if (!item) return;
            
            if (!item.start_time || item.start_time.trim() === '') {
                alert('시작 시간이 없습니다.');
                return;
            }
            
            if (item.end_time && item.end_time.trim() !== '') {
                alert('이 작업은 이미 종료되었습니다.');
                return;
            }
            
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                if (window.supabase) {
                    const { error } = await window.supabase
                        .from('packaging_schedule')
                        .update({ 
                            end_time: timeString,
                            status: 'completed'
                        })
                        .eq('id', itemId);
                    
                    if (error) throw error;
                }
                
                // Update local data
                const index = scheduleData.findIndex(s => s.id === itemId);
                scheduleData[index].end_time = timeString;
                scheduleData[index].status = 'completed';
                
                if (currentWork && currentWork.id === itemId) {
                    currentWork = null;
                    workStartTime = null;
                    stopTimer();
                }
                
                displayIdSelector();
                displayScheduleTable();
                updateCurrentStatus();
                
                // Update selected task if it's the one being ended
                if (window.selectedTaskId === itemId) {
                    selectTask(itemId);
                }
                
                console.log(`Work ended: ${item.part_number} at ${timeString}`);
            } catch (error) {
                console.error('Error ending work:', error);
                alert('작업 종료 중 오류가 발생했습니다.');
            }
        }


        // Start timer
        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                if (workStartTime) {
                    const now = new Date();
                    const elapsed = Math.floor((now - workStartTime) / 1000);
                    
                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const seconds = elapsed % 60;
                    
                    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    document.getElementById('elapsedTime').textContent = timeString;
                }
            }, 1000);
        }

        // Stop timer
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('elapsedTime').textContent = '00:00:00';
        }


        // Update current status
        function updateCurrentStatus() {
            const activeItem = scheduleData.find(item => item.status === 'active');
            
            if (activeItem) {
                document.getElementById('currentRound').textContent = `ID ${activeItem.id}`;
                document.getElementById('currentPart').textContent = activeItem.part_number;
            } else {
                document.getElementById('currentRound').textContent = '-';
                document.getElementById('currentPart').textContent = '-';
            }
        }

        // Refresh data
        function refreshData() {
            loadScheduleData();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (timerInterval) clearInterval(timerInterval);
            if (clockInterval) clearInterval(clockInterval);
        });
    </script>
</body>
</html>
