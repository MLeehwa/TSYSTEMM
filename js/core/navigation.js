/**
 * Navigation Manager
 * Handles page loading and navigation in the new architecture
 */

class NavigationManager {
    constructor() {
        this.currentPage = null;
        this.pageModules = new Map();
        this.isInitialized = false;
        this.init();
    }

    async init() {
        try {
            console.log('üß≠ Initializing Navigation Manager...');
            
            this.setupEventListeners();
            this.registerPageModules();
            this.isInitialized = true;
            
            console.log('‚úÖ Navigation Manager initialized');
            
        } catch (error) {
            console.error('‚ùå Navigation Manager init failed:', error);
        }
    }

    setupEventListeners() {
        try {
            console.log('üîó Setting up navigation event listeners...');
            
            // ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä
            const sidebarToggle = TMUtils.getElement('sidebarToggle');
            if (sidebarToggle) {
                console.log('‚úÖ Sidebar toggle button found');
                TMUtils.addSafeEventListener(sidebarToggle, 'click', () => {
                    console.log('üîÑ Sidebar toggle clicked');
                    this.toggleSidebar();
                });
            } else {
                console.warn('‚ö†Ô∏è Sidebar toggle button not found');
            }

            // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÎßÅÌÅ¨Îì§ - DOMÏù¥ Î°úÎìúÎêú ÌõÑÏóê ÏÑ§Ï†ï
            this.setupNavigationLinks();

            // ÏãúÏä§ÌÖú ÏÉÅÌÉú Î≤ÑÌäº
            const systemStatusBtn = TMUtils.getElement('systemStatusBtn');
            if (systemStatusBtn) {
                console.log('‚úÖ System status button found');
                TMUtils.addSafeEventListener(systemStatusBtn, 'click', () => {
                    console.log('üîÑ System status button clicked');
                    this.showSystemStatus();
                });
            } else {
                console.warn('‚ö†Ô∏è System status button not found');
            }
            
            console.log('‚úÖ Event listeners setup completed');
            
        } catch (error) {
            console.error('‚ùå Error setting up event listeners:', error);
        }
    }

    setupNavigationLinks() {
        try {
            console.log('üîó Setting up navigation links...');
            
            // Î™®Îì† ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÎßÅÌÅ¨ Ï∞æÍ∏∞
            const navLinks = document.querySelectorAll('[data-page]');
            console.log(`üìã Found ${navLinks.length} navigation links:`, navLinks);
            
            navLinks.forEach((link, index) => {
                const pageName = link.getAttribute('data-page');
                console.log(`üîó Setting up link ${index + 1}: ${pageName}`);
                
                // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
                link.removeEventListener('click', this.handleNavLinkClick);
                
                // ÏÉà Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log(`üîÑ Navigation link clicked: ${pageName}`);
                    this.loadPage(pageName);
                });
                
                console.log(`‚úÖ Link ${pageName} setup completed`);
            });
            
            console.log('‚úÖ All navigation links setup completed');
            
        } catch (error) {
            console.error('‚ùå Error setting up navigation links:', error);
        }
    }

    registerPageModules() {
        // FIFO ÏãúÏä§ÌÖú Î™®ÎìàÎì§
        this.pageModules.set('fifo-upload', {
            path: 'pages/fifo/upload.html',
            script: 'js/fifo/upload.js',
            title: 'FIFO Data Upload'
        });

        this.pageModules.set('fifo-list', {
            path: 'pages/fifo/list.html',
            script: 'js/fifo/list.js',
            title: 'FIFO Data List'
        });

        this.pageModules.set('fifo-analysis', {
            path: 'pages/fifo/analysis.html',
            script: 'js/fifo/analysis.js',
            title: 'FIFO Analysis'
        });

        // Ìä∏Îü≠ ÏãúÏä§ÌÖú Î™®ÎìàÎì§
        this.pageModules.set('truck-management', {
            path: 'pages/truck/management.html',
            script: 'js/truck/management.js',
            title: 'Truck Management'
        });

        this.pageModules.set('truck-status', {
            path: 'pages/truck/status.html',
            script: 'js/truck/status.js',
            title: 'Truck Status'
        });
    }

    async loadPage(pageName) {
        try {
            console.log(`üîÑ Loading page: ${pageName}`);
            
            const pageModule = this.pageModules.get(pageName);
            if (!pageModule) {
                throw new Error(`Page module ${pageName} not found`);
            }

            // ÌéòÏù¥ÏßÄ Î°úÎî© ÏãúÏûë
            this.showLoadingState();

            // HTML ÏΩòÌÖêÏ∏† Î°úÎìú
            const htmlContent = await this.fetchPageContent(pageModule.path);
            
            // Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ ÏóÖÎç∞Ïù¥Ìä∏
            this.updateMainContent(htmlContent, pageModule.title);
            
            // JavaScript Î™®Îìà Î°úÎìú
            await this.loadPageScript(pageModule.script);
            
            // ÌéòÏù¥ÏßÄ Î°úÎî© ÏôÑÎ£å
            this.hideLoadingState();
            this.updateActiveNavigation(pageName);
            
            console.log(`‚úÖ Page ${pageName} loaded successfully`);
            
        } catch (error) {
            console.error(`‚ùå Failed to load page ${pageName}:`, error);
            this.showErrorState(error);
        }
    }

    async fetchPageContent(pagePath) {
        try {
            const response = await fetch(pagePath);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return await response.text();
        } catch (error) {
            throw new Error(`Failed to fetch page content: ${error.message}`);
        }
    }

    updateMainContent(htmlContent, title) {
        const mainContent = TMUtils.getElement('mainContent');
        if (!mainContent) {
            throw new Error('Main content area not found');
        }

        // ÌéòÏù¥ÏßÄ Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
        const pageTitle = document.querySelector('.page-title');
        if (pageTitle) {
            pageTitle.textContent = title;
        }

        // HTML ÏΩòÌÖêÏ∏† ÏÇΩÏûÖ
        mainContent.innerHTML = htmlContent;

        // Ïù∏ÎùºÏù∏ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
        this.executeInlineScripts(mainContent);
    }

    async loadPageScript(scriptPath) {
        try {
            // Í∏∞Ï°¥ Ïä§ÌÅ¨Î¶ΩÌä∏ Ï†úÍ±∞
            const existingScript = document.querySelector(`script[src="${scriptPath}"]`);
            if (existingScript) {
                existingScript.remove();
            }

            // FIFO ÏóÖÎ°úÎìú Î™®ÎìàÏùò Í≤ΩÏö∞ Ï§ëÎ≥µ Î°úÎî© Î∞©ÏßÄ
            if (scriptPath.includes('fifo/upload.js') && window.fifoUploadModule) {
                console.log('‚ö†Ô∏è FIFO Upload Module already loaded, skipping script load');
                return;
            }

            // ÏÉà Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = scriptPath;
                script.onload = () => {
                    console.log(`‚úÖ Script loaded: ${scriptPath}`);
                    resolve();
                };
                script.onerror = (error) => {
                    console.error(`‚ùå Script load failed: ${scriptPath}`, error);
                    reject(error);
                };
                document.body.appendChild(script);
            });
        } catch (error) {
            throw new Error(`Script loading failed: ${error.message}`);
        }
    }

    executeInlineScripts(container) {
        try {
            const scripts = container.querySelectorAll('script');
            scripts.forEach(script => {
                if (script.textContent.trim()) {
                    try {
                        eval(script.textContent);
                    } catch (error) {
                        console.error('‚ùå Inline script execution failed:', error);
                    }
                }
            });
        } catch (error) {
            console.error('‚ùå Error executing inline scripts:', error);
        }
    }

    showLoadingState() {
        const loadingIndicator = TMUtils.getElement('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.classList.remove('hidden');
        }
    }

    hideLoadingState() {
        const loadingIndicator = TMUtils.getElement('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
        }
    }

    showErrorState(error) {
        const mainContent = TMUtils.getElement('mainContent');
        if (mainContent) {
            mainContent.innerHTML = `
                <div class="error-page">
                    <h2>‚ö†Ô∏è Page Load Error</h2>
                    <p>${error.message}</p>
                    <button onclick="location.reload()" class="btn btn-primary">
                        Refresh Page
                    </button>
                </div>
            `;
        }
    }

    updateActiveNavigation(activePage) {
        // Î™®Îì† ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÎßÅÌÅ¨ÏóêÏÑú active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
        const navLinks = document.querySelectorAll('[data-page]');
        navLinks.forEach(link => {
            link.classList.remove('active');
        });

        // ÌòÑÏû¨ ÌôúÏÑ± ÌéòÏù¥ÏßÄÏóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
        const activeLink = document.querySelector(`[data-page="${activePage}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }

    toggleSidebar() {
        const sidebar = TMUtils.getElement('sidebar');
        if (sidebar) {
            sidebar.classList.toggle('collapsed');
        }
    }

    showSystemStatus() {
        const status = {
            navigation: this.isInitialized ? 'ready' : 'initializing',
            database: window.dbManager ? window.dbManager.isReady() ? 'connected' : 'disconnected' : 'not_loaded',
            systems: window.systemManager ? window.systemManager.getAllSystemStatus() : 'not_loaded'
        };

        console.log('üìä System Status:', status);
        
        // ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏÉÅÌÉú ÌëúÏãú
        const statusText = `
            üß≠ Navigation: ${status.navigation}
            üîó Database: ${status.database}
            ‚öôÔ∏è Systems: ${JSON.stringify(status.systems, null, 2)}
        `;
        
        TMUtils.showStatus(statusText, 'info');
    }

    // ÌéòÏù¥ÏßÄ Î™®Îìà ÏÉÅÌÉú ÌôïÏù∏
    getPageModuleStatus(pageName) {
        const module = this.pageModules.get(pageName);
        return module ? 'registered' : 'not_found';
    }

    // Î™®Îì† ÌéòÏù¥ÏßÄ Î™®Îìà ÏÉÅÌÉú ÌôïÏù∏
    getAllPageModuleStatus() {
        const status = {};
        for (const [name] of this.pageModules) {
            status[name] = this.getPageModuleStatus(name);
        }
        return status;
    }
}

// Ï†ÑÏó≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Í¥ÄÎ¶¨Ïûê ÏÉùÏÑ±
window.navigationManager = new NavigationManager();

console.log('‚úÖ Navigation Manager loaded');
